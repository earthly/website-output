<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<link rel="icon" type="image/png" href="/blog/assets/images/favicon.png">
<!-- begin _includes/seo.html -->





<title>Why is JRuby Slow? - Earthly Blog</title>
<meta name="description" content="Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses Earthly and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.">


  <meta name="author" content="Adam Gordon Bell">
  
  <meta property="article:author" content="Adam Gordon Bell">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Earthly Blog">
<meta property="og:title" content="Why is JRuby Slow?">
<meta property="og:url" content="https://earthly.dev/blog/jruby/">


  <meta property="og:description" content="Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses Earthly and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.">



  <meta property="og:image" content="/blog/generated/assets/images/jruby/header-800-5e8dd6404.jpg">



  <meta name="twitter:site" content="@EarthlyTech">
  <meta name="twitter:title" content="Why is JRuby Slow?">
  <meta name="twitter:description" content="Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses Earthly and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.">
  <meta name="twitter:url" content="https://earthly.dev/blog/jruby/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://earthly.dev/blog/generated/assets/images/jruby/header-800-5e8dd6404.jpg">
  

  



  <meta property="article:published_time" content="2021-05-26T00:00:00-04:00">





  

  


<link rel="canonical" href="https://earthly.dev/blog/jruby/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Organization",
      "url": "https://earthly.dev/blog/",
      "logo": "/assets/images/logo-header.png"
    
  }
</script>






<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Earthly Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161831101-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161831101-5');
</script>
  <!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '259843109045285');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=259843109045285&ev=PageView&noscript=1"
    />
</noscript>
 <!-- End Facebook Pixel Code -->
  <!-- Twitter universal website tag code -->
<script>
  !function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
  },s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
  a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
  // Insert Twitter Pixel ID and Standard Event data below
  twq('init','o5s6p');
  twq('track','PageView');
  </script>
  <!-- End Twitter universal website tag code -->


  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/blog/assets/images/white-logo.png" alt="Earthly"></a>
        
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/">Blog home</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/articles/">Articles</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/news/">News</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/tutorials/">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/earthly/earthly">GitHub</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  







<div class="page__hero"
  style=" background-image: url('');"
>
  
      <picture class="page__hero-image"><source srcset="/blog/generated/assets/images/jruby/header-400-28357c61a.webp 400w, /blog/generated/assets/images/jruby/header-600-28357c61a.webp 600w, /blog/generated/assets/images/jruby/header-800-28357c61a.webp 800w, /blog/generated/assets/images/jruby/header-1000-28357c61a.webp 1000w, /blog/generated/assets/images/jruby/header-1200-28357c61a.webp 1200w" type="image/webp"><source srcset="/blog/generated/assets/images/jruby/header-400-28357c61a.png 400w, /blog/generated/assets/images/jruby/header-600-28357c61a.png 600w, /blog/generated/assets/images/jruby/header-800-28357c61a.png 800w, /blog/generated/assets/images/jruby/header-1000-28357c61a.png 1000w, /blog/generated/assets/images/jruby/header-1200-28357c61a.png 1200w" type="image/png"><img src="/blog/generated/assets/images/jruby/header-800-28357c61a.jpg" alt="Why is JRuby Slow?"></picture>

  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar">
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Why is JRuby Slow?">
    <meta itemprop="description" content="Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses Earthly and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.">
    <meta itemprop="datePublished" content="2021-05-26T00:00:00-04:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Why is JRuby Slow?
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          14 minute read
        
        
        &nbsp;	&nbsp;<i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-05-26T00:00:00-04:00">May 26, 2021</time>
        

      </span>
    
    <span>
      
      
      
      <div class="author__avatar_top">
          <picture class="image-author"><source srcset="/blog/generated/assets/images/authors/adamgordonbell-240-fc29677ee.webp 240w" type="image/webp"><source srcset="/blog/generated/assets/images/authors/adamgordonbell-240-ad4309f1a.png 240w" type="image/png"><img src="/blog/generated/assets/images/authors/adamgordonbell-240-ad4309f1a.png" alt="Adam Gordon Bell %"></picture>

          &nbsp;	&nbsp;
          Adam Gordon Bell
      </div>
      
    </span>
  </p>


        </header>
      
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#what-is-jruby">What is JRuby?</a><ul><li><a href="#install-jruby">Install JRuby</a></li></ul></li><li><a href="#why-do-people-use-jruby">Why do people use JRuby?</a><ul><li><a href="#getting-past-the-gil">Getting past the GIL</a></li><li><a href="#library-access-and-environment-access">Library Access and Environment Access</a></li><li><a href="#long-running-process-performance">Long-Running Process Performance</a></li></ul></li><li><a href="#why-is-my-jruby-program-slow">Why is my JRuby Program Slow?</a><ul><li><a href="#inside---dev">Inside --dev</a></li></ul></li><li><a href="#why-is-my-jruby-program-wrong">Why is my JRuby Program Wrong?</a></li><li><a href="#what-is-truffleruby">What is TruffleRuby?</a><ul><li><a href="#install-truffleruby">Install TruffleRuby</a></li></ul></li><li><a href="#performance-shoot-out">Performance Shoot-out</a><ul><li><a href="#failure-of-fork">Failure Of Fork</a></li><li><a href="#test-with-rubyspy">Test with RubySpy</a><ul><li><a href="#jekyll-test-1">Jekyll Test 1</a></li><li><a href="#jekyll-test-2">Jekyll Test 2</a></li></ul></li></ul></li><li><a href="#performance-advice">Performance Advice</a></li><li><a href="#updates">Updates</a></li><li><a href="#more-resources">More Resources</a></li></ul>

            </nav>
          </aside>
        
        <p>Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses <a href="http://earthly.dev/">Earthly</a> and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.</p>
<p>The build times looked like this:</p>
<div class="center">
<table>
<thead>
<tr class="header">
<th>Ruby Version</th>
<th style="text-align: center;">Jekyll CI Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2.5</td>
<td style="text-align: center;">8m 31s</td>
</tr>
<tr class="even">
<td>2.7</td>
<td style="text-align: center;">8m 33s</td>
</tr>
<tr class="odd">
<td>3.0</td>
<td style="text-align: center;">7m 47s</td>
</tr>
<tr class="even">
<td>JRuby</td>
<td style="text-align: center;">45m 16s</td>
</tr>
</tbody>
</table>
<figcaption>
A Representative Jekyll CI <a href="https://github.com/jekyll/jekyll/runs/2048545456?check_suite_focus=true">Build</a>
</figcaption>
</div>
<p>The Jekyll CI does lots of things in it that a simple Jekyll site build might not but clearly JRuby was slowing the whole process down by a significant amount, and this surprised me: Wasn’t the entire point of using JRuby, and its new brother TruffleRuby, speed? <strong>Why was JRuby so slow?</strong></p>
<p>Even building this blog and using all the tricks I’ve found, the performance of Ruby on the JVM still looks like this:</p>
<div class="center">
<table>
<thead>
<tr class="header">
<th>Runtime</th>
<th>Jekyll Build Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MRI Ruby 2.7.0</td>
<td>2.64 seconds</td>
</tr>
<tr class="even">
<td>Fastest Ruby on JVM Build</td>
<td>25.7 seconds</td>
</tr>
</tbody>
</table>
<figcaption>
Building This blog is 10x slower
</figcaption>
</div>
<p>So why is JRuby slow in these examples? It turns out that the answer is complicated.</p>
<h2 id="what-is-jruby">What is JRuby?</h2>
<blockquote>
<p>I was very happy to discover the JRuby project, my favorite programming language running on what’s probably the best virtual machine in the world. - Peter Lind</p>
</blockquote>
<p>JRuby is an alternative Ruby interpreter that runs on the Java Virtual Machine (JVM). MRI Ruby, also known as CRuby, is written in C and is the standard interpreter and runtime for Ruby.</p>
<h3 id="install-jruby">Install JRuby</h3>
<p>On my mac book, I can switch from the MRI Ruby to JRuby like this.</p>
<p>Install rbenv:</p>
<pre><code>brew install rbenv</code></pre>
<p>List possible install options:</p>
<pre><code>rbenv install -l     </code></pre>
<p>Install:</p>
<pre><code>rbenv install jruby-9.2.16.0</code></pre>
<p>Set a specific project to use JRuby:</p>
<pre><code>rbenv local jruby-9.2.16.0</code></pre>
<h2 id="why-do-people-use-jruby">Why do people use JRuby?</h2>
<!-- vale Vale.Spelling = NO -->
<blockquote class="twitter-tweet">
<p lang="en" dir="ltr">
OMG <a href="https://twitter.com/hashtag/JRuby?src=hash&amp;ref_src=twsrc%5Etfw">#JRuby</a> +Java.util.concurrent FTW! Doing a recursive backtrace through billion+, I've made it 30,000x faster than 1.9.3. 30 THOUSAND.
</p>
— /dave/null (<span class="citation" data-cites="bokmann">@bokmann</span>) <a href="https://twitter.com/bokmann/status/381422498170273792?ref_src=twsrc%5Etfw">September 21, 2013</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<!-- vale Vale.Spelling = YES -->
<p>There are several reasons people might choose JRuby, several of which have to do with performance.</p>
<h3 id="getting-past-the-gil">Getting past the GIL</h3>
<p>MRI Ruby, much like Python, has a global interpreter lock. This means that although you can have many threads in a single Ruby process, only one will ever be running at a time. If you look at <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/performance/fannkuchredux.html">many</a> of the benchmark shout-out results, parallel multi-core solutions dominate. JRuby lets you sidestep the GIL as a bottleneck, at the cost of having to worry about writing thread-safe code.</p>
<h3 id="library-access-and-environment-access">Library Access and Environment Access</h3>
<p>A common driver for JRuby usage is the need for a Java-based library or the need to target the JVM. You could be trying to write an Android app or a Swing app using JRuby, or maybe you already have an existing Ruby codebase but need it to run on the JVM. My 2 cents is that if you start from scratch and need to target the JVM, JRuby should not be the first option you consider. If you do choose JRuby, be warned that you will need a good grasp of Java, the JVM, and Ruby: if you’re coming to the JVM for java libraries and functionality, then JRuby won’t save you from having to read Java.</p>
<h3 id="long-running-process-performance">Long-Running Process Performance</h3>
<p>MRI Ruby is known to be slow, as compared to the JVM or even Node.js. According to <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/performance/pidigits.html">The Computer Language Benchmarks Game</a>, it’s often 5-10x slower than a similar Java solution. Small performance benchmarks are often not the best way to assess practical performance, but one place the JVM is known to perform very well compared to interpreted languages is in long-running server applications, where <a href="https://jakubstransky.com/2018/08/28/hotspot-jvm-jit-optimisation-techniques/">adaptive optimizations</a> can make a big difference.</p>
<h2 id="why-is-my-jruby-program-slow">Why is my JRuby Program Slow?</h2>
<p>The JVM might be fast at running Java in benchmark games, but that doesn’t necessarily carry over to JRuby. The JVM makes different performance trade-offs than MRI Ruby. Notably, an untuned JVM process has a slow start-up time, and with JRuby, this can get even worse as lots of standard library code is loaded on start-up. The JVM starts by working as a byte code interpreter and compiles “hot” code as it goes but in a large Ruby project, with lots of gems, the overhead of JITing all the Ruby code to bytecode can lead to a significantly slower start-up time.</p>
<p>If you are using JRuby at the command line or starting lots of short-lived JRuby processes, then it is likely that JRuby will be slower than MRI Ruby. However, the JVM is extensively tunable, and it’s possible to tune things to behave more like standard Ruby. If you want your JRuby to behave more like MRI Ruby, you probably want to set the <code>--dev</code> flag. Either like this:</p>
<pre><code> ENV JRUBY_OPTS=&quot;--dev&quot;</code></pre>
<p>OR</p>
<pre><code>jruby --dev file.rb</code></pre>
<p>In my Jekyll use case, this change and some other small JVM parameter tweaking made a big difference. I was able to get the build time down from 45m 16s to 24m 1s.</p>
<div class="center">
<table>
<thead>
<tr class="header">
<th>JRuby Flags</th>
<th>Jekyll CI Run Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>JRuby</td>
<td>45m 16s</td>
</tr>
<tr class="even">
<td>JRuby –dev</td>
<td>24m 1s</td>
</tr>
</tbody>
</table>
<figcaption>
<code>--dev</code> gets us closer to MRI Ruby
</figcaption>
</div>
<h3 id="inside---dev">Inside <code>--dev</code></h3>
<p>The <code>--dev</code> flag indicates to JRuby that you are running it in as a developer and would prefer quick startup time over absolute performance. JRuby, in turn, tells the JVM only do a single level jit (<code>-J-XX:TieredStopAtLevel=1</code>) and to not worry about verifying the bytecode (<code>-J-Xverify:none</code>). More details on the flag can found <a href="http://blog.headius.com/2019/09/jruby-startup-time-exploration.html">here</a>.</p>
<h2 id="why-is-my-jruby-program-wrong">Why is my JRuby Program Wrong?</h2>
<p>Ruby’s built-in types were built with the GIL in mind and are not thread-safe on the JVM. If you move the JRuby to sidestep the GIL, keep in mind that you may be introducing threading bugs. If you get unexpected or non-deterministic results in your concurrent array usage, you should look at concurrent data structures for the JVM like ConcurrentHashMap or ConcurrentSkipListMap. You may find that they not only fix the threading issues but could be <a href="https://gist.github.com/bokmann/6652776">orders of magnitude faster</a> than the idiomatic Ruby way. Jekyll is not multi-threaded, however, so this is not an issue I needed to worry about.</p>
<h2 id="what-is-truffleruby">What is TruffleRuby?</h2>
<p><a href="https://www.graalvm.org/">GraalVM</a> is a JVM with different goals than the standard Java virtual machine.<br />
According to Wikipedia, these goals are:</p>
<ul>
<li>To improve the performance of Java virtual machine-based languages to match the performance of native languages.</li>
<li>To reduce the start-up time of JVM-based applications by compiling them ahead-of-time with GraalVM Native Image technology.</li>
<li>To allow freeform mixing of code from any programming language in a single program.</li>
</ul>
<p>Increased performance and better start-up time sound precisely like what we need to improve on JRuby, and this fact did not go unnoticed: <a href="https://github.com/oracle/truffleruby">TruffleRuby</a> is a fork of JRuby that runs on GraalVM. Because GraalVM supports both ahead of time compilation and JIT, it’s possible to optimize either for peak performance of a long-running service or for start-up time, which is helpful for shorter running command-line apps like Jekyll.</p>
<p>TruffleRuby explains the trade-offs of AOT vs. JIT like this:</p>
<table>
<thead>
<tr class="header">
<th>Configuration:</th>
<th style="text-align: right;">Native (<code>--native</code>, default)</th>
<th style="text-align: right;">JVM (<code>--jvm</code>)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Time to start TruffleRuby</td>
<td style="text-align: right;">about as fast as MRI start-up</td>
<td style="text-align: right;">slower</td>
</tr>
<tr class="even">
<td>Time to reach peak performance</td>
<td style="text-align: right;">faster</td>
<td style="text-align: right;">slower</td>
</tr>
<tr class="odd">
<td>Peak performance (also considering GC)</td>
<td style="text-align: right;">good</td>
<td style="text-align: right;">best</td>
</tr>
<tr class="even">
<td>Java host interoperability</td>
<td style="text-align: right;">needs reflection configuration</td>
<td style="text-align: right;">just works</td>
</tr>
</tbody>
</table>
<h3 id="install-truffleruby">Install TruffleRuby</h3>
<p>Install rbenv:</p>
<pre><code>brew install rbenv</code></pre>
<p>List possible install options:</p>
<pre><code>rbenv install -l     </code></pre>
<p>Install:</p>
<pre><code>rbenv install truffleruby+graalvm-21.0.0  
rbenv local truffleruby+graalvm-21.0.0  </code></pre>
<pre><code>ruby --version
truffleruby 21.0.0, like ruby 2.7.2, GraalVM CE Native [x86_64-darwin]</code></pre>
<p>Set mode to <code>--native</code></p>
<pre><code>ENV TRUFFLERUBYOPT=&#39;--native&#39;</code></pre>
<h2 id="performance-shoot-out">Performance Shoot-out</h2>
TruffleRuby is significantly better in CPU heavy performance tests than JRuby, whose performance is significantly better than MRI Ruby. <a href="https://pragtob.wordpress.com/2020/08/24/the-great-rubykon-benchmark-2020-cruby-vs-jruby-vs-truffleruby/">PragToby</a> has a great breakdown:
<div class="wide">
<figure>
<img src="/blog/assets/images/jruby/2020_relative_speedup.png" alt="Performance of JVM Ruby runtimes in small tests looks good but is it too good to be true?" /><figcaption aria-hidden="true">Performance of JVM Ruby runtimes in small tests looks good but is it too good to be true?</figcaption>
</figure>
</div>
<p>However, in my testing with Jekyll and the Jekyll CI pipeline, JRuby and TruffleRuby are significantly slower than using MRI Ruby. How can this be?</p>
<p>I think there are two reasons for this:</p>
<ol type="1">
<li>Real-World projects like Jekyll involve a lot more code, and JITing that code has a high start-up cost.</li>
<li>Real-world code like Jekyll or Rails is optimized for MRI Ruby, and many of those optimizations don’t help or actively hinder the JVM.</li>
</ol>
<h3 id="failure-of-fork">Failure Of Fork</h3>
<p>The most obvious place where you see this difference is multi-process Ruby programs. The GIL is not an issue across processes and the comparatively fast start time of MRI Ruby is an advantage when forking a new process. On the other hand, JVM Programs are often written in a multi-threading style where code only has to be JIT’d once, and the start-up cost is shared across threads. And in fact, if you ignore language shoot-out games, where everything is a single process and instead compare an MRI multi-process approach to a TruffleRuby multi-threading approach, many advantages of the JVM seem to disappear.</p>
<div class="wide">
<figure>
<img src="/blog/assets/images/jruby/mri_truffle.png" alt="Multi-process MRI Ruby is close in performance to multi-threaded TruffleRuby" /><figcaption aria-hidden="true">Multi-process MRI Ruby is close in performance to multi-threaded TruffleRuby</figcaption>
</figure>
</div>
<p>This chart comes from <a href="https://github.com/eregon">Benoit Daloze</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, the TruffleRuby lead. The benchmark in question is a long-running server-side application using a minimal web framework. It is in the sweet spot of the Graal and TruffleRuby, with little code to JIT and much time to make up for a slow start. But even so, MRIRuby does well.</p>
<p>Which brings me back to my original question: Why is JRuby slow for Jekyll? I do not see similar times but significantly slower times. Jekyll is not forking processes, so that is not the issue. hugo, the static site builder for Go, is <a href="https://forestry.io/blog/hugo-and-jekyll-compared/#performance-1">significantly</a> faster than Jekyll. So we know that Jekyll is not at the limits of hardware where there is simply no more performance to squeeze out.</p>
<h3 id="test-with-rubyspy">Test with RubySpy</h3>
<p>To dig into this, let’s take a look at a flame-graph of the Jekyll build for this blog using RubySpy:</p>
<div class="center">
<table>
<thead>
<tr class="header">
<th>Runtime</th>
<th>Jekyll Build Time for this site</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MRI Ruby 2.7.0</td>
<td>2.64 seconds</td>
</tr>
<tr class="even">
<td>TruffleRuby-dev</td>
<td>25.7 seconds</td>
</tr>
</tbody>
</table>
<figcaption>
This blog is 10x slower to build on TruffleRuby
</figcaption>
</div>
<h4 id="jekyll-test-1">Jekyll Test 1</h4>
<pre><code>sudo RUBYOPT=&#39;-W0&#39; rbspy record -- bundle exec jekyll build --profile</code></pre>
<div class="wide">
<figure>
<img src="/blog/assets/images/jruby/flame-graph.png" alt="A Flame Graph shows most time is File Access" /><figcaption aria-hidden="true">A Flame Graph shows most time is File Access</figcaption>
</figure>
</div>
<p>What we see is that 50% of the wall time was spent in writing files:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write static files, pages, and posts.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns nothing.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">def</span> write</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>      each_site_file <span class="cf">do</span> <span class="kw">|</span>item<span class="kw">|</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        item<span class="at">.write</span>(dest) <span class="cf">if</span> regenerator<span class="at">.regenerate?</span>(item)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      regenerator<span class="at">.write_metadata</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Jekyll</span><span class="kw">::</span><span class="dt">Hooks</span><span class="at">.trigger</span> <span class="wa">:site</span>, <span class="wa">:post_write</span>, <span class="dv">self</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span></code></pre></div>
<p>And 16% of time was spent reading files.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read Site data from disk and load it into internal data structures.</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns nothing.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">def</span> read</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>      reader<span class="at">.read</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>      limit_posts!</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Jekyll</span><span class="kw">::</span><span class="dt">Hooks</span><span class="at">.trigger</span> <span class="wa">:site</span>, <span class="wa">:post_read</span>, <span class="dv">self</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span></code></pre></div>
<p>Overall only 22% of the time was spent doing the actual work of generating HTML:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode ruby"><code class="sourceCode ruby"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Render the site to the destination.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns nothing.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">def</span> render</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>      relative_permalinks_are_deprecated</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>      payload <span class="kw">=</span> site_payload</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Jekyll</span><span class="kw">::</span><span class="dt">Hooks</span><span class="at">.trigger</span> <span class="wa">:site</span>, <span class="wa">:pre_render</span>, <span class="dv">self</span>, payload</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      render_docs(payload)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      render_pages(payload)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Jekyll</span><span class="kw">::</span><span class="dt">Hooks</span><span class="at">.trigger</span> <span class="wa">:site</span>, <span class="wa">:post_render</span>, <span class="dv">self</span>, payload</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span></code></pre></div>
<p>In other words, all the time is spent reading to and from the disk. Clearly, the hugo case shows us this could be faster: we aren’t hitting a hardware limit. Yet why does this run even slower in JRuby and TruffleRuby than it does in MRI Ruby? Let’s try another test.</p>
<h4 id="jekyll-test-2">Jekyll Test 2</h4>
<p>Testing on the build process for another Jekyll site gives similar results timings: TruffleRuby is significantly slower.</p>
<div class="center">
<table>
<thead>
<tr class="header">
<th>Runtime</th>
<th>Jekyll CI Run Time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MRI Ruby 2.7.0</td>
<td>20 seconds</td>
</tr>
<tr class="even">
<td>TruffleRuby-dev</td>
<td>116 seconds</td>
</tr>
</tbody>
</table>
<figcaption>
A larger Jekyll Site
</figcaption>
</div>
<div class="wide">
<figure>
<img src="/blog/assets/images/jruby/flame-graph2.png" alt="This time most of the time is Liquid Template Rendering" /><figcaption aria-hidden="true">This time most of the time is Liquid Template Rendering</figcaption>
</figure>
</div>
<p>This time the flamegraph shows most time is spent with rendering liquid templates rather than IO. I wasn’t able to figure out a way to get a flamegraph out of TruffleRuby.</p>
<p>So what does this mean? My guess is that the filesystem Ruby code or the liquid templates do not benefit from being on the JVM. On the contrary, they seem to run slower.</p>
<p>It might be possible to reimplement <code>write</code> and <code>read</code> to follow JVM high-performance file access best practices, and it might be possible to reimplement liquid templates in a Java native way. That should bring a speed-up, but I’m not sure if that would make JRuby faster than MRI Ruby for Jekyll or only bring it up to a similar performance.</p>
<h2 id="performance-advice">Performance Advice</h2>
<p>All this leaves me with the most generic performance advice: You should test your Ruby codebase with different runtimes and see what works best for you.</p>
<p>If your code is long-running, CPU bound, and thread-based, and if the GIL limits you, TruffleRuby will probably be a win. Also, if that is the case and you tweak your code to use Java concurrent data structures instead of Ruby defaults, you can probably achieve an order of magnitude speed-up. If the garbage collector is a bottleneck for your app, that could also be another reason for trying out a different runtime.</p>
<p>However, if your existing ruby codebase is not CPU bound and not multi-threaded, it will probably run slower on JRuby and Truffle Ruby than with the MRIRuby runtime.</p>
<p>Also, I could be wrong. If I missed something important, then I’d love to hear from you. Here at <a href="http://earthly.dev/">Earthly</a> we take build performance very seriously, so if you have additional suggestions for speeding up Ruby or Jekyll, I’d love to hear them.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<h2 id="updates">Updates</h2>
<section id="update-1" class="no_toc_section">
<h3>Update #1</h3>
</section>
<p>Both <span class="citation" data-cites="ChrisGSeaton">@ChrisGSeaton</span>, the creator of TruffleRuby and <span class="citation" data-cites="headius">@headius</span>, who works on JRuby have responded on <a href="https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/">reddit</a> with suggestions and requests for reproduction steps. I’m going to put together an example to share.</p>
<section id="update-2" class="no_toc_section">
<h3>Update #2</h3>
</section>
<p>The area where JRuby and TruffleRuby shine are long running processes that have had time to warm up. Based on suggestions I put together a repository of a simple small Jekyll build being built 20 times by the same process <a href="https://github.com/agbell/jekyll-perf">here</a>. After 20 builds with the same running process the build times do start to converge, but even after that MRI Ruby is still fastest.</p>
<section id="update-3" class="no_toc_section">
<h3>Update #3</h3>
</section>
<p>I have filed a bug with Truffle Ruby and received some performance advice that I think is worth sharing here:</p>
<section id="some-feedback-on-the-assumptions-of-the-article" class="no_toc_section">
<h4>Some Feedback on The Assumptions of The Article</h4>
</section>
<blockquote>
<p>Hello there, here are some notes on the blog post.</p>
<p>“TruffleRuby is a fork of JRuby”</p>
<p>Technically true from a repository point of view, and that’s what the README says (I’ll update that), but in practice it’s like &gt;90% of code is not from JRuby. It’s quite different technologies.</p>
<p>“hugo, the static site builder for Go, is significantly faster than Jekyll. So we know that Jekyll is not at the limits of hardware where there is simply no more performance to squeeze out.”</p>
<p>I’d bet that’s in part due to a different design. Most likely hugo is better optimized and might do much less work due to different constraints.</p>
<p>“However, if your existing ruby codebase is not CPU bound and not multi-threaded, it will probably run slower on JRuby and TruffleRuby than with the MRI Ruby runtime.”</p>
<p>I think there is no such simple rule and also there is the question of “not CPU bound” is how much time spent in the kernel. TruffleRuby can be faster on many Ruby workloads, as long as there is Ruby code to run, there is potential for optimization. Of course if 90% is spent in read/write system calls, only 10% of it can be optimized by a Ruby implementation, but I would expect that’s pretty rare.</p>
<p>The main thing I think is if it’s not almost entirely IO-bound, then there is potential to speed up. And the only way to know for sure is to try it, as you say.</p>
<p>“I’d especially love to hear how to get a flame graph out of TruffleRuby”</p>
<p>Thank you for the issue at <a href="https://github.com/oracle/truffleruby/issues/2363">https://github.com/oracle/truffleruby/issues/2363</a>. Currently TruffleRuby has multiple Ruby-level profilers (<code>--cpusampler</code>, VisualVM, Chrome Inspector). We’re working on having an easy way to get a flamegraph (right now we use this but one needs to clone the TruffleRuby repository which is less convenient). Java-level profiling is also possible via VisualVM. async-profiler needs something like JDK&gt;=15 to work properly with Graal compilations IIRC.</p>
<p><a href="https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/gzqxexa/?context=3">eregontp on reddit</a></p>
</blockquote>
<section id="some-advice-for-making-ruby-single-process" class="no_toc_section">
<h4>Some Advice for Making Ruby Single Process</h4>
</section>
<blockquote>
<p>Your simplest answer for both JRuby and TruffleRuby would be to set it up to use a single process to do everything. In JRuby, it is trivial to start up a separate, isolated JRuby instance within the same process:</p>
<pre><code>my_jruby = org.jruby.Ruby.new_instance
my_jruby.eval_script(ruby_code)</code></pre>
<p>The code given will run in the same process but a completely different JRuby environment. This can be adapted to run your “subprocesses” without starting a fresh JVM every time.</p>
<p>TruffleRuby likely has something similar based on GraalVM polyglot APIs.</p>
<p>If you managed to get your CI run to use a single process, I would be surprised if it was not as fast or faster than standard C-based Ruby.</p>
<p><a href="https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/gzjh5kt/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">headius on reddit</a></p>
</blockquote>
<p>Note: The article does cover <code>--dev</code> and I did put together a single process <a href="https://github.com/agbell/jekyll-perf">example</a> in update 2. The results are way better, but still slower.</p>
<section id="using-application-class-data-sharing" class="no_toc_section">
<h4>Using Application Class Data Sharing</h4>
</section>
<blockquote>
<p>AppCDS is a way to significantly improve startup speed without impacting total runtime performance. It’d be interesting to see if employing that helps with performance. <a href="https://medium.com/@toparvion/appcds-for-spring-boot-applications-first-contact-6216db6a4194" class="uri">https://medium.com/@toparvion/appcds-for-spring-boot-applications-first-contact-6216db6a4194</a></p>
<p>Finally, if you can, I’d be interested to see what happens if you work from a RAMDisk rather than the HD. I imagine the IO problems you were likely seeing is due to a lot of back and forth communication between the app and the disk, what happens if you kill that off?</p>
<p><a href="https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/gzj1d3j/?utm_source=reddit&amp;utm_medium=web2x&amp;context=3">cogman on reddit</a></p>
</blockquote>
<p>The feedback from the JRuby and TruffleRuby people has been amazing. They have been offering suggestions and asking for tickets and reproduction steps. These are ambitious projects that keep improving and I’m excited to hear that making Jekyll run faster than it does on CRuby is very possible with some additional elbow grease.</p>
<h2 id="more-resources">More Resources</h2>
<ul>
<li><a href="https://pragtob.wordpress.com/2020/08/24/the-great-rubykon-benchmark-2020-cruby-vs-jruby-vs-truffleruby/">CRuby VS JRuby VS TruffleRuby</a></li>
<li><a href="https://github.com/oracle/truffleruby/blob/master/README.md">Truffle Ruby</a></li>
<li><a href="https://www.youtube.com/watch?v=281YdMYRAsk">Running Rack and Rails Faster with TruffleRuby</a></li>
</ul>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>The work behind JRuby, TruffleRuby, and especially GraalVM is terrific. The TruffleRuby benchmark numbers for CPU heavy work continue to improve year upon year. I’m not trying to dunk on the great work done, merely trying to investigate the numbers I am seeing.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>I’d especially love to hear how to get a flame graph out of TruffleRuby. I didn’t get anywhere getting <a href="https://github.com/jvm-profiling-tools/async-profiler">async-profiler</a> to attach.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

        
      </section>

      


<div itemscope itemtype="https://schema.org/Person">
  <!-- <h5>About The Author</h5> -->

  
    <div class="author__avatar">
      
        <picture class="image-author"><source srcset="/blog/generated/assets/images/authors/adamgordonbell-240-fc29677ee.webp 240w" type="image/webp"><source srcset="/blog/generated/assets/images/authors/adamgordonbell-240-ad4309f1a.png 240w" type="image/png"><img src="/blog/generated/assets/images/authors/adamgordonbell-240-ad4309f1a.png" alt="Adam Gordon Bell %"></picture>

      
    </div>
  

  <div class="author__content">
    
      <h4 class="author__name" itemprop="name">Adam Gordon Bell</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Spreading the word about open source builds at Earthly. Host of CoRecursive podcast. Physical Embodiment of Cunningham’s Law</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <!-- <button class="btn btn--inverse">Follow</button> -->
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

      <footer class="page__meta">
        
        



  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/categories/tutorial" class="page__taxonomy-item" rel="tag">Tutorial</a>
    
    </span>
  </p>



        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-05-26T00:00:00-04:00">May 26, 2021</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blog/backward-and-forward-compatibility/" class="pagination--pager" title="Protocol Buffers Best Practices for Backward and Forward Compatibility
">Previous</a>
    
    
      <a href="/blog/achieving-repeatability/" class="pagination--pager" title="Achieving Repeatability in Continuous Integration
">Next</a>
    
  </nav>

    </div>
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          










<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <picture><source srcset="/blog/generated/assets/images/example/teaser-600-fc9eab451.webp 600w, /blog/generated/assets/images/example/teaser-800-fc9eab451.webp 800w" type="image/webp"><source srcset="/blog/generated/assets/images/example/teaser-600-b449882ef.jpg 600w, /blog/generated/assets/images/example/teaser-800-b449882ef.jpg 800w" type="image/jpeg"><img src="/blog/generated/assets/images/example/teaser-800-b449882ef.jpg"></picture>

      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/example/" rel="permalink">Example Post
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

This post is in the future, and won’t show up in the published site

</p>
  </article>
</div>

        
          










<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <picture><source srcset="/blog/generated/assets/images/default-teaser-600-aae60f084.webp 600w, /blog/generated/assets/images/default-teaser-800-aae60f084.webp 800w" type="image/webp"><source srcset="/blog/generated/assets/images/default-teaser-600-495449b49.jpg 600w, /blog/generated/assets/images/default-teaser-800-495449b49.jpg 800w" type="image/jpeg"><img src="/blog/generated/assets/images/default-teaser-800-495449b49.jpg"></picture>

      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/example-plot/" rel="permalink">Example Graphs
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
You can embedded graphs into the markdown like this:

</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/earthlytech" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/earthly/earthly" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 <a href="https://earthly.dev/">Earthly</a>. </div>

      </footer>
    </div>

    <script src="/blog/assets/js/vendor/jquery/jquery-3.5.1.js"></script>
<script src="/blog/assets/js/plugins/jquery.fitvids.js"></script>
<script src="/blog/assets/js/plugins/smooth-scroll.js"></script>
<script src="/blog/assets/js/plugins/gumshoe.js"></script>
<script src="/blog/assets/js/plugins/jquery.magnific-popup.js"></script>
<script src="/blog/assets/js/main.min.js"></script>

  <script> // minified version of https://earthly.dev/assets/js/analytics.js
    function setCookie(e,t,r){var i="";if(r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),i="; expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+i+"; path=/"}function getCookie(e){for(var t=e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var o=r[i];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null}function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function getAnalyticCookie(){cookieName="earthlyID";var e=getCookie(cookieName);return null==e&&(e=uuidv4()),setCookie(cookieName,e,36500),e}jQuery.ajax({type:"POST",url:"https://api.earthly.dev/analytics",data:JSON.stringify({key:"website",url:window.location.href,referrer:document.referrer,earthlyID:getAnalyticCookie()})});
</script>




  </body>
</html>

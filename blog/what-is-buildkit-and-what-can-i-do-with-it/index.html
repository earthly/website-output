<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<link rel="icon" type="image/png" href="/blog/assets/images/favicon.png">
<!-- begin _includes/seo.html --><title>What is Buildkit? - Earthly</title>
<meta name="description" content="There is an excellent open-source project that you have probably used without realizing it. It‚Äôs called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn‚Äôt just build Docker images; it can build OCI images and several other output formats. OpenFasS uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.">


  <meta name="author" content="Adam Gordon Bell">
  
  <meta property="article:author" content="Adam Gordon Bell">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Earthly">
<meta property="og:title" content="What is Buildkit?">
<meta property="og:url" content="https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/">


  <meta property="og:description" content="There is an excellent open-source project that you have probably used without realizing it. It‚Äôs called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn‚Äôt just build Docker images; it can build OCI images and several other output formats. OpenFasS uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.">





  <meta name="twitter:site" content="@EarthlyTech">
  <meta name="twitter:title" content="What is Buildkit?">
  <meta name="twitter:description" content="There is an excellent open-source project that you have probably used without realizing it. It‚Äôs called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn‚Äôt just build Docker images; it can build OCI images and several other output formats. OpenFasS uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.">
  <meta name="twitter:url" content="https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/">

  
    <meta name="twitter:card" content="summary">
    
  

  



  <meta property="article:published_time" content="2021-02-19T00:00:00-05:00">



  <meta property="article:modified_time" content="2021-03-29T00:00:00-04:00">



  

  


<link rel="canonical" href="https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Earthly",
      "url": "https://earthly.dev/blog/",
      "sameAs": ["https://twitter.com/mmistakes","https://www.facebook.com/michaelrose"]
    
  }
</script>






<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Earthly Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161831101-4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161831101-4');
  gtag('config', 'UA-161831101-5', {
    'linker': {
      'domains': ['blog.earthly.dev']
    },
  });
</script>
  <!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '259843109045285');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=259843109045285&ev=PageView&noscript=1"
    />
</noscript>
 <!-- End Facebook Pixel Code -->
  <script>
  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var key=analytics.methods[e];analytics[key]=analytics.factory(key)}analytics.load=function(key,e){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);analytics._loadOptions=e};analytics.SNIPPET_VERSION="4.13.1";
  analytics.load("ZNzktfRyL0ihBWdbb6JjGv5L06hA9izj");
  analytics.page();
  }}();
</script>
  <!-- Twitter universal website tag code -->
<script>
  !function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
  },s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
  a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
  // Insert Twitter Pixel ID and Standard Event data below
  twq('init','o5s6p');
  twq('track','PageView');
  </script>
  <!-- End Twitter universal website tag code -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/blog/"><img src="/blog/assets/images/logo.png" alt="Earthly"></a>
        
        <a class="site-title" href="/blog/">
          Earthly
          <span class="site-subtitle">Better Builds.</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/">Home</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/articles/">Articles</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/news/">News</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/tutorials/">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/earthly/earthly">GitHub</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  







<div class="page__hero"
  style=" background-image: url('');"
>
  
      <picture class="page__hero-image"><source srcset="/blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-400-a2e045280.webp 400w, /blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-600-a2e045280.webp 600w, /blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-800-a2e045280.webp 800w, /blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-1000-a2e045280.webp 1000w" type="image/webp"><source srcset="/blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-400-a2e045280.jpg 400w, /blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-600-a2e045280.jpg 600w, /blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-800-a2e045280.jpg 800w, /blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-1000-a2e045280.jpg 1000w" type="image/jpeg"><img src="/blog/generated/assets/images/what-is-buildkit-and-what-can-i-do-with-it/header-800-a2e045280.jpg" alt="What is Buildkit?"></picture>

  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="What is Buildkit?">
    <meta itemprop="description" content="There is an excellent open-source project that you have probably used without realizing it. It‚Äôs called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn‚Äôt just build Docker images; it can build OCI images and several other output formats. OpenFasS uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.">
    <meta itemprop="datePublished" content="2021-02-19T00:00:00-05:00">
    <meta itemprop="dateModified" content="2021-03-29T00:00:00-04:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">What is Buildkit?
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          10 minute read
        
        
        &nbsp;	&nbsp;<i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-03-29">March 29, 2021</time>
        

      </span>
    
    <span>
      
      
      
      <div class="author__avatar_top">
          <img src="/blog/assets/images/authors/adamgordonbell.png" alt="Adam Gordon Bell" itemprop="image">&nbsp;	&nbsp;
          Adam Gordon Bell
      </div>
      
    </span>
  </p>


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#history">History</a></li><li><a href="#install-buildkit">Install BuildKit</a><ul><li><a href="#buildctl">buildctl</a></li><li><a href="#buildkitd">buildkitd</a></li></ul></li></ul></li><li><a href="#building-an-image">Building an Image</a></li><li><a href="#tangent-where-are-froms-from">Tangent: Where are `FROM‚Äôs from</a></li><li><a href="#watching-it-build">Watching It Build</a><ul><li><a href="#what-is-runc">What is runc</a></li></ul></li><li><a href="#how-to-see-docker-processes-on-macos-and-windows">How to see Docker Processes on macOS and Windows</a></li><li><a href="#what-is-in-from-scratch">What is in FROM scratch</a></li><li><a href="#conclusion">Conclusion</a></li></ul>

            </nav>
          </aside>
        
        <p>There is an excellent open-source project that you have probably used without realizing it. It‚Äôs called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn‚Äôt just build Docker images; it can build OCI images and several other output formats. <a href="https://www.openfaas.com/">OpenFasS</a> uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.</p>
<p>You may not know you‚Äôve used BuildKit because other applications wrap it. Modern versions of <code>docker build</code> can use BuildKit and it will soon be enabled by default. Today let‚Äôs look at how to use BuildKit directly.</p>
<h2 id="history">History</h2>
<blockquote>
<p>BuildKit is a new project under the Moby umbrella for building and packaging software using containers. It‚Äôs a new codebase meant to replace the internals of the current build features in the Moby Engine. - <a href="https://blog.mobyproject.org/introducing-buildkit-17e056cc5317">Introducing BuildKit</a></p>
</blockquote>
<p>T√µnis Tiigi, a Docker employee and BuildKit‚Äôs primary developer, created BuildKit to separate the logic of building images from the main moby project and to enable future development. BuildKit has support for pluggable frontends, which allow it to make more than just docker images using dockerfiles. With BuildKit, we can substitute the dockerfile syntax for <a href="https://github.com/openllb/hlb">hlb</a> and replace the docker image format for a pure tar file output. That is just one of the possible combinations BuildKit, with its pluggable backends and frontends, unlocks.</p>
<figure>
<img src="/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/1.gif" alt="animation of buildctl building a dockerfile" /><figcaption aria-hidden="true">animation of buildctl building a dockerfile</figcaption>
</figure>
<p>The original BuildKit proposal is found in the moby project:</p>
<blockquote>
<p>‚ÄúBuildkit is a proposal to separate out docker build experience into a separate project, allowing different users to collaborate on the underlying technology and reuse and customize it in different ways.‚Äù</p>
</blockquote>
<blockquote>
<p>‚ÄúOne of the main design goals of BuildKit is to separate frontend and backend concerns during a build process‚Äù - <a href="https://github.com/moby/moby/issues/32925">Intial BuildKit Proposal</a></p>
</blockquote>
<h2 id="install-buildkit">Install BuildKit</h2>
<h4 id="buildctl">buildctl</h4>
<p>BuildKit has two primary components: buildctl and buildkitd. buildctl is the BuildKit controller, and it communicates with <code>buildkitd</code>. Though designed for Linux, it can run on macOS and Windows under WSL2.</p>
<p>On macOS, you can install buildctl with brew.</p>
<pre><code>brew install buildkit</code></pre>
<p>On Linux and Windows, grab a release from <a href="https://github.com/moby/buildkit/releases">Github</a>.</p>
<p>Afterward, you should be able to call buildctl</p>
<pre><code>‚ûú  ~ buildctl
NAME:
   buildctl - build utility

USAGE:
   buildctl [global options] command [command options] [arguments...]

VERSION:
   0.8.1

COMMANDS:
   du        disk usage
   prune     clean up build cache
   build, b  build
   debug     debug utilities
   help, h   Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --debug                enable debug output in logs
   --addr value           buildkitd address (default: &quot;unix:///run/buildkit/buildkitd.sock&quot;)
   --tlsservername value  buildkitd server name for certificate validation
   --tlscacert value      CA certificate for validation
   --tlscert value        client certificate
   --tlskey value         client key
   --tlsdir value         directory containing CA certificate, client certificate, and client key
   --timeout value        timeout backend connection after value seconds (default: 5)
   --help, -h             show help
   --version, -v          print the version</code></pre>
<p><em><strong>Other Tools</strong>: In this guide, we will use <a href="https://linux.die.net/man/1/pstree">pstree</a>, <a href="https://github.com/Canop/broot">br</a>, and <a href="blog.earthly.dev/mitmproxy/">mitmproxy</a>. They are not required to use BuildKit or to follow this guide, but they help us demonstrate how BuildKit works.</em></p>
<h4 id="buildkitd">buildkitd</h4>
<p>buildkitd does the actual work of transforming a build definition into some output. It is designed to be a long-running process. It also isn‚Äôt possible to run it on macOS or Windows. For this tutorial, we will run it as a docker container. That will work regardless of your host OS.</p>
<pre><code>‚ûú docker run --rm --privileged -d --name buildkit moby/buildkit
Unable to find image &#39;moby/buildkit:latest&#39; locally
latest: Pulling from moby/buildkit
05e7bc50f07f: Already exists 
d7d1da19a5ee: Already exists 
10f8f68c5adb: Already exists 
00d21c774e02: Already exists 
Digest: sha256:ecd5ad4910c322cad6995f8a1a0805d9da4b09ed4aaef40627f5bcb8ebf74068
Status: Downloaded newer image for moby/buildkit:latest
6c4342639e07eedc16ba2f5d9f91fb2f82e1793cdea73aec1725e6652cab315a

‚ûú docker ps
CONTAINER ID   IMAGE           COMMAND       CREATED          STATUS          PORTS     NAMES
6c4342639e07   moby/buildkit &quot;buildkitd&quot; 45 seconds ago   Up 43 seconds             buildkit</code></pre>
<p>We also need to tell buildctl where to find buildkitd:</p>
<pre><code>export BUILDKIT_HOST=docker-container://buildkit</code></pre>
<p><em>On Linux, you can substitute these steps with just running <code>buildkitd</code> to avoid the container.</em></p>
<h2 id="building-an-image">Building an Image</h2>
<p>Now that we have all dependencies we need, let‚Äôs build an image using BuildKit:</p>
<pre><code>cat .\DockerFile
FROM alpine
RUN echo &quot;built with BuildKit!&quot; &gt;  file
CMD [&quot;/bin/sh&quot;]</code></pre>
<pre><code>‚ûúbuildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=.
[+] Building 1.4s (5/5) FINISHED                               
 =&gt; [internal] load build definition from Dockerfile      0.0s
 =&gt; =&gt; transferring dockerfile: 453B                      0.0s
 =&gt; [internal] load .dockerignore                         0.0s
 =&gt; =&gt; transferring context: 2B                           0.0s
 =&gt; [internal] load metadata for docker.io/library/alpin  1.3s
 =&gt; [auth] library/alpine:pull token for registry-1.dock  0.0s
 =&gt; [1/2] FROM docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&gt; =&gt; resolve docker.io/library/alpine@sha256:08d6ca16c  0.0s
  =&gt; [2/2] RUN echo &quot;built with buildkit!&quot; &gt;  file   </code></pre>
<p>We have built the image, but we haven‚Äôt given it a name nor told BuildKit what to do with it.</p>
<p>By default, the build result will remain internal to BuildKit. An output type needs to be specified to retrieve the result. Let‚Äôs specify a docker hub account that we have permission to push to:</p>
<pre><code>‚ûú buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=image,name=docker.io/agbell/test,push=true
[+] Building 2.9s (8/8) FINISHED                               
 =&gt; [internal] load build definition from Dockerfile      0.0s
 =&gt; =&gt; transferring dockerfile: 32B                       0.0s
 =&gt; [internal] load .dockerignore                         0.0s
 =&gt; =&gt; transferring context: 2B                           0.0s
 =&gt; [internal] load metadata for docker.io/library/alpin  0.7s
 =&gt; [auth] library/alpine:pull token for registry-1.dock  0.0s
 =&gt; [1/1] FROM docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&gt; =&gt; resolve docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&gt; [2/2] RUN echo &quot;built with buildkit!&quot; &gt;  file 
 =&gt; exporting to image                                    2.2s
 =&gt; =&gt; exporting layers                                   0.0s
 =&gt; =&gt; exporting manifest sha256:a81d7671b5ceeb534739c95  0.0s
 =&gt; =&gt; exporting config sha256:4c8c89bca725572cf9ff3bd6a  0.0s</code></pre>
<p>After that, we can pull it and run it:</p>
<pre><code>‚ûú docker run -it agbell/test
/ # cat file
built with BuildKit!</code></pre>
<h2 id="tangent-where-are-froms-from">Tangent: Where are `FROM‚Äôs from</h2>
<p>If we have an image locally on our machine, can we use it in a <code>FROM</code> to build something based on it? Let‚Äôs find out by altering our <code>FROM</code> to use a local image:</p>
<pre><code>FROM agbell/test:local
RUN echo &quot;BuildKit built&quot;&gt;  file
CMD [&quot;/bin/sh&quot;] 
</code></pre>
<pre><code>&gt; docker tag alpine agbell/test:local
&gt; buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
------
 &gt; [internal] load metadata for docker.io/agbell/test:local:
------
error: failed to solve: rpc error: code = Unknown desc = failed to solve with frontend dockerfile.v0: failed to create LLB definition: docker.io/agbell/test:local: not found
</code></pre>
<p>It doesn‚Äôt work. It looks like it is trying to fetch the image from docker.io, the default docker hub registry.</p>
<p>We can verify this by quickly <a href="blog.earthly.dev/mitmproxy/">capturing requests</a> from buildkitd:</p>
<pre><code>‚ûú cat ~\Dockerfile
FROM moby/buildkit 
RUN apk update &amp;&amp; apk add curl
WORKDIR /usr/local/share/ca-certificates
COPY mitmproxy.crt mitmproxy.crt
RUN update-ca-certificates
‚ûú docker build . -t buildkit:mitm
 ...
‚ûú docker run --rm --privileged -d --name buildkit buildkit:mitm
6676dc0109eb3f5f09f7380d697005b6aae401bb72a4ee366f0bb279c0be137b</code></pre>
<figure>
<img src="/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/2.png" alt="404 on mitm proxy" /><figcaption aria-hidden="true">404 on mitm proxy</figcaption>
</figure>
<p>We can see a <code>404</code>, and this confirms buildkitd is expecting registry that it can access over the network using the docker registry v2 api.</p>
<h2 id="watching-it-build">Watching It Build</h2>
<p>Buildkitd is responsible for building the image, but <code>runc</code> does the actual execution of each step. runc executes each <code>RUN</code> command in your dockerfile in a separate process. runc requires Linux kernel 5.2 or later with support for cgroups, and is why buildkitd can‚Äôt run natively on macOS or Windows.</p>
<h3 id="what-is-runc">What is runc</h3>
<blockquote>
<p>‚ÄúPlease note that runc is a low-level tool not designed with an end-user in mind. It is mostly employed by other higher-level container software. Therefore, unless there is some specific use case that prevents the use of tools like Docker or Podman, it is not recommended to use runc directly.‚Äù - <a href="https://github.com/opencontainers/runc">runc readme</a></p>
</blockquote>
<p>We can watch the execution of our build by using <code>pstree</code> and <code>watch</code>. Open two side by side terminals, run <code>docker exec -it buildkit "/bin/watch" "-n1" "pstree -p"</code> in one and call <code>buildctl build ...</code> in the other. You will see <code>buildkitd</code> start a <code>buildkit-runc</code> process and then a separate process for each <code>RUN</code> command.</p>
<figure>
<img src="/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/3.png" alt="Diagram of buildkit running and pstree showing the process tree of buildkitd" /><figcaption aria-hidden="true">Diagram of buildkit running and pstree showing the process tree of buildkitd</figcaption>
</figure>
<h2 id="how-to-see-docker-processes-on-macos-and-windows">How to see Docker Processes on macOS and Windows</h2>
<p>On macOS and Windows, Docker processes run on a separate virtual machine (VM). If you‚Äôre using the default and recommended Docker Desktop, this VM is the Linux container host.</p>
<p><em>Note: Docker Machine is an earlier approach to running Docker on macOS and Windows where the Docker VM runs in VirtualBox or VMware. Docker Machine steps may differ.</em></p>
<p>The above <code>exec</code> trick lets us see the processes inside a specific container, but to see all the processes running across all the containers, we need a different technique. To do that, we can use <code>docker run</code> and <code>nsenter</code>:</p>
<pre><code>docker run -it --rm --privileged --pid=host ubuntu nsenter -t 1 -m -u -n -i s</code></pre>
<p>We can now use <code>watch</code> and <code>pstree</code> to view the whole container host in a single view:</p>
<pre><code>docker-desktop:/# pstree -p
init(1)-+-containerd(983)
        |-containerd-shim(1018)---acpid(1039)
        |-containerd-shim(1064)---diagnosticsd(1085)---sh(1354)
        |-containerd-shim(1109)-+-containerd-shim(2495)-+-buildkitd(2522)
        |                       |                       `-sh(2614)---watch(2903)
        |                       |-containerd-shim(4035)---sh(4062)---pstree(5058)
        |                       |-docker-init(1136)---entrypoint.sh(1154)---logwrite(1183)---lifecycle-serve(1188)-+-logwrite(1340)---containerd(1345)
        |                       |                                                                                  |-logwrite(1550)---dockerd(1555)
        |                       |                                                                                  `-logwrite(1800)
        |                       |-rpc.statd(1293)
        |                       `-rpcbind(1265)
        |-containerd-shim(1162)---host-timesync-d(1199)
        |-containerd-shim(1245)---kmsg(1282)
        |-containerd-shim(1310)---start(1347)---sntpc(1397)
        |-containerd-shim(1374)
        |-containerd-shim(1433)---trim-after-dele(1460)
        |-containerd-shim(1483)---vpnkit-forwarde(1517)
        |-memlogd(442)
        |-rungetty.sh(429)---login(431)---sh(443)
        |-rungetty.sh(432)---login(433)---sh(437)
        `-vpnkit-bridge(452)</code></pre>
<p>We can use pstree with a process id (pid) while a build is running to focus on just the buildkitd tree:</p>
<pre><code>docker-desktop:/# watch -n 1 pstree -p 2522 </code></pre>
<h1 id="buildkit-output-types">BuildKit Output Types</h1>
<p>So far, we have only used <code>output type=image,</code> but BuildKit supports several types of outputs.</p>
<p>We can output a tar:</p>
<pre><code>buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=tar,dest=out.tar
 =&gt; [internal] load build definition from Dockerfile      0.0s
 =&gt; =&gt; transferring dockerfile: 31B                       0.0s
 =&gt; [internal] load .dockerignore                         0.0s
 =&gt; =&gt; transferring context: 2B                           0.0s
...
 =&gt; exporting to client                                   2.6s
 =&gt; =&gt; sending tarball                                    2.6s</code></pre>
<pre><code>&gt; ls *.tar
 out.tar</code></pre>
<p>And if we try to load it as a docker image, it will fail:</p>
<pre><code>&gt; docker load &lt; out.tar
open /var/lib/docker/tmp/docker-import-013443725/bin/json: no such file or directory</code></pre>
<p>This tag isn‚Äôt an image of any sort. There are no layers or manifests, just the full filesystem that the built image would contain.</p>
<p>We can also export directly to the local filesystem:</p>
<pre><code>buildctl build --frontend dockerfile.v0 --local context=. --local dockerfile=. --output type=local,dest=output   
[+] Building 2.6s (10/10) FINISHED                             
 =&gt; [internal] load build definition from Dockerfile      0.0s
 =&gt; =&gt; transferring dockerfile: 31B                       0.0s
 =&gt; [internal] load .dockerignore                         0.0s
 =&gt; =&gt; transferring context: 2B                           0.0s
 =&gt; [internal] load metadata for docker.io/library/alpin  0.6s
 =&gt; [auth] library/alpine:pull token for registry-1.dock  0.0s
 =&gt; [1/5] FROM docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&gt; =&gt; resolve docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&gt; CACHED [2/5] RUN apk update                           0.0s
 =&gt; CACHED [3/5] RUN apk upgrade                          0.0s
 =&gt; CACHED [4/5] RUN apk add gcc                          0.0s
 =&gt; CACHED [5/5] RUN sleep 1                              0.0s
 =&gt; exporting to client                                   1.9s
 =&gt; =&gt; copying files 121.14MB                             1.9sr</code></pre>
<p>This filesystem output could be useful if we were trying to trim our image down. We could look through the output and find things to remove and use a multi-stage build to remove them. <a href="https://github.com/Canop/broot">broot</a> is pretty handy for this:</p>
<figure>
<img src="/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/4.png" alt="tree view of alpine image showing space used in each directory" /><figcaption aria-hidden="true">tree view of alpine image showing space used in each directory</figcaption>
</figure>
<h2 id="what-is-in-from-scratch">What is in <code>FROM scratch</code></h2>
<p>One thing we can do with our newfound powers is investigate the <code>scratch</code> keyword. The scratch keyword doesn‚Äôt correspond to an actual image. We can‚Äôt run it:</p>
<pre><code>docker run scratch
Unable to find image&#39; scratch:latest&#39; locally
docker: Error response from daemon: &#39;scratch&#39; is a reserved name.</code></pre>
<p>However, does it actually contain anything? Is a <code>FROM scratch</code> image literally empty or are there certain required elements of unix filesystem that <code>scratch</code> provides? Let‚Äôs find out:</p>
<pre><code>&gt; mkdir scratch
&gt; cat .\Dockerfile
FROM scratch
&gt; buildctl build --frontend dockerfile.v0 --local context=. --local dockerfile=. --output type=local,dest=scratch
[+] Building 0.1s (3/3) FINISHED                               
 =&gt; [internal] load build definition from Dockerfile      0.0s
 =&gt; =&gt; transferring dockerfile: 31B                       0.0s
 =&gt; [internal] load .dockerignore                         0.0s
 =&gt; =&gt; transferring context: 2B                           0.0s
 =&gt; exporting to client                                   0.0s
 =&gt; =&gt; copying files                                      0.0s
 &gt; ls scratch
 &gt; br -s scratch
 0 ./output</code></pre>
<p>It‚Äôs empty! The scratch keyword indicates a completely empty docker layer. The more you know! <em>(The more you know is a trademark of The National Broadcasting Company, who in no way endorse this article üòÄ )</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>Alright, we have now covered some ways to use BuildKit directly. BuildKit is used internally by <code>docker build</code> in modern docker versions, but using it directly unlocks some extra options.</p>
<p>One use we covered was changing the output type. We can use BuildKit to export tars and local file systems. We also use <code>pstree</code> and <code>mitmProxy</code> to watch how buildkitd forks processes and make network requests.</p>
<p>There is much more to learn, though. BuildKit is behind the <code>docker buildx</code> multiplatform build feature and supports the ability to have multiple workers execute builds in parallel. BuildKit also supports caching, different frontends, docker-compose builds, faster multi-stage builds, and several other features.</p>
<p>In a future article, we will cover creating a custom frontend and leaving the Dockerfile syntax behind.</p>

        
      </section>

      


<div itemscope itemtype="https://schema.org/Person">
  <h5>About The Author</h5>

  
    <div class="author__avatar">
      
        <img src="/blog/assets/images/authors/adamgordonbell.png" alt="Adam Gordon Bell" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Adam Gordon Bell</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Spreading the word about open source builds at Earthly. Host of CoRecursive podcast.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

      <footer class="page__meta">
        
        



  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/categories/tutorials" class="page__taxonomy-item" rel="tag">Tutorials</a>
    
    </span>
  </p>



        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-03-29">March 29, 2021</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blog/mitmproxy/" class="pagination--pager" title="How to Man in the Middle HTTPS Using mitmproxy
">Previous</a>
    
    
      <a href="/blog/intercal-yaml-and-other-horrible-programming-languages/" class="pagination--pager" title="INTERCAL, YAML, And Other Horrible Programming Languages
">Next</a>
    
  </nav>

    </div>
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          











<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <picture><source srcset="/blog/generated/assets/images/default-teaser-245-f6e40bbee.webp 245w" type="image/webp"><source srcset="/blog/generated/assets/images/default-teaser-245-f6e40bbee.jpg 245w" type="image/jpeg"><img src="/blog/generated/assets/images/default-teaser-800-f6e40bbee.jpg"></picture>

      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/slow-performance-in-jenkins/" rel="permalink">Addressing Slow Performance in Jenkins
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
There‚Äôs nothing more frustrating than a sluggish continuous integration system. It slows down feedback loops and prevents code from reaching production quic...</p>
  </article>
</div>

        
          











<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <picture><source srcset="/blog/generated/assets/images/default-teaser-245-f6e40bbee.webp 245w" type="image/webp"><source srcset="/blog/generated/assets/images/default-teaser-245-f6e40bbee.jpg 245w" type="image/jpeg"><img src="/blog/generated/assets/images/default-teaser-800-f6e40bbee.jpg"></picture>

      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/understanding-bash/" rel="permalink">Understanding Bash
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
Bash scripts give you the ability to turn a tedious series of commands into an easily runnable and repeatable script. With many real-world use cases, like u...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/earthlytech" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/earthly/earthly" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 <a href="http://earthly.dev/">Earthly</a>. </div>

      </footer>
    </div>

    <script src="/blog/assets/js/main.min.js"></script>

  <script> // minified version of http://earthly.dev/assets/js/analytics.js
    function setCookie(e,t,r){var i="";if(r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),i="; expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+i+"; path=/"}function getCookie(e){for(var t=e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var o=r[i];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null}function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function getAnalyticCookie(){cookieName="earthlyID";var e=getCookie(cookieName);return null==e&&(e=uuidv4()),setCookie(cookieName,e,36500),e}jQuery.ajax({type:"POST",url:"https://api.earthly.dev/analytics",data:JSON.stringify({key:"website",url:window.location.href,referrer:document.referrer,earthlyID:getAnalyticCookie()})});
</script>




  </body>
</html>

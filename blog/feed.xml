<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="https://earthly.dev/blog/feed.xml" rel="self" type="application/atom+xml" /><link href="https://earthly.dev/blog/" rel="alternate" type="text/html" /><updated>2021-04-08T18:48:14-04:00</updated><id>https://earthly.dev/blog/feed.xml</id><title type="html">Earthly Blog</title><subtitle>Build automation for the container era.</subtitle><entry><title type="html">Understanding Bash</title><link href="https://earthly.dev/blog/understanding-bash/" rel="alternate" type="text/html" title="Understanding Bash" /><published>2021-04-01T00:00:00-04:00</published><updated>2021-04-01T00:00:00-04:00</updated><id>https://earthly.dev/blog/understanding-bash</id><content type="html" xml:base="https://earthly.dev/blog/understanding-bash/">&lt;p&gt;Bash scripts give you the ability to turn a tedious series of commands into an easily runnable and repeatable script. With many real-world use cases, like using a bash script to run a continuous deployment process, create a series of files in a folder, or download the contents of several URLs, it’s worth your time to make sure bash scripting is in your programming toolbox.&lt;/p&gt;
&lt;p&gt;When you’re done with this article, you’ll not only be able to write bash scripts, but you’ll be able to write them using today’s accepted best practices.&lt;/p&gt;
&lt;h2 id=&quot;use-the-right-shebang&quot;&gt;Use the Right Shebang&lt;/h2&gt;
&lt;p&gt;The very first thing you’ll see at the top of every (well-written) bash script is what’s called a &lt;a href=&quot;https://www.in-ulm.de/~mascheck/various/shebang/&quot;&gt;&lt;em&gt;shebang&lt;/em&gt;&lt;/a&gt;. I’ll walk you through a couple of them here.&lt;/p&gt;
&lt;h3 id=&quot;binbash&quot;&gt;#!/bin/bash&lt;/h3&gt;
&lt;p&gt;The most common shebang is the one referring to the &lt;code&gt;bash&lt;/code&gt; executable:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Essentially it tells your terminal that when you run the script it should use &lt;code&gt;bash&lt;/code&gt; to execute it. It can be vital since you may be using a different shell in your machine (&lt;code&gt;zsh&lt;/code&gt;, &lt;code&gt;fish&lt;/code&gt;, &lt;code&gt;sh&lt;/code&gt;, etc.), but you designed the script to work specifically with bash. In many cases, it doesn’t matter what shell you’re using, but there can be some very noteworthy differences in how they work, leading a script to work in &lt;code&gt;bash&lt;/code&gt; but not &lt;code&gt;sh&lt;/code&gt;, for example.&lt;/p&gt;
&lt;h3 id=&quot;userbinenv-bash&quot;&gt;#!/user/bin/env bash&lt;/h3&gt;
&lt;p&gt;If you use the previous shebang, it’s crucial that you give the executable’s absolute path. You should be aware of this since there is an alternative, where you use the &lt;code&gt;bash&lt;/code&gt; executable found in the &lt;code&gt;$PATH&lt;/code&gt;. You can do so by writing:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/user/bin/env bash&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Some people like to customize their systems, either their personal system or production servers, resulting in the &lt;code&gt;bash&lt;/code&gt; executable not being located in &lt;code&gt;/bin/bash&lt;/code&gt; every time. Use the above line if you can’t be sure that the &lt;code&gt;bash&lt;/code&gt; executable will be located in the same path when this script is run.&lt;/p&gt;
&lt;h2 id=&quot;understand-common-sets&quot;&gt;Understand Common Sets&lt;/h2&gt;
&lt;p&gt;When you run a bash script, it will always run in a new &lt;em&gt;subshell&lt;/em&gt;. This means that any unique configurations you have in your current setup will not be used within the script execution. It also means that you can customize the environment that the script is running in without worrying about how your terminal will be affected.&lt;/p&gt;
&lt;p&gt;One way to change this environment is to use the &lt;code&gt;set&lt;/code&gt; command. I’ll go over the four most common ones and where they’re useful. I’ll show the short form for these sets in the examples throughout this article, but keep in mind that there are also long-form versions. I’ll mention those briefly.&lt;/p&gt;
&lt;h3 id=&quot;set--u&quot;&gt;set -u&lt;/h3&gt;
&lt;p&gt;By default, bash doesn’t do a lot of error handling. That’s left up to you. So if you want to have your script exit at a certain point, you have to define it. For example, you may have the following script:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$TEST&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello World&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you run the script as shown above, it’ll give you the following output:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hello&lt;/span&gt; World&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;See how it doesn’t complain that the &lt;code&gt;$TEST&lt;/code&gt; variable is not set? You can change that. Setting the &lt;code&gt;set -u&lt;/code&gt; (short form of &lt;code&gt;set -o nounset&lt;/code&gt;) command initially, you’re telling bash that you want it to fail if a variable is not set.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Script:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-u&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;$TEST&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello World&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Output:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;line&lt;/span&gt; 3: TEST: unbound variable&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Without &lt;code&gt;set -u&lt;/code&gt;, bash will use an empty string instead of the unset variable. When running &lt;code&gt;echo $TEST&lt;/code&gt;, that isn’t too dangerous. However, you may be running a command like &lt;code&gt;rm -rf /$TEST&lt;/code&gt; to define a path you want to delete. In this case, without &lt;code&gt;set -u&lt;/code&gt;, you would end up deleting your entire file system (which there’s no way to recover by default).&lt;/p&gt;
&lt;h3 id=&quot;set--x&quot;&gt;set -x&lt;/h3&gt;
&lt;p&gt;You’ll likely at some point have a big script where it’s tough to keep track of not just which commands are running what, but also which commands are outputting what. This is where &lt;code&gt;set -x&lt;/code&gt; comes to the rescue. Alternatively, you can write this as its long form, &lt;code&gt;set -o xtrace&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;When using &lt;code&gt;set -x&lt;/code&gt;, you get the following script and output.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Script:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-x&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hi&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello World&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Output:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;+&lt;/span&gt; echo Hi&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hi&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;+&lt;/span&gt; echo Hello World&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hello&lt;/span&gt; World&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;set--e&quot;&gt;set -e&lt;/h3&gt;
&lt;p&gt;Sometimes you want to make sure that the entire script fails if one of the commands fails. This is not the default behavior in bash. You can see &lt;a href=&quot;https://www.gnu.org/software/bash/manual/html_node/The-Set-Builtin.html&quot;&gt;here&lt;/a&gt; that without any set options, bash is running without much error handling.&lt;/p&gt;
&lt;p&gt;To make sure the script fails, you should use &lt;code&gt;set -e&lt;/code&gt; (also known as &lt;code&gt;set -o errexit&lt;/code&gt;), probably the most common one.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Script:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-e&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;foo&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello World&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Output:&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;line&lt;/span&gt; 3: foo: command not found&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;set--eo-pipefail&quot;&gt;set -eo pipefail&lt;/h3&gt;
&lt;p&gt;Finally, we can make the script fail if a command in a pipeline fails. Usually, bash only looks for the exit code from the last command in a pipeline. If that’s 0, it’ll continue just fine. Exit code 0 is what we want, since in bash that means success.&lt;/p&gt;
&lt;p&gt;Let’s use the following script as an example:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;foo&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello World&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hi&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;set -eo pipefail&lt;/code&gt; will turn the output from:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hello&lt;/span&gt; World&lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;line&lt;/span&gt; 2: foo: command not found&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hi&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;into:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hello&lt;/span&gt; World&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;line&lt;/span&gt; 2: foo: command not found&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The reason you may want the script to fail if a pipeline fails is the same as earlier with &lt;code&gt;set -u&lt;/code&gt;. Let’s modify the scenario a bit. You have the following in your script:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;va&quot;&gt;FILE_PATH&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; /tmp/path.txt &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sed&lt;/span&gt; ‘s/_/-/g&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-rf&lt;/span&gt; /&lt;span class=&quot;va&quot;&gt;$FILE_PATH&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;Note: &lt;code&gt;sed&lt;/code&gt; is a search-and-replace command. In this case it replaces underscores with dashes.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The intention is that &lt;code&gt;/tmp/path.txt&lt;/code&gt; contains &lt;code&gt;tmp_file.txt&lt;/code&gt;. Assume that the file &lt;code&gt;/tmp-file.txt&lt;/code&gt; exists on the system. In this case the script will work perfectly and delete &lt;code&gt;/tmp-file.txt&lt;/code&gt;. But what if &lt;code&gt;/tmp/path.txt&lt;/code&gt; doesn’t exist? &lt;code&gt;cat /tmp/path.txt&lt;/code&gt; will fail, but the script won’t. Now you’ve deleted your entire filesystem, but &lt;code&gt;set -eo pipefail&lt;/code&gt; will prevent this.&lt;/p&gt;
&lt;h3 id=&quot;sets-in-summary&quot;&gt;Sets in Summary&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Set&lt;/th&gt;
&lt;th&gt;Long form&lt;/th&gt;
&lt;th&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;set -u&lt;/td&gt;
&lt;td&gt;set -o nounset&lt;/td&gt;
&lt;td&gt;Exits script on undefined variables&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;set -x&lt;/td&gt;
&lt;td&gt;set -o xtrace&lt;/td&gt;
&lt;td&gt;Shows command currently executing&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;set -e&lt;/td&gt;
&lt;td&gt;set -o errexit&lt;/td&gt;
&lt;td&gt;Exits script on error&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;set -eo pipefail&lt;/td&gt;
&lt;td&gt;set -eo pipefail&lt;/td&gt;
&lt;td&gt;Exits script on pipeline fail&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h2 id=&quot;use-error-checking-tools&quot;&gt;Use Error Checking Tools&lt;/h2&gt;
&lt;p&gt;Although you may be familiar with all the best practices, it can be tough to remember them all when your script is coming to life. Luckily there are tools available to help, like &lt;a href=&quot;https://www.shellcheck.net/#&quot;&gt;ShellCheck&lt;/a&gt;. ShellCheck has both a browser version and a command-line tool, but for this article, let’s work with the command-line version. You can find &lt;a href=&quot;https://github.com/koalaman/shellcheck#installing&quot;&gt;installation instructions here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We’ll use the following script as an example:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;What&amp;#39;s your name?&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;read&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;NAME&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello &lt;span class=&quot;va&quot;&gt;$NAME&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By saving this in a script in a file called &lt;code&gt;greeting.sh&lt;/code&gt; and running &lt;code&gt;shellcheck greeting.sh&lt;/code&gt;, you get the following output in your terminal:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;In greeting.sh line 1:
echo &amp;quot;What&amp;#39;s your name?&amp;quot;
^-- SC2148: Tips depend on target shell and yours is unknown. Add a shebang or a &amp;#39;shell&amp;#39; directive.


In greeting.sh line 2:
read NAME
^--^ SC2162: read without -r will mangle backslashes.


In greeting.sh line 3:
echo Hello $NAME
           ^---^ SC2086: Double quote to prevent globbing and word splitting.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As you can see, &lt;code&gt;shellcheck&lt;/code&gt; doesn’t just tell you what you need to change, but also why it needs to be changed. This is a valuable resource, not just for improving your scripts, but also to get better at writing them in the first place.&lt;/p&gt;
&lt;p&gt;With these tips, you’ll end up with the following script:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;co&quot;&gt;#!/bin/bash&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-2&quot;&gt;&lt;a href=&quot;#cb17-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; “What’s your name&lt;span class=&quot;pp&quot;&gt;?&lt;/span&gt;”&lt;/span&gt;
&lt;span id=&quot;cb17-3&quot;&gt;&lt;a href=&quot;#cb17-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;read&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-r&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;NAME&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-4&quot;&gt;&lt;a href=&quot;#cb17-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; Hello “&lt;span class=&quot;va&quot;&gt;$NAME&lt;/span&gt;”&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;understand-variable-naming-and-declaration&quot;&gt;Understand Variable Naming and Declaration&lt;/h2&gt;
&lt;p&gt;As you saw earlier, we tried to use the &lt;code&gt;$TEST&lt;/code&gt; variable. Variables can open up a whole world of opportunities, but they can also be tricky to work with. Let’s go over some of the common scenarios for working with variables.&lt;/p&gt;
&lt;h3 id=&quot;assigning-variables&quot;&gt;Assigning Variables&lt;/h3&gt;
&lt;p&gt;Assigning a variable in bash is reasonably straightforward, using the &lt;code&gt;=&lt;/code&gt; symbol. Here’s an example of assigning “Hello World” to a &lt;code&gt;$TEST&lt;/code&gt; variable:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb18&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb18-1&quot;&gt;&lt;a href=&quot;#cb18-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; MSG=&lt;span class=&quot;st&quot;&gt;&amp;quot;Hello world!&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-2&quot;&gt;&lt;a href=&quot;#cb18-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; echo &lt;span class=&quot;va&quot;&gt;$MSG&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-3&quot;&gt;&lt;a href=&quot;#cb18-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Hello&lt;/span&gt; world!&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;using-variables-inside-strings&quot;&gt;Using Variables Inside Strings&lt;/h3&gt;
&lt;p&gt;There are multiple ways to use a variable that you’ve assigned a value. As an example, we’ve assigned &lt;code&gt;foo=uname&lt;/code&gt;.&lt;/p&gt;
&lt;h4 id=&quot;double-quotes&quot;&gt;Double Quotes&lt;/h4&gt;
&lt;p&gt;If you want to echo the contents of a variable, then use double quotes. It will expand what’s inside the variable and print that to the screen.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; foo=”uname”&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$foo&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb19-3&quot;&gt;&lt;a href=&quot;#cb19-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;uname&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;single-quotes&quot;&gt;Single Quotes&lt;/h4&gt;
&lt;p&gt;In some cases, you don’t want to output a variable’s contents, but maybe write an explanation of what that variable is used for. To avoid expansion, use single quotes:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; foo=”uname”&lt;/span&gt;
&lt;span id=&quot;cb20-2&quot;&gt;&lt;a href=&quot;#cb20-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;#39;$foo&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb20-3&quot;&gt;&lt;a href=&quot;#cb20-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;va&quot;&gt;$foo&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This also means that you don’t have to manually escape the &lt;code&gt;$&lt;/code&gt; symbol, which you otherwise would need to in the case of double quotes.&lt;/p&gt;
&lt;h4 id=&quot;backticks&quot;&gt;Backticks&lt;/h4&gt;
&lt;p&gt;The third option for using a variable is backticks. Use this when you want the contents of the variable to be run as a shell command:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; foo=”uname”&lt;/span&gt;
&lt;span id=&quot;cb21-2&quot;&gt;&lt;a href=&quot;#cb21-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; echo &lt;span class=&quot;kw&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$foo&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;`&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb21-3&quot;&gt;&lt;a href=&quot;#cb21-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Linux&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;using-curly-brackets&quot;&gt;Using Curly Brackets&lt;/h3&gt;
&lt;p&gt;You can get away with merely referring to a variable by writing &lt;code&gt;$FOO&lt;/code&gt;. However, you may want to refer to a variable inside a string or concatenate it with another. Take a look at the following example:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb22&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb22-1&quot;&gt;&lt;a href=&quot;#cb22-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; FOO=&lt;span class=&quot;st&quot;&gt;&amp;quot;Hel&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb22-2&quot;&gt;&lt;a href=&quot;#cb22-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$FOOlo&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; world&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this case, bash would try to find the variable &lt;code&gt;$FOOlo&lt;/code&gt;, but we just wanted to print “Hello world.” To make this work, you will have to do the following:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb23&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb23-1&quot;&gt;&lt;a href=&quot;#cb23-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; FOO=&lt;span class=&quot;st&quot;&gt;&amp;quot;Hel&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb23-2&quot;&gt;&lt;a href=&quot;#cb23-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;${FOO}&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;lo world&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is most likely useful when you want to use a variable to define a path, like &lt;code&gt;/opt/${ENVIRONMENT}_build.txt&lt;/code&gt;. Without curly brackets, the script would try to look up &lt;code&gt;$ENVIRONMENT_build&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;properly-set-permissions&quot;&gt;Properly Set Permissions&lt;/h2&gt;
&lt;p&gt;One of the pitfalls that I remember running into time and time again when I started making bash scripts was remembering that &lt;a href=&quot;https://www.guru99.com/file-permissions.html&quot;&gt;permissions&lt;/a&gt; had to be set right. See, when you make a file with, for example, &lt;code&gt;touch&lt;/code&gt;, it gives read/write permissions to the owner and read rights to everyone else. This means that you’ll get a &lt;code&gt;permission denied&lt;/code&gt; error when you try to run the script.&lt;/p&gt;
&lt;p&gt;Luckily this is easily fixed. Run &lt;code&gt;chmod +x script.sh&lt;/code&gt;, and now everyone is allowed to run the script.&lt;/p&gt;
&lt;p&gt;However, do be aware that changing permissions can impose security risks. Read more about &lt;a href=&quot;https://www.linux.com/training-tutorials/understanding-linux-file-permissions/&quot;&gt;Linux file permissions&lt;/a&gt; before you start changing permissions blindly.&lt;/p&gt;
&lt;h2 id=&quot;ensure-readability&quot;&gt;Ensure Readability&lt;/h2&gt;
&lt;p&gt;One of the biggest pitfalls that newcomers run into is forgetting about readability. It’s easy to get caught up in wanting to have a working script, and maybe you’re even used to running everything manually in the terminal, where you want to type as little as possible.&lt;/p&gt;
&lt;p&gt;When it comes to scripts, you want to make sure that you can still easily remember what’s happening six months down the line. An easy way to do this is by using more extended options (&lt;code&gt;--quiet&lt;/code&gt; instead of &lt;code&gt;-q&lt;/code&gt;), using longer variable names (&lt;code&gt;MESSAGE&lt;/code&gt; instead of &lt;code&gt;MSG&lt;/code&gt;), and writing comments.&lt;/p&gt;
&lt;p&gt;You can write commands using a hash mark, after which you can write your comment, like so:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Below line will echo “Hello World!”
echo “Hello World!”&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;understand-your-script-in-relation-to-cli&quot;&gt;Understand Your Script in Relation to CLI&lt;/h2&gt;
&lt;p&gt;When reading this article, you may have noticed that many code examples are being run straight in the terminal rather than written as a bash script. There’s a good reason for that! You can write everything you write in a bash script directly in the terminal.&lt;/p&gt;
&lt;p&gt;There is one significant difference between executing a script and typing the commands in your terminal. When you run a script, it’ll start up a new, clean shell in which the script will run. This means that no variables set in your terminal will interfere with your script.&lt;/p&gt;
&lt;p&gt;For example, if you set &lt;code&gt;TEST=”hello”&lt;/code&gt; in your shell and run &lt;code&gt;echo $TEST&lt;/code&gt; inside a script, it will print nothing to your screen.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;At this point, you should be ready to venture into the exciting world of bash scripting. You’ve learned about common shebangs, what &lt;code&gt;set&lt;/code&gt; does, and how it can improve the error handling of your scripts, as well as understanding some general pitfalls developers run into with bash.&lt;/p&gt;
&lt;p&gt;So go ahead and automate those annoying commands you’ve been typing out every day. Tired of manually going into your browser and finding the git repo you’re working on? Make a script to parse the remote git URL and open it automatically. Maybe you have to rename a bunch of files. Make a script that can loop through them and rename them. The world is your oyster.&lt;/p&gt;</content><author><name>Kasper Siig</name></author><category term="Tutorials" /><summary type="html">Bash scripts give you the ability to turn a tedious series of commands into an easily runnable and repeatable script. With many real-world use cases, like using a bash script to run a continuous deployment process, create a series of files in a folder, or download the contents of several URLs, it’s worth your time to make sure bash scripting is in your programming toolbox.</summary></entry><entry><title type="html">Compiling Containers - Dockerfiles, LLVM, and BuildKit</title><link href="https://earthly.dev/blog/compiling-containers-dockerfiles-llvm-and-buildkit/" rel="alternate" type="text/html" title="Compiling Containers - Dockerfiles, LLVM, and BuildKit" /><published>2021-03-17T00:00:00-04:00</published><updated>2021-03-17T00:00:00-04:00</updated><id>https://earthly.dev/blog/compiling-containers-dockerfiles-llvm-and-buildkit</id><content type="html" xml:base="https://earthly.dev/blog/compiling-containers-dockerfiles-llvm-and-buildkit/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;How are containers made? Usually, from a series of statements like &lt;code&gt;RUN&lt;/code&gt;, &lt;code&gt;FROM&lt;/code&gt;, and &lt;code&gt;COPY&lt;/code&gt;, which are put into a Dockerfile and built. But how are those commands turned into a container image and then a running container? We can build up an intuition for how this works by understanding the phases involved and creating a container image ourselves. We will create an image programmatically and then develop a trivial syntactic frontend and use it to build an image.&lt;/p&gt;
&lt;h3 id=&quot;game-plan&quot;&gt;Game Plan&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;☑️ Intro&lt;/li&gt;
&lt;li&gt;☐️ Background&lt;/li&gt;
&lt;li&gt;&lt;input type=&quot;checkbox&quot; disabled=&quot;&quot; /&gt;
Understanding Compiler Stages and BuildKit&lt;/li&gt;
&lt;li&gt;&lt;input type=&quot;checkbox&quot; disabled=&quot;&quot; /&gt;
Programmatically Creating an Image&lt;/li&gt;
&lt;li&gt;&lt;input type=&quot;checkbox&quot; disabled=&quot;&quot; /&gt;
Building a Frontend for BuildKit&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;on-docker-build&quot;&gt;On &lt;code&gt;Docker Build&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;We can create container images in several ways. We can use Buildpacks, we can use build tools like Bazel or sbt, but by far, the most common way images are built is using &lt;code&gt;docker build&lt;/code&gt; with a Dockerfile. The familiar base images Alpine, Ubuntu, and Debian are all created this way.&lt;/p&gt;
&lt;p&gt;Here is an example Dockerfile:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot; data-startFrom=&quot;100&quot;&gt;&lt;pre class=&quot;sourceCode numberSource dockerfile numberLines&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot; style=&quot;counter-reset: source-line 99;&quot;&gt;&lt;span id=&quot;cb1-100&quot;&gt;&lt;a href=&quot;#cb1-100&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; alpine&lt;/span&gt;
&lt;span id=&quot;cb1-101&quot;&gt;&lt;a href=&quot;#cb1-101&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; README.md README.md&lt;/span&gt;
&lt;span id=&quot;cb1-102&quot;&gt;&lt;a href=&quot;#cb1-102&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;quot;standard docker build&amp;quot;&lt;/span&gt; &amp;gt; /built.txt&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We will be using variations on this Dockerfile throughout this tutorial.&lt;/p&gt;
&lt;p&gt;We can build it like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker build . -t test&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But what is happening when you call &lt;code&gt;docker build&lt;/code&gt;? To understand that, we will need a little background.&lt;/p&gt;
&lt;h2 id=&quot;background&quot;&gt;Background&lt;/h2&gt;
&lt;p&gt;A docker image is made up of layers. Those layers form an immutable filesystem. A container image also has some descriptive data, such as the start-up command, the ports to expose, and volumes to mount. When you &lt;code&gt;docker run&lt;/code&gt; an image, it starts up inside a container runtime.&lt;/p&gt;
&lt;p&gt;I like to think about images and containers by analogy. If an image is like an executable, then a container is like a process. You can run multiple containers from one image, and a running image isn’t an image at all but a container.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/1-2.png&quot; title=&quot;fig:&quot; alt=&quot;An image is like an executable&quot; /&gt;
&lt;/div&gt;
&lt;p&gt;Continuing our analogy, &lt;a href=&quot;https://github.com/moby/buildkit&quot;&gt;BuildKit&lt;/a&gt; is a compiler, just like &lt;a href=&quot;https://en.wikipedia.org/wiki/LLVM&quot;&gt;LLVM&lt;/a&gt;. But whereas a compiler takes source code and libraries and produces an executable, BuildKit takes a Dockerfile and a file path and creates a container image.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/099.png&quot; alt=&quot;BuildKit is like a compiler for Docker images&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;BuildKit is like a compiler for Docker images&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;Docker build uses BuildKit, to turn a Dockerfile into a docker image, OCI image, or another image format. In this walk-through, we will primarily use BuildKit directly.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/buildctl-2.png&quot; alt=&quot;Docker Daemon with BuildKit Daemon inside it&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Docker Daemon with BuildKit Daemon inside it&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;This &lt;a href=&quot;https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/&quot;&gt;primer on using buildkit&lt;/a&gt; supplies some helpful background on using BuildKit, &lt;code&gt;buildkitd&lt;/code&gt;, and &lt;code&gt;buildctl&lt;/code&gt; via the command-line. However, the only prerequisite for today is running &lt;code&gt;brew install buildkit&lt;/code&gt; or the appropriate OS &lt;a href=&quot;https://github.com/moby/buildkit#quick-start&quot;&gt;equivalent&lt;/a&gt; steps.&lt;/p&gt;
&lt;h2 id=&quot;how-do-compilers-work&quot;&gt;How Do Compilers Work?&lt;/h2&gt;
&lt;p&gt;A traditional compiler takes code in a high-level language and lowers it to a lower-level language. In most conventional ahead-of-time compilers, the final target is machine code. Machine code is a low-level programming language that your CPU understands&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ Fun Fact: Machine Code VS. Assembly&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Machine code is written in binary. This makes it hard for a human to understand. Assembly code is a plain-text representation of machine code that is designed to be somewhat human-readable. There is generally a 1-1 mapping between instructions the machine understands (in machine code) and the OpCodes in Assembly&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Compiling the classic c “Hello, World” into x86 assembly code using the CLANG frontend for LLVM looks like this:&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/compilingc.png&quot; alt=&quot;Compiling Hello World to X86 assembly&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Compiling Hello World to X86 assembly&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;Creating an image from a dockerfile works a similar way:&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/build-an-image.png&quot; alt=&quot;Compiling Docker Image&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Compiling Docker Image&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;BuildKit is passed the Dockerfile and the build context, which is the present working directory in the above diagram. In simplified terms, each line in the dockerfile is turned into a layer in the resulting image. One significant way image building differs from compiling is this build context. A compiler’s input is limited to source code, whereas &lt;code&gt;docker build&lt;/code&gt; takes a reference to the host filesystem as an input and uses it to perform actions such as &lt;code&gt;COPY&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;there-is-a-catch&quot;&gt;There Is a Catch&lt;/h2&gt;
&lt;p&gt;The earlier diagram of compiling “Hello, World” in a single step missed a vital detail. Computer hardware is not a singular thing. If every compiler were a hand-coded mapping from a high-level language to x86 machine code, then moving to the Apple M1 processor would be quite challenging because it has a different instruction set.&lt;/p&gt;
&lt;p&gt;Compiler authors have overcome this challenge by splitting compilation into phases. The traditional phases are the frontend, the backend, and the middle. The middle phase is sometimes called the optimizer, and it deals primarily with an internal representation (IR).&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/3stagebuild.png&quot; alt=&quot;Three stage build process&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Three stage build process&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;This staged approach means you don’t need a new compiler for each new machine architecture. Instead, you just need a new backend. Here is an example of what that looks like in &lt;a href=&quot;https://llvm.org/&quot;&gt;LLVM&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/backends.png&quot; alt=&quot;Backends of LLVM&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Backends of LLVM&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;h2 id=&quot;intermediate-representations&quot;&gt;Intermediate Representations&lt;/h2&gt;
&lt;p&gt;This multiple backend approach allows LLVM to target ARM, X86, and many other machine architectures using LLVM Intermediate Representation (IR) as a standard protocol. LLVM IR is a human-readable programming language that backends need to be able to take as input. To create a new backend, you need to write a translator from LLVM IR to your target machine code. That translation is the primary job of each backend.&lt;/p&gt;
&lt;p&gt;Once you have this IR, you have a protocol that various phases of the compiler can use as an interface, and you can build not just many backends but many frontends as well. LLVM has frontends for numerous languages, including C++, Julia, Objective-C, Rust, and Swift.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/frontends-2.png&quot; alt=&quot;One compiler, with many frontend and backends&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;One compiler, with many frontend and backends&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;If you can write a translation from your language to LLVM IR, LLVM can translate that IR into machine code for all the backends it supports. This translation function is the primary job of a compiler frontend.&lt;/p&gt;
&lt;p&gt;In practice, there is much more to it than that. Frontends need to tokenize and parse input files, and they need to return pleasant errors. Backends often have target-specific optimizations to perform and heuristics to apply. But for this tutorial, the critical point is that having a standard representation ends up being a bridge that connects many front ends with many backends. This shared interface removes the need to create a compiler for every combination of language and machine architecture. It is a simple but very empowering trick!&lt;/p&gt;
&lt;h2 id=&quot;buidkit&quot;&gt;BuidKit&lt;/h2&gt;
&lt;p&gt;Images, unlike executables, have their own isolated filesystem. Nevertheless, the task of building an image looks very similar to compiling an executable. They can have varying syntax (dockerfile1.0, dockerfile1.2), and the result must target several machine architectures (arm64 vs. x86_64).&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“LLB is to Dockerfile what LLVM IR is to C” - &lt;a href=&quot;https://github.com/moby/buildkit/blob/master/README.md&quot;&gt;BuildKit Readme&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This similarity was not lost on the BuildKit creators. BuildKit has its own intermediate representation, LLB. And where LLVM IR has things like function calls and garbage-collection strategies, LLB has mounting filesystems and executing statements.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/LLBIR-fixed.png&quot; alt=&quot;LLVM IR VS. LLB&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;LLVM IR VS. LLB&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/moby/buildkit/blob/ebd98bcbe600c662a72ce9725417540f277be4d6/solver/pb/ops.proto&quot;&gt;LLB&lt;/a&gt; is defined as a protocol buffer, and this means that BuildKit frontends can make GRPC requests against buildkitd to build a container directly.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/Send-LLB.png&quot; alt=&quot;LLVM IR VS. LLB&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;LLVM IR VS. LLB&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;h2 id=&quot;programmatically-making-an-image&quot;&gt;Programmatically Making An Image&lt;/h2&gt;
Alright, enough background. Let’s programmatically generate the LLB for an image and then build an image.&lt;br /&gt;

&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;ℹ️ Using Go&lt;/p&gt;
&lt;p&gt;In this example, we will be using Go which lets us leverage existing BuildKit libraries, but it’s possible to accomplish this in any language with Protocol Buffer support.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Import LLB defintions:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;import (
    &amp;quot;github.com/moby/buildkit/client/llb&amp;quot;
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Create LLB for an Alpine image:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func createLLBState() llb.State {
    return llb.Image(&amp;quot;docker.io/library/alpine&amp;quot;).
        File(llb.Copy(llb.Local(&amp;quot;context&amp;quot;), &amp;quot;README.md&amp;quot;, &amp;quot;README.md&amp;quot;)).
        Run(llb.Args([]string{&amp;quot;/bin/sh&amp;quot;, &amp;quot;-c&amp;quot;, &amp;quot;echo \&amp;quot;programmatically built\&amp;quot; &amp;gt; /built.txt&amp;quot;})).
    Root()
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We are accomplishing the equivalent of a &lt;code&gt;FROM&lt;/code&gt; by using &lt;code&gt;llb.Image&lt;/code&gt;. Then, we copy a file from the local file system into the image using &lt;code&gt;File&lt;/code&gt; and &lt;code&gt;Copy&lt;/code&gt;. Finally, we &lt;code&gt;RUN&lt;/code&gt; a command to echo some text to a file. LLB has many more operations, but you can recreate many standard images with these three building blocks.&lt;/p&gt;
&lt;p&gt;The final thing we need to do is turn this into protocol-buffer and emit it to standard out:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {

    dt, err := createLLBState().Marshal(context.TODO(), llb.LinuxAmd64)
    if err != nil {
        panic(err)
    }
    llb.WriteTo(dt, os.Stdout)
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let’s look at the what this generates using the &lt;code&gt;dump-llb&lt;/code&gt; option of buildctl:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt; go run ./writellb/writellb.go | \
 buildctl debug dump-llb | \
 jq .
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We get this JSON formatted LLB:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;Op&amp;quot;: {
    &amp;quot;Op&amp;quot;: {
      &amp;quot;source&amp;quot;: {
        &amp;quot;identifier&amp;quot;: &amp;quot;local://context&amp;quot;,
        &amp;quot;attrs&amp;quot;: {
          &amp;quot;local.unique&amp;quot;: &amp;quot;s43w96rwjsm9tf1zlxvn6nezg&amp;quot;
        }
      }
    },
    &amp;quot;constraints&amp;quot;: {}
  },
  &amp;quot;Digest&amp;quot;: &amp;quot;sha256:c3ca71edeaa161bafed7f3dbdeeab9a5ab34587f569fd71c0a89b4d1e40d77f6&amp;quot;,
  &amp;quot;OpMetadata&amp;quot;: {
    &amp;quot;caps&amp;quot;: {
      &amp;quot;source.local&amp;quot;: true,
      &amp;quot;source.local.unique&amp;quot;: true
    }
  }
}
{
  &amp;quot;Op&amp;quot;: {
    &amp;quot;Op&amp;quot;: {
      &amp;quot;source&amp;quot;: {
        &amp;quot;identifier&amp;quot;: &amp;quot;docker-image://docker.io/library/alpine:latest&amp;quot;
      }
    },
    &amp;quot;platform&amp;quot;: {
      &amp;quot;Architecture&amp;quot;: &amp;quot;amd64&amp;quot;,
      &amp;quot;OS&amp;quot;: &amp;quot;linux&amp;quot;
    },
    &amp;quot;constraints&amp;quot;: {}
  },
  &amp;quot;Digest&amp;quot;: &amp;quot;sha256:665ba8b2cdc0cb0200e2a42a6b3c0f8f684089f4cd1b81494fbb9805879120f7&amp;quot;,
  &amp;quot;OpMetadata&amp;quot;: {
    &amp;quot;caps&amp;quot;: {
      &amp;quot;source.image&amp;quot;: true
    }
  }
}
{
  &amp;quot;Op&amp;quot;: {
    &amp;quot;inputs&amp;quot;: [
      {
        &amp;quot;digest&amp;quot;: &amp;quot;sha256:665ba8b2cdc0cb0200e2a42a6b3c0f8f684089f4cd1b81494fbb9805879120f7&amp;quot;,
        &amp;quot;index&amp;quot;: 0
      },
      {
        &amp;quot;digest&amp;quot;: &amp;quot;sha256:c3ca71edeaa161bafed7f3dbdeeab9a5ab34587f569fd71c0a89b4d1e40d77f6&amp;quot;,
        &amp;quot;index&amp;quot;: 0
      }
    ],
    &amp;quot;Op&amp;quot;: {
      &amp;quot;file&amp;quot;: {
        &amp;quot;actions&amp;quot;: [
          {
            &amp;quot;input&amp;quot;: 0,
            &amp;quot;secondaryInput&amp;quot;: 1,
            &amp;quot;output&amp;quot;: 0,
            &amp;quot;Action&amp;quot;: {
              &amp;quot;copy&amp;quot;: {
                &amp;quot;src&amp;quot;: &amp;quot;/README.md&amp;quot;,
                &amp;quot;dest&amp;quot;: &amp;quot;/README.md&amp;quot;,
                &amp;quot;mode&amp;quot;: -1,
                &amp;quot;timestamp&amp;quot;: -1
              }
            }
          }
        ]
      }
    },
    &amp;quot;platform&amp;quot;: {
      &amp;quot;Architecture&amp;quot;: &amp;quot;amd64&amp;quot;,
      &amp;quot;OS&amp;quot;: &amp;quot;linux&amp;quot;
    },
    &amp;quot;constraints&amp;quot;: {}
  },
  &amp;quot;Digest&amp;quot;: &amp;quot;sha256:ba425dda86f06cf10ee66d85beda9d500adcce2336b047e072c1f0d403334cf6&amp;quot;,
  &amp;quot;OpMetadata&amp;quot;: {
    &amp;quot;caps&amp;quot;: {
      &amp;quot;file.base&amp;quot;: true
    }
  }
}
{
  &amp;quot;Op&amp;quot;: {
    &amp;quot;inputs&amp;quot;: [
      {
        &amp;quot;digest&amp;quot;: &amp;quot;sha256:ba425dda86f06cf10ee66d85beda9d500adcce2336b047e072c1f0d403334cf6&amp;quot;,
        &amp;quot;index&amp;quot;: 0
      }
    ],
    &amp;quot;Op&amp;quot;: {
      &amp;quot;exec&amp;quot;: {
        &amp;quot;meta&amp;quot;: {
          &amp;quot;args&amp;quot;: [
            &amp;quot;/bin/sh&amp;quot;,
            &amp;quot;-c&amp;quot;,
            &amp;quot;echo \&amp;quot;programmatically built\&amp;quot; &amp;gt; /built.txt&amp;quot;
          ],
          &amp;quot;cwd&amp;quot;: &amp;quot;/&amp;quot;
        },
        &amp;quot;mounts&amp;quot;: [
          {
            &amp;quot;input&amp;quot;: 0,
            &amp;quot;dest&amp;quot;: &amp;quot;/&amp;quot;,
            &amp;quot;output&amp;quot;: 0
          }
        ]
      }
    },
    &amp;quot;platform&amp;quot;: {
      &amp;quot;Architecture&amp;quot;: &amp;quot;amd64&amp;quot;,
      &amp;quot;OS&amp;quot;: &amp;quot;linux&amp;quot;
    },
    &amp;quot;constraints&amp;quot;: {}
  },
  &amp;quot;Digest&amp;quot;: &amp;quot;sha256:d2d18486652288fdb3516460bd6d1c2a90103d93d507a9b63ddd4a846a0fca2b&amp;quot;,
  &amp;quot;OpMetadata&amp;quot;: {
    &amp;quot;caps&amp;quot;: {
      &amp;quot;exec.meta.base&amp;quot;: true,
      &amp;quot;exec.mount.bind&amp;quot;: true
    }
  }
}
{
  &amp;quot;Op&amp;quot;: {
    &amp;quot;inputs&amp;quot;: [
      {
        &amp;quot;digest&amp;quot;: &amp;quot;sha256:d2d18486652288fdb3516460bd6d1c2a90103d93d507a9b63ddd4a846a0fca2b&amp;quot;,
        &amp;quot;index&amp;quot;: 0
      }
    ],
    &amp;quot;Op&amp;quot;: null
  },
  &amp;quot;Digest&amp;quot;: &amp;quot;sha256:fda9d405d3c557e2bd79413628a435da0000e75b9305e52789dd71001a91c704&amp;quot;,
  &amp;quot;OpMetadata&amp;quot;: {
    &amp;quot;caps&amp;quot;: {
      &amp;quot;constraints&amp;quot;: true,
      &amp;quot;platform&amp;quot;: true
    }
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looking through the output, we can see how our code maps to LLB.&lt;/p&gt;
&lt;p&gt;Here is our &lt;code&gt;Copy&lt;/code&gt; as part of a FileOp:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;    &amp;quot;Action&amp;quot;: {
              &amp;quot;copy&amp;quot;: {
                &amp;quot;src&amp;quot;: &amp;quot;/README.md&amp;quot;,
                &amp;quot;dest&amp;quot;: &amp;quot;/README.md&amp;quot;,
                &amp;quot;mode&amp;quot;: -1,
                &amp;quot;timestamp&amp;quot;: -1
              }&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Here is mapping our build context for use in our &lt;code&gt;COPY&lt;/code&gt; command:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  &amp;quot;Op&amp;quot;: {
      &amp;quot;source&amp;quot;: {
        &amp;quot;identifier&amp;quot;: &amp;quot;local://context&amp;quot;,
        &amp;quot;attrs&amp;quot;: {
          &amp;quot;local.unique&amp;quot;: &amp;quot;s43w96rwjsm9tf1zlxvn6nezg&amp;quot;
        }
      }&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Similarly, the output contains LLB that corresponds to our &lt;code&gt;RUN&lt;/code&gt; and &lt;code&gt;FROM&lt;/code&gt; commands.&lt;/p&gt;
&lt;h3 id=&quot;building-our-llb&quot;&gt;Building Our LLB&lt;/h3&gt;
&lt;p&gt;To build our image, we must first start &lt;code&gt;buildkitd&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker run --rm --privileged -d --name buildkit moby/buildkit
export BUILDKIT_HOST=docker-container://buildkit&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can then build our image like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;go run ./writellb/writellb.go | \
buildctl build \
--local context=. \
--output type=image,name=docker.io/agbell/test,push=true&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The output flag lets us specify what backend we want BuildKit to use. We will ask it to build an OCI image and push it to docker.io.&lt;/p&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;ℹ️ Real-World Usage&lt;/p&gt;
&lt;p&gt;In the real-world tool, we might want to programmatically make sure &lt;code&gt;buildkitd&lt;/code&gt; is running and send the RPC request directly to it, as well as provide friendly error messages. For tutorial purposes, we will skip all that.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;We can run it like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker run -it --pull always agbell/test:latest /bin/sh
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And we can then see the results of our programmatic &lt;code&gt;COPY&lt;/code&gt; and &lt;code&gt;RUN&lt;/code&gt; commands:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/ # cat built.txt 
programmatically built
/ # ls README.md
README.md&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There we go! The &lt;a href=&quot;https://github.com/agbell/compiling-containers/blob/main/writellb/writellb.go&quot;&gt;full code example&lt;/a&gt; can be a great starting place for your own programmatic docker image building.&lt;/p&gt;
&lt;h2 id=&quot;a-true-frontend-for-buildkit&quot;&gt;A True Frontend for BuildKit&lt;/h2&gt;
&lt;p&gt;A true compiler front end does more than just emit hardcoded IR. A proper frontend takes in files, tokenizes them, parses them, generates a syntax tree, and then lowers that syntax tree into the internal representation. &lt;a href=&quot;https://matt-rickard.com/building-a-new-dockerfile-frontend/&quot;&gt;Mockerfiles&lt;/a&gt; are an example of such a frontend:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#syntax=r2d4/mocker
apiVersion: v1alpha1
images:
- name: demo
  from: ubuntu:16.04
  package:
    install:
    - curl
    - git
    - gcc&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And because Docker build supports the &lt;code&gt;#syntax&lt;/code&gt; command we can even build a Mockerfiles directly with &lt;code&gt;docker build&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker build -f mockerfile.yaml&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To support the #syntax command, all that is needed is to put the frontend in a docker image that accepts a GRPC request in the correct format, publish that image somewhere. At that point, anyone can use your frontend &lt;code&gt;docker build&lt;/code&gt; by just using &lt;code&gt;#syntax=yourimagename&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;building-our-own-example-frontend-for-docker-build&quot;&gt;Building Our Own Example Frontend for &lt;code&gt;Docker build&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;Building a tokenizer and a parser as a GRPC service is beyond the scope of this article. But we can get our feet wet by extracting and modifying an existing frontend. The standard &lt;a href=&quot;https://github.com/moby/buildkit/tree/master/frontend/dockerfile&quot;&gt;dockerfile frontend&lt;/a&gt; is easy to disentangle from the moby project. I’ve pulled the relevant parts out into a &lt;a href=&quot;https://github.com/agbell/compiling-containers/tree/main/ickfile&quot;&gt;stand-alone repo&lt;/a&gt;. Let’s make some trivial modifications to it and test it out.&lt;/p&gt;
&lt;p&gt;So far, we’ve only used the docker commands &lt;code&gt;FROM&lt;/code&gt;, &lt;code&gt;RUN&lt;/code&gt; and &lt;code&gt;COPY&lt;/code&gt;. At a surface level, with its capitalized commands, Dockerfile syntax looks a lot like the programming language &lt;a href=&quot;https://earthly.dev/blog/intercal-yaml-and-other-horrible-programming-languages/&quot;&gt;INTERCAL&lt;/a&gt;. Let change these commands to their INTERCAL equivalent and develop our own Ickfile format &lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Dockerfile&lt;/th&gt;
&lt;th style=&quot;text-align: center;&quot;&gt;Ickfile&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;FROM&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;COME FROM&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;RUN&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;PLEASE&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;COPY&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;STASH&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The modules in the dockerfile frontend split the parsing of the input file into several discreet steps, with execution flowing this way:&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/compiling-containers-dockerfiles-llvm-and-buildkit/controlflow.png&quot; alt=&quot;ControlFlow from main.go to Dockerfile2LLB to Parser to Command.go&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;ControlFlow from main.go to Dockerfile2LLB to Parser to Command.go&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;For this tutorial, we are only going to make trivial changes to the frontend. We will leave all the stages intact and focus on customizing the existing commands to our tastes. To do this, all we need to do is change &lt;code&gt;command.go&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;package command

// Define constants for the command strings
const (
    Copy        = &amp;quot;stash&amp;quot;
    Run         = &amp;quot;please&amp;quot;
    From        = &amp;quot;come_from&amp;quot;
    ...
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then we build our image:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker build . -t agbell/ick&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And we can use this image as a BuildKit frontend and build images with it like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#syntax=agbell/ick
COME_FROM alpine
STASH README.md README.md
PLEASE echo &amp;quot;custom frontend built&amp;quot; &amp;gt; /built.txt&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;DOCKER_BUILDKIT=1 docker build . -f ./Ickfile -t ick &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And we can run it just like any other image:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker run -it ick /bin/sh&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And we can then see results of our &lt;code&gt;STASH&lt;/code&gt; and &lt;code&gt;PLEASE&lt;/code&gt; commands:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/ # cat built.txt 
custom frontend built
/ # ls README.md
README.md&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I’ve pushed this image to dockerhub. Anyone can start building images using our &lt;code&gt;ickfile&lt;/code&gt; format by adding &lt;code&gt;#syntax=agbell/ick&lt;/code&gt; to an existing Dockerfile. No manual installation is required!&lt;/p&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;ℹ️ Enabling BuildKit&lt;/p&gt;
&lt;p&gt;BuildKit is included but not enabled by default in the current version of Docker (&lt;code&gt;version 20.10.2&lt;/code&gt;). To instruct &lt;code&gt;docker build&lt;/code&gt; to use BuildKit set the following environment variable &lt;code&gt;DOCKER_BUILDKIT=1&lt;/code&gt;. This will not be necessary once BuildKit reaches general availability.&lt;/p&gt;
&lt;/div&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;We have learned that a three-phased structure borrowed from compilers powers building images, that an intermediate representation called LLB is the key to that structure. Empowered by the knowledge, we have produced two frontends for building images.&lt;/p&gt;
&lt;p&gt;This deep dive on frontends still leaves much to explore. If you want to learn more, I suggest looking into BuildKit workers. Workers do the actual building and are the secret behind &lt;code&gt;docker buildx&lt;/code&gt;, and &lt;a href=&quot;https://docs.docker.com/buildx/working-with-buildx/&quot;&gt;multi-archtecture builds&lt;/a&gt;. &lt;code&gt;docker build&lt;/code&gt; also has support for remote workers and cache mounts, both of which can lead to faster builds.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; uses BuildKit internally for its repeatable build syntax. Without it, our containerized Makefile-like syntax would not be possible. If you want a saner CI process, then &lt;a href=&quot;https://earthly.dev/&quot;&gt;you should check it out&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There is also much more to explore about how modern compilers work. Modern compilers often have many stages and more than one intermediate representation, and they are often able to do very sophisticated optimizations.&lt;a href=&quot;#fn3&quot; class=&quot;footnote-ref&quot; id=&quot;fnref3&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The difference between the two is murky, but I like to think of a transpiler as something that translates from one human-readable text-based programming language to another. The java compiler translates Java code to java byte code, which is a binary format. Meanwhile, PureScript, which translates to JavaScript, is regarded as a transpiler because JavaScript is text-based.&lt;/p&gt;
&lt;section class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;Fun Fact: You may have heard the term transpiler or transcompiler in the past. Transpilers are compilers that transform one programming language into another. If all compilers translate from one language to another, then what makes something a transpiler?&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;Ick is the name of the INTERCAL compiler. Therefore Ickfile can be its Dockerfile equivalent.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;If you want to learn more about optimizing compilers, Matt Godbolt’s article on &lt;a href=&quot;https://queue.acm.org/detail.cfm?id=3372264&quot;&gt;C++ Optimizations&lt;/a&gt; is a great place to start. The book &lt;a href=&quot;https://www.amazon.com/Building-Optimizing-Compiler-Bob-Morgan/dp/155558179X&quot;&gt;Building an Optimizing Compiler&lt;/a&gt; is also often recommended online.&lt;a href=&quot;#fnref3&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Tutorials" /><summary type="html">How are containers made? Usually, from a series of statements like RUN, FROM, and COPY, which are put into a Dockerfile and built. But how are those commands turned into a container image and then a running container?</summary></entry><entry><title type="html">On YAML Discussions</title><link href="https://earthly.dev/blog/on-yaml-discussions/" rel="alternate" type="text/html" title="On YAML Discussions" /><published>2021-03-12T00:00:00-05:00</published><updated>2021-03-12T00:00:00-05:00</updated><id>https://earthly.dev/blog/on-yaml-discussions</id><content type="html" xml:base="https://earthly.dev/blog/on-yaml-discussions/">&lt;p&gt;My article about how &lt;a href=&quot;https://earthly.dev/blog/intercal-yaml-and-other-horrible-programming-languages/&quot;&gt;YAML makes a bad programming language&lt;/a&gt; &lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; generated a lot of great discussions online.&lt;/p&gt;
&lt;p&gt;Here are some highlights, lightly edited:&lt;/p&gt;
&lt;h2 id=&quot;config-traps&quot;&gt;Config Traps&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://news.ycombinator.com/item?id=26276420&quot;&gt;dkarl&lt;/a&gt; pointed out that putting things in config files that shouldn’t be there happens for many reasons:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Reason:&lt;/strong&gt; Pride in creating a “generic” system that can be configured to do all kinds of new things “without touching the code.”&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Reality check:&lt;/strong&gt; only one or two programmers understand how to modify the config file, and changes have to go through the same life cycle as a code change, so you haven’t gained anything. You’ve only made it harder to onboard new programmers to the project.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Reason:&lt;/strong&gt; Hope that if certain logic is encoded in config files, then it can never get complicated.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Reality check:&lt;/strong&gt; Product requirements do not magically become simpler because of your implementation decisions.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Reason:&lt;/strong&gt; Hope that you can get non-programmers to code review your business logic.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Reality check:&lt;/strong&gt; the DSL you embedded in your config file isn’t as “human readable” as you think it is.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;dhall-is-strange&quot;&gt;DHALL is Strange&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://lobste.rs/s/1nxt6g/intercal_yaml_other_horrible#c_pc0dt6&quot;&gt;AndyC&lt;/a&gt; thought that Dhall was not the right answer to the YAML problem:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I agree with the problem, but disagree with the solution. Total languages don’t give you any useful engineering properties, but lack of side effects do (and Dhall also offers that).&lt;/p&gt;
&lt;p&gt;From the surface, it seems like HCL, jsonnet, and Cue, are just as suitable as Dhall, and probably more familiar (to varying degrees).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This is an excellent point. &lt;a href=&quot;https://github.com/hashicorp/hcl&quot;&gt;HCL&lt;/a&gt; does look a bit less strange to outsiders, and Hashicorp already has mindshare in the DevOps community, and it certainly beats config templates.&lt;/p&gt;
&lt;h2 id=&quot;dsl-creation-story&quot;&gt;DSL Creation Story&lt;/h2&gt;
&lt;p&gt;Reddit user &lt;a href=&quot;https://www.reddit.com/r/programming/comments/ls6tgm/intercal_yaml_and_other_horrible_programming/gopf8fj/?utm_source=reddit&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;XANi_&lt;/a&gt; explained how DSL’s embedded in YAML keep getting created: &amp;gt; The vicious cycle of &amp;gt; * We don’t want config to be turing complete, we just need to declare some initial setup &amp;gt; &amp;gt; * Oops, we need to add some conditions. Just code it as data, changing config format is too much work &amp;gt; &amp;gt; * Oops, we need to add some templates. Just use &amp;lt;primary language’s popular templating library&amp;gt;, changing config format is too much work. &amp;gt; &amp;gt; * And congratulations, you have now written a DSL &amp;gt; &amp;gt;If you need conditions and flexibility, picking existing language is by FAR superior choice.&lt;/p&gt;
&lt;h2 id=&quot;rake-webpack-and-groovy&quot;&gt;Rake, Webpack, and Groovy&lt;/h2&gt;
&lt;p&gt;Many readers pointed out that their development community skipped right by this DSL dead end by using a full programming language for build and config needs:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I always thought it was weird that a lot of web technologies take config files that are executable javascript. (Thinking of webpack). But it makes a lot of sense now, and I much prefer that approach. - &lt;a href=&quot;https://www.reddit.com/r/programming/comments/ls6tgm/intercal_yaml_and_other_horrible_programming/gopq0uv/?utm_source=reddit&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;Bunny&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;It’s fairly common in Pythonland [ to just use Python] …&lt;/p&gt;
&lt;p&gt;It’s an ideal solution for technically-savvy users in non-security sensitive contexts. - &lt;a href=&quot;https://www.reddit.com/r/programming/comments/ls6tgm/intercal_yaml_and_other_horrible_programming/gopy30z/?utm_source=reddit&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;&lt;strong&gt;crakers&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;I’m not convinced that just using programming language for your configuration files is actually that bad. For instance, with node, if you just use JS files that export an object instead of. JSON files, you end up with a lot more programmable and flexible thing. I don’t actually see the problem. - &lt;a href=&quot;https://www.reddit.com/r/programming/comments/ls6tgm/intercal_yaml_and_other_horrible_programming/goqm3z0/?utm_source=reddit&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;light24bulbs&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;writing-a-parser&quot;&gt;Writing a Parser&lt;/h2&gt;
&lt;p&gt;Hillel Wayne wrote a &lt;a href=&quot;https://buttondown.email/hillelwayne/archive/a3fe2688-464d-4f98-ae6b-207e7b5a1255&quot;&gt;great newsletter&lt;/a&gt; on YAML, and the ways it’s abused. He pointed out that the main competition for embedding your DSL into YAML is writing a parser, and using YAML is just easier.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[YAML] preparses the content for us. This isn’t a big enough draw to YAMLize complex programming languages, but it’s a huge huge deal for small DSLs. I suspect that’s the main reason why semgrep uses YAML for its rules and why so many technologies jury-rig it into a configuration language&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;You can see the full commentary on the orginal article on &lt;a href=&quot;https://www.reddit.com/r/programming/comments/ls6tgm/intercal_yaml_and_other_horrible_programming/&quot;&gt;Reddit&lt;/a&gt;, on &lt;a href=&quot;https://news.ycombinator.com/item?id=26271582&quot;&gt;Hacker News&lt;/a&gt; and on &lt;a href=&quot;https://lobste.rs/s/1nxt6g/intercal_yaml_other_horrible&quot;&gt;Lobste.rs&lt;/a&gt;.&lt;/p&gt;
&lt;section class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;To clarify, YAML, when used as the syntax frontend for a domain-specific, vendor-specific, programming language is a bad idea. I am aware YAML is not a programming language itself.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Articles" /><category term="news" /><summary type="html">My article about how YAML makes a bad programming language 1 generated a lot of great discussions online. To clarify, YAML, when used as the syntax frontend for a domain-specific, vendor-specific, programming language is a bad idea. I am aware YAML is not a programming language itself.↩︎</summary></entry><entry><title type="html">Build Your Own Ngrok Clone With AWS</title><link href="https://earthly.dev/blog/build-your-own-ngrok-clone/" rel="alternate" type="text/html" title="Build Your Own Ngrok Clone With AWS" /><published>2021-03-11T00:00:00-05:00</published><updated>2021-03-11T00:00:00-05:00</updated><id>https://earthly.dev/blog/build-your-own-ngrok-clone</id><content type="html" xml:base="https://earthly.dev/blog/build-your-own-ngrok-clone/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://ngrok.com/&quot;&gt;Ngrok&lt;/a&gt; is a tool that allows you to create secure, publically accessible URLs for your locally running code. Just a simple &lt;code&gt;./ngrok http 3000&lt;/code&gt;, and your tunnel is up and running! It also comes with an inspector for all traffic traveling over its tunnels. Pretty slick right? However, for a stable domain it costs &lt;em&gt;at least&lt;/em&gt; $5/month, and it only goes up from there. Additionally, you’re limited in the number of connections and tunnels that you can make.&lt;/p&gt;
&lt;p&gt;However, it can be hard to trust fancy tools like &lt;code&gt;ngrok&lt;/code&gt; until you experience how the sausage is made; at least once. It may also be hard to explan yet &lt;em&gt;another&lt;/em&gt; recurring charge on the credit card to your partner. So, here is a tutorial to build yourself a DIY &lt;code&gt;ngrok&lt;/code&gt; for free (at least 12 months, after that its very cheap), using the &lt;a href=&quot;https://aws.amazon.com/free/&quot;&gt;AWS Free Tier&lt;/a&gt;, &lt;a href=&quot;https://www.nginx.com/&quot;&gt;NGINX&lt;/a&gt;, and (of course) &lt;a href=&quot;https://earthly.dev/&quot;&gt;Earthly&lt;/a&gt;. The result is a decent approximation that won’t break the bank.&lt;/p&gt;
&lt;h2 id=&quot;so-how-does-ngrok-work&quot;&gt;So, How Does &lt;code&gt;ngrok&lt;/code&gt; Work?&lt;/h2&gt;
&lt;p&gt;To understand why &lt;code&gt;ngrok&lt;/code&gt; is so cool, you’ll need to first understand how you would normally get traffic from the broader internet into your local machine. A typical flow would be something like this:&lt;/p&gt;
&lt;div class=&quot;wide&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;img src=&quot;/blog/assets/images/build-your-own-ngrok-clone/without_ngrok.png&quot; alt=&quot;Diagram showing the flow of traffic from a users web browser, through the internet, a home router, and finally the users computer. It points out that the user controls the DNS lookup, router, and their machine.&quot; /&gt;&lt;br /&gt;
&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;This flow is normal for most of the machines on the internet today, but it has its downsides for local development. For instance, most home and non-commerical internet connections do not have a &lt;a href=&quot;https://whatismyipaddress.com/dynamic-static&quot;&gt;Static IP&lt;/a&gt; - which means you need to double-check your IP address before sending it out, or (more often) install and configure additional software to keep your DNS records up to date.&lt;/p&gt;
&lt;p&gt;Additionally, you’ll need to configure your router to forward that traffic to your machine. This configuration is typically fairly annoying to set up, and should also be turned off each time you arent using it, otherwise you are keeping your computer exposed to the internet at large! Its like putting a giant welcome mat out for hackers during their automated scans.&lt;/p&gt;
With this foundation, you can now understand why &lt;code&gt;ngrok&lt;/code&gt; (and our DIY one) is so cool! It removes the need for all this additional configuration, while also providing better security. All you need to do is add an extra computer into the mix, like this:
&lt;div class=&quot;wide&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;img src=&quot;/blog/assets/images/build-your-own-ngrok-clone/with_ngrok.png&quot; alt=&quot;Diagram showing the flow of traffic from a users web browser, through the internet, a home router, and finally the users computer. It points out that the user controls the DNS lookup, router, and their machine.&quot; /&gt;&lt;br /&gt;
&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Because you are using a &lt;a href=&quot;https://en.wikipedia.org/wiki/Reverse_proxy&quot;&gt;Reverse Proxy&lt;/a&gt; to get the traffic from the extra computer to yours, no additional configuration is required on your end. And, when you are done, you can simply shut down the extra machine, and there are no loose ends or open ports left to close!&lt;/p&gt;
&lt;p&gt;As mentioned above, this tutorial uses AWS to create the proxy. Other cloud providers will work just as well, but the commands and samples in this document will be for AWS only. &lt;a href=&quot;https://github.com/earthly/example-diy-ngrok&quot;&gt;Pull requests are welcome&lt;/a&gt;, if you want to contribute specific scripts for your cloud provider of choice!&lt;/p&gt;
&lt;p&gt;One elephant in the room to address before moving on is the inevitable “Why not (Terraform/Pulumi/Cloud Formation/My Favorite IAAS tool…)?” question. These tools are, in fact, made for setting up and tearing down insfrastructure exactly like this! However, using fewer tools helps keep this tutorial simple and accessible, so only the AWS CLI will be used throughout.&lt;/p&gt;
&lt;h2 id=&quot;lets-build-it&quot;&gt;Lets Build It&lt;/h2&gt;
&lt;p&gt;You will need the following to complete the rest of this tutorial:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;An active AWS account &lt;a href=&quot;https://portal.aws.amazon.com/billing/signup#/start&quot;&gt;(If you don’t have one, you can sign up here)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html&quot;&gt;Installed the AWS CLI&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html&quot;&gt;Configured AWS credentials&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Optionally, you may also want to install:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://stedolan.github.io/jq/&quot;&gt;jq&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;With those in hand, it’s time to get started!&lt;/p&gt;
&lt;h3 id=&quot;where-will-the-instance-live&quot;&gt;Where will the instance live?&lt;/h3&gt;
&lt;p&gt;Before creating anything in the cloud, you’ll need to make sure that you have some information about the VPC and subnet the instance will be assigned to. This information can be found in the console, or on the command-line via &lt;code&gt;aws ec2 describe-subnets&lt;/code&gt;. It will list all your subnets, and the VPCs they belong to.&lt;/p&gt;
&lt;p&gt;If your cloud is like most peoples, you likely have quite a few of these lying around, which makes it difficult to find the one you want to place your proxy in. I like to add &lt;code&gt;jq&lt;/code&gt; into the mix to make it easier to parse, like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ aws ec2 describe-subnets \
    | jq -r &amp;#39;.Subnets[] \
    | &amp;quot;\(.AvailabilityZone)\t\(.CidrBlock)\t\(.SubnetId)\t\(.VpcId)&amp;quot;&amp;#39; \
    | sort&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;When selecting a subnet, ensure that the one you choose assigns public IP addresses, as you will need to accept traffic from the general internet later.&lt;/p&gt;
&lt;h3 id=&quot;ssh-keypair&quot;&gt;SSH Keypair&lt;/h3&gt;
&lt;p&gt;The first thing to create is your EC2 SSH keypair. This is simple to do, especially because the &lt;code&gt;aws&lt;/code&gt; tool can generate on for you.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ aws ec2 create-key-pair \
    --key-name proxy-key-pair \
    &amp;gt; key-output.json&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ About the AWS CLI output&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Note the &lt;code&gt;&amp;gt; key-output.json&lt;/code&gt; at the end. The &lt;code&gt;aws&lt;/code&gt; CLI tool will always &lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/cliv2-migration.html#cliv2-migration-output-pager&quot;&gt;invoke your system pager with some kind of JSON output as the result of any calls&lt;/a&gt;. Because you don’t want to lose the key generated by &lt;code&gt;aws&lt;/code&gt; for our yet-to-be-created instance, capture it here. It’s a running trend that you will see throughout this tutorial.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;You can get the key directly with &lt;code&gt;jq&lt;/code&gt; by &lt;code&gt;jq -r .KeyPairId key-output.json&lt;/code&gt;, or via your preferred means.&lt;/p&gt;
&lt;h3 id=&quot;security-group&quot;&gt;Security Group&lt;/h3&gt;
&lt;p&gt;Now that you have a key pair, you will also need to create a security group for the instance to reside in. To oversimplify, a security group is essentially a firewall for your instance, constraining what ports traffic is allowed to enter or leave on. &lt;a href=&quot;https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html#VPCSecurityGroups&quot;&gt;You can read more about security groups here, for a longer and more complete explanation.&lt;/a&gt; Getting this right is important, so your proxy is less likely to be compromised.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ aws ec2 create-security-group \
    --group-name reverse-proxy \
    --description reverse-proxy \
    --vpc-id $VPC_ID \
    &amp;gt; sg-output.json&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Don’t Forget&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Make sure you replace &lt;code&gt;$VPC_ID&lt;/code&gt; with the ID for the &lt;a href=&quot;#where-will-the-instance-live&quot;&gt;VPC you identified earlier&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;By default, AWS security groups are configured to disallow all traffic coming in (ingress), and to allow all traffic out (egress). While an instance that doesn’t allow traffic in is fairly secure, it also doesn’t do you much good. You will need to open up port 22 (ssh) for traffic from our current IP only, and port 80 (http) for traffic from the internet at large. By restricting SSH to your current IP address, you prevent external entities from attempting to SSH into your proxy.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ aws ec2 authorize-security-group-ingress \
    --group-id $SG_ID \
    --protocol tcp \
    --port 22 \
    --cidr $IP/32 \
    --no-cli-pager

❯ aws ec2 authorize-security-group-ingress \
    --group-id $SG_ID \
    --protocol tcp \
    --port 80 \
    --cidr 0.0.0.0/0 \
    --no-cli-pager&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ Find your public IP from the command line&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;AWS has a public service that returns your IP to you. It’s super handy for scripting, because its much clearer to read than the most popular &lt;code&gt;dig&lt;/code&gt;-based examples passed around on the internet. You can use it like this: &lt;code&gt;curl -s https://checkip.amazonaws.com&lt;/code&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;notice--warning&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Don’t Forget&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Make sure you replace &lt;code&gt;$SG_ID&lt;/code&gt; with the ID for the security group you created earlier. If you saved the output like the sample earlier, you can get it by running &lt;code&gt;jq -r .GroupId sg-output.json&lt;/code&gt;. Also, make sure you replace &lt;code&gt;$IP&lt;/code&gt; with your &lt;em&gt;public&lt;/em&gt; IP address.&lt;/p&gt;
&lt;/div&gt;
&lt;h3 id=&quot;ec2-instance&quot;&gt;EC2 Instance&lt;/h3&gt;
&lt;p&gt;Now that you have keys, and a security group configured in AWS, you’re finally ready to create your EC2 instance! Its easiest for this kind of work to use a &lt;code&gt;t2.micro&lt;/code&gt;, since that is available on AWS’ free tier. If your account is older than 1 year, this instance is still among the cheapest to provision. If a &lt;code&gt;t2.micro&lt;/code&gt; is too expensive, you may want to size down to a &lt;code&gt;t2.nano&lt;/code&gt;, or consider &lt;a href=&quot;https://aws.amazon.com/ec2/spot/&quot;&gt;spot instances&lt;/a&gt;, which are beyond the scope of this tutorial. The instance will be provisioned with an AMI using Amazon Linux 2, to keep things as simple as possible.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ aws ec2 run-instances \
    --image-id resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2 \
    --count 1 \
    --instance-type t2.micro \
    --key-name $KEY_NAME \
    --security-group-ids $SG_ID \
    --subnet-id $SUBNET_ID \
    &amp;gt; ec2-output.json&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--warning&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Don’t Forget&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Make sure you replace &lt;code&gt;$KEY_NAME&lt;/code&gt; with the name (&lt;em&gt;not id&lt;/em&gt;) of the keypair you created earlier (&lt;code&gt;proxy-key-pair&lt;/code&gt;). Also make sure you replace &lt;code&gt;$SG_ID&lt;/code&gt; with the ID for the security group you created earlier, and &lt;code&gt;$SUBNET_ID&lt;/code&gt; with the subnet you identified before you began.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;notice&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ EC2 is fast, but not instant&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Although AWS can provision instances very quickly, it can &lt;em&gt;still&lt;/em&gt; take a couple minutes for the instance to come up, so be patient! You can wait for the instance on the CLI (if desired) by running the following command: &lt;code&gt;aws ec2 wait instance-status-ok --instance-ids $EC2_ID&lt;/code&gt;, where &lt;code&gt;$EC2_ID&lt;/code&gt; is the instance ID from the prior step.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Creating the instance isn’t the end of our work, however. You’ll still need to configure it to actually reverse proxy the traffic coming in from the internet to our local development machine. To that end, NGINX is a fantastic,battle-tested option. As soon the instance is ready, SSH into the box and install NGINX.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ sudo amazon-linux-extras install nginx1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;NGINX needs to be configured to use the AWS-assigned public DNS name, and proxy traffic from port 80 to you. Heres a sample config you can use:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;upstream tunnel {
  server 127.0.0.1:8080;
}

server {
  server_name PUBLIC_DNS;
  
  location / {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect off;
    
    proxy_pass http://tunnel;
  }
}&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--warning&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Don’t Forget&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Be sure to replace &lt;code&gt;PUBLIC_DNS&lt;/code&gt; with the AWS public DNS name. This is &lt;em&gt;not&lt;/em&gt; in the initial output from AWS, because the DNS name is not granted until the machine enters a running state. You can find itby running &lt;code&gt;aws ec2 describe-instances --instance-ids $EC2_ID&lt;/code&gt;, where &lt;code&gt;$EC2_ID&lt;/code&gt; is the ID of the machine you provisioned earlier. This ID &lt;em&gt;can&lt;/em&gt; be found in the outputwhen you created the instance by running &lt;code&gt;jq -r '.Instances[0].InstanceId' ec2-output.json&lt;/code&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Save the completed configuration as &lt;code&gt;/etc/nginx/conf.d/server.conf&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Additionally, NGINX doesn’t quite handle the lengthy public DNS names that AWS hands out, so you’ll need to increase &lt;code&gt;server_names_hash_bucket_size&lt;/code&gt; to the next power of 2, which is &lt;code&gt;128&lt;/code&gt;. To do this, add &lt;code&gt;server_names_hash_bucket_size 128&lt;/code&gt; to &lt;code&gt;/etc/nginx/nginx.conf&lt;/code&gt;, in the &lt;code&gt;http&lt;/code&gt; section.&lt;/p&gt;
&lt;p&gt;Now that NGINX is configured, start it, and exit your SSH session.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ sudo service nginx start

...

❯ exit&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;using-the-proxy&quot;&gt;Using the Proxy&lt;/h3&gt;
&lt;p&gt;Now that the instance is configured, all you will need to do to allow the internet at large to connect to a service running on your local box is to use an &lt;code&gt;ssh&lt;/code&gt; reverse proxy to get data from AWS to your local machine! Start one up like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ ssh -i key.pem -R 8080:localhost:$LOCAL_PORT ec2-user@$PUBLIC_DNS&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--warning&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Don’t Forget&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Replace &lt;code&gt;$LOCAL_PORT&lt;/code&gt; with the port your application is running on, and &lt;code&gt;$PUBLIC_DNS&lt;/code&gt; with the AWS-assigned public DNS name, like you did for the NGINX config.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Once that is up, all you need to do is simply share the AWS public DNS name with anybody you want to allow into your locally-hosted website!&lt;/p&gt;
&lt;h2 id=&quot;teardown&quot;&gt;Teardown&lt;/h2&gt;
&lt;p&gt;Although you can leave the proxy up for as long as you like, you’ll likely need to tear it down eventually. If you have AWS console access, simply terminate the instance, delete the security group, and delete the keypair. If you saved the IDs of these resources (they are in the JSON responses from earlier), you can also do it via the command line:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ aws ec2 terminate-instances --no-cli-pager --instance-ids $EC2_ID &amp;gt; /dev/null

❯ aws ec2 delete-key-pair --no-cli-pager --key-pair-id $KEY_ID &amp;amp;&amp;amp; \
  aws ec2 delete-security-group --no-cli-pager --group-id $SG_ID&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that the instance could take a couple minutes to finish terminating. You will not be able to remove the key or security group before the instance has been terminated.&lt;/p&gt;
&lt;h2 id=&quot;create-using-earthly&quot;&gt;Create using Earthly&lt;/h2&gt;
&lt;p&gt;If you don’t want to deal with manual setup or teardown, we’ve created an &lt;code&gt;Earthfile&lt;/code&gt; that should automate all of this for you. It can create a proxy just like this, from scratch, in under five minutes! To start up a proxy using &lt;code&gt;earthly&lt;/code&gt;, execute this &lt;em&gt;single&lt;/em&gt; command.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;❯ earthly \
  --secret-file config=/home/user/.aws/config \
  --secret-file credentials=/home/dchw/.aws/credentials \
  --build-arg AWS_REGION=my_region \
  --build-arg SUBNET_ID=my_subnet \
  github.com/earthly/example-diy-ngrok:main+build-proxy&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ AWS Credentials&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The reason you’ll need to pass the credentials, is so that our scripts can use them to construct the proxy. If you are uncomfortable passing credentials to a remote target, feel free to clone and inspect the repository before using it. You could also simplify this by trying out Earthly’s experimental &lt;a href=&quot;https://docs.earthly.dev/guides/cloud-secrets&quot;&gt;cloud-based secrets.&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;notice--warning&quot; data-markdown=&quot;1&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Don’t Forget&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Replace the following:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;/home/user&lt;/code&gt; with the directory of the AWS configuration directory (&lt;code&gt;.aws&lt;/code&gt;)&lt;br /&gt;
&lt;code&gt;my-region&lt;/code&gt; with the AWS region you use.&lt;br /&gt;
&lt;code&gt;my-subnet&lt;/code&gt; with the ID of the subnet you would like to use.&lt;/p&gt;
&lt;p&gt;If you need to use temporary role-based credentials, add &lt;code&gt;--build-arg AWS_PROFILE=my_profile&lt;/code&gt;, where the profile is the one to assume when creating the resources.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Building this container will construct a proxy in the same manner detailed earlier, but with a few extra benefits:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Allows you to retrieve the generated SSH key&lt;/li&gt;
&lt;li&gt;Automated teardown of the constructed proxy&lt;/li&gt;
&lt;li&gt;Sample SSH Command for proxying&lt;/li&gt;
&lt;li&gt;A list of all IDs for all resources created&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To see everything it can do, run &lt;code&gt;docker run proxy:latest&lt;/code&gt; for a list.&lt;/p&gt;
&lt;h2 id=&quot;shortcomings&quot;&gt;Shortcomings&lt;/h2&gt;
&lt;p&gt;This approach to a free, simple ngrok alternative isn’t without its shortcomings. For instance, it can’t do &lt;code&gt;https&lt;/code&gt; without a self-signed certificate, because issuers like Let’s Encrypt won’t issue certificates for AWS public DNS names. Also, it can’t handle a ton of traffic since its a small &lt;code&gt;t2.micro&lt;/code&gt; capped at low bandwidth.&lt;/p&gt;
&lt;p&gt;It also requires non-trivial IAM permissions in AWS to setup and teardown. If you don’t have that kind of access to an account, you may end up waiting on others to set it up for you.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Turns out it’s pretty simple to get something basic up and running, just like &lt;code&gt;ngrok&lt;/code&gt; does. But, if you find yourself relying on this kind of tooling every day, it may be better to pay for a service that can do it better.&lt;/p&gt;
&lt;p&gt;Thanks for following along with us! &lt;a href=&quot;https://github.com/earthly/example-diy-ngrok&quot;&gt;Visit the example repository, with all scripts avaliable here.&lt;/a&gt;&lt;/p&gt;
&lt;!--kg-card-end: markdown--&gt;</content><author><name>Corey Larson</name></author><category term="Tutorials" /><summary type="html">Ngrok is a tool that allows you to create secure, publically accessible URLs for your locally running code.</summary></entry><entry><title type="html">Understanding Docker Logging and Log Files</title><link href="https://earthly.dev/blog/understanding-docker-logging-and-log-files/" rel="alternate" type="text/html" title="Understanding Docker Logging and Log Files" /><published>2021-03-10T00:00:00-05:00</published><updated>2021-03-10T00:00:00-05:00</updated><id>https://earthly.dev/blog/understanding-docker-logging-and-log-files</id><content type="html" xml:base="https://earthly.dev/blog/understanding-docker-logging-and-log-files/">&lt;p&gt;Docker logging and its management are an important part of the containerization of your application. Once you’ve deployed your application, logging is one of the best tools to help reveal errors, aid in debugging, and optimize your application’s performance.&lt;/p&gt;
&lt;p&gt;With that in mind, let’s dive into Docker logging and its log files.&lt;/p&gt;
&lt;h2 id=&quot;introduction-to-docker-logging&quot;&gt;Introduction to Docker Logging&lt;/h2&gt;
&lt;p&gt;Developers, DevOps professionals, and product stakeholders all apply knowledge gained from logging to improve a system’s performance and reliability. Much of what an application, server, or OS does should be recorded in the logs and aggregated in an easily accessible location. A &lt;a href=&quot;https://www.sumologic.com/glossary/log-analysis/&quot;&gt;log analysis&lt;/a&gt; then uses all the log events and audit trails to help chalk out a clear picture of events that happen across your application.&lt;/p&gt;
&lt;p&gt;In &lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt;, containers are isolated and bundled with software, libraries, and configuration files. In a traditional single-server setup log analysis is centralized on a single node, but with a stateless containerized setup logging becomes more complex. Why? Two reasons:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. Containers are transient.&lt;/strong&gt; When a Docker container broadcasts logs, it sends them to the application’s &lt;code&gt;stdout&lt;/code&gt; and &lt;code&gt;stderr&lt;/code&gt; output streams. The underlying container logging driver can start accessing these streams, and the logs are stored on the Docker host in JSON files (&lt;a href=&quot;https://docs.docker.com/config/containers/logging/json-file/&quot;&gt;&lt;code&gt;json-file&lt;/code&gt; is the default logging driver used by Docker&lt;/a&gt;). It writes JSON-formatted logs to a file on the host where the container is running. Any logs stored in the container will be deleted when it is terminated or shut down.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. Containers are multileveled.&lt;/strong&gt; There are two levels of aggregation in Docker logging. One refers to the logs from inside the container in your Dockerized application, and the second refers to the logs from the host servers (eg, system logs, Docker daemon logs), which are generally located in &lt;code&gt;/var/log&lt;/code&gt;. A log aggregator that has access to the host pulls application log files and accesses the file system inside the container to collect the logs. Later, you’d need to correlate these log events for analysis.&lt;/p&gt;
&lt;p&gt;In this article, you’ll learn about different logging strategies you can use in a Dockerized application—how you can access logs and understand Docker logging commands, drivers, configuration, and management to build a highly performant and reliable infrastructure.&lt;/p&gt;
&lt;h2 id=&quot;docker-logging-commands&quot;&gt;Docker Logging Commands&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;docker logs&lt;/code&gt; is a command that shows all the information logged by a running container. The &lt;code&gt;docker service logs&lt;/code&gt; command shows information logged by all the containers participating in a service. By default, the output of these commands, as it would appear if you run the command in a terminal, opens up three I/O streams: STDIN, STDOUT, and STDERR. And the default is set to show only STDOUT and STDERR.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;STDIN is the command’s input stream, which may include input from the keyboard or input from another command.&lt;/li&gt;
&lt;li&gt;STDOUT is usually a command’s normal output.&lt;/li&gt;
&lt;li&gt;STDERR is typically used to output error messages.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;code&gt;docker logs&lt;/code&gt; command may not be useful in cases when a logging driver is configured to send logs to a file, database, or an external host/backend, or if the image is configured to send logs to a file instead of STDOUT and STDERR. With &lt;code&gt;docker logs &amp;lt;CONTAINER_ID&amp;gt;&lt;/code&gt;, you can see all the logs broadcasted by a specific container identified by a unique ID.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker run &lt;span class=&quot;at&quot;&gt;--name&lt;/span&gt; test &lt;span class=&quot;at&quot;&gt;-d&lt;/span&gt; busybox sh &lt;span class=&quot;at&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;while true; do &lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; date&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;; sleep 1; done&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; date&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Tue&lt;/span&gt; 06 Feb 2020 00:00:00 UTC&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker logs &lt;span class=&quot;at&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--until&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;2s test&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Tue&lt;/span&gt; 06 Feb 2020 00:00:00 UTC&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Tue&lt;/span&gt; 06 Feb 2020 00:00:01 UTC&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Tue&lt;/span&gt; 06 Feb 2020 00:00:02 UTC&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;docker logs&lt;/code&gt; works a bit differently in community and enterprise versions. In Docker Enterprise, &lt;code&gt;docker logs&lt;/code&gt; read logs created by any logging driver, but in Docker CE, it can only read logs created by the json-file, local, and journald drivers.&lt;/p&gt;
&lt;p&gt;For example, here’s the JSON log created by the &lt;a href=&quot;https://hub.docker.com/_/hello-world&quot;&gt;hello-world&lt;/a&gt; Docker image using the json-file driver:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;log&amp;quot;&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;Hello from Docker!\n&amp;quot;&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;stream&amp;quot;&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;stdout&amp;quot;&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;time&amp;quot;&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;2021-02-10T00:00:00.000000000Z&amp;quot;&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see, the log follows a pattern of printing:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Log’s origin&lt;/li&gt;
&lt;li&gt;Either &lt;code&gt;stdout&lt;/code&gt; or &lt;code&gt;stderr&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;A timestamp&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can find this log in your Docker host at:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; /var/lib/docker/containers/&lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;/&lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;-json.log  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These Docker logs are stored in a host container and will build up over time. To address that, you can implement log rotation, which will remove a chunk of logs at specified intervals, and a log aggregator, which can be used to push them into a centralized location for a permanent log repository. You can use this repository for further analysis and improvements in the system down the road.&lt;/p&gt;
&lt;p&gt;To find &lt;code&gt;container_id&lt;/code&gt;, run the &lt;code&gt;docker ps&lt;/code&gt; command. It’ll list all the running containers.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker ps&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;CONTAINER&lt;/span&gt; ID   IMAGE       COMMAND             CREATED             STATUS              PORTS     NAMES&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;cg95e1yqk810&lt;/span&gt;   bar_image  &lt;span class=&quot;st&quot;&gt;&amp;quot;node index.js&amp;quot;&lt;/span&gt;     Y min ago           Up Y min            80/tcp     bar_app&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then, the &lt;code&gt;docker logs container_id&lt;/code&gt; lists the logs for a particular container.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker logs &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container_id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you want to follow the Docker container logs:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker logs &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container_id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; -f&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you want to see the last N log lines:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker logs &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container_id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; --tail N&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you only want to see any specific logs, use &lt;code&gt;grep&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker logs &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container_id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;grep&lt;/span&gt; node&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you want to check errors:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker logs &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;container_id&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-i&lt;/span&gt; error&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;logging-drivers-supported-by-docker&quot;&gt;Logging Drivers Supported by Docker&lt;/h2&gt;
&lt;p&gt;Logging drivers, or log-drivers, are mechanisms for getting information from running containers and services, and Docker has lots of them available for you. Every Docker daemon has a default logging driver, which each container uses. Docker uses the json-file logging driver as its default driver.&lt;/p&gt;
&lt;p&gt;Currently, Docker supports the following logging drivers:&lt;/p&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 43%&quot; /&gt;
&lt;col style=&quot;width: 56%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th style=&quot;text-align: center;&quot;&gt;Driver&lt;/th&gt;
&lt;th style=&quot;text-align: center;&quot;&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;none&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;No logs are available for the container and Docker logs do not return any output.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/local/&quot;&gt;local&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Logs are stored in a custom format designed for minimal overhead.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/json-file/&quot;&gt;json-file&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Logs are formatted as JSON. The default logging driver for Docker.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/syslog/&quot;&gt;syslog&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes logging messages to the Syslog facility. The Syslog daemon must be running on the host machine.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/journald/&quot;&gt;journald&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to journald. The journald daemon must be running on the host machine.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/gcplogs/&quot;&gt;gcplogs&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to Google Cloud Platform (GCP) logging.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/awslogs/&quot;&gt;awslogs&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to Amazon CloudWatch logs.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/splunk/&quot;&gt;splunk&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to Splunk using the HTTP Event Collector.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/gelf/&quot;&gt;gelf&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to a Graylog Extended Log Format (GELF) endpoint, such as Graylog or Logstash.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/fluentd/&quot;&gt;fluentd&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to fluentd (forward input). The fluentd daemon must be running on the host machine.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/etwlogs/&quot;&gt;etwlogs&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages as Event Tracing for Windows (ETW) events. Only available on Windows platforms.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;&lt;strong&gt;&lt;a href=&quot;https://docs.docker.com/config/containers/logging/logentries/&quot;&gt;logentries&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;Writes log messages to Rapid7 Logentries.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;configuring-the-logging-driver&quot;&gt;Configuring the Logging Driver&lt;/h3&gt;
&lt;p&gt;To configure the Docker daemon to a logging driver, you need to set the value of &lt;code&gt;log-driver&lt;/code&gt; to the name of the logging driver in the daemon.json configuration file. Then you need to restart Docker for the changes to take effect for all the newly created containers. All the existing containers will remain as they are.&lt;/p&gt;
&lt;p&gt;For example, let’s set up a default logging driver with some additional options.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode json&quot;&gt;&lt;code class=&quot;sourceCode json&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;&amp;quot;log-driver&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;json-file&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;&amp;quot;log-opts&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;max-size&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;25m&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;max-file&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;10&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-6&quot;&gt;&lt;a href=&quot;#cb10-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;labels&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;production_bind&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-7&quot;&gt;&lt;a href=&quot;#cb10-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;env&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;os,customer&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-8&quot;&gt;&lt;a href=&quot;#cb10-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-9&quot;&gt;&lt;a href=&quot;#cb10-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To find the current logging driver for the Docker daemon:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker info &lt;span class=&quot;at&quot;&gt;--format&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;{{.LoggingDriver}}&amp;#39;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;json-file&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can override the default driver by adding the &lt;code&gt;--log-driver&lt;/code&gt; option to the docker run command that creates a container.&lt;/p&gt;
&lt;p&gt;The following command will start using the Splunk driver:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; run &lt;span class=&quot;at&quot;&gt;--log-driver&lt;/span&gt; splunk httpd&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify the &lt;code&gt;daemon.json&lt;/code&gt; file, to pass the address of the splunk host to the driver:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode json&quot;&gt;&lt;code class=&quot;sourceCode json&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;log-driver&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;splunk&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;log-opts&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;splunk-url&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;172.1.1.1:11111&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker inspect &lt;span class=&quot;at&quot;&gt;-f&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;{{.HostConfig.LogConfig.Type}}&amp;#39;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;CONTAINER&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;splunk&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;choosing-the-delivery-mode-of-log-messages-from-container-to-log-driver&quot;&gt;Choosing the Delivery Mode of Log Messages From Container to Log Driver&lt;/h3&gt;
&lt;p&gt;Docker provides two modes for delivering log messages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Blocking (default):&lt;/strong&gt; The container interrupts the application every time it needs to deliver a message to the driver. This will add latency in the performance of your application (for some drivers), but it’ll guarantee that all the messages will be sent to the driver. Case in point, the json-file driver writes logs very quickly, therefore it’s unlikely to cause latency. But drivers like &lt;code&gt;gcplogs&lt;/code&gt; and &lt;code&gt;awslogs&lt;/code&gt; open a connection to a remote server and so are more likely to block and cause latency.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;Non-Blocking:&lt;/strong&gt; The container writes and stores its logs to an in-memory ring buffer until the logging driver is available to process them. This ensures that a high rate of logging will not affect application performance. It does not guarantee that all the messages will be sent to the driver. In cases where log broadcasts are faster than the driver processor, the ring buffer will soon run out of space. As a result, buffered logs are deleted to make space for the next set of incoming logs. The default value for &lt;code&gt;max-buffer-size&lt;/code&gt; is 1 MB.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To change the mode:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode json&quot;&gt;&lt;code class=&quot;sourceCode json&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;log-driver&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;splunk&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;log-opts&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-4&quot;&gt;&lt;a href=&quot;#cb15-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;splunk-url&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;172.1.1.1:11111&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-5&quot;&gt;&lt;a href=&quot;#cb15-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;mode&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;non-blocking&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-6&quot;&gt;&lt;a href=&quot;#cb15-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-7&quot;&gt;&lt;a href=&quot;#cb15-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;understanding-logging-strategies&quot;&gt;Understanding Logging Strategies&lt;/h2&gt;
&lt;p&gt;Docker logging effectively means logging the events of an application, host OS, and the respective Docker service. There are a few defined logging strategies you should keep in mind when working with containerized apps.&lt;/p&gt;
&lt;h3 id=&quot;application-logging&quot;&gt;1. Application Logging&lt;/h3&gt;
&lt;p&gt;In this logging strategy, the application running in the containers will have its own logging framework. For example, a Node.js app could use a &lt;a href=&quot;https://www.npmjs.com/package/winston&quot;&gt;&lt;code&gt;winston&lt;/code&gt;&lt;/a&gt; library to format and send the logs. With this approach, you have complete control over the logging event.&lt;/p&gt;
&lt;p&gt;If you have multiple containers, you need to add an identifier at each container level, so you can uniquely determine the container and its respective logs. But as the size of the logs increases, this will start creating a load on the application process. Due to the transient nature of containers, the logs will be wiped out when a container is terminated or shut down.&lt;/p&gt;
&lt;p&gt;To address this, you have two options: - Configure steady storage to hold these logs, i.e. disks/data volumes. - Forward these logs to a log management solution.&lt;/p&gt;
&lt;h3 id=&quot;data-volumes&quot;&gt;2. Data Volumes&lt;/h3&gt;
&lt;p&gt;In this logging strategy, your container’s directory gets links to one of the host machine directories that will hold all the data for you. Containers can now be terminated or shut down, and access logs from multiple containers.&lt;/p&gt;
&lt;p&gt;A regular backup is a good idea in order to prevent data corruption or loss in case of a failure. But if you want to shift the containers on different hosts without loss of data, then the data volumes strategy will make that difficult.&lt;/p&gt;
&lt;h3 id=&quot;docker-logging-driver&quot;&gt;3. Docker Logging Driver&lt;/h3&gt;
&lt;p&gt;Docker has a bunch of logging drivers that can be used in your logging strategy. The configured driver reads the data broadcast by the container’s &lt;code&gt;stdout&lt;/code&gt; or &lt;code&gt;stderr&lt;/code&gt; streams and writes it to a file on the host machine. By default, the host machine holds the log files, but you can forward these events using the available drivers, like fluentd, Splunk, and awslogs.&lt;/p&gt;
&lt;p&gt;Note that the &lt;code&gt;docker log&lt;/code&gt; command will not work if you use anything other than the &lt;code&gt;json-file&lt;/code&gt; driver. And if log forwarding over a TCP connection fails or becomes unreachable, the containers will shut down.&lt;/p&gt;
&lt;h3 id=&quot;dedicated-logging-container&quot;&gt;4. Dedicated Logging Container&lt;/h3&gt;
&lt;p&gt;Here, you need to set up a dedicated container whose only job is to collect and manage logs within a Docker ecosystem. It’ll aggregate, monitor, and analyze logs from containers and forward them to a central repository. The log dependency on the host machine is no longer an issue, and it’s best suited for microservices architecture.&lt;/p&gt;
&lt;p&gt;This strategy gives you the freedom to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Move containers between the hosts.&lt;/li&gt;
&lt;li&gt;Scale up by just adding a new container.&lt;/li&gt;
&lt;li&gt;Tie up all the various streams of log events.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;sidecar-logging-container&quot;&gt;5. Sidecar Logging Container&lt;/h3&gt;
&lt;p&gt;This logging strategy is similar to dedicated logging in that you have a container to hold logs, but here, each application has its own dedicated logging container (note that the application and its log container can be considered as a single unit). This opens up the flexibility of app-level logging customization. By adding custom identifiers, you can identify the specific container that broadcasts the log.&lt;/p&gt;
&lt;p&gt;This is best suited for a complex system where each entity customizes the logs, making it popular in microservices deployment. Maintaining a container per application level will require additional resources for management and setup, so it’s complex to implement. Also, you may end up losing data when a container from the unit becomes unserviceable.&lt;/p&gt;
&lt;h3 id=&quot;third-party-logging-services&quot;&gt;6. Third-party Logging Services&lt;/h3&gt;
&lt;p&gt;There are a lot of third-party logging services you can use according to your infrastructure and application needs, enabling you to aggregate, manage, and analyze logs and take proactive preventative actions as a result.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;http://www.splunk.com/&quot;&gt;Splunk&lt;/a&gt;:&lt;/strong&gt; Splunk is built to scale from a single server to multiple data centers. It has built-in alerting and reporting, real-time search, analysis, and visualization, which helps you take action against malfunctions faster. It comes with a Splunk Enterprise on-premise deployment and Splunk Cloud. The free plan comes with 500 MB data per day, and the paid plan starts from $150 a month for a GB.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https://github.com/elastic/logstash&quot;&gt;Logstash&lt;/a&gt;:&lt;/strong&gt; Logstash is part of the &lt;a href=&quot;https://www.elastic.co/products&quot;&gt;Elastic Stack&lt;/a&gt; along with Beats, Elasticsearch, and Kibana. It’s a server-side data processing pipeline that ingests data from a multitude of sources simultaneously, transforms it, and then sends it to your favourite “stash.” Logstash has over 200 plugins for input, filter/transform, and output. It’s free and open source.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;http://www.fluentd.org/&quot;&gt;Fluentd&lt;/a&gt;:&lt;/strong&gt; Fluentd is an open-source data collector. Its performance has been well proven, handling 5 TB of daily data, 50,000 messages/sec at peak time. The main reason to use it would be performance. It’s free and open source.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https://www.papertrail.com/&quot;&gt;PaperTrail&lt;/a&gt;:&lt;/strong&gt; PaperTrail is a simple and user-friendly service that provides a terminal-like experience. Once the data is sent over the syslog, you can perform tail and search operations with the PaperTrail UI. It’s affordable for low volumes but becomes expensive for higher volume. It comes with a free 50 MB/month plan, and paid plans start at $7/month for 1 GB per month.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;https://www.loggly.com/&quot;&gt;Loggly&lt;/a&gt;:&lt;/strong&gt; Loggly focuses on simplicity and ease of use for a DevOps audience. It’s one of the more robust log analyzers. Primary use cases are for troubleshooting and customer support scenarios, and it provides richer visualizations and more parsing functionality than PaperTrail. It comes with a free 200 MB/day, and paid plans start at $79 a month for 1 GB per day ingestion with a 2 weeks retention.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;limitations-and-challenges-of-docker-logging&quot;&gt;Limitations and Challenges of Docker Logging&lt;/h2&gt;
&lt;p&gt;Docker makes containerized application deployment easier, faster, and streamlines it with limited resources. Log management and analysis are handled differently with Docker as compared to a traditional system, which introduces a new set of challenges and limitations. From storing logs in a file system to forwarding them to a central repository, Docker logging has some pain points you’ll need to overcome with a deeper understanding of Docker capability.&lt;/p&gt;
&lt;h3 id=&quot;the-only-compatible-driver-is-json-file&quot;&gt;The Only Compatible Driver Is json-file&lt;/h3&gt;
&lt;p&gt;The json-file driver is the only one that works with the &lt;code&gt;docker logs&lt;/code&gt; command, a limitation of Docker logs. When you start using any other logging drivers, such as Fluentd or Splunk, the &lt;code&gt;docker logs&lt;/code&gt; command shows an error and the Docker logs API calls will fail. Also, you won’t be able to check the container logs in this situation.&lt;/p&gt;
&lt;h3 id=&quot;docker-syslog-impacts-container-deployment&quot;&gt;Docker Syslog Impacts Container Deployment&lt;/h3&gt;
&lt;p&gt;The reliable way to deliver logs is via Docker Syslog with TCP or TLS. But this driver needs an established TCP connection to the Syslog server whenever a container starts up. And the container will fail ife a connection is not made.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb16&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb16-1&quot;&gt;&lt;a href=&quot;#cb16-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker: Error response from daemon: Failed to initialize logging driver: dial tcp&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Your container deployment will be affected if you face network problems or latency issues. And it’s not recommended that you restart the Syslog server because this will drop all the connections from the containers to a central Syslog server.&lt;/p&gt;
&lt;h3 id=&quot;potential-loss-of-logs-with-docker-syslog-driver&quot;&gt;Potential Loss of Logs with Docker Syslog Driver&lt;/h3&gt;
&lt;p&gt;The Docker syslog driver needs an established TCP or TLS connection to deliver logs. Note that when the connection is down or not reachable, you’ll start losing the logs until the connection reestablished.&lt;/p&gt;
&lt;h3 id=&quot;multiline-logs-not-supported&quot;&gt;Multiline Logs Not Supported&lt;/h3&gt;
&lt;p&gt;Generally, either of two patterns is followed for logging: single-line per log or multiple lines with extended information per log, like stack traces or exceptions. But with Docker logging, this is a moot point, because containers always broadcast logs to the same output: &lt;code&gt;stdout&lt;/code&gt;. ### Multiple Logging Drivers Not Supported It’s mandatory that you use only a single driver for all of your logging needs. Scenarios where you can store logs locally and push it to remote servers are not supported.&lt;/p&gt;
&lt;h3 id=&quot;logs-can-miss-or-skip&quot;&gt;Logs Can Miss or Skip&lt;/h3&gt;
&lt;p&gt;There’s a rate limitation setting at the Docker end for journald drivers that takes care of the rate that logs get pushed. If it exceeds, then the driver might skip some logs. To prevent such issues, increase the rate limitation settings according to your logging needs.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;While Docker containerization allows developers to encapsulate a program and its file system into a single portable package, that certainly doesn’t mean containerization is free of maintenance. Docker Logging is a bit more complex than traditional methods, so teams using Docker must familiarize themselves with the Docker logging to support full-stack visibility, troubleshooting, performance improvements, root cause analysis, etc.&lt;/p&gt;
&lt;p&gt;As we have seen in this post, to facilitate logging, Docker offers logging drivers and commands in the platform which gives you the mechanisms for accessing the performance data and also provides plugins to integrate with third-party logging tools as well. To maximize the logging capabilities there are several methods and strategies which help in designing your logging infrastructure, but each comes with its advantages and disadvantages.&lt;/p&gt;
&lt;p&gt;With this understanding of logging, containerization can be a powerful tool. Earthly is a containerized &lt;a href=&quot;https://earthly.dev/&quot;&gt;continuous integration tool&lt;/a&gt;. If you’ve ever had to deal with flaky builds you should &lt;a href=&quot;https://earthly.dev/&quot;&gt;check it out&lt;/a&gt;.&lt;/p&gt;</content><author><name>Sanket Makhija</name></author><category term="Tutorials" /><category term="docker" /><category term="tutorials" /><summary type="html">Docker logging and its management are an important part of the containerization of your application. Once you’ve deployed your application, logging is one of the best tools to help reveal errors, aid in debugging, and optimize your application’s performance.</summary></entry><entry><title type="html">How to Setup and Use Amazon’s Elastic Container Registry</title><link href="https://earthly.dev/blog/how-to-setup-and-use-amazons-elastic-container-registry/" rel="alternate" type="text/html" title="How to Setup and Use Amazon’s Elastic Container Registry" /><published>2021-03-05T00:00:00-05:00</published><updated>2021-03-05T00:00:00-05:00</updated><id>https://earthly.dev/blog/how-to-setup-and-use-amazons-elastic-container-registry</id><content type="html" xml:base="https://earthly.dev/blog/how-to-setup-and-use-amazons-elastic-container-registry/">&lt;p&gt;A container is a simple unit that packages all your code and its dependencies so your application can run quickly and reliably from any computing environment. That means you could quickly move from your local environment to your staging and into production. Due to their portability, small size, and convenience, containers are becoming &lt;a href=&quot;https://www.cio.com/article/3434010/more-enterprises-are-using-containers-here-s-why.html&quot;&gt;a method of choice&lt;/a&gt; for shipping modern applications.&lt;/p&gt;
&lt;p&gt;Containers are created from a read-only template called an &lt;em&gt;Image&lt;/em&gt;. These images need to be stored somewhere so they can be retrieved by any machine authorized to use them. That’s where a container registry comes in.&lt;/p&gt;
&lt;h2 id=&quot;docker-hub-where-many-start&quot;&gt;Docker Hub: Where Many Start&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.docker.com/&quot;&gt;Docker&lt;/a&gt; is one of the most well-known pieces of software for working with containerized applications. To help with the storage issue, Docker created &lt;a href=&quot;https://hub.docker.com/&quot;&gt;Docker Hub&lt;/a&gt; - the world’s largest container registry - where developers can share and download pre-built images from others.&lt;/p&gt;
&lt;p&gt;While Docker Hub is still the most common option, it’s lost a bit of steam since the company started restricting free public repositories to just &lt;a href=&quot;https://cloudonaut.io/amazon-ecr-vs-docker-hub-vs-github-container-registry/&quot;&gt;a few hundred pulls every 6 hours&lt;/a&gt;. Docker Hub also offers some of the same features that ECR does (image scanning, team access) to paid users, but it’s likely to be much more expensive than Amazon ECR is when you’re starting out.&lt;/p&gt;
&lt;p&gt;Finally, the free Docker Hub plan has added a restrictive retention policy. They will delete any container images that haven’t been accessed within the last six months, so if you’re using Docker Hub for your side project that you update only occasionally, you might be surprised to find it suddenly gone one day.&lt;/p&gt;
&lt;h2 id=&quot;introducing-amazon-elastic-container-registry-ecr&quot;&gt;Introducing Amazon Elastic Container Registry (ECR)&lt;/h2&gt;
&lt;p&gt;Amazon ECR is a fully managed container registry offered as part of the AWS suite. Like Docker Hub, it makes storing, sharing, managing, and deploying your images easier, but it’s also likely to save you money - especially if you’re already using AWS. Simply push your images to ECR and pull the images using container management tool: &lt;a href=&quot;https://kubernetes.io/&quot;&gt;Kuberenetes&lt;/a&gt;, &lt;a href=&quot;https://docs.docker.com/compose/&quot;&gt;Docker Compose&lt;/a&gt;, &lt;a href=&quot;https://aws.amazon.com/ecs&quot;&gt;ECS&lt;/a&gt;, &lt;a href=&quot;https://aws.amazon.com/eks&quot;&gt;EKS&lt;/a&gt;, etc.&lt;/p&gt;
&lt;h3 id=&quot;pricing&quot;&gt;Pricing&lt;/h3&gt;
&lt;p&gt;Generally, public repositories are suitable for open-source developers sharing their work with the world for free. In contrast, private repositories are used by companies to share proprietary images of their internal software. Depending on the privacy level you need, here’s how AWS charges for ECR:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Private Repositories&lt;/strong&gt;: As a part of the AWS free tier, you get 500 MB of storage for one year for private repositories. Beyond that, the storage cost is $0.10 per GB-month of data storage for private repositories.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Public Repositories&lt;/strong&gt;: ECR offers 50 GB-month of free storage and 500 GB to 5 TB (depending on whether you authenticate with AWS or not) for public repositories. Beyond that, the storage cost is $0.10 per GB-month of data storage.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There may be additional costs depending on your region and usage, so be sure to check the pricing &lt;a href=&quot;https://aws.amazon.com/ecr/pricing/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;why-ecr&quot;&gt;Why ECR?&lt;/h3&gt;
&lt;p&gt;If you’re already bought into the Amazon ecosystem, ECR is an obvious choice for your container registry as you won’t have to add a new service to your budget. Besides saving you money, ECR integrates with other standard AWS services, which will hopefully improve developer experience as well.&lt;/p&gt;
&lt;h3 id=&quot;iam-identity-and-access-management&quot;&gt;&lt;a href=&quot;https://aws.amazon.com/iam&quot;&gt;IAM (Identity and Access Management)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.aws.amazon.com/AmazonECR/latest/userguide/repository-policies.html&quot;&gt;ECR integrates with IAM&lt;/a&gt; to configure policies and manage and control access to your images. This means you won’t have to share credentials or manage permissions individually for each repository.&lt;/p&gt;
&lt;h3 id=&quot;eks-elastic-kubernetes-service&quot;&gt;&lt;a href=&quot;https://aws.amazon.com/eks&quot;&gt;EKS (Elastic Kubernetes Service)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Kubernetes is a widely used container orchestration technology for automating deployments, networking, and scaling your application. Elastic Kubernetes Service is the AWS-managed Kubernetes platform.&lt;/p&gt;
&lt;p&gt;EKS allows you to run Kubernetes on AWS without maintaining your own &lt;a href=&quot;https://kubernetes.io/docs/concepts/overview/components/#control-plane-components&quot;&gt;Kubernetes control plane&lt;/a&gt;. You define a manifest file, and the Kubernetes master node will schedule and run the deployments. As you’ll see later, you can use images hosted in ECR in this manifest file to easily deploy your workloads from your public or private repositories.&lt;/p&gt;
&lt;h3 id=&quot;ecs-elastic-container-service&quot;&gt;&lt;a href=&quot;https://aws.amazon.com/ecs&quot;&gt;ECS (Elastic Container Service)&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Like EKS, ECS is a container orchestration service that makes running, stopping, and managing containers on AWS resources easy. Without getting into all of the specifics, ECS is typically better for teams that want a simple but powerful way to run their containers, while EKS adds the flexibility and security options available in Kubernetes. To learn more about each of AWS’s container orchestration tools, read &lt;a href=&quot;https://aws.amazon.com/blogs/containers/amazon-ecs-vs-amazon-eks-making-sense-of-aws-container-services/&quot;&gt;this article on picking the right one&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;When integrating with ECR, ECS users simply have to &lt;a href=&quot;https://docs.aws.amazon.com/AmazonECR/latest/userguide/ECR_on_ECS.html&quot;&gt;add their images to a task definition&lt;/a&gt;. Task definitions are JSON files that describe each container that forms the application. These definitions are similar to Kubernetes manifest files but require their own format and options.&lt;/p&gt;
&lt;h2 id=&quot;using-elastic-container-registry&quot;&gt;Using Elastic Container Registry&lt;/h2&gt;
&lt;p&gt;If you’ve decided that ECR is the right option for your application, you’re ready to set up and start using it. In the remainder of this tutorial, I’ll walk you through the steps required to get started with ECR. I’ll show you how to push and pull images from ECR and how you can use your ECR images in EKS and ECS.&lt;/p&gt;
&lt;p&gt;Typically these steps will be run as part of your continuous integration workflow, but you can also run them locally to get more familiar with the required tooling before you automate them.&lt;/p&gt;
&lt;h3 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html&quot;&gt;AWS Credentials&lt;/a&gt; with permissions to interact with ECR.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://docs.docker.com/get-docker/&quot;&gt;Docker installed for your operating system&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;The &lt;a href=&quot;https://aws.amazon.com/cli/&quot;&gt;AWS CLI installed locally&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;creating-a-new-repository&quot;&gt;Creating a New Repository&lt;/h3&gt;
&lt;p&gt;Assuming you’ve already got an AWS account and permissions correctly configured, the easiest way to get started is to create a new ECR repository via the Amazon Web Services UI.&lt;/p&gt;
&lt;p&gt;Go to the &lt;a href=&quot;http://console.aws.amazon.com/ecr/get-started&quot;&gt;ECR homepage&lt;/a&gt; and click the &lt;em&gt;Get Started&lt;/em&gt; button.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/how-to-setup-and-use-amazons-elastic-container-registry/xX4GGwL.png&quot; alt=&quot;ECR landing page&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;ECR landing page&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;You will be taken to the &lt;em&gt;Create repository&lt;/em&gt; page, where you can enter all the details for your new repository.&lt;/p&gt;
&lt;h3 id=&quot;configuring-your-repository&quot;&gt;Configuring Your Repository&lt;/h3&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/how-to-setup-and-use-amazons-elastic-container-registry/SZrf8AQ.png&quot; alt=&quot;Amazon ECR repository creation menu&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Amazon ECR repository creation menu&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Choose a visibility (&lt;em&gt;Public&lt;/em&gt; or &lt;em&gt;Private&lt;/em&gt;), name the repository (ideally something short but self-explanatory), and below the name, select any of the other options you need:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;Tag immutability&lt;/em&gt; - Prevents the same tag from being pushed twice and overwriting a previous version of the tag.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;Scan on push&lt;/em&gt; - Your images will be scanned for security vulnerabilities each time a new tag is pushed.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;[KMS encryption}(https://medium.com/&lt;span class=&quot;citation&quot; data-cites=&quot;suprajaraman/aws-kms-all-about-keys-564245425ecc&quot;&gt;@suprajaraman/aws-kms-all-about-keys-564245425ecc&lt;/span&gt;)&lt;/em&gt; - Allows you to use AWS Key Management Service (KMS) to encrypt the images in this repository.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;Note: your final repository URL structure will be something like this:&lt;/em&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;account-id&amp;gt;.dkr.ecr.&amp;lt;account-region&amp;gt;.amazonaws.com/&amp;lt;repository-name&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Once your repository is configured, click &lt;em&gt;Create repository&lt;/em&gt; to initialize your ECR repository. If you want to create a public repository, you can follow the same steps but select &lt;code&gt;Pubic&lt;/code&gt; instead of &lt;code&gt;Private&lt;/code&gt;.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/how-to-setup-and-use-amazons-elastic-container-registry/XCZe4vX.png&quot; alt=&quot;Amazon ECR dashboard&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Amazon ECR dashboard&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;pushing-an-image-to-the-repository&quot;&gt;Pushing an Image to the Repository&lt;/h3&gt;
&lt;p&gt;Before publishing the Image to ECR, make sure you have Docker installed on your workstation and a project with a Dockerfile that’s ready to be built and pushed to ECR.&lt;/p&gt;
&lt;p&gt;If you don’t have a project ready, create a new file called &lt;code&gt;Dockerfile&lt;/code&gt; and enter the following (this is based on the official &lt;a href=&quot;https://hub.docker.com/_/alpine&quot;&gt;Docker &lt;code&gt;alpine:3.7&lt;/code&gt; image&lt;/a&gt;):&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM alpine:3.7
CMD echo &amp;#39;Hello world&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next, &lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html&quot;&gt;set up your AWS credentials on the CLI&lt;/a&gt; if you haven’t already:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;aws configure&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Paste your &lt;em&gt;AWS Access Key ID&lt;/em&gt; and &lt;em&gt;AWS Secret Access Key&lt;/em&gt;. This will allow your CLI instance access to your AWS account.&lt;/p&gt;
&lt;p&gt;If you’re using the CLI as part of your continuous integration workflow, you also have the option &lt;a href=&quot;https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html&quot;&gt;to use environment variables&lt;/a&gt; to securely store your credentials.&lt;/p&gt;
&lt;h3 id=&quot;adding-your-ecr-credentials-to-the-docker-cli&quot;&gt;Adding Your ECR Credentials to the Docker CLI&lt;/h3&gt;
&lt;p&gt;Next, you need Docker to be able to push images to your ECR repository. The &lt;a href=&quot;https://docs.docker.com/engine/reference/commandline/login/&quot;&gt;&lt;code&gt;docker login&lt;/code&gt; command&lt;/a&gt; will allow you to do this, so using the AWS CLI, retrieve your ECR password and pipe it into the Docker command:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;aws ecr get-login-password \
    --region &amp;lt;account-region&amp;gt; \
| docker login \
    --username AWS \
    --password-stdin &amp;lt;account-id&amp;gt;.dkr.ecr.&amp;lt;account-region&amp;gt;.amazonaws.com/&amp;lt;repository-name&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After authentication, you will see &lt;code&gt;Login Succeeded&lt;/code&gt; as a response. Now you’ll be able to push tagged images to your ECR repository.&lt;/p&gt;
&lt;p&gt;If you are pushing or pulling images from this machine regularly, you may not want to go through this login process every time. Instead of using &lt;code&gt;docker login&lt;/code&gt;, you can configure the &lt;a href=&quot;https://github.com/awslabs/amazon-ecr-credential-helper&quot;&gt;Amazon ECR Docker Credential Helper&lt;/a&gt; to give the Docker daemon direct access to your AWS credentials. This method is also convenient for CI environments because it automates the authentication process and caches tokens to minimize your risk of being throttled.&lt;/p&gt;
&lt;h3 id=&quot;pushing-an-image-to-ecr&quot;&gt;Pushing an Image to ECR&lt;/h3&gt;
&lt;p&gt;Next, build the image from your Dockerfile:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker build -t &amp;lt;image-name&amp;gt;:&amp;lt;image-version&amp;gt; .&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then, tag the image with your ECR repository name:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker tag &amp;lt;image-name&amp;gt;:&amp;lt;image-version&amp;gt; &amp;lt;account-id&amp;gt;.dkr.ecr.&amp;lt;account-region&amp;gt;.amazonaws.com/&amp;lt;repository-name&amp;gt;:&amp;lt;image-version&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Your image is now ready to push to ECR:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker push &amp;lt;account-id&amp;gt;.dkr.ecr.&amp;lt;account-region&amp;gt;.amazonaws.com/&amp;lt;repository-name&amp;gt;:&amp;lt;image-version&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And just like that, you have pushed our first image to a repository on Elastic Container Registry. In the next section, you’ll see how you can use these images for local or remote deployments.&lt;/p&gt;
&lt;h3 id=&quot;pulling-an-image-from-ecr&quot;&gt;Pulling an Image from ECR&lt;/h3&gt;
&lt;p&gt;Whether you want to pull an image from a public ECR repository or your company has private images stored in ECR, pulling works in the same way it does in any container registry. After you’ve authenticated (using the same steps above), you can use &lt;a href=&quot;https://docs.docker.com/engine/reference/commandline/pull/&quot;&gt;&lt;code&gt;docker pull&lt;/code&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull &amp;lt;account-id&amp;gt;.dkr.ecr.&amp;lt;account-region&amp;gt;.amazonaws.com/&amp;lt;repository-name&amp;gt;:&amp;lt;image-version&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now you can run this image locally.&lt;/p&gt;
&lt;h3 id=&quot;using-ecr-images-in-a-dockerfile&quot;&gt;Using ECR Images in a Dockerfile&lt;/h3&gt;
&lt;p&gt;If you are building a new application from a base image stored in ECR, you can use the &lt;code&gt;FROM&lt;/code&gt; command in your Dockerfile just as you would with any other Docker image. For example:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM: &amp;lt;account-id&amp;gt;.dkr.ecr.&amp;lt;account-region&amp;gt;.amazonaws.com/&amp;lt;repository-name&amp;gt;:&amp;lt;image-version&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Again, you’ll need to be authenticated if you want to build an image off a private image in ECR, but this allows you to share base images with your team or the public.&lt;/p&gt;
&lt;h3 id=&quot;using-ecr-images-in-production-deployments&quot;&gt;Using ECR Images in Production Deployments&lt;/h3&gt;
&lt;p&gt;To use your images from ECR in a container management platform like ECS or EKS, simply add the name and tag of the image you want to use to the relevant configuration file.&lt;/p&gt;
&lt;h5 id=&quot;eks-manifest&quot;&gt;EKS Manifest&lt;/h5&gt;
&lt;p&gt;For example, you can use the following EKS manifest to deploy a NodeJS image stored in ECR:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1 
kind: Job 
metadata: 
    name: eks-iam-test-s3 
spec: template: 
    metadata: 
      labels: 
        app: eks-iam-test-s3 
    spec: 
      serviceAccountName: iam-test 
      containers: 
        - name: eks-iam-test 
          image: 123456789012.dkr.ecr.us-west-2.amazonaws.com/aws-nodejs-sample:v1 
          args: [&amp;quot;s3&amp;quot;, &amp;quot;ls&amp;quot;] 
      restartPolicy: Never&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;When deployed, it will create a job with the name &lt;code&gt;eks-iam-test-s3&lt;/code&gt; using the &lt;code&gt;123456789012.dkr.ecr.us-west-2.amazonaws.com/aws-nodejs-sample:v1&lt;/code&gt; image. To see the complete step-by-step process for deploying this job to EKS, see &lt;a href=&quot;https://docs.amazonaws.cn/en_us/AmazonECR/latest/userguide/ECR_on_EKS.html&quot;&gt;the AWS documentation here&lt;/a&gt;.&lt;/p&gt;
&lt;h5 id=&quot;ecs-task-definition&quot;&gt;ECS Task Definition&lt;/h5&gt;
&lt;p&gt;ECR images can also be used in ECS task definition files to define your containers:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
  &amp;quot;containerDefinitions&amp;quot;: [
    {
      &amp;quot;name&amp;quot;: &amp;quot;sample-app&amp;quot;,
      &amp;quot;image&amp;quot;: &amp;quot;123456789012.dkr.ecr.us-west-2.amazonaws.com/aws-nodejs-sample:v1&amp;quot;,
      &amp;quot;memory&amp;quot;: 200,
      &amp;quot;cpu&amp;quot;: 10,
      &amp;quot;essential&amp;quot;: true
    }
  ],
  &amp;quot;family&amp;quot;: &amp;quot;example_task_3&amp;quot;,
  &amp;quot;taskRoleArn&amp;quot;: &amp;quot;arn:aws:iam::123456789012:role/AmazonECSTaskS3BucketRole&amp;quot;
}&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This definition will deploy a container named &lt;code&gt;sample-app&lt;/code&gt; using image &lt;code&gt;123456789012.dkr.ecr.us-west-2.amazonaws.com/aws-nodejs-sample:v1&lt;/code&gt;. More detailed steps are &lt;a href=&quot;https://docs.aws.amazon.com/AmazonECS/latest/developerguide/create-task-definition.html&quot;&gt;available in the ECS documentation here&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;In this tutorial, you learned the basics of containers and container registries. You learned about the differences between Docker Hub and Amazon ECR for public and private repository hosting, and you saw how to set up and use ECR to store your images.&lt;/p&gt;
&lt;p&gt;Whether you’re using Docker images in production or not, ECR is a useful tool if you’re already embedded in the AWS ecosystem. It gives you the advantage of working well with other Amazon services like IAM for security and ECS or EKS for deployments.&lt;/p&gt;
&lt;p&gt;If you are pushing images to ECR as part of your build pipeline, check out Earthly’s support for &lt;a href=&quot;https://docs.earthly.dev/docs/guides/configuring-registries/aws-ecr&quot;&gt;ECR credentials&lt;/a&gt;. Unlike other build tools, Earthly executes each CI build in an isolated containerized environment, and it can pull images from ECR or any other container registry you choose. It’s free to use, so &lt;a href=&quot;https://earthly.dev/&quot;&gt;check Earthly out today&lt;/a&gt;.&lt;/p&gt;</content><author><name>Vivek Sonar</name></author><category term="Tutorials" /><summary type="html">A container is a simple unit that packages all your code and its dependencies so your application can run quickly and reliably from any computing environment. That means you could quickly move from your local environment to your staging and into production. Due to their portability, small size, and convenience, containers are becoming a method of choice for shipping modern applications.</summary></entry><entry><title type="html">Using Apple Silicon (M1) as a cloud engineer, two months in</title><link href="https://earthly.dev/blog/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/" rel="alternate" type="text/html" title="Using Apple Silicon (M1) as a cloud engineer, two months in" /><published>2021-03-03T00:00:00-05:00</published><updated>2021-03-03T00:00:00-05:00</updated><id>https://earthly.dev/blog/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in</id><content type="html" xml:base="https://earthly.dev/blog/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/">&lt;p&gt;So I’ve been using my new M1-based MacBook Pro for a couple of months for a mix of development, email, and other things an &lt;a href=&quot;https://github.com/earthly/earthly&quot;&gt;open-source maintainer&lt;/a&gt; does day-to-day.&lt;/p&gt;
&lt;p&gt;The typical first reaction that you get when using this is “it runs my Docker stack without sounding like a plane taking off??”.&lt;/p&gt;
&lt;p&gt;It’s a pretty amazing piece of engineering, and in many ways, I think that the ARM architecture is the future. A number of fast-growing tech giants (besides Apple) are pouring a ton of money into making ARM work for a ton of use-cases: Nvidia (trying to &lt;a href=&quot;https://www.cnbc.com/2020/09/14/nvidia-to-buy-arm-holdings-from-softbank-for-40-billion.html&quot;&gt;buy ARM Holdings from SoftBank&lt;/a&gt;) and Amazon (deep investment in the new &lt;a href=&quot;https://aws.amazon.com/ec2/graviton/&quot;&gt;Graviton processors&lt;/a&gt;) are the two that primarily come to mind.&lt;/p&gt;
&lt;p&gt;As you might know, in processors low energy consumption (and low heat dissipation) often equates to the ability to scale processing efficiently for large workloads. It also means longer battery cycles for non-cloud use-cases (less waste, more bang for the buck). This is why I think ARM is the future, even if it might take a decade for the mainstream cloud to migrate over.&lt;/p&gt;
&lt;p&gt;My Xeon Linux-based workstation suddenly feels old.&lt;/p&gt;
&lt;h2 id=&quot;compatibility&quot;&gt;Compatibility&lt;/h2&gt;
&lt;p&gt;All the software I need to use “just works”. I found that if an ARM-native version is not available for an application, the emulated one works just fine and there’s no performance drawback that I can notice. To emulate an application, you just need to install Rosetta 2. The OS will automatically detect that Rosetta is needed and prompt you to install it. However, you can also install it manually via&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/usr/sbin/softwareupdate --install-rosetta&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The tools you use for development are likely still catching up to this architectural change, and will be for some time. We engineers sometimes use very low-level system capabilities. In some cases, I had to install preview editions of software, but everything worked very well for me. Here are some programs that I’ve tested:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;✅ Chrome (native)&lt;/li&gt;
&lt;li&gt;✅ 1Password (emulated)&lt;/li&gt;
&lt;li&gt;✅ Zoom (native)&lt;/li&gt;
&lt;li&gt;✅ Backblaze (emulated)&lt;/li&gt;
&lt;li&gt;✅ Signal (emulated)&lt;/li&gt;
&lt;li&gt;✅ Spotify (emulated)&lt;/li&gt;
&lt;li&gt;✅ VS Code. The amd64 version works perfectly well, however, the terminal will be an amd64 process, which may cause some programs to also run as amd64. The arm64 native version is available on the &lt;a href=&quot;https://code.visualstudio.com/insiders/&quot;&gt;VS Code Insiders&lt;/a&gt; and works really well.&lt;/li&gt;
&lt;li&gt;✅ Docker. M1 native version is a must. Emulation doesn’t have virtualization features, which the Docker app requires. You can download the &lt;a href=&quot;https://docs.docker.com/docker-for-mac/apple-m1/&quot;&gt;Docker App for M1&lt;/a&gt;, which is in preview. As mentioned on the documentation page, there are some limitations currently related to HTTP proxy, VPN clients, and performance, but the Docker team is making progress fast. (A month or two ago Kubernetes wasn’t working, but now it is!).&lt;/li&gt;
&lt;li&gt;✅ Brew (native, encountered some issues with git, but was able to fix them)&lt;/li&gt;
&lt;li&gt;✅ iTerm (native)&lt;/li&gt;
&lt;li&gt;✅ Earthly (&lt;code&gt;v0.5.1+&lt;/code&gt; now supports M1 natively - just &lt;code&gt;brew install earthly&lt;/code&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I should also mention that during the first few weeks I had some issues with audio skips when using Bluetooth, but an OS update fixed it (just like &lt;a href=&quot;https://www.imore.com/fix-way-m1-mac-bluetooth-problems&quot;&gt;Apple promissed&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;I also use a ✅ YubiKey 5C Nano and a bunch of random peripherals like a ✅ USB microphone and a ✅ dock plugged into Ethernet.&lt;/p&gt;
&lt;p&gt;Languages and frameworks I’ve tested - most of them in Docker containers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;✅ Go. &lt;a href=&quot;https://golang.org/doc/go1.16#darwin&quot;&gt;1.16 RC adds support for building darwin/arm64 binaries&lt;/a&gt;. I built binaries in Docker and ran them natively. Works great.&lt;/li&gt;
&lt;li&gt;🟡 Java and Scala. I had issues with the JVM, experiencing random process hangs. It seems that there are no official OpenJDK builds for aarch64, however there are some community options. See more info below.&lt;/li&gt;
&lt;li&gt;✅ C++ works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;🟡 .Net works fine when emulated as amd64 in a container. Did not immediately work natively (and I did not investigate).&lt;/li&gt;
&lt;li&gt;✅ Elixir works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;✅ gRPC works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;✅ JavaScript / Node works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;✅ Python works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;✅ Ruby and Ruby on Rails works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;✅ Cobol (yes, really) works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;li&gt;✅ Rust works fine on native architecture in Docker. Minimal testing though.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;how-to-tell-what-architecture-a-program-is-running-as&quot;&gt;How to tell what architecture a program is running as&lt;/h2&gt;
&lt;p&gt;It’s extremely easy to mistake the kind of architecture you run as. Rosetta 2 is that good.&lt;/p&gt;
&lt;p&gt;The easiest way to tell the difference is by opening Activity Monitor and looking at the Architecture column: if it says &lt;code&gt;Apple&lt;/code&gt;, it’s ARM. If it says &lt;code&gt;Intel&lt;/code&gt;, it’s X86_64. Here’s how I can tell that Zoom is an ARM process, while Spotify is an X86_64 process.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/img1.png&quot; alt=&quot;Activity Monitor showing Zoom as an Apple process&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Activity Monitor showing Zoom as an Apple process&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/img2.png&quot; alt=&quot;Activity Monitor showing Spotify as an Intel process&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Activity Monitor showing Spotify as an Intel process&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;If you’re not sure about the terminal you’re using, you can type &lt;code&gt;uname -m&lt;/code&gt;. It’ll say either &lt;code&gt;X86_64&lt;/code&gt;, &lt;code&gt;arm64&lt;/code&gt; (mac) or &lt;code&gt;aarch64&lt;/code&gt; (linux). &lt;code&gt;arm64&lt;/code&gt; and &lt;code&gt;aarch64&lt;/code&gt; are both ARM - &lt;code&gt;uname&lt;/code&gt; on Mac just reports it differently compared to Linux.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/img3.png&quot; alt=&quot;Terminal showing the output of uname -m as arm64&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Terminal showing the output of &lt;code&gt;uname -m&lt;/code&gt; as &lt;code&gt;arm64&lt;/code&gt;&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;brew-issues&quot;&gt;Brew issues&lt;/h2&gt;
&lt;p&gt;One issue I encountered on both my M1 laptop and also a &lt;a href=&quot;https://www.macstadium.com/m1-mini&quot;&gt;MacStadium MacMini&lt;/a&gt; instance that we use for Mac testing is that Brew randomly started to complain about git missing. Not sure what the cause of this is, but it could be the fact that brew has been adding native arm support for many packages in the last few months and it’s possible that this migration resulted in some inconsistencies. This is pure speculation, however, I’ve not researched this.&lt;/p&gt;
&lt;p&gt;(In any case, a very impressive effort to switch architecture so quickly for a project that hosts so many packages!)&lt;/p&gt;
&lt;p&gt;Back to fixing the issue now. Using &lt;code&gt;brew doctor&lt;/code&gt; I was able to find out that Xcode needed a (re)install. Easy: &lt;code&gt;xcode-select --install&lt;/code&gt;. However, the issue was still there. On the MacStadium instance, I was able to just uninstall brew and reinstall it and everything was fine. I was not as comfortable doing that on my laptop after having installed so much via casks. Instead, I was able to just remove the brew &lt;code&gt;git&lt;/code&gt; via &lt;code&gt;brew uninstall git&lt;/code&gt; and simply rely on &lt;code&gt;git&lt;/code&gt; from Xcode, which seems to work just fine. (If anyone reading this knows what’s up with my brew’s git and can tell me how to fix it, ping me on Twitter: &lt;span class=&quot;citation&quot; data-cites=&quot;vladaionescu&quot;&gt;[@vladaionescu]&lt;/span&gt;(https://twitter.com/VladAIonescu))&lt;/p&gt;
&lt;h2 id=&quot;using-docker&quot;&gt;Using Docker&lt;/h2&gt;
&lt;p&gt;The Docker preview worked almost flawlessly for me from day 1. Making use of multi-platform images seems daunting at first, but really it’s actually pretty simple.&lt;/p&gt;
&lt;p&gt;The Docker for Mac app comes packed with &lt;a href=&quot;https://www.qemu.org/&quot;&gt;QEMU&lt;/a&gt; out of the box - so Docker is able to run either arm64 and amd64 images. Most official images are now supported on arm64 too. If you’re building an image, by default it’ll use your native architecture to execute the build (arm64) and most things will magically just work. Your mileage may vary, however, if you are &lt;code&gt;curl&lt;/code&gt;ing some binary that may need to switch from &lt;code&gt;X86_64&lt;/code&gt; to &lt;code&gt;aarch64&lt;/code&gt; in its URL, or if you’re doing lower-level stuff. I also noticed that some alpine packages are also not available for ARM (eg &lt;code&gt;shellcheck&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;To build an image for a different architecture, you can use &lt;code&gt;docker buildx build --platform=linux/amd64 .&lt;/code&gt; instead of the usual &lt;code&gt;docker build .&lt;/code&gt;. For more details on building multi-platform images see &lt;a href=&quot;https://medium.com/nttlabs/buildx-multiarch-2c6c2df00ca2&quot;&gt;Akihiro Suda’s blog&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you &lt;code&gt;docker pull&lt;/code&gt; an image from the registry, it will again default to your native architecture (if available), unless you specify &lt;code&gt;--platform=linux/amd64&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;If you &lt;code&gt;docker run&lt;/code&gt; an image, it will default to whatever version of the image you have available locally or it will attempt to pull the arm64 version from the registry. You can also override the platform via &lt;code&gt;--platform=linux/amd64&lt;/code&gt; if you’d like to run the amd64 version specifically.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/img4.png&quot; alt=&quot;Terminal showing the output of uname -m for different container platforms&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Terminal showing the output of &lt;code&gt;uname -m&lt;/code&gt; for different container platforms&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Docker Compose will happily run a mixture of various architectures. The same rules apply with regards to pulling and running. You can also specify &lt;code&gt;platform: linux/amd64&lt;/code&gt; for the service definition in &lt;code&gt;docker-compose.yml&lt;/code&gt; if you’d like to be specific.&lt;/p&gt;
&lt;p&gt;One thing to note is that Docker-in-Docker is not supported by QEMU (&lt;a href=&quot;https://github.com/moby/qemu/pull/7&quot;&gt;abandoned PR here&lt;/a&gt;). So you cannot run an arm64 Docker in an amd64 Docker or vice-versa. &lt;strong&gt;However&lt;/strong&gt;, if you run your natively-supported Docker-in-Docker, the inner Docker can still run multi-platform images fine.&lt;/p&gt;
&lt;p&gt;There are currently performance issues with multi-processor use - so much so that performance using a single core is sometimes slightly better than the performance of using 8 cores. Or at least that’s what &lt;span class=&quot;citation&quot; data-cites=&quot;jasmas&quot;&gt;[@jasmas claims]&lt;/span&gt;(https://github.com/docker/roadmap/issues/142#issuecomment-772732443).&lt;/p&gt;
&lt;h2 id=&quot;using-vs-code&quot;&gt;Using VS Code&lt;/h2&gt;
&lt;p&gt;Native support for Apple Silicon is not yet available in the generally available VS Code version, but running the amd64 emulated version works pretty well. You can also use the native version via a VS Code Universal build (contains both architectures in a single package) available via &lt;a href=&quot;https://code.visualstudio.com/insiders/#osx&quot;&gt;VS Code Insiders&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;An issue I ran into with the amd64 version was that I did not realize that the terminal was also an amd64 process (Again, Rosetta 2 is just that good). In some situations, this led to some strange issues when running Docker, where QEMU was acting up with segmentation faults. After some head-scratching the issue was resolved by switching to the ARM-based VS Code Insiders edition.&lt;/p&gt;
&lt;h2 id=&quot;using-earthly&quot;&gt;Using Earthly&lt;/h2&gt;
&lt;p&gt;We’ve added support for Apple M1 in Earthly and so far it’s working wonderfully. This is in Beta, so if you end up giving this a try - we’d appreciate any feedback you can give us via &lt;a href=&quot;https://github.com/earthly/earthly/issues&quot;&gt;GitHub issues&lt;/a&gt; or in our &lt;a href=&quot;https://earthly.dev/slack&quot;&gt;Slack&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;One useful Earthly trick I’ve used a lot is that if one part of your build has not yet been ported to amd64, you can simply mark it as &lt;code&gt;--platform=linux/amd64&lt;/code&gt; - and thus only that part will execute on amd64. The rest will run natively. This is relatively rare, however - most Docker builds just work across either platform. Our &lt;a href=&quot;https://github.com/earthly/earthly/blob/b7b640094f8b5a0982eca5376cb54147feac7878/Earthfile#L295-L321&quot;&gt;examples build&lt;/a&gt; is pretty representative. There’s also an extensive guide on &lt;a href=&quot;https://docs.earthly.dev/guides/multi-platform&quot;&gt;multi-platform builds with Earthly&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;using-go&quot;&gt;Using Go&lt;/h2&gt;
&lt;p&gt;You don’t necessarily need to build &lt;code&gt;darwin/arm64&lt;/code&gt; binaries to run them on M1. Rosetta 2 emulation works great on Intel ones. If you want to, however, &lt;a href=&quot;https://golang.org/doc/go1.16#darwin&quot;&gt;Go 1.16 RC just added support for this&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;java-scala-jvm-issues&quot;&gt;Java / Scala / JVM issues&lt;/h2&gt;
&lt;p&gt;I ran into issues when using the JVM. After investigating online, it seems that OpenJDK is not yet available for the M1. The way this was manifesting for me was that the JVM process would just hang randomly. By using &lt;code&gt;--platform=linux/amd64&lt;/code&gt; in Docker or in Earthly builds, I was able to get OpenJDK to work most of the time, but I’m still seeing random hangs.&lt;/p&gt;
&lt;p&gt;According to this &lt;a href=&quot;https://stackoverflow.com/questions/64788005/java-jdk-for-apple-m1-chip&quot;&gt;StackOverflow thread&lt;/a&gt;, there are &lt;a href=&quot;https://www.azul.com/downloads/zulu-community/?package=jdk&quot;&gt;Azul-provided builds of the Zulu JDK&lt;/a&gt; for the M1 and also &lt;a href=&quot;https://github.com/microsoft/openjdk-aarch64/releases/tag/16-ea%2B10-macos&quot;&gt;Microsoft has put up an aarch64 build for the OpenJDK&lt;/a&gt; too. I have not tested these so I can’t say whether they work well or not.&lt;/p&gt;
&lt;h2 id=&quot;performance&quot;&gt;Performance&lt;/h2&gt;
&lt;p&gt;One of the things I noticed about my new laptop is that everything opens up really fast and the awake from sleep time is also really low. These are sub-second differences though so you might not notice it - or maybe it’s a placebo acting up on me and there’s no real difference :-)&lt;/p&gt;
&lt;p&gt;Docker is currently slower, however, as mentioned above, due to the multi-core issue. As far as I can tell the difference is approximately 1.75X compared to an Intel MacBook Pro. I would assume that this will be fixed in a future preview of the Docker for Mac app.&lt;/p&gt;
&lt;h2 id=&quot;battery-life&quot;&gt;Battery life&lt;/h2&gt;
&lt;p&gt;Battery life on the M1 is really really really good - half a day of Zoom meetings + email only took 20% of my battery. I work from home a lot, so I don’t use this much. But it’s great to know it really lasts for a serious coding session if I needed it on the go.&lt;/p&gt;
&lt;h2 id=&quot;cost&quot;&gt;Cost&lt;/h2&gt;
&lt;p&gt;I can’t talk about the M1 without mentioning the cost of the setup. It has very similar specs to the Intel MBP I bought last year, but it’s a whole $1000 cheaper. It’s crazy. I don’t know why - it feels really performant for the most part, it has 100% fewer fans and a long-lasting battery. Why would anyone buy the old version anymore?&lt;/p&gt;
&lt;p&gt;The only downside is that it only has two Thunderbolt ports, rather than four. But it’s not a huge deal for me as I use a dock.&lt;/p&gt;
&lt;p&gt;I think the strategy here is that this will be the low-end MacBook Pro of the line-up, while a future Apple Silicon-based one will have even beefier specs.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;As you can see, my workflow is very much Docker-heavy. Docker seems to be working well enough for me and it’s taken away any possible pain that may be associated with individual language ecosystem tooling.&lt;/p&gt;
&lt;p&gt;For most binaries, if they don’t work across platforms natively, Rosetta 2 works wonders on them, or &lt;code&gt;--platform=linux/amd64&lt;/code&gt; in Docker is all that is needed. The JVM issues were the only ones I could not figure out completely - but also, I did not spend time trying out the Microsoft-provided OpenJDK build or the Zulu JVM.&lt;/p&gt;
&lt;p&gt;Overall I’m happy with my M1. I like bleeding-edge technology, and I had to use preview versions of some software, but had no major issues in my typical workflow. I’m surprised how well most things just work.&lt;/p&gt;
&lt;p&gt;If you’re a developer and your coding productivity depends on your laptop, I would triple check that my setup works as expected on an ARM architecture before making a purchase. For the most part you should be fine outside the Java / Scala world - but you never know!&lt;/p&gt;
&lt;p&gt;If you’re not a developer, or only use your laptop for browsing and email, I really don’t see any reason why you would pick an Intel MacBook over this one. I would also assume that the MacBook Air version is also amazing (unlike the Intel version of MacBook Air, which is often on the slow side for modern web browsing). The M1 chip is very similar between Pro and Air and there’s no need for fans.&lt;/p&gt;</content><author><name>Vlad A. Ionescu</name></author><category term="Articles" /><category term="docker" /><category term="apple-silicon" /><category term="m1" /><category term="arm64" /><category term="aarch64" /><summary type="html">So I’ve been using my new M1-based MacBook Pro for a couple of months for a mix of development, email, and other things an open-source maintainer does day-to-day.</summary></entry><entry><title type="html">INTERCAL, YAML, And Other Horrible Programming Languages</title><link href="https://earthly.dev/blog/intercal-yaml-and-other-horrible-programming-languages/" rel="alternate" type="text/html" title="INTERCAL, YAML, And Other Horrible Programming Languages" /><published>2021-02-25T00:00:00-05:00</published><updated>2021-02-25T00:00:00-05:00</updated><id>https://earthly.dev/blog/intercal-yaml-and-other-horrible-programming-languages</id><content type="html" xml:base="https://earthly.dev/blog/intercal-yaml-and-other-horrible-programming-languages/">&lt;h2 id=&quot;program-rejected-for-mental-health-reasons&quot;&gt;PROGRAM REJECTED FOR MENTAL HEALTH REASONS&lt;/h2&gt;
&lt;p&gt;In 1972, two students learning FORTRAN came up with a fantastic new programming language called INTERCAL. INTERCAL is a bit unusual. For example, single quotes are called &lt;em&gt;sparks&lt;/em&gt;, and double quotes are called &lt;em&gt;rabbit ears&lt;/em&gt;, less than (&amp;lt;) is an &lt;em&gt;angle&lt;/em&gt;, and a dash (-) is a &lt;em&gt;worm&lt;/em&gt;. This makes the manual read like a word puzzle combined with an extended in-joke.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;One final comment about sparks and rabbit-ears; if the next character in the program is a spot, as often happens because onespot variables are common choices for operands, a spark and the following spot can be combined into a wow (!). - &lt;a href=&quot;http://www.catb.org/~esr/intercal/ick.htm&quot;&gt;INTERCAL Manual&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The compiler errors are where the authors got genuinely creative. Errors include &lt;code&gt;VARIABLES MAY NOT BE STORED IN WEST HYPERSPACE&lt;/code&gt; for accessing an array incorrectly, &lt;code&gt;IT CAME FROM BEYOND SPACE&lt;/code&gt; for invalid control flow, &lt;code&gt;PROGRAM REJECTED FOR MENTAL HEALTH REASONS&lt;/code&gt; for threading issues, &lt;code&gt;I HAVE NO FILE AND I MUST SCREAM&lt;/code&gt; for file not found, and &lt;a href=&quot;http://www.catb.org/~esr/intercal/ick.htm#Errors&quot;&gt;many many more&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Yes, this is a parody language, and reading the manual, you get the sense that no one has yet had as much fun writing technical documentation as Lyon and Woods did writing this.&lt;/p&gt;
&lt;p&gt;The language itself looks less fun. Here is &lt;a href=&quot;http://www.rosettacode.org/wiki/Category:Intercal&quot;&gt;Hello World&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode fortran&quot;&gt;&lt;code class=&quot;sourceCode fortranfixed&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       NOTE THIS IS INTERCAL&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       PLEASE ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; SUB #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;54&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; SUB #&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;192&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; SUB #&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;136&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       PLEASE ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; SUB #&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;208&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; SUB #&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;98&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; COME FROM (&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;       &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;READ&lt;/span&gt; OUT ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; ,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; SUB #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;134&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;)    PLEASE ABSTAIN FROM (&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;One of the exciting innovations of INTERCAL is the &lt;code&gt;COMEFROM&lt;/code&gt; &lt;a href=&quot;https://en.wikipedia.org/wiki/COMEFROM#Examples&quot;&gt;instruction&lt;/a&gt;, seen here in a variant of BASIC.&lt;/p&gt;
&lt;pre class=&quot;qwbasic&quot;&gt;&lt;code&gt;10 COMEFROM 40
20 INPUT &amp;quot;WHAT IS YOUR NAME? &amp;quot;; A$
30 PRINT &amp;quot;HELLO, &amp;quot;; A$
40 REM&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A &lt;code&gt;COMEFROM&lt;/code&gt; anywhere in a program can grab control flow from the line you are reading. And in some implementations, if many &lt;code&gt;COMEFROM&lt;/code&gt;’s reference the same line, execution splits off in each direction.&lt;/p&gt;
&lt;p&gt;A &lt;code&gt;COMEFROM&lt;/code&gt; is the inverse of a &lt;code&gt;GOTO&lt;/code&gt; statement with multi-threading thrown in. It breaks the mental model of imperative execution where each line’s evaluation leads to the next line. The idea that you can simulate its execution in your head, line by line, is fundamental to imperative programming and &lt;code&gt;COMEFROM&lt;/code&gt; attempts to break that model.&lt;/p&gt;
&lt;h2 id=&quot;variables-may-not-be-stored-in-west-hyperspace&quot;&gt;VARIABLES MAY NOT BE STORED IN WEST HYPERSPACE&lt;/h2&gt;
&lt;p&gt;At Twitter, they have a giant monorepo with lots of services in it. And somebody at Twitter wanted to know which language was most prevalent. Which language does Twitter use the most?&lt;/p&gt;
&lt;p&gt;Java came in 3rd, and Scala came in 2nd. But 1st was a surprise. The number one programming language used at Twitter was YAML&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;YAML usually doesn’t feel like a programming language to me. The file I’m currently writing in is in markdown with some YAML at the top to set the title and associated fields.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;title&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; INTERCAL, YAML, And Other Horrible Programming Languages&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;author&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; Adam&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Nothing executes the YAML. It only offers some information to the blogging platform. But I don’t think that is the type of YAML that made up the volume of config at Twitter.&lt;/p&gt;
&lt;p&gt;I suspect a lot of it was build and deployment scripts in the form of YAML. It was the type of configuration that encoded the control flow of some external system. YAML like that lives in this grey zone between declarative configuration and a full-blown programming language.&lt;/p&gt;
&lt;p&gt;I’ll show you what I mean. Let’s look at an example from &lt;a href=&quot;https://github.com/koalaman/shellcheck/blob/master/.travis.yml&quot;&gt;shellcheck&lt;/a&gt;’s build script.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;language&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; shell&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; linux&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;  &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; docker&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That seems like straight-forward config.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;jobs&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;  &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;    &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;stage&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; Build&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;env&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; BUILD=linux&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;workspaces&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;create&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;          &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; ws-linux&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;          &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; deploy&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;code&gt;create&lt;/code&gt;, in the above, is starting to seem a bit more like execution. Let’s continue.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;  &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; ls -la ${CASHER_DIR}/ || true&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; tar -xvf ${CASHER_DIR}/ws-osx-fetch.tgz --strip-components=5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; ls -la deploy&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; ./.github_deploy&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;  &lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now the YAML has just devolved into specifying how to execute a grab bag of commands. We haven’t seen control-flow yet, but it’s coming.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; type = push&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; source ./.multi_arch_docker&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;        &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; set -ex; multi_arch_docker::main; set +x&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There we go, branching. It’s an if statement in a YAML file!&lt;/p&gt;
&lt;p&gt;And this isn’t TravisCI, or CI specific. Here is a simple example from Ansible:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;hosts&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; all&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;  &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;tasks&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-3&quot;&gt;&lt;a href=&quot;#cb8-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;    &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; foo.yml&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-4&quot;&gt;&lt;a href=&quot;#cb8-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; something == &amp;quot;foo&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-5&quot;&gt;&lt;a href=&quot;#cb8-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;    &lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-6&quot;&gt;&lt;a href=&quot;#cb8-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;    &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;include&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; bar.yml&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb8-7&quot;&gt;&lt;a href=&quot;#cb8-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;      &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;when&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; something == &amp;quot;bar&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here is GitHub Actions:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode yaml&quot;&gt;&lt;code class=&quot;sourceCode yaml&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;steps&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt; &lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; Step 7&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;   &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; ${{ github.event_name == &amp;#39;pull_request&amp;#39; &amp;amp;&amp;amp; github.event.action == &amp;#39;unassigned&amp;#39; }}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb9-5&quot;&gt;&lt;a href=&quot;#cb9-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;at&quot;&gt;   &lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;run&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;at&quot;&gt; echo This event is a pull request that had an assignee removed.&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here is part of a Grafana &lt;a href=&quot;deployment.yaml&quot;&gt;Helm Chart&lt;/a&gt;:&lt;/p&gt;
&lt;pre class=&quot;liquid&quot;&gt;&lt;code&gt;  
  {{ if (or (not .Values.persistence.enabled) (eq .Values.persistence.type &amp;quot;pvc&amp;quot;)) }}
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: {{ template &amp;quot;grafana.fullname&amp;quot; . }}
    namespace: {{ template &amp;quot;grafana.namespace&amp;quot; . }}
    labels:
      {{- include &amp;quot;grafana.labels&amp;quot; . | nindent 4 }}
  {{- if .Values.labels }}
  {{ toYaml .Values.labels | indent 4 }}
  {{- end }}
  {{- with .Values.annotations }}
    annotations:
  {{ toYaml . | indent 4 }}
  {{- end }}
  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I think this is a problem&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;. Writing control flow in a config file is like hammering in a screw. It’s a useful tool being used for the wrong job.&lt;/p&gt;
&lt;p&gt;How did we get to this world of little programming languages embedded into YAML? Is calling something configuration just less scary? And if so, is a c++ program just config you give to gcc?&lt;/p&gt;
&lt;p&gt;Did things ever get this complicated in XML times?&lt;/p&gt;
&lt;p&gt;It turns out they did:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode xml&quot;&gt;&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:stylesheet&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; version=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1.0&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; xmlns:xsl=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;http://www.w3.org/1999/XSL/Transform&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:output&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; method=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;text&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; omit-xml-declaration=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;yes&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:template&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; match=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-6&quot;&gt;&lt;a href=&quot;#cb11-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:call-template&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;FizzBuzz&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-7&quot;&gt;&lt;a href=&quot;#cb11-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:with-param&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;i&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; select=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;1&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-8&quot;&gt;&lt;a href=&quot;#cb11-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:call-template&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-9&quot;&gt;&lt;a href=&quot;#cb11-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:template&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-10&quot;&gt;&lt;a href=&quot;#cb11-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-11&quot;&gt;&lt;a href=&quot;#cb11-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:template&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;FizzBuzz&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-12&quot;&gt;&lt;a href=&quot;#cb11-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:param&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;i&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-13&quot;&gt;&lt;a href=&quot;#cb11-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:choose&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-14&quot;&gt;&lt;a href=&quot;#cb11-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:when&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; test=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;($i mod 3) = 0 and ($i mod 5) = 0&amp;quot;&lt;/span&gt;&amp;gt;FizzBuzz&lt;span class=&quot;dv&quot;&gt;&amp;amp;#xa;&lt;/span&gt;&amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:when&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-15&quot;&gt;&lt;a href=&quot;#cb11-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:when&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; test=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;$i mod 3 = 0&amp;quot;&lt;/span&gt;&amp;gt;Fizz&lt;span class=&quot;dv&quot;&gt;&amp;amp;#xa;&lt;/span&gt;&amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:when&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-16&quot;&gt;&lt;a href=&quot;#cb11-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:when&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; test=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;$i mod 5 = 0&amp;quot;&lt;/span&gt;&amp;gt;Buzz&lt;span class=&quot;dv&quot;&gt;&amp;amp;#xa;&lt;/span&gt;&amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:when&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-17&quot;&gt;&lt;a href=&quot;#cb11-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:otherwise&lt;/span&gt;&amp;gt;&amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:value-of&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; select=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;$i&amp;quot;&lt;/span&gt; /&amp;gt;&amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:text&lt;/span&gt;&amp;gt;&lt;span class=&quot;dv&quot;&gt;&amp;amp;#xa;&lt;/span&gt;&amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:text&lt;/span&gt;&amp;gt;&amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:otherwise&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-18&quot;&gt;&lt;a href=&quot;#cb11-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:choose&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-19&quot;&gt;&lt;a href=&quot;#cb11-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:if&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; test=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;$i &lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;&amp;amp;lt;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; 100&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-20&quot;&gt;&lt;a href=&quot;#cb11-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:call-template&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;FizzBuzz&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-21&quot;&gt;&lt;a href=&quot;#cb11-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &amp;lt;&lt;span class=&quot;kw&quot;&gt;xsl:with-param&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;i&amp;quot;&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; select=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;$i + 1&amp;quot;&lt;/span&gt; /&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-22&quot;&gt;&lt;a href=&quot;#cb11-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:call-template&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-23&quot;&gt;&lt;a href=&quot;#cb11-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:if&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-24&quot;&gt;&lt;a href=&quot;#cb11-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:template&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-25&quot;&gt;&lt;a href=&quot;#cb11-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&amp;lt;/&lt;span class=&quot;kw&quot;&gt;xsl:stylesheet&lt;/span&gt;&amp;gt;&lt;/span&gt;
&lt;span id=&quot;cb11-26&quot;&gt;&lt;a href=&quot;#cb11-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That is &lt;code&gt;FizzBuzz&lt;/code&gt; in &lt;a href=&quot;https://gist.github.com/JustinPealing/6f619a23729720a9c14d9917201028c8&quot;&gt;XSLT&lt;/a&gt;. I assume it was written in jest, but in many ways, XML and XSLT are better than an ad-hoc YAML based scripting language. XSLT is a documented and standardized thing, not just some ad-hoc format for specifying execution.&lt;/p&gt;
&lt;p&gt;It burns my eyes to look at it, but at least XSLT was intended to be used as a programming language. That is something we can’t say about YAML or INTERCAL.&lt;/p&gt;
&lt;p&gt;The problem with these languages embedded into YAML is they are all one-off implementations. TravisCI conditionals have a TravisCI specific syntax, usage, and features. You can’t use Travis’s &lt;code&gt;concat&lt;/code&gt; function or conditional regex in the YAML configuration for your ansible playbooks.&lt;/p&gt;
&lt;p&gt;In a vague way, this YAML problem is like the &lt;code&gt;COMEFROM&lt;/code&gt; problem. If you know yaml, you can’t just open a .yml file and start reading file line by line. You need to understand how the configuration controls the execution of the specific system it’s for. And that is hard.&lt;/p&gt;
&lt;!-- If it's `title: bla` that is easy enough, but once we hit conditionals and filters, it feels like we are using the wrong tool. --&gt;
&lt;h2 id=&quot;i-have-no-file-and-i-must-scream&quot;&gt;I HAVE NO FILE AND I MUST SCREAM&lt;/h2&gt;
&lt;p&gt;The line between configuration and programming languages is not some bright dividing line. It is easy to slowly drift into adding programming language constructs to a config file. Before you know it, you have a full unspecified programming language embedded in the interpretation of your config file.&lt;/p&gt;
&lt;p&gt;That is the worst of both worlds, and so much YAML seems to drift into this area.&lt;/p&gt;
&lt;p&gt;I like YAML more than XML, but for control flow, you know what would be better than YAML? Anything else! Maybe even INTERCAL? I mean, how bad could a joke programming language be?&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode fortran&quot;&gt;&lt;code class=&quot;sourceCode fortranfixed&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;100&lt;/span&gt;)  PLEASE NOTE THIS IS THE FIZZBUZZ &lt;span class=&quot;kw&quot;&gt;FUNCTION&lt;/span&gt;    &lt;/span&gt;
&lt;span id=&quot;cb12-2&quot;&gt;&lt;a href=&quot;#cb12-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-3&quot;&gt;&lt;a href=&quot;#cb12-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE: IS THE INPUT DIVISIBLE BY #&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;?&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-4&quot;&gt;&lt;a href=&quot;#cb12-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.1&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.100&lt;/span&gt;   &lt;/span&gt;
&lt;span id=&quot;cb12-5&quot;&gt;&lt;a href=&quot;#cb12-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.2&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-6&quot;&gt;&lt;a href=&quot;#cb12-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;2030&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-7&quot;&gt;&lt;a href=&quot;#cb12-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE: is &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt; (remainder) &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;?&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-8&quot;&gt;&lt;a href=&quot;#cb12-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;#39;~#1&amp;quot;$#1&amp;#39;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;~&lt;/span&gt;#&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-9&quot;&gt;&lt;a href=&quot;#cb12-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;130&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-10&quot;&gt;&lt;a href=&quot;#cb12-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb12-11&quot;&gt;&lt;a href=&quot;#cb12-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE NUMBER IS &lt;span class=&quot;bu&quot;&gt;NOT&lt;/span&gt; DIVISIBLE BY #&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; CHECK &lt;span class=&quot;kw&quot;&gt;IF&lt;/span&gt; DIVISIBLE BY &lt;span class=&quot;co&quot;&gt;#3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-12&quot;&gt;&lt;a href=&quot;#cb12-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.2&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-13&quot;&gt;&lt;a href=&quot;#cb12-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;2030&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-14&quot;&gt;&lt;a href=&quot;#cb12-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE: is &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt; (remainder) &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;?&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-15&quot;&gt;&lt;a href=&quot;#cb12-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;#39;~#1&amp;quot;$#1&amp;#39;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;~&lt;/span&gt;#&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-16&quot;&gt;&lt;a href=&quot;#cb12-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;110&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-17&quot;&gt;&lt;a href=&quot;#cb12-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-18&quot;&gt;&lt;a href=&quot;#cb12-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE NUMBER IS &lt;span class=&quot;bu&quot;&gt;NOT&lt;/span&gt; DIVISIBLE BY #&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; CHECK &lt;span class=&quot;kw&quot;&gt;IF&lt;/span&gt; DIVISIBLE BY #&lt;span class=&quot;co&quot;&gt;5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-19&quot;&gt;&lt;a href=&quot;#cb12-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.2&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-20&quot;&gt;&lt;a href=&quot;#cb12-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;2030&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-21&quot;&gt;&lt;a href=&quot;#cb12-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE: is &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt; (remainder) &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;?&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-22&quot;&gt;&lt;a href=&quot;#cb12-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;?&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;#39;~#1&amp;quot;$#1&amp;#39;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;~&lt;/span&gt;#&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-23&quot;&gt;&lt;a href=&quot;#cb12-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;120&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-24&quot;&gt;&lt;a href=&quot;#cb12-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb12-25&quot;&gt;&lt;a href=&quot;#cb12-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE NUMBER IS REGULAR &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;RETURN&lt;/span&gt; THE INPUT&lt;/span&gt;
&lt;span id=&quot;cb12-26&quot;&gt;&lt;a href=&quot;#cb12-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.101&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.100&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-27&quot;&gt;&lt;a href=&quot;#cb12-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;199&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-28&quot;&gt;&lt;a href=&quot;#cb12-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-29&quot;&gt;&lt;a href=&quot;#cb12-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;110&lt;/span&gt;)   &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;111&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-30&quot;&gt;&lt;a href=&quot;#cb12-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; FORGET #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-31&quot;&gt;&lt;a href=&quot;#cb12-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE NUMBER IS DIVISIBLE BY #&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;RETURN&lt;/span&gt; FIZZ&lt;/span&gt;
&lt;span id=&quot;cb12-32&quot;&gt;&lt;a href=&quot;#cb12-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.101&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;61440&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-33&quot;&gt;&lt;a href=&quot;#cb12-33&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;199&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-34&quot;&gt;&lt;a href=&quot;#cb12-34&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-35&quot;&gt;&lt;a href=&quot;#cb12-35&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-36&quot;&gt;&lt;a href=&quot;#cb12-36&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;120&lt;/span&gt;)   &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;111&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-37&quot;&gt;&lt;a href=&quot;#cb12-37&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; FORGET #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-38&quot;&gt;&lt;a href=&quot;#cb12-38&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE NUMBER IS DIVISIBLE BY #&lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;RETURN&lt;/span&gt; BUZZ&lt;/span&gt;
&lt;span id=&quot;cb12-39&quot;&gt;&lt;a href=&quot;#cb12-39&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.101&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;45056&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-40&quot;&gt;&lt;a href=&quot;#cb12-40&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;199&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-41&quot;&gt;&lt;a href=&quot;#cb12-41&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-42&quot;&gt;&lt;a href=&quot;#cb12-42&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;130&lt;/span&gt;)   &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;111&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-43&quot;&gt;&lt;a href=&quot;#cb12-43&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; FORGET #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-44&quot;&gt;&lt;a href=&quot;#cb12-44&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    PLEASE NOTE NUMBER IS DIVISIBLE BY #&lt;span class=&quot;dv&quot;&gt;15&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;RETURN&lt;/span&gt; FIZZ&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt;BUZZ&lt;/span&gt;
&lt;span id=&quot;cb12-45&quot;&gt;&lt;a href=&quot;#cb12-45&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; &lt;span class=&quot;fl&quot;&gt;.101&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;-&lt;/span&gt; #&lt;span class=&quot;dv&quot;&gt;64256&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-46&quot;&gt;&lt;a href=&quot;#cb12-46&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; (&lt;span class=&quot;dv&quot;&gt;199&lt;/span&gt;) NEXT&lt;/span&gt;
&lt;span id=&quot;cb12-47&quot;&gt;&lt;a href=&quot;#cb12-47&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-48&quot;&gt;&lt;a href=&quot;#cb12-48&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;111&lt;/span&gt;)   &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; RESUME &lt;span class=&quot;fl&quot;&gt;.4&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-49&quot;&gt;&lt;a href=&quot;#cb12-49&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;/span&gt;
&lt;span id=&quot;cb12-50&quot;&gt;&lt;a href=&quot;#cb12-50&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;(&lt;span class=&quot;dv&quot;&gt;199&lt;/span&gt;)   &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; FORGET #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb12-51&quot;&gt;&lt;a href=&quot;#cb12-51&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;DO&lt;/span&gt; RESUME #&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Oh God.&lt;/p&gt;
&lt;p&gt;Well, ok, maybe not INTERCAL but anything else. &lt;a href=&quot;#fn3&quot; class=&quot;footnote-ref&quot; id=&quot;fnref3&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
&lt;section class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;See my interview with &lt;a href=&quot;https://www.se-radio.net/2019/08/episode-375-gabriel-gonzalez-on-configuration/&quot;&gt;Gabriel Gonzalez on Configuration&lt;/a&gt; at Software Engineering Radio.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;Ansible and Helm are actually templating languages built on top of YAML, which is better than embedded control flow, but the point still stands.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn3&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;Practically, you may have to use tools that encode a DSL into config, but you can use them while recognizing that we can do better. I think something like &lt;a href=&quot;https://dhall-lang.org/#&quot;&gt;Dhall&lt;/a&gt; for complicated config and something like &lt;a href=&quot;https://www.pulumi.com/&quot;&gt;pulumi&lt;/a&gt; for complex configuration as code should be where we aim for as an industry.&lt;a href=&quot;#fnref3&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Articles" /><summary type="html">In 1972, two students learning FORTRAN came up with a fantastic new programming language called INTERCAL.</summary></entry><entry><title type="html">What is Buildkit?</title><link href="https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/" rel="alternate" type="text/html" title="What is Buildkit?" /><published>2021-02-19T00:00:00-05:00</published><updated>2021-02-19T00:00:00-05:00</updated><id>https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it</id><content type="html" xml:base="https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/">&lt;p&gt;There is an excellent open-source project that you have probably used without realizing it. It’s called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn’t just build Docker images; it can build OCI images and several other output formats. &lt;a href=&quot;https://www.openfaas.com/&quot;&gt;OpenFasS&lt;/a&gt; uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.&lt;/p&gt;
&lt;p&gt;You may not know you’ve used BuildKit because other applications wrap it. Modern versions of &lt;code&gt;docker build&lt;/code&gt; can use BuildKit and it will soon be enabled by default. Today let’s look at how to use BuildKit directly.&lt;/p&gt;
&lt;h2 id=&quot;history&quot;&gt;History&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;BuildKit is a new project under the Moby umbrella for building and packaging software using containers. It’s a new codebase meant to replace the internals of the current build features in the Moby Engine. - &lt;a href=&quot;https://blog.mobyproject.org/introducing-buildkit-17e056cc5317&quot;&gt;Introducing BuildKit&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Tõnis Tiigi, a Docker employee and BuildKit’s primary developer, created BuildKit to separate the logic of building images from the main moby project and to enable future development. BuildKit has support for pluggable frontends, which allow it to make more than just docker images using dockerfiles. With BuildKit, we can substitute the dockerfile syntax for &lt;a href=&quot;https://github.com/openllb/hlb&quot;&gt;hlb&lt;/a&gt; and replace the docker image format for a pure tar file output. That is just one of the possible combinations BuildKit, with its pluggable backends and frontends, unlocks.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/1.gif&quot; alt=&quot;animation of buildctl building a dockerfile&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;animation of buildctl building a dockerfile&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;The original BuildKit proposal is found in the moby project:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;“Buildkit is a proposal to separate out docker build experience into a separate project, allowing different users to collaborate on the underlying technology and reuse and customize it in different ways.”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;“One of the main design goals of BuildKit is to separate frontend and backend concerns during a build process” - &lt;a href=&quot;https://github.com/moby/moby/issues/32925&quot;&gt;Intial BuildKit Proposal&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;install-buildkit&quot;&gt;Install BuildKit&lt;/h2&gt;
&lt;h4 id=&quot;buildctl&quot;&gt;buildctl&lt;/h4&gt;
&lt;p&gt;BuildKit has two primary components: buildctl and buildkitd. buildctl is the BuildKit controller, and it communicates with &lt;code&gt;buildkitd&lt;/code&gt;. Though designed for Linux, it can run on macOS and Windows under WSL2.&lt;/p&gt;
&lt;p&gt;On macOS, you can install buildctl with brew.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;brew install buildkit&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On Linux and Windows, grab a release from &lt;a href=&quot;https://github.com/moby/buildkit/releases&quot;&gt;Github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Afterward, you should be able to call buildctl&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;➜  ~ buildctl
NAME:
   buildctl - build utility

USAGE:
   buildctl [global options] command [command options] [arguments...]

VERSION:
   0.8.1

COMMANDS:
   du        disk usage
   prune     clean up build cache
   build, b  build
   debug     debug utilities
   help, h   Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --debug                enable debug output in logs
   --addr value           buildkitd address (default: &amp;quot;unix:///run/buildkit/buildkitd.sock&amp;quot;)
   --tlsservername value  buildkitd server name for certificate validation
   --tlscacert value      CA certificate for validation
   --tlscert value        client certificate
   --tlskey value         client key
   --tlsdir value         directory containing CA certificate, client certificate, and client key
   --timeout value        timeout backend connection after value seconds (default: 5)
   --help, -h             show help
   --version, -v          print the version&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Other Tools&lt;/strong&gt;: In this guide, we will use &lt;a href=&quot;https://linux.die.net/man/1/pstree&quot;&gt;pstree&lt;/a&gt;, &lt;a href=&quot;https://github.com/Canop/broot&quot;&gt;br&lt;/a&gt;, and &lt;a href=&quot;earthly.dev/blog/mitmproxy/&quot;&gt;mitmproxy&lt;/a&gt;. They are not required to use BuildKit or to follow this guide, but they help us demonstrate how BuildKit works.&lt;/em&gt;&lt;/p&gt;
&lt;h4 id=&quot;buildkitd&quot;&gt;buildkitd&lt;/h4&gt;
&lt;p&gt;buildkitd does the actual work of transforming a build definition into some output. It is designed to be a long-running process. It also isn’t possible to run it on macOS or Windows. For this tutorial, we will run it as a docker container. That will work regardless of your host OS.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;➜ docker run --rm --privileged -d --name buildkit moby/buildkit
Unable to find image &amp;#39;moby/buildkit:latest&amp;#39; locally
latest: Pulling from moby/buildkit
05e7bc50f07f: Already exists 
d7d1da19a5ee: Already exists 
10f8f68c5adb: Already exists 
00d21c774e02: Already exists 
Digest: sha256:ecd5ad4910c322cad6995f8a1a0805d9da4b09ed4aaef40627f5bcb8ebf74068
Status: Downloaded newer image for moby/buildkit:latest
6c4342639e07eedc16ba2f5d9f91fb2f82e1793cdea73aec1725e6652cab315a

➜ docker ps
CONTAINER ID   IMAGE           COMMAND       CREATED          STATUS          PORTS     NAMES
6c4342639e07   moby/buildkit &amp;quot;buildkitd&amp;quot; 45 seconds ago   Up 43 seconds             buildkit&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We also need to tell buildctl where to find buildkitd:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;export BUILDKIT_HOST=docker-container://buildkit&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;em&gt;On Linux, you can substitute these steps with just running &lt;code&gt;buildkitd&lt;/code&gt; to avoid the container.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&quot;building-an-image&quot;&gt;Building an Image&lt;/h2&gt;
&lt;p&gt;Now that we have all dependencies we need, let’s build an image using BuildKit:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat .\DockerFile
FROM alpine
RUN echo &amp;quot;built with BuildKit!&amp;quot; &amp;gt;  file
CMD [&amp;quot;/bin/sh&amp;quot;]&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;➜buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=.
[+] Building 1.4s (5/5) FINISHED                               
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 453B                      0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
 =&amp;gt; [internal] load metadata for docker.io/library/alpin  1.3s
 =&amp;gt; [auth] library/alpine:pull token for registry-1.dock  0.0s
 =&amp;gt; [1/2] FROM docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&amp;gt; =&amp;gt; resolve docker.io/library/alpine@sha256:08d6ca16c  0.0s
  =&amp;gt; [2/2] RUN echo &amp;quot;built with buildkit!&amp;quot; &amp;gt;  file   &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We have built the image, but we haven’t given it a name nor told BuildKit what to do with it.&lt;/p&gt;
&lt;p&gt;By default, the build result will remain internal to BuildKit. An output type needs to be specified to retrieve the result. Let’s specify a docker hub account that we have permission to push to:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;➜ buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=image,name=docker.io/agbell/test,push=true
[+] Building 2.9s (8/8) FINISHED                               
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 32B                       0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
 =&amp;gt; [internal] load metadata for docker.io/library/alpin  0.7s
 =&amp;gt; [auth] library/alpine:pull token for registry-1.dock  0.0s
 =&amp;gt; [1/1] FROM docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&amp;gt; =&amp;gt; resolve docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&amp;gt; [2/2] RUN echo &amp;quot;built with buildkit!&amp;quot; &amp;gt;  file 
 =&amp;gt; exporting to image                                    2.2s
 =&amp;gt; =&amp;gt; exporting layers                                   0.0s
 =&amp;gt; =&amp;gt; exporting manifest sha256:a81d7671b5ceeb534739c95  0.0s
 =&amp;gt; =&amp;gt; exporting config sha256:4c8c89bca725572cf9ff3bd6a  0.0s&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After that, we can pull it and run it:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;➜ docker run -it agbell/test
/ # cat file
built with BuildKit!&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;tangent-where-are-froms-from&quot;&gt;Tangent: Where are `FROM’s from&lt;/h2&gt;
&lt;p&gt;If we have an image locally on our machine, can we use it in a &lt;code&gt;FROM&lt;/code&gt; to build something based on it? Let’s find out by altering our &lt;code&gt;FROM&lt;/code&gt; to use a local image:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM agbell/test:local
RUN echo &amp;quot;BuildKit built&amp;quot;&amp;gt;  file
CMD [&amp;quot;/bin/sh&amp;quot;] 
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker tag alpine agbell/test:local
&amp;gt; buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
------
 &amp;gt; [internal] load metadata for docker.io/agbell/test:local:
------
error: failed to solve: rpc error: code = Unknown desc = failed to solve with frontend dockerfile.v0: failed to create LLB definition: docker.io/agbell/test:local: not found
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It doesn’t work. It looks like it is trying to fetch the image from docker.io, the default docker hub registry.&lt;/p&gt;
&lt;p&gt;We can verify this by quickly &lt;a href=&quot;earthly.dev/blog/mitmproxy/&quot;&gt;capturing requests&lt;/a&gt; from buildkitd:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;➜ cat ~\Dockerfile
FROM moby/buildkit 
RUN apk update &amp;amp;&amp;amp; apk add curl
WORKDIR /usr/local/share/ca-certificates
COPY mitmproxy.crt mitmproxy.crt
RUN update-ca-certificates
➜ docker build . -t buildkit:mitm
 ...
➜ docker run --rm --privileged -d --name buildkit buildkit:mitm
6676dc0109eb3f5f09f7380d697005b6aae401bb72a4ee366f0bb279c0be137b&lt;/code&gt;&lt;/pre&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/2.png&quot; alt=&quot;404 on mitm proxy&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;404 on mitm proxy&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;We can see a &lt;code&gt;404&lt;/code&gt;, and this confirms buildkitd is expecting registry that it can access over the network using the docker registry v2 api.&lt;/p&gt;
&lt;h2 id=&quot;watching-it-build&quot;&gt;Watching It Build&lt;/h2&gt;
&lt;p&gt;Buildkitd is responsible for building the image, but &lt;code&gt;runc&lt;/code&gt; does the actual execution of each step. runc executes each &lt;code&gt;RUN&lt;/code&gt; command in your dockerfile in a separate process. runc requires Linux kernel 5.2 or later with support for cgroups, and is why buildkitd can’t run natively on macOS or Windows.&lt;/p&gt;
&lt;h3 id=&quot;what-is-runc&quot;&gt;What is runc&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;“Please note that runc is a low-level tool not designed with an end-user in mind. It is mostly employed by other higher-level container software. Therefore, unless there is some specific use case that prevents the use of tools like Docker or Podman, it is not recommended to use runc directly.” - &lt;a href=&quot;https://github.com/opencontainers/runc&quot;&gt;runc readme&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We can watch the execution of our build by using &lt;code&gt;pstree&lt;/code&gt; and &lt;code&gt;watch&lt;/code&gt;. Open two side by side terminals, run &lt;code&gt;docker exec -it buildkit &quot;/bin/watch&quot; &quot;-n1&quot; &quot;pstree -p&quot;&lt;/code&gt; in one and call &lt;code&gt;buildctl build ...&lt;/code&gt; in the other. You will see &lt;code&gt;buildkitd&lt;/code&gt; start a &lt;code&gt;buildkit-runc&lt;/code&gt; process and then a separate process for each &lt;code&gt;RUN&lt;/code&gt; command.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/3.png&quot; alt=&quot;Diagram of buildkit running and pstree showing the process tree of buildkitd&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Diagram of buildkit running and pstree showing the process tree of buildkitd&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;how-to-see-docker-processes-on-macos-and-windows&quot;&gt;How to see Docker Processes on macOS and Windows&lt;/h2&gt;
&lt;p&gt;On macOS and Windows, Docker processes run on a separate virtual machine (VM). If you’re using the default and recommended Docker Desktop, this VM is the Linux container host.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Note: Docker Machine is an earlier approach to running Docker on macOS and Windows where the Docker VM runs in VirtualBox or VMware. Docker Machine steps may differ.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The above &lt;code&gt;exec&lt;/code&gt; trick lets us see the processes inside a specific container, but to see all the processes running across all the containers, we need a different technique. To do that, we can use &lt;code&gt;docker run&lt;/code&gt; and &lt;code&gt;nsenter&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker run -it --rm --privileged --pid=host ubuntu nsenter -t 1 -m -u -n -i s&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can now use &lt;code&gt;watch&lt;/code&gt; and &lt;code&gt;pstree&lt;/code&gt; to view the whole container host in a single view:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker-desktop:/# pstree -p
init(1)-+-containerd(983)
        |-containerd-shim(1018)---acpid(1039)
        |-containerd-shim(1064)---diagnosticsd(1085)---sh(1354)
        |-containerd-shim(1109)-+-containerd-shim(2495)-+-buildkitd(2522)
        |                       |                       `-sh(2614)---watch(2903)
        |                       |-containerd-shim(4035)---sh(4062)---pstree(5058)
        |                       |-docker-init(1136)---entrypoint.sh(1154)---logwrite(1183)---lifecycle-serve(1188)-+-logwrite(1340)---containerd(1345)
        |                       |                                                                                  |-logwrite(1550)---dockerd(1555)
        |                       |                                                                                  `-logwrite(1800)
        |                       |-rpc.statd(1293)
        |                       `-rpcbind(1265)
        |-containerd-shim(1162)---host-timesync-d(1199)
        |-containerd-shim(1245)---kmsg(1282)
        |-containerd-shim(1310)---start(1347)---sntpc(1397)
        |-containerd-shim(1374)
        |-containerd-shim(1433)---trim-after-dele(1460)
        |-containerd-shim(1483)---vpnkit-forwarde(1517)
        |-memlogd(442)
        |-rungetty.sh(429)---login(431)---sh(443)
        |-rungetty.sh(432)---login(433)---sh(437)
        `-vpnkit-bridge(452)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can use pstree with a process id (pid) while a build is running to focus on just the buildkitd tree:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker-desktop:/# watch -n 1 pstree -p 2522 &lt;/code&gt;&lt;/pre&gt;
&lt;h1 id=&quot;buildkit-output-types&quot;&gt;BuildKit Output Types&lt;/h1&gt;
&lt;p&gt;So far, we have only used &lt;code&gt;output type=image,&lt;/code&gt; but BuildKit supports several types of outputs.&lt;/p&gt;
&lt;p&gt;We can output a tar:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;buildctl build \
    --frontend=dockerfile.v0 \
    --local context=. \
    --local dockerfile=. \
    --output type=tar,dest=out.tar
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 31B                       0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
...
 =&amp;gt; exporting to client                                   2.6s
 =&amp;gt; =&amp;gt; sending tarball                                    2.6s&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; ls *.tar
 out.tar&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And if we try to load it as a docker image, it will fail:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker load &amp;lt; out.tar
open /var/lib/docker/tmp/docker-import-013443725/bin/json: no such file or directory&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This tag isn’t an image of any sort. There are no layers or manifests, just the full filesystem that the built image would contain.&lt;/p&gt;
&lt;p&gt;We can also export directly to the local filesystem:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;buildctl build --frontend dockerfile.v0 --local context=. --local dockerfile=. --output type=local,dest=output   
[+] Building 2.6s (10/10) FINISHED                             
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 31B                       0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
 =&amp;gt; [internal] load metadata for docker.io/library/alpin  0.6s
 =&amp;gt; [auth] library/alpine:pull token for registry-1.dock  0.0s
 =&amp;gt; [1/5] FROM docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&amp;gt; =&amp;gt; resolve docker.io/library/alpine@sha256:08d6ca16c  0.0s
 =&amp;gt; CACHED [2/5] RUN apk update                           0.0s
 =&amp;gt; CACHED [3/5] RUN apk upgrade                          0.0s
 =&amp;gt; CACHED [4/5] RUN apk add gcc                          0.0s
 =&amp;gt; CACHED [5/5] RUN sleep 1                              0.0s
 =&amp;gt; exporting to client                                   1.9s
 =&amp;gt; =&amp;gt; copying files 121.14MB                             1.9sr&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This filesystem output could be useful if we were trying to trim our image down. We could look through the output and find things to remove and use a multi-stage build to remove them. &lt;a href=&quot;https://github.com/Canop/broot&quot;&gt;broot&lt;/a&gt; is pretty handy for this:&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/what-is-buildkit-and-what-can-i-do-with-it/4.png&quot; alt=&quot;tree view of alpine image showing space used in each directory&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;tree view of alpine image showing space used in each directory&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;what-is-in-from-scratch&quot;&gt;What is in &lt;code&gt;FROM scratch&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;One thing we can do with our newfound powers is investigate the &lt;code&gt;scratch&lt;/code&gt; keyword. The scratch keyword doesn’t correspond to an actual image. We can’t run it:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker run scratch
Unable to find image&amp;#39; scratch:latest&amp;#39; locally
docker: Error response from daemon: &amp;#39;scratch&amp;#39; is a reserved name.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, does it actually contain anything? Is a &lt;code&gt;FROM scratch&lt;/code&gt; image literally empty or are there certain required elements of unix filesystem that &lt;code&gt;scratch&lt;/code&gt; provides? Let’s find out:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; mkdir scratch
&amp;gt; cat .\Dockerfile
FROM scratch
&amp;gt; buildctl build --frontend dockerfile.v0 --local context=. --local dockerfile=. --output type=local,dest=scratch
[+] Building 0.1s (3/3) FINISHED                               
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 31B                       0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
 =&amp;gt; exporting to client                                   0.0s
 =&amp;gt; =&amp;gt; copying files                                      0.0s
 &amp;gt; ls scratch
 &amp;gt; br -s scratch
 0 ./output&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It’s empty! The scratch keyword indicates a completely empty docker layer. The more you know! &lt;em&gt;(The more you know is a trademark of The National Broadcasting Company, who in no way endorse this article 😀 )&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Alright, we have now covered some ways to use BuildKit directly. BuildKit is used internally by &lt;code&gt;docker build&lt;/code&gt; in modern docker versions, but using it directly unlocks some extra options.&lt;/p&gt;
&lt;p&gt;One use we covered was changing the output type. We can use BuildKit to export tars and local file systems. We also use &lt;code&gt;pstree&lt;/code&gt; and &lt;code&gt;mitmProxy&lt;/code&gt; to watch how buildkitd forks processes and make network requests.&lt;/p&gt;
&lt;p&gt;There is much more to learn, though. BuildKit is behind the &lt;code&gt;docker buildx&lt;/code&gt; multiplatform build feature and supports the ability to have multiple workers execute builds in parallel. BuildKit also supports caching, different frontends, docker-compose builds, faster multi-stage builds, and several other features.&lt;/p&gt;
&lt;p&gt;In a future article, we will cover creating a custom frontend and leaving the Dockerfile syntax behind.&lt;/p&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Tutorials" /><summary type="html">There is an excellent open-source project that you have probably used without realizing it. It’s called BuildKit, and it is what turns a Dockerfile into a Docker image. And it doesn’t just build Docker images; it can build OCI images and several other output formats. OpenFasS uses it to turn functions into full containers, and here at Earthly, we use it to create complete continuous integration pipelines.</summary></entry><entry><title type="html">How to Man in the Middle HTTPS Using mitmproxy</title><link href="https://earthly.dev/blog/mitmproxy/" rel="alternate" type="text/html" title="How to Man in the Middle HTTPS Using mitmproxy" /><published>2021-02-11T00:00:00-05:00</published><updated>2021-02-11T00:00:00-05:00</updated><id>https://earthly.dev/blog/mitmproxy</id><content type="html" xml:base="https://earthly.dev/blog/mitmproxy/">&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Have you ever wanted to see what kinds of requests a service or application on your machine is making and what kind of responses it is getting back? Have you ever tried and failed to capture this traffic or modify it to investigate how something works (or doesn’t work). If you have, then mitmproxy might be what you need. Being able to scan through and observe HTTP protocol traffic easily is a great debugging aid.&lt;/p&gt;
&lt;p&gt;This guide will walk you through installing and using mitmproxy to capture HTTPS requests. We will start with macOS traffic capture, then touch on Linux and Windows and then finally show how to capture docker daemon traffic and docker container traffic.&lt;/p&gt;
&lt;h2 id=&quot;what-is-mitmproxy&quot;&gt;What is mitmproxy?&lt;/h2&gt;
&lt;p&gt;mitmproxy is a command-line tool that acts as a HTTP and HTTPS proxy and records all the traffic. You can easily see what requests are being made and even replay them. It’s great for diagnosing problems.&lt;/p&gt;
&lt;h2 id=&quot;installing-it&quot;&gt;Installing it&lt;/h2&gt;
&lt;p&gt;On Mac, mitmproxy is easy to install with brew:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;brew install mitmproxy&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;On Windows and Linux, &lt;a href=&quot;https://docs.mitmproxy.org/stable/overview-installation/&quot;&gt;download the binary release&lt;/a&gt; and place it somewhere in your path.&lt;/p&gt;
&lt;h2 id=&quot;start-it-up&quot;&gt;#1 Start it up&lt;/h2&gt;
&lt;p&gt;To start up mitmproxy, type &lt;code&gt;mitmproxy&lt;/code&gt;, and it will start up bound to port 8080.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt;mitmproxy&lt;/code&gt;&lt;/pre&gt;
The command-line interface (CLI) has VIM-like keybindings. &lt;code&gt;q&lt;/code&gt; will quit, and arrow keys or &lt;code&gt;h&lt;/code&gt;, &lt;code&gt;j&lt;/code&gt;, &lt;code&gt;k&lt;/code&gt;, &lt;code&gt;l&lt;/code&gt; will move you up and down through the request list. &lt;code&gt;?&lt;/code&gt; will load the help, and &lt;code&gt;&amp;lt;&amp;lt;enter&amp;gt;&amp;gt;&lt;/code&gt; will drill in on a specific request.
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/1.png&quot;
       alt=&quot;Help menu for mitmproxy&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Help Menu for mitmproxy&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;mitmproxy also has a web interface if you prefer the mouse over VIM keybindings. The advanced functionality is a bit more discoverable in the web interface, but the CLI version is convenient for quick capture sessions.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/2.png&quot;
       alt=&quot;mitmproxy starting up&quot;&gt;
&lt;/figure&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/3.png&quot;
       alt=&quot;mitmweb starting up&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;We will use both throughout the tutorial. Whichever you choose, start it up and leave it running.&lt;/p&gt;
&lt;h2 id=&quot;proxy-our-connection&quot;&gt;#2 Proxy Our Connection&lt;/h2&gt;
&lt;p&gt;Let’s set up our internet connection to use this proxy. On macOS, Under &lt;code&gt;Setting -&amp;gt; Network&lt;/code&gt;, select your connection and click advanced.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/4.png&quot;
       alt=&quot;Setting -&gt; Network on macOS&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;&lt;code&gt;Setting -&amp;gt; Network&lt;/code&gt; on macOS&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Under proxies, enable both HTTP and HTTPS proxies and choose port 8080:&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/5.png&quot;
       alt=&quot;Setup Proxy under Setting -&gt; Network-&gt; Advanced on macOS&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Setup Proxy under &lt;code&gt;Setting -&amp;gt; Network-&amp;gt; Advanced&lt;/code&gt; on macOS&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;&lt;em&gt;On Windows, &lt;a href=&quot;https://www.howtogeek.com/tips/how-to-set-your-proxy-settings-in-windows-8.1/&quot;&gt;follow these steps&lt;/a&gt; to set up a proxy.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;On Linux, MITM supports a &lt;a href=&quot;https://docs.mitmproxy.org/stable/howto-transparent/&quot;&gt;transparent proxying&lt;/a&gt; at the network layer.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&quot;adding-mitmproxy-as-a-certificate-authority&quot;&gt;Adding mitmproxy as A Certificate Authority&lt;/h2&gt;
&lt;p&gt;We now have our connection proxied to go through our instance of mitmproxy. However, if we attempt to make a HTTPS-based request in a web browser (loading twitter.com for example), something interesting happens.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/6.png&quot;
       alt=&quot;Chrome does not recognize the certificate&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Chrome does not recognize the certificate&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Chrome is warning us that we might be subject to a man in the middle attack.&lt;/p&gt;
&lt;h3 id=&quot;what-is-a-man-in-the-middle&quot;&gt;What is a man in the middle&lt;/h3&gt;
&lt;p&gt;A man in middle attack (MITM) is a security threat where an attacker can get between incoming and outgoing requests. You think you are talking to Twitter.com, but you are talking to the man in the middle, who is talking to Twitter for you. This MITM can view everything you send and even change what you receive.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/7.png&quot;
       alt=&quot;Diagram of Man in the middle&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;The HTTPS protocol prevents MITM attacks. The HTTPS protocol is pretty complex, but all we need to know is that HTTPS uses a trusted Certificate Authority (CA) to sign a certificate. Our browsers assume that if a trusted CA signs the certificate, we are talking directly to who we think we are.&lt;/p&gt;
&lt;p&gt;You can view what CA signed the certificate of the website you are viewing in your browser.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/8.png&quot;
       alt=&quot;Viewing a certificate in your browser&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Viewing a certificate in your browser&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;This is great for protecting online communication but problematic for our debugging purposes. We are trying to man in the middle our own requests. To help overcome this, mitmproxy has generated a certificate. All we need is to get our machine to trust it.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/9.png&quot;
       alt=&quot;Getting a Certificate signed by an unknown certificate authority&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Getting a Certificate signed by an unknown certificate authority&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;how-to-add-a-trusted-certificate-authority-certificate&quot;&gt;How to add a Trusted Certificate Authority Certificate&lt;/h2&gt;
&lt;p&gt;mitmproxy generated a certificate and private key the first time you ran it. The certificate generated is specific to your machine and is located in &lt;code&gt;~/.mitmproxy/mitmproxy-ca-cert.cer&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; cat ~/.mitmproxy/mitmproxy-ca-cert.cer 
-----BEGIN CERTIFICATE-----
MIIC1TCCAb2gAwIBAgIJAOY7y/7Qrqr3MA0GCSqGSIb3DQEBBQUAMBoxGDAWBgNV
BAMTD3d3dy5leGFtcGxlLmNvbTAeFw0yMTAxMjYxNTQyMjhaFw0zMTAxMjQxNTQy
MjhaMBoxGDAWBgNVBAMTD3d3dy5leGFtcGxlLmNvbTCCASIwDQYJKoZIhvcNAQEB
BQADggEPADCCAQoCggEBAMLImmAMUg1zz6GnpoOA7Ln9p53o7v1M4+1O6lYmGtAK
4zetlcMF3mjtNr+AszBFYBpkhd1ef7rDSOc5YxCQ52SZlJc2l2vVtkn5bL1Xa2/W
AdzQcNq2meX6Pdm+YBC7KsmM8+uo8pXy3+gj7avWLXQ3BG+WaWRnRtgVoke53a0s
H+KFwR077XkrIYpOccsrX6+bMrjcnKkEbxb6Q8wdk664c+yf9F+WBC4zcnU43va/
Vl9ETGVOofab6YMk7CICFWEYj/1OJFIMNcEwWpm1eBDXvzt13d1xkiRTDYq+aRKb
utuFiYo7pngGjSEttQKl1nVUcDgkFhPE7Kz3mTBn2T8CAwEAAaMeMBwwGgYDVR0R
BBMwEYIPd3d3LmV4YW1wbGUuY29tMA0GCSqGSIb3DQEBBQUAA4IBAQAxT8EIJUAN
i842v+CoAOnRTO2jDtjIsxgg6WYlpHu1VL+Mh/ye4hfPz6DyyemM4Df64tEc7Mw8
KlhNqXfomY2trZHuxfeyMjg9GItmYaoeV+xg5SDYjGmgE2n8nc5FH5TlhimE9gd1
48NNMFRPXm2cYRz3T4i0HqesBrAmdpWBOQmCqzqF5SR08xqlS8X9ELzkRGTRDiJ5
4j5m1uI0rHyzSVlBK1DKy1LdkGNtes/OuTSZsnQ6PqZBzIZDhbzS0pz7GP9IqHkK
K2k43zCas8fHIU5o+0XoFQ7JoA+1AV3S9LYVD2rHfeOMMY/VzTP+b67/KY7H/Wl+
QyVJfmCmjt2i
-----END CERTIFICATE-----
cat mitmproxy-ca.pem
-----BEGIN PRIVATE KEY-----
MIIC1TCCAb2gAwIBAgIJAOY7y/7Qrqr3MA0GCSqGSIb3DQEBBQUAMBoxGDAWBgNV
BAMTD3d3dy5leGFtcGxlLmNvbTAeFw0yMTAxMjYxNTQyMjhaFw0zMTAxMjQxNTQy
MjhaMBoxGDAWBgNVBAMTD3d3dy5leGFtcGxlLmNvbTCCASIwDQYJKoZIhvcNAQEB
BQADggEPADCCAQoCggEBAMLImmAMUg1zz6GnpoOA7Ln9p53o7v1M4+1O6lYmGtAK
4zetlcMF3mjtNr+AszBFYBpkhd1ef7rDSOc5YxCQ52SZlJc2l2vVtkn5bL1Xa2/W
AdzQcNq2meX6Pdm+YBC7KsmM8+uo8pXy3+gj7avWLXQ3BG+WaWRnRtgVoke53a0s
H+KFwR077XkrIYpOccsrX6+bMrjcnKkEbxb6Q8wdk664c+yf9F+WBC4zcnU43va/
Vl9ETGVOofab6YMk7CICFWEYj/1OJFIMNcEwWpm1eBDXvzt13d1xkiRTDYq+aRKb
utuFiYo7pngGjSEttQKl1nVUcDgkFhPE7Kz3mTBn2T8CAwEAAaMeMBwwGgYDVR0R
BBMwEYIPd3d3LmV4YW1wbGUuY29tMA0GCSqGSIb3DQEBBQUAA4IBAQAxT8EIJUAN
i842v+CoAOnRTO2jDtjIsxgg6WYlpHu1VL+Mh/ye4hfPz6DyyemM4Df64tEc7Mw8
KlhNqXfomY2trZHuxfeyMjg9GItmYaoeV+xg5SDYjGmgE2n8nc5FH5TlhimE9gd1
48NNMFRPXm2cYRz3T4i0HqesBrAmdpWBOQmCqzqF5SR08xqlS8X9ELzkRGTRDiJ5
4j5m1uI0rHyzSVlBK1DKy1LdkGNtes/OuTSZsnQ6PqZBzIZDhbzS0pz7GP9IqHkK
K2k43zCas8fHIU5o+0XoFQ7JoA+1AV3S9LYVD2rHfeOMMY/VzTP+b67/KY7H/Wl+
QyVJfmCmjt2i=
-----END PRIVATE KEY-----&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;em&gt;Note: Once we instruct our machine to trust this certificate, someone with the private key who controlled your internet connection, like your ISP, could use it to MITM your connection. For this reason, don’t share your MITM private key, or any private key, with others.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&quot;add-the-cert-on-macos&quot;&gt;Add the Cert On MacOS&lt;/h2&gt;
&lt;p&gt;On macOS, the easiest way to add a new CA is to copy it to the desktop and then double-click it.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cp ~/.mitmproxy/mitmproxy-ca-cert.cer ~/Desktop&lt;/code&gt;&lt;/pre&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/10.png&quot;
       alt=&quot;Getting a Certificate signed by an unknown certificate authority&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;You will be prompted for your credentials, and the certificate will be added as ‘untrusted’.&lt;/p&gt;
&lt;p&gt;Double-click on the certificate in the Keychain list and set the ‘Secure Sockets Layer’ drop down to ‘Always Trust’&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/11.png&quot;
       alt=&quot;Setting certificate to Always Trust&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;You will then be prompted for your password again, and then your certificate will be trusted.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/13.png&quot;
       alt=&quot;mitmproxy certificate proxy always trusted&quot;&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;installing-the-trusted-root-certificate-on-windows&quot;&gt;Installing The Trusted Root Certificate On Windows&lt;/h2&gt;
&lt;p&gt;If you are on Windows, follow this guide &lt;a href=&quot;https://docs.microsoft.com/en-us/skype-sdk/sdn/articles/installing-the-trusted-root-certificate&quot;&gt;to add the MITM root certificate as a trusted root certificate authority&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;installing-the-cert-on-debian-based-linux-distributions&quot;&gt;Installing The Cert on Debian Based Linux Distributions&lt;/h2&gt;
&lt;p&gt;On Debian-based Linux distributions, follow these steps:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; mkdir /usr/local/share/ca-certificates/extra
&amp;gt; cp ~/.mitmproxy/mitmproxy-ca-cert.cer /usr/local/share/ca-certificates/extra/mitmproxy-ca-cert.crt
&amp;gt; update-ca-certificates&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;em&gt;We will be using these steps later when we work with docker containers on macOS and Windows.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&quot;great-success&quot;&gt;Great Success!&lt;/h2&gt;
&lt;p&gt;At this point, assuming you still have mitmproxy running and you still have your network interface setup to proxy through &lt;code&gt;localhost:8080&lt;/code&gt;, you should be able to view all the HTTP and HTTPS network requests your machine is making in the mitmproxy (or MITMWeb) window.&lt;/p&gt;
Here is Slack making requests:
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/14.png&quot;
       alt=&quot;mitmweb has captured a request from the slack application&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;mitmweb has captured a request from the slack application&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;All HTTPS connections now have certificates signed by mitmproxy, which your machine trusts.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/15.png&quot;
       alt=&quot;Google.com now shows a mitmproxy signed certificate&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Google.com now shows a mitmproxy signed certificate&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;mitm-the-docker-linux-container-host-on-macos-windows&quot;&gt;MITM The Docker Linux Container Host on macOS &amp;amp; Windows&lt;/h2&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/16.png&quot;
       alt=&quot;Diagram of docker runtime on macOS and Windows&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Docker containers run differently on macOS and Windows&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;At this point, we can successfully capture traffic on our host operating system. Unfortunately, this is insufficient for capturing docker container traffic on macOS and Windows. So let’s move on to proxying traffic on the Linux Container Host.&lt;/p&gt;
&lt;p&gt;On macOS and Windows, Linux containers do not run on the host OS. They can’t because they need a Linux host to run. Instead, they run on the Linux Container Host, a VM that Docker Desktop manages.&lt;/p&gt;
&lt;p&gt;To see the docker daemon’s incoming and outgoing requests, we need to get our proxy settings and our certificate authority into that VM. &amp;gt; Before we proceed, we need to clear the proxy settings on the host network connection. We can leave mitmproxy (or MITMWeb running).&lt;/p&gt;
&lt;p&gt;On Windows and macOS, the easiest way to configure a proxy is via &lt;code&gt;Docker Desktop.&lt;/code&gt; Configure the proxy settings under &lt;code&gt;Preferences -&amp;gt; Resources -&amp;gt; Proxies.&lt;/code&gt;&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/18.png&quot;
       alt=&quot;Configure the proxy settings under Preferences -&gt; Resources -&gt; Proxies.&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;Configure the proxy settings under &lt;code&gt;Preferences -&amp;gt; Resources -&amp;gt; Proxies.&lt;/code&gt;&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;With that done, the network interface will be proxied. All that is left to do is get our certificate trusted by the Linux container host. Thankfully, Docker Desktop takes care of this for us. On startup, Docker Desktop loads the trusted root certificates from the host machine into the Docker VM, so all we need to do is restart docker. (&lt;code&gt;Restart Docker&lt;/code&gt; in Docker Desktop).&lt;/p&gt;
&lt;h2 id=&quot;docker-mitm-on-linux&quot;&gt;Docker MITM on Linux&lt;/h2&gt;
&lt;p&gt;On Linux, we can add a proxy by editing the docker client config and then restarting.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; cat ~/.docker/config.json
{
 &amp;quot;proxies&amp;quot;:
 {
   &amp;quot;default&amp;quot;:
   {
     &amp;quot;httpProxy&amp;quot;: &amp;quot;http://127.0.0.1:8080&amp;quot;,
     &amp;quot;httpsProxy&amp;quot;: &amp;quot;http://127.0.0.1:8080&amp;quot;
   }
 }
}&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; sudo service docker restart
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;test-it&quot;&gt;Test it&lt;/h3&gt;
&lt;p&gt;After restarting, we can test the proxying by performing a docker pull for a random image&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;➜  ~ docker pull couchbase:7.0.0-beta
7.0.0-beta: Pulling from library/couchbase
83ee3a23efb7: Pull complete
db98fc6f11f0: Pull complete
f611acd52c6c: Pull complete
3aa2029a80db: Pull complete
abe30feace46: Pull complete
9b70018fbd54: Pull complete
d9b67d157052: Pull complete
212afe5e3a9c: Pull complete
ff5e5d4b4f9c: Pull complete
4df60b92878a: Pull complete
eee5137af1d8: Pull complete
c4ef83141448: Pull complete
6a04071b6d8c: Pull complete
f52d17d818b3: Pull complete
Digest: sha256:290a7a0623b62e02438e6f0cd03adf116ac465f70fc4254a4059bcf51e8fa040
Status: Downloaded newer image for couchbase:7.0.0-beta
docker.io/library/couchbase:7.0.0-beta&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can then see the requests and responses in our proxy:&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/19.png&quot;
       alt=&quot;mitmproxy request for docker.io&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;We can even see the binary payload of the layer requests and the fact that docker uses Cloudflare as a CDN.&lt;/p&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/20.png&quot;
       alt=&quot;&quot;&gt;
&lt;figcaption&gt;
&lt;p&gt;mitmweb request for cloudflare.docker.com&lt;/p&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;## &lt;em&gt;Troubleshooting&lt;/em&gt; &lt;em&gt;If &lt;code&gt;docker pull&lt;/code&gt; fails with a certificate error or the requests don’t get proxied, make sure you have restarted docker at least once and that the proxy settings are in place.&lt;/em&gt;&lt;/p&gt;
&lt;h2 id=&quot;capturing-docker-container-traffic&quot;&gt;Capturing Docker Container Traffic&lt;/h2&gt;
&lt;p&gt;We now know how to capture traffic on our host machine and the Linux container host. But what happens when we make requests from inside a running container?&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker run -it ubuntu
root@ca43de1bb8b1:/# apt upgrade &amp;amp; apt update &amp;amp; apt install curl
...
root@167f5742c295:/# curl http://google.com
&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&amp;quot;content-type&amp;quot; content=&amp;quot;text/html;charset=utf-8&amp;quot;&amp;gt;
&amp;lt;TITLE&amp;gt;301 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;
&amp;lt;H1&amp;gt;301 Moved&amp;lt;/H1&amp;gt;
The document has moved
&amp;lt;A HREF=&amp;quot;http://www.google.com/&amp;quot;&amp;gt;here&amp;lt;/A&amp;gt;.
&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&lt;/code&gt;&lt;/pre&gt;
We are successfully capturing the requests and responses:
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/21.png&quot;
       alt=&quot;&quot;&gt;
&lt;figcaption&gt;
&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;However, we hit problems when we try to use HTTPS:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;root@ca43de1bb8b1:/# curl https://google.com/
curl: (60) server certificate verification failed. CAfile: /etc/ssl/certs/ca-certificates.crt CRLfile: none
More details here: http://curl.haxx.se/docs/sslcerts.html

curl performs SSL certificate verification by default, using a &amp;quot;bundle&amp;quot;
 of Certificate Authority (CA) public keys (CA certs). If the default
 bundle file isn&amp;#39;t adequate, you can specify an alternate file
 using the --cacert option.
If this HTTPS server uses a certificate signed by a CA represented in
 the bundle, the certificate verification probably failed due to a
 problem with the certificate (it might be expired, or the name might
 not match the domain name in the URL).
If you&amp;#39;d like to turn off curl&amp;#39;s verification of the certificate, use
 the -k (or --insecure) option.
 &amp;gt; exit&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;adding-the-ca-cert-to-our-linux-container&quot;&gt;Adding the CA Cert to our Linux Container&lt;/h2&gt;
&lt;p&gt;The solution here is a familiar one. We need to follow the steps we used above for configuring Linux to trust a certificate authority, but we need to do it inside our container.&lt;/p&gt;
&lt;p&gt;There are several ways to accomplish this.&lt;/p&gt;
&lt;h2 id=&quot;solution-1-volume-mount-the-cert&quot;&gt;Solution #1: Volume Mount The Cert&lt;/h2&gt;
&lt;p&gt;The simplest solution is to mount the certificate into the proper spot in our container and run &lt;code&gt;update-ca-certificates&lt;/code&gt;. ### Alpine:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Run container and mount in our CA Cert
&amp;gt; docker run -it -v ~/.mitmproxy/mitmproxy-ca-cert.cer:/usr/local/share/ca-certificates/mitmproxy-ca-cert.cer alpine
# Add ca-certificates (and curl for testing)
root@167f5742c295:/# apk update &amp;amp;&amp;amp; apk upgrade &amp;amp;&amp;amp; apk add ca-certificates &amp;amp;&amp;amp; apk add curl
...

# include trust our cert
root@167f5742c295:/# update-ca-certificates
Updating certificates in /etc/ssl/certs...
1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d...
done.

# Test https
root@167f5742c295:/# curl https://google.com
&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&amp;quot;content-type&amp;quot; content=&amp;quot;text/html;charset=utf-8&amp;quot;&amp;gt;
&amp;lt;TITLE&amp;gt;301 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;
&amp;lt;H1&amp;gt;301 Moved&amp;lt;/H1&amp;gt;
The document has moved
&amp;lt;A HREF=&amp;quot;https://www.google.com/&amp;quot;&amp;gt;here&amp;lt;/A&amp;gt;.
&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;

# Success!&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;ubuntu&quot;&gt;Ubuntu&lt;/h3&gt;
&lt;p&gt;The general pattern with some small modifications works on Ubuntu-based images as well.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker run -it -v ~/.mitmproxy/mitmproxy-ca-cert.cer:/usr/local/share/ca-certificates/mitmproxy-ca-cert.crt ubuntu

root@167f5742c295:/# apt update &amp;amp;&amp;amp; apt upgrade &amp;amp;&amp;amp; apt install ca-certificates curl

root@167f5742c295:/# update-ca-certificates 
Updating certificates in /etc/ssl/certs...
1 added, 0 removed; done.
Running hooks in /etc/ca-certificates/update.d...
done.

root@167f5742c295:/# curl https://google.com
&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&amp;quot;content-type&amp;quot; content=&amp;quot;text/html;charset=utf-8&amp;quot;&amp;gt;
&amp;lt;TITLE&amp;gt;301 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;
&amp;lt;H1&amp;gt;301 Moved&amp;lt;/H1&amp;gt;
The document has moved
&amp;lt;A HREF=&amp;quot;https://www.google.com/&amp;quot;&amp;gt;here&amp;lt;/A&amp;gt;.
&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;

\&amp;gt; # Success!!&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;solution-2-extend-the-image&quot;&gt;Solution #2: Extend the Image&lt;/h2&gt;
&lt;p&gt;Volume mounting the certificate and manually running &lt;code&gt;update-ca-certificates&lt;/code&gt; is an excellent proof of concept, but if you want to run a docker container in the background and have all traffic proxied, then interactive mode won’t cut it. In that case, extending the image is the way to go.&lt;/p&gt;
&lt;h2 id=&quot;extending-an-alpine-image-to-add-a-certificate-authority&quot;&gt;Extending an Alpine Image to Add a Certificate Authority&lt;/h2&gt;
&lt;p&gt;We can create a new Dockerfile that extends the image we want to proxy and add in the certificate.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM alpine # or any alpine based image
RUN apk update &amp;amp;&amp;amp; apk add curl
WORKDIR /usr/local/share/ca-certificates
COPY mitmproxy.crt mitmproxy.crt
RUN update-ca-certificates&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can then build it and tag it with a &lt;code&gt;:mitm&lt;/code&gt; tag.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker build --tag alpine:mitm .
[+] Building 1.9s (10/10) FINISHED                             
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 200B                      0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
 =&amp;gt; [internal] load metadata for docker.io/library/alpin  0.0s
 =&amp;gt; CACHED [1/5] FROM docker.io/library/alpine            0.0s
 =&amp;gt; [internal] load build context                         0.2s
 =&amp;gt; =&amp;gt; transferring context: 1.36kB                       0.2s
 =&amp;gt; [2/5] RUN apk update &amp;amp;&amp;amp; apk add curl                  1.4s
 =&amp;gt; [3/5] WORKDIR /usr/local/share/ca-certificates        0.0s
 =&amp;gt; [4/5] COPY mitmproxy.crt mitmproxy.crt                0.0s 
 =&amp;gt; [5/5] RUN /usr/sbin/update-ca-certificates            0.3s 
 =&amp;gt; exporting to image                                    0.1s 
 =&amp;gt; =&amp;gt; exporting layers                                   0.1s 
 =&amp;gt; =&amp;gt; writing image sha256:ca5be16f3d19c34ea5e29ac1774b  0.0s 
 =&amp;gt; =&amp;gt; naming to docker.io/library/alpine:mitm            0.0s&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now anytime we run this image, it will be ready to accept responses signed by our certificate authority. And because we didn’t change the entry point, we can use it wherever we would use the base image.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker run -it alpine:mitm      
\&amp;gt; curl https://google.com
&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&amp;quot;content-type&amp;quot; content=&amp;quot;text/html;charset=utf-8&amp;quot;&amp;gt;
&amp;lt;TITLE&amp;gt;301 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;
&amp;lt;H1&amp;gt;301 Moved&amp;lt;/H1&amp;gt;
The document has moved
&amp;lt;A HREF=&amp;quot;https://www.google.com/&amp;quot;&amp;gt;here&amp;lt;/A&amp;gt;.
&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Any requests by anything running inside the container will be transparently proxied. If you are trying to debug what a service you depend on is doing this will come in handy.&lt;/p&gt;
&lt;h2 id=&quot;extending-an-ubuntu-image-to-add-a-certificate-authority&quot;&gt;Extending an Ubuntu Image to Add a Certificate Authority&lt;/h2&gt;
&lt;p&gt;A similar process will work with Ubuntu-based images:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM ubuntu
RUN apt update -y &amp;amp;&amp;amp; apt upgrade -y &amp;amp;&amp;amp; apt install ca-certificates curl -y
WORKDIR /usr/local/share/ca-certificates
COPY mitmproxy.crt mitmproxy.crt
RUN update-ca-certificates &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker build --tag ubuntu:mitm .
[+] Building 36.4s (10/10) FINISHED                            
 =&amp;gt; [internal] load build definition from Dockerfile      0.0s
 =&amp;gt; =&amp;gt; transferring dockerfile: 234B                      0.0s
 =&amp;gt; [internal] load .dockerignore                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 2B                           0.0s
 =&amp;gt; [internal] load metadata for docker.io/library/ubunt  0.0s
 =&amp;gt; CACHED [1/5] FROM docker.io/library/ubuntu            0.0s
 =&amp;gt; [internal] load build context                         0.0s
 =&amp;gt; =&amp;gt; transferring context: 35B                          0.0s
 =&amp;gt; [2/5] RUN apt update -y &amp;amp;&amp;amp; apt upgrade -y &amp;amp;&amp;amp; apt in  35.0s
 =&amp;gt; [3/5] WORKDIR /usr/local/share/ca-certificates        0.0s
 =&amp;gt; [4/5] COPY mitmproxy.crt mitmproxy.crt                0.0s
 =&amp;gt; [5/5] RUN update-ca-certificates                      0.9s 
 =&amp;gt; exporting to image                                    0.4s 
 =&amp;gt; =&amp;gt; exporting layers                                   0.3s 
 =&amp;gt; =&amp;gt; writing image sha256:06fbbeea728364e3bacef503f7c2  0.0s 
 =&amp;gt; =&amp;gt; naming to docker.io/library/ubuntu:mitm            0.0s&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; docker run -it ubuntu:mitm    
root&amp;gt; curl https://google.com
&amp;lt;HTML&amp;gt;&amp;lt;HEAD&amp;gt;&amp;lt;meta http-equiv=&amp;quot;content-type&amp;quot; content=&amp;quot;text/html;charset=utf-8&amp;quot;&amp;gt;
&amp;lt;TITLE&amp;gt;301 Moved&amp;lt;/TITLE&amp;gt;&amp;lt;/HEAD&amp;gt;&amp;lt;BODY&amp;gt;
&amp;lt;H1&amp;gt;301 Moved&amp;lt;/H1&amp;gt;
The document has moved
&amp;lt;A HREF=&amp;quot;https://www.google.com/&amp;quot;&amp;gt;here&amp;lt;/A&amp;gt;.
&amp;lt;/BODY&amp;gt;&amp;lt;/HTML&amp;gt;
# Success&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;but-wait-theres-more&quot;&gt;But wait, there’s more&lt;/h2&gt;
&lt;figure class&gt;
&lt;img src=&quot;/blog/assets/images/mitmproxy/22.png&quot;
       alt=&quot;man in the middle diagram&quot;&gt;
&lt;/figure&gt;
&lt;p&gt;There we go. We can now capture HTTPS traffic made by any containers we run. Combined with the previous steps, we can now intercept and inspect HTTP and HTTPS protocol traffic on our host machine, on a Linux virtual machine running in a hypervisor, and in the actual running containers.&lt;/p&gt;
&lt;p&gt;If you can get something running on your local machine, you can now capture and inspect its network requests. This can be very handy for debugging problems and building up an understanding of how something works without digging into the source code. The setup can be a bit complicated, but I hope you can see why mitmproxy is a great tool to keep in your toolkit.&lt;/p&gt;
&lt;p&gt;The fun doesn’t stop here, though. &lt;a href=&quot;https://mitmproxy.org/&quot;&gt;mitmproxy&lt;/a&gt; can modify and replay requests and has an active ecosystem, including &lt;a href=&quot;https://github.com/ustwo/mastermind&quot;&gt;mastermind&lt;/a&gt; which lets you build mock services based on captured requests and &lt;a href=&quot;https://github.com/secretsquirrel/BDFProxy&quot;&gt;BDFProxy&lt;/a&gt;, which uses mitmproxy to modify common security updates for &lt;del&gt;nefarious reasons&lt;/del&gt; security research projects, and much more.&lt;/p&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Tutorials" /><summary type="html">Have you ever wanted to see what kinds of requests a service or application on your machine is making and what kind of responses it is getting back?</summary></entry></feed>
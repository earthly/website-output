<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.1.1">Jekyll</generator><link href="https://earthly.dev/blog/feed.xml" rel="self" type="application/atom+xml" /><link href="https://earthly.dev/blog/" rel="alternate" type="text/html" /><updated>2021-06-04T14:35:40-04:00</updated><id>https://earthly.dev/blog/feed.xml</id><title type="html">Earthly Blog</title><subtitle>Build automation for the container era.</subtitle><entry><title type="html">Achieving Repeatability in Continuous Integration</title><link href="https://earthly.dev/blog/achieving-repeatability/" rel="alternate" type="text/html" title="Achieving Repeatability in Continuous Integration" /><published>2021-06-01T00:00:00-04:00</published><updated>2021-06-01T00:00:00-04:00</updated><id>https://earthly.dev/blog/achieving-repeatability</id><content type="html" xml:base="https://earthly.dev/blog/achieving-repeatability/">&lt;blockquote&gt;
&lt;p&gt;In software engineering, continuous integration is the practice of merging all developers’ working copies to a shared mainline several times a day. Grady Booch first proposed the term CI in his 1991 method, although he did not advocate integrating several times a day. —&lt;a href=&quot;https://en.wikipedia.org/wiki/Continuous_integration&quot; title=&quot;Wikipedia article on continuous integration&quot;&gt;Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Continuous Integration (CI) and continuous delivery (CD) are some of the best practices that any DevOps team can implement. You could argue that they’re necessary for teams looking to ship quality products fast and with confidence.&lt;/p&gt;
&lt;p&gt;CI and CD are two pieces of a whole, the former dealing with the task to automate the process of building, testing, and integrating new features and code changes into the codebase mainline; and the latter dealing with automating the process of delivering the changes to the defined environments.&lt;/p&gt;
&lt;p&gt;The implementation of both methodologies is often referred to as a &lt;strong&gt;CI/CD pipeline&lt;/strong&gt;; it is worth noting that both for CI and CD, the operating principles and coding philosophy are equally as important as the technical aspect of the implementation.&lt;/p&gt;
&lt;p&gt;CI’s technical goal is to provide consistent and automated results to build, package, and test applications. This repeatable flow and process allows teams to commit and merge changes more frequently, thus reducing the risk of conflicts or getting stuck in &lt;strong&gt;Integration Hell&lt;/strong&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Integration Hell refers to the point in production when members on a delivery team integrate their individual code. In traditional software development environments, this integration process is rarely smooth and seamless, instead resulting in hours or perhaps days of fixing the code so that it can finally integrate. Continuous Integration (CI) aims to avoid this completely by enabling and encouraging team members to integrate frequently (e.g., hourly, or at least daily). —&lt;a href=&quot;https://www.solutionsiq.com/agile-glossary/integration-hell/&quot; title=&quot;Accenture | SolutionsIQ&amp;#39;s definition of Integration Hell&quot;&gt;SolutionsIQ&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This article focuses on the concepts, tools, and best practices that will allow you to achieve a high degree of repeatability and consistency on your CI/CD pipeline.&lt;/p&gt;
&lt;h2 id=&quot;ci-repeatability-principles&quot;&gt;CI Repeatability Principles&lt;/h2&gt;
&lt;p&gt;One of the critical aspects of a successful and healthy CI pipeline is having repeatable builds, which guarantee consistent and reliable results. Four fundamental principles are essential to observe to achieve repeatability:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Reliability&lt;/li&gt;
&lt;li&gt;Reproducibility&lt;/li&gt;
&lt;li&gt;Reusability&lt;/li&gt;
&lt;li&gt;Speed&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;reliability&quot;&gt;Reliability&lt;/h3&gt;
&lt;p&gt;Reliability in continuous integration comes from knowing that the systems involved in testing the application are both available and capable of performing the complete set of tests that we need. This also means that the system has to produce consistent builds.&lt;/p&gt;
&lt;p&gt;Reliability gives the confidence to deliver shippable working code at any time during the application lifetime.&lt;/p&gt;
&lt;h3 id=&quot;reproducibility&quot;&gt;Reproducibility&lt;/h3&gt;
&lt;p&gt;CI infrastructure and pipelines can be—and more often than not, are—software assets on their own. The work done to create and implement CI runners and pipelines for our software projects can also be built, tested, and packaged just like any other software build.&lt;/p&gt;
&lt;p&gt;Examples of this are containerizing the environments used to run your test suites, including dependencies such as a database or ancillary applications for the end-to-end test suites.&lt;/p&gt;
&lt;p&gt;Treating the CI pipelines as another software project also allows the development team to reproduce the same results from the CI pipeline locally and shorten the feedback loop.&lt;/p&gt;
&lt;h3 id=&quot;reusability&quot;&gt;Reusability&lt;/h3&gt;
&lt;p&gt;With reproducible builds, we can achieve reusability, meaning that the same tools and process can be used in more than one project. Having a system in which we are not building a special custom CI pipeline for each project allows us to find patterns that we can apply to many projects.&lt;/p&gt;
&lt;p&gt;The type of reusable resources greatly varies depending on the type of applications and tests on each organization, from simple reusable scripts to containerized environments.&lt;/p&gt;
&lt;h3 id=&quot;speed&quot;&gt;Speed&lt;/h3&gt;
&lt;p&gt;One of the primary benefits of a good and effective CI process is the feedback loop it provides to the developers working on a project. Feedback loops start losing their value and &lt;a href=&quot;https://martinfowler.com/articles/developer-effectiveness.html&quot; title=&quot;Tim Cochran&amp;#39;s article on maximizing developer effectiveness at MartinFowler.com&quot;&gt;detract from developer effectiveness as they get slower&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We need to consider several factors when building a support CI pipeline, from the underlying hardware and test runners to the structure of the unit tests themselves as a larger unit. Integration tests do add to the overall testing time, and it’s important to keep that time short to make the value of the tests high.&lt;/p&gt;
&lt;h2 id=&quot;best-practices&quot;&gt;Best Practices&lt;/h2&gt;
&lt;p&gt;Now that we understand why &lt;strong&gt;reusability&lt;/strong&gt;, &lt;strong&gt;reproducibility&lt;/strong&gt;, &lt;strong&gt;reliability&lt;/strong&gt;, and &lt;strong&gt;speed&lt;/strong&gt; are important for building repeatable and effective continuous integration pipelines, let’s talk about specific practices and processes that can help achieve them.&lt;/p&gt;
&lt;h3 id=&quot;test-automation-and-coverage&quot;&gt;Test Automation and Coverage&lt;/h3&gt;
&lt;p&gt;To leverage the full value of continuous integration, you will need to automate all your tests and make sure they run for every change made to the repository. It’s also advisable to leverage the following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Unit tests&lt;/strong&gt; to verify the behavior of small methods and functions&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Integration tests&lt;/strong&gt; to make sure multiple components work together&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Acceptance tests&lt;/strong&gt; to cover behavior required on the business specifications&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;End-to-end tests&lt;/strong&gt; to validate the behavior of the application as a whole from the user perspective&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;adopting-continuous-integration&quot;&gt;Adopting Continuous Integration&lt;/h3&gt;
&lt;p&gt;While automation and observability of our pipelines are important, the cultural aspects of working with continuous integration and ensuring that the team adopts the continuous integration principles are equally as important.&lt;/p&gt;
&lt;h4 id=&quot;integrate-early-and-often&quot;&gt;Integrate Early and Often&lt;/h4&gt;
&lt;p&gt;A crucial cultural aspect of continuous integration is building the habit and cadence of the team committing their code every day and multiple times per day. By pushing their code frequently, developers can quickly find conflicts between two changes and also become aware of other work.&lt;/p&gt;
&lt;p&gt;Additionally, pushing their commits often allows developers to get feedback from the full CI pipeline running and allow them to identify defects in the code much sooner.&lt;/p&gt;
&lt;p&gt;The rule of thumb is that developers should commit their code every day, whether it is to the mainline branch on a feature branch. The more frequently you commit, the less opportunity there will be for conflict, errors, or broken tests, significantly increasing the team’s speed.&lt;/p&gt;
&lt;h4 id=&quot;fail-early-and-fail-fast&quot;&gt;Fail Early and Fail Fast&lt;/h4&gt;
&lt;p&gt;The whole point of continuous integration is providing rapid feedback. Nothing is more frustrating than a build that takes hours to complete, only to fail because of errors in some of the initial test suites.&lt;/p&gt;
&lt;p&gt;It is possible that due to the size of the application, the complete set of tests (unit, integration, end-to-end) might take a while to run. To help things go smoothly, you should consider the following processes:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Breaking tests into groups (per module, per domain, and so forth) and running them in parallel&lt;/li&gt;
&lt;li&gt;Run critical path tests first (core or fundamental logic)&lt;/li&gt;
&lt;li&gt;Fail and stop the entire build if critical tests fail&lt;/li&gt;
&lt;li&gt;Integrate with notifications systems (Slack, email) to let developers know as soon things fail&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&quot;make-it-visible&quot;&gt;Make It Visible&lt;/h4&gt;
&lt;p&gt;A core tenet of continuous integration is communication, so you want to ensure that everyone can easily see the state of the system and the changes that have been made to it.&lt;/p&gt;
&lt;p&gt;Information such as the states of integration branches and the state of the mainline build become a priority. Back in the day, engineering teams would go as far as hooking up physical traffic lights to signal the state of the mainline branch.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/achieving-repeatability/anBo2up.png&quot; alt=&quot;Semaphore CI&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Semaphore CI&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;Nowadays, with cloud solutions being more prevalent and deeply integrated with source control systems, it’s much easier to give all developers a high degree of visibility. A perfect example is CI pipelines with &lt;a href=&quot;https://github.com/features/actions&quot; title=&quot;GitHub Actions workflow automation&quot;&gt;GitHub Actions&lt;/a&gt;, which provides feedback directly on pull requests and allows you to visualize the state of a pipeline at every given step.&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/achieving-repeatability/twM26E6.png&quot; alt=&quot;Github Actions CI&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Github Actions CI&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h4 id=&quot;fix-broken-builds-immediately&quot;&gt;Fix Broken Builds Immediately&lt;/h4&gt;
&lt;p&gt;A crucial part of implementing continuous integrations is that if the mainline build fails, it needs to be fixed right away. One of the key points of working with CI is having a trusted, stable code base to develop against.&lt;/p&gt;
&lt;p&gt;The mainline build breaking is not necessarily a bad thing on its own. Still, it might highlight gaps in how the team works, like people not being careful enough about updating and building locally before committing.&lt;/p&gt;
&lt;p&gt;The fastest way to fix a broken build is to roll back to the last known good commit and review what happened. By all means, we should avoid debugging on the broken mainline; this becomes especially true when multiple teams are working on the same code base.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Continuous integration reduces risk by eliminating long integration efforts and reducing the feedback loops. To recap, there are many advantages to implementing continuous integration in your teams:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Allows identifying bugs and software defects faster&lt;/li&gt;
&lt;li&gt;Reduces the feedback loop for engineers&lt;/li&gt;
&lt;li&gt;Removes blind spots that can occur with deferred integration&lt;/li&gt;
&lt;li&gt;Improves communication and velocity of the engineering teams&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To achieve repeatability in a CI/CD pipeline, it’s essential to keep in mind the following principles:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Reliable&lt;/strong&gt; continuous integration environments help us avoid slowing down the feedback loops for the developers and maintain &lt;strong&gt;speed&lt;/strong&gt; of development.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Reproducible&lt;/strong&gt; builds give our developers confidence to keep momentum and keep building with confidence.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Reusability&lt;/strong&gt; allows us to leverage the tools, patterns, and environments for continuous integration across projects.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Speed&lt;/strong&gt; reduces the feedback cycle for developers, allowing them to ship more features in a shorter time.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Finally, having continuous integration and continuous delivery removes one of the biggest barriers to implementing &lt;strong&gt;continuous deployment&lt;/strong&gt;. Continuous deployment extends this flow and enables fully automated deployments into production.&lt;/p&gt;
&lt;p&gt;The combination of continuous integration, continuous delivery, and continuous deployment allows teams to ship features faster and get them in front of customers faster, shortening the feedback loop and increasing value generation.&lt;/p&gt;
&lt;p&gt;For anyone looking to learn more about continuous integration, I highly recommend &lt;a href=&quot;https://martinfowler.com/&quot;&gt;Martin Fowler’s&lt;/a&gt; book &lt;a href=&quot;https://www.martinfowler.com/books/duvall.html&quot; title=&quot;Continuous Integration by Martin Fowler&quot;&gt;Continuous Integration&lt;/a&gt;.&lt;/p&gt;</content><author><name>Allan MacGregor</name></author><category term="Tutorials" /><summary type="html">In software engineering, continuous integration is the practice of merging all developers’ working copies to a shared mainline several times a day. Grady Booch first proposed the term CI in his 1991 method, although he did not advocate integrating several times a day. —Wikipedia</summary></entry><entry><title type="html">Creating and hosting your own deb packages and apt repo</title><link href="https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo/" rel="alternate" type="text/html" title="Creating and hosting your own deb packages and apt repo" /><published>2021-06-01T00:00:00-04:00</published><updated>2021-06-01T00:00:00-04:00</updated><id>https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo</id><content type="html" xml:base="https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo/">&lt;!-- markdownlint-disable MD032 --&gt;
&lt;p&gt;As an Ubuntu user, I find myself typing &lt;code&gt;apt install ...&lt;/code&gt; frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests. &lt;!-- markdownlint-enable MD032 --&gt;&lt;/p&gt;
&lt;h2 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h2&gt;
&lt;p&gt;This tutorial assumes you are using ubuntu, and that the following packages are installed:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get install &lt;span class=&quot;at&quot;&gt;-y&lt;/span&gt; gcc dpkg-dev gpg&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;step-0-creating-a-simple-hello-world-program&quot;&gt;Step 0: creating a simple hello world program&lt;/h2&gt;
&lt;p&gt;Before getting started with packaging, let’s create a basic hello world program under &lt;code&gt;~/example/hello-world-program&lt;/code&gt;. To do this, you can copy and paste the following commands into your terminal:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; ~/example/hello-world-program&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;#include &amp;lt;stdio.h&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;int main() {&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    printf(&amp;quot;hello packaged world\n&amp;quot;);&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-6&quot;&gt;&lt;a href=&quot;#cb2-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    return 0;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb2-7&quot;&gt;&lt;a href=&quot;#cb2-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;}&amp;#39;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/hello-world-program/hello.c&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then, you can compile it with:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/example/hello-world-program&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;gcc&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-o&lt;/span&gt; hello-world hello.c&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There’s no technical reason for picking C for this example – the language doesn’t matter. It’s the binary we will be distributing in our deb package.&lt;/p&gt;
&lt;h2 id=&quot;step-1-creating-a-deb-package&quot;&gt;Step 1: Creating a deb package&lt;/h2&gt;
&lt;p&gt;Debian, and Debian-based linux distributions use &lt;code&gt;.deb&lt;/code&gt; packages to package and distribute programs. To start we will create a directory in the form:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;package-name&amp;gt;_&amp;lt;version&amp;gt;-&amp;lt;release-number&amp;gt;_&amp;lt;architecture&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;where the&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;package-name&lt;/code&gt; is the name of our package, &lt;code&gt;hello-world&lt;/code&gt; in our case,&lt;/li&gt;
&lt;li&gt;&lt;code&gt;version&lt;/code&gt; is the version of the software, &lt;code&gt;0.0.1&lt;/code&gt; in our case,&lt;/li&gt;
&lt;li&gt;&lt;code&gt;release-number&lt;/code&gt; is used to track different releases of the same software version; it’s usually set to &lt;code&gt;1&lt;/code&gt;, but hypothetically if there was an error in the packaging (e.g. a file was missed, or the description had an error in it, or a post-install script was wrong), this number would be increased to track the change, and&lt;/li&gt;
&lt;li&gt;&lt;code&gt;architecture&lt;/code&gt; is the target architecture of the platform, &lt;code&gt;amd64&lt;/code&gt; in this example; however if your package is architecture-independent (e.g. a python script), then you can set this to &lt;code&gt;all&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;Theoretically, the directory doesn’t have to follow this naming convention; however some of the tools we will use later in the tutorial require this directory naming convention.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;So for this example, we’ll create the directory with:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This directory will be the root of the package. Since we want our &lt;code&gt;hello-world&lt;/code&gt; binary to be installed system wide, we’ll have to store it under &lt;code&gt;usr/bin/hello-world&lt;/code&gt; with the following commands:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; usr/bin&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cp&lt;/span&gt; ~/example/hello-world-program/hello-world usr/bin/.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Each package requires a &lt;code&gt;control&lt;/code&gt; file which needs to be located under the &lt;code&gt;DEBIAN&lt;/code&gt; directory. You can copy and paste the following to create one:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64/DEBIAN&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;Package: hello-world&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Version: 0.0.1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Maintainer: example &amp;lt;example@example.com&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Depends: libc6&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Architecture: amd64&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Homepage: http://example.com&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-9&quot;&gt;&lt;a href=&quot;#cb7-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Description: A program that prints hello&amp;quot;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-10&quot;&gt;&lt;a href=&quot;#cb7-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that we’re assuming an amd64 Architecture for this tutorial, if your binary is for a different architecture, adjust accordingly. If you’re distributing a platform-independent package, you can set the architecture to &lt;code&gt;all&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;By this point you should have created two files:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;~/example/hello-world_0.0.1-1_amd64/usr/bin/hello-world
~/example/hello-world_0.0.1-1_amd64/DEBIAN/control&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To build the .deb package, run:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;dpkg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--build&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will output a deb package under &lt;code&gt;~/example/hello-world_0.0.1.deb&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;You can inspect the info of the deb by running:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;dpkg-deb&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--info&lt;/span&gt; ~/example/hello-world_0.0.1.deb&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which will show:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;new&lt;/span&gt; Debian package, version 2.0.&lt;/span&gt;
&lt;span id=&quot;cb11-2&quot;&gt;&lt;a href=&quot;#cb11-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;size&lt;/span&gt; 2832 bytes: control archive=336 bytes.&lt;/span&gt;
&lt;span id=&quot;cb11-3&quot;&gt;&lt;a href=&quot;#cb11-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;ex&quot;&gt;182&lt;/span&gt; bytes,     7 lines      control&lt;/span&gt;
&lt;span id=&quot;cb11-4&quot;&gt;&lt;a href=&quot;#cb11-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Package:&lt;/span&gt; hello-world&lt;/span&gt;
&lt;span id=&quot;cb11-5&quot;&gt;&lt;a href=&quot;#cb11-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Version:&lt;/span&gt; 0.0.1&lt;/span&gt;
&lt;span id=&quot;cb11-6&quot;&gt;&lt;a href=&quot;#cb11-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Maintainer:&lt;/span&gt; example &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;example@example.com&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb11-7&quot;&gt;&lt;a href=&quot;#cb11-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Depends:&lt;/span&gt; libc6&lt;/span&gt;
&lt;span id=&quot;cb11-8&quot;&gt;&lt;a href=&quot;#cb11-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Architecture:&lt;/span&gt; amd64&lt;/span&gt;
&lt;span id=&quot;cb11-9&quot;&gt;&lt;a href=&quot;#cb11-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Homepage:&lt;/span&gt; http://example.com&lt;/span&gt;
&lt;span id=&quot;cb11-10&quot;&gt;&lt;a href=&quot;#cb11-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;Description:&lt;/span&gt; A program that prints hello&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can also view the contents by running:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;dpkg-deb&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--contents&lt;/span&gt; ~/example/hello-world_0.0.1.deb&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which will show:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;drwxrwxr-x alex/alex         0 2021-05-17 16:21 ./
drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/
drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/bin/
-rwxrwxr-x alex/alex     16696 2021-05-17 16:18 ./usr/bin/hello-world&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;It’s also possible to run &lt;code&gt;less ~/example/hello-world_0.0.1.deb&lt;/code&gt; which will output the above information, thanks to &lt;code&gt;/bin/lesspipe&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;This package can then be installed using the &lt;code&gt;-f&lt;/code&gt; option under &lt;code&gt;apt-get install&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get install &lt;span class=&quot;at&quot;&gt;-f&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64.deb&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then once installed, you can verify it works with commands like:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;which&lt;/span&gt; hello-world&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;hello-world&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which should output &lt;code&gt;/usr/bin/hello-world&lt;/code&gt; and &lt;code&gt;hello packaged world&lt;/code&gt; respectively.&lt;/p&gt;
&lt;p&gt;Finally, if you want to remove it, you can run:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get remove hello-world&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This concludes the first step of building a &lt;code&gt;.deb&lt;/code&gt; package. If you have access to an existing apt repository, you could submit the deb to the repository maintainer, and call it a day.&lt;/p&gt;
&lt;h2 id=&quot;step-2-creating-an-apt-repository&quot;&gt;Step 2: Creating an apt repository&lt;/h2&gt;
&lt;p&gt;In this step, we will show how to create your own apt repository which can be used to host one or more deb packages.&lt;/p&gt;
&lt;p&gt;Let’s start with creating a directory to hold our debs:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb18&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb18-1&quot;&gt;&lt;a href=&quot;#cb18-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; ~/example/apt-repo/pool/main/&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then copy our deb(s) into this directory:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cp&lt;/span&gt; ~/example/hello-world_0.0.1-1_amd64.deb ~/example/apt-repo/pool/main/.&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;Larger apt repositories create sub-directories for each program or project. For example, the official ubuntu apt repo stores all vim related packages under &lt;code&gt;/ubuntu/pool/main/v/vim/&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Once you’ve copied in all of your debs, we will create a different directory to contain a list of all available packages and corresponding metadata:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; ~/example/apt-repo/dists/stable/main/binary-amd64&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;If you want to support multiple architectures, make a directory above for each type (e.g. &lt;code&gt;i386&lt;/code&gt;, &lt;code&gt;amd64&lt;/code&gt;, etc).&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Next, we will generate a &lt;code&gt;Packages&lt;/code&gt; file, which will contain a list of all availables packes in this repository. We will use the &lt;code&gt;dpkg-scanpackages&lt;/code&gt; program to generate it, by running:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/example/apt-repo&lt;/span&gt;
&lt;span id=&quot;cb21-2&quot;&gt;&lt;a href=&quot;#cb21-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;dpkg-scanpackages&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--arch&lt;/span&gt; amd64 pool/ &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; dists/stable/main/binary-amd64/Packages&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It’s also good practice to compress the packages file, as apt will favour downloading compressed data whenever available. Let’s do this by running:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb22&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb22-1&quot;&gt;&lt;a href=&quot;#cb22-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; dists/stable/main/binary-amd64/Packages &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;gzip&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-9&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; dists/stable/main/binary-amd64/Packages.gz&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let’s take a quick look at the contents of the Packages file:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Package: hello-world
Version: 0.0.1
Architecture: amd64
Maintainer: example &amp;lt;example@example.com&amp;gt;
Depends: libc6
Filename: pool/main/hello-world_0.0.1-1_amd64.deb
Size: 2832
MD5sum: 3eba602abba5d6ea2a924854d014f4a7
SHA1: e300cabc138ac16b64884c9c832da4f811ea40fb
SHA256: 6e314acd7e1e97e11865c11593362c65db9616345e1e34e309314528c5ef19a6
Homepage: http://example.com
Description: A program that prints hello&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;if you had multiple deb files, you would have an entry for each package&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;The contents of the Packages file is a list of all available packages along with metadata from the &lt;code&gt;DEBIAN/control&lt;/code&gt; file, and some hashes which can be used to validate the integrety of the package.&lt;/p&gt;
&lt;p&gt;Next we will create a Release file. Unfortunately &lt;code&gt;dpkg-scanpackages&lt;/code&gt; does not create Release files. Some people use programs like &lt;code&gt;apt-ftparchive&lt;/code&gt;; however in this example I’ll cover an alternative to &lt;code&gt;apt-ftparchive&lt;/code&gt; by using a small bash script.&lt;/p&gt;
&lt;p&gt;First let’s look at an example of a Release file, which can be broken up into two parts:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;&lt;p&gt;Metadata about the repository, for example:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Origin: Example Repository
Label: Example
Suite: stable
Codename: stable
Version: 1.0
Architectures: amd64 arm64 arm7
Components: main
Description: An example software repository&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;A list of all &lt;code&gt;Packages&lt;/code&gt; files and their corresponding hashes and file size, for example:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;MD5Sum:
 9eb0c0528a0647daf18c7e225ac68f45 667 main/binary-amd64/Packages.gz
 628682afa8a0208e08b5a208a4c4c85b 1685 main/binary-amd64/Packages
 b5bef2199e86a43ae02adc0b7b38bc8a 556 main/binary-arm7/Packages.gz
 81c53db3b9c5e9de44d3ca9fc4487995 1289 main/binary-arm7/Packages
 15258b054124639f0641c399f291af17 557 main/binary-arm64/Packages.gz
 dc597a0815aebb56b25a4ad979682f49 1292 main/binary-arm64/Packages
SHA1:
 a4074284eb528e5d16c2c94e203d61dd825fa774 667 main/binary-amd64/Packages.gz
 ee86dd9061967232e6e68104a695f7d45d191b41 1685 main/binary-amd64/Packages
 a6f4897bcf6a4b068c5b8fafca01fc89761106dc 556 main/binary-arm7/Packages.gz
 43171192ce84dcb43bba99828fe7493ff23e0b0e 1289 main/binary-arm7/Packages
 9f353a909a9a3dab0a9cae1a3c7ccb879ff18d32 557 main/binary-arm64/Packages.gz
 da15c24e51a028ff591656eef0d1da0dbb85ba97 1292 main/binary-arm64/Packages
SHA256:
 dee57f6f4a2209b63301984acb4b279f694648915fd559287a414365884c1842 667 main/binary-amd64/Packages.gz
 7d82e5929d909d10d9f2d7129df3f6754946397caf1c08e9e4a65713f4ac39ff 1685 main/binary-amd64/Packages
 2b3c611305e096ef246d77d2bc5fcfa807034dd200f8f99005ab640cf2c014a4 556 main/binary-arm7/Packages.gz
 d03d5192e24e098a91465ab37d34e0a2c539f50a430eb3262a543e7bd11212a1 1289 main/binary-arm7/Packages
 f96316ff77e96d246447f0ca8383472acefc0744d9b49d2be1d214d174bba38a 557 main/binary-arm64/Packages.gz
 58120a7b5ceb57ab4faca01adac3d62009a52962e0d0a6f4b7ceb1b8faedf280 1292 main/binary-arm64/Packages&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;And that’s it for what a &lt;code&gt;Release&lt;/code&gt; file looks like. How hard could it be? let’s &lt;a href=&quot;/blog/understanding-bash&quot;&gt;write some bash&lt;/a&gt;. Just copy and paste the following in your terminal to get a copy of the script:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb26&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb26-1&quot;&gt;&lt;a href=&quot;#cb26-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;#39;#!/bin/sh&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-2&quot;&gt;&lt;a href=&quot;#cb26-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;set -e&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-3&quot;&gt;&lt;a href=&quot;#cb26-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-4&quot;&gt;&lt;a href=&quot;#cb26-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;do_hash() {&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-5&quot;&gt;&lt;a href=&quot;#cb26-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    HASH_NAME=$1&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-6&quot;&gt;&lt;a href=&quot;#cb26-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    HASH_CMD=$2&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-7&quot;&gt;&lt;a href=&quot;#cb26-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    echo &amp;quot;${HASH_NAME}:&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-8&quot;&gt;&lt;a href=&quot;#cb26-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    for f in $(find -type f); do&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-9&quot;&gt;&lt;a href=&quot;#cb26-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;        f=$(echo $f | cut -c3-) # remove ./ prefix&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-10&quot;&gt;&lt;a href=&quot;#cb26-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;        if [ &amp;quot;$f&amp;quot; = &amp;quot;Release&amp;quot; ]; then&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-11&quot;&gt;&lt;a href=&quot;#cb26-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;            continue&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-12&quot;&gt;&lt;a href=&quot;#cb26-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;        fi&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-13&quot;&gt;&lt;a href=&quot;#cb26-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;        echo &amp;quot; $(${HASH_CMD} ${f}  | cut -d&amp;quot; &amp;quot; -f1) $(wc -c $f)&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-14&quot;&gt;&lt;a href=&quot;#cb26-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;    done&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-15&quot;&gt;&lt;a href=&quot;#cb26-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;}&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-16&quot;&gt;&lt;a href=&quot;#cb26-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-17&quot;&gt;&lt;a href=&quot;#cb26-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;cat &amp;lt;&amp;lt; EOF&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-18&quot;&gt;&lt;a href=&quot;#cb26-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Origin: Example Repository&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-19&quot;&gt;&lt;a href=&quot;#cb26-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Label: Example&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-20&quot;&gt;&lt;a href=&quot;#cb26-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Suite: stable&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-21&quot;&gt;&lt;a href=&quot;#cb26-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Codename: stable&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-22&quot;&gt;&lt;a href=&quot;#cb26-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Version: 1.0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-23&quot;&gt;&lt;a href=&quot;#cb26-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Architectures: amd64 arm64 arm7&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-24&quot;&gt;&lt;a href=&quot;#cb26-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Components: main&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-25&quot;&gt;&lt;a href=&quot;#cb26-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Description: An example software repository&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-26&quot;&gt;&lt;a href=&quot;#cb26-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Date: $(date -Ru)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-27&quot;&gt;&lt;a href=&quot;#cb26-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;EOF&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-28&quot;&gt;&lt;a href=&quot;#cb26-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;do_hash &amp;quot;MD5Sum&amp;quot; &amp;quot;md5sum&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-29&quot;&gt;&lt;a href=&quot;#cb26-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;do_hash &amp;quot;SHA1&amp;quot; &amp;quot;sha1sum&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-30&quot;&gt;&lt;a href=&quot;#cb26-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;do_hash &amp;quot;SHA256&amp;quot; &amp;quot;sha256sum&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb26-31&quot;&gt;&lt;a href=&quot;#cb26-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;&amp;#39;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/generate-release.sh &lt;span class=&quot;kw&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;chmod&lt;/span&gt; +x ~/example/generate-release.sh&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next let’s run the &lt;code&gt;generate-release.sh&lt;/code&gt; script with:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb27&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb27-1&quot;&gt;&lt;a href=&quot;#cb27-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/example/apt-repo/dists/stable&lt;/span&gt;
&lt;span id=&quot;cb27-2&quot;&gt;&lt;a href=&quot;#cb27-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;~/example/generate-release.sh&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; Release&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;At this point, you can try hosting this repo for yourself. In this example we’ll use python’s simple http server; however in practice you’ll want to use a production-ready server. Here’s how you can start it up for testing:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb28&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb28-1&quot;&gt;&lt;a href=&quot;#cb28-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/example&lt;/span&gt;
&lt;span id=&quot;cb28-2&quot;&gt;&lt;a href=&quot;#cb28-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;python3&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-m&lt;/span&gt; http.server&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then configure this apt repository:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb29&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb29-1&quot;&gt;&lt;a href=&quot;#cb29-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;deb [arch=amd64] http://127.0.0.1:8000/apt-repo stable main&amp;quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; tee /etc/apt/sources.list.d/example.list&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then finally update apt and install our new hello-world package:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb30&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb30-1&quot;&gt;&lt;a href=&quot;#cb30-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get update &lt;span class=&quot;at&quot;&gt;--allow-insecure-repositories&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb30-2&quot;&gt;&lt;a href=&quot;#cb30-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get install hello-world&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that the &lt;code&gt;--allow-insecure-repositories&lt;/code&gt; will print the following warning message:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;W: The repository &amp;#39;http://127.0.0.1:8000/apt-repo stable Release&amp;#39; is not signed.
N: Data from such a repository can&amp;#39;t be authenticated and is therefore potentially dangerous to use.
N: See apt-secure(8) manpage for repository creation and user configuration details.&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;That flag should never be used in a production environment. In the next section we’ll cover how to sign the repository, so it can be used in a trusted manor. Similarly when we install &lt;code&gt;hello-world&lt;/code&gt;, we are asked if we want to proceed with an un-authenticated package:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;WARNING: The following packages cannot be authenticated!
  hello-world
Install these packages without verification? [y/N]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Fortunately in the next section we’ll cover generating a PGP key, and signing our repository with it, which will allow users to verify the repository contents have not been tampered with.&lt;/p&gt;
&lt;h2 id=&quot;step-3-signing-your-apt-repository-with-gpg&quot;&gt;Step 3: Signing your apt repository with GPG&lt;/h2&gt;
&lt;p&gt;In the previous step, we generated a &lt;code&gt;Release&lt;/code&gt; file, which referenced one or more &lt;code&gt;Packages&lt;/code&gt; files along with it’s corresponding md5, sha1, and sha256 hashes. The &lt;code&gt;Packages&lt;/code&gt; file in turns references a deb package along with it’s md5, sha1, and sha256 hashes.&lt;/p&gt;
&lt;p&gt;As of 2021, md5 and sha1 hashes are no longer considered secure; however sha256 is still considered to be secure. Therefore if a user can verify that the initial Release file has not been tampered with, then they could make use of the sha256 to verify the Packages file, then use the sha256 contained in the Packages file to verify the deb file.&lt;/p&gt;
&lt;p&gt;In order to sign the apt repo, all we must do is sign the Release file.&lt;/p&gt;
&lt;h3 id=&quot;pgp-gpg-and-gnupgp&quot;&gt;PGP, GPG, and GnuPGP&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;PGP, OpenPGP, GnuPG, GPG, (and careful not to typo PHP).&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Software has a lot of accronyms, and this extends into digital signatures. “Pretty Good Privacy” (PGP), was created in 1991 by Phil Zimmermann and eventually became the main product of non other than PGP Inc. To encourage adoption of PGP, the company created an open standard unsurprisingly called OpenPGP.&lt;/p&gt;
&lt;p&gt;OpenPGP is only a specification, that’s where GNU Privacy Guard (GPG) fits in: GPG is an implementation of (Open)PGP. So is it a PGP key, or a GPG key? I don’t know, I’ve seen it called both, I’m going to call it a PGP because that’s what is contained in the first line of the armoured text: &lt;code&gt;-----BEGIN PGP PUBLIC KEY BLOCK-----&lt;/code&gt;.&lt;/p&gt;
&lt;h4 id=&quot;creating-a-new-publicprivate-pgp-keypair&quot;&gt;Creating a new public/private PGP keypair&lt;/h4&gt;
&lt;p&gt;Let’s start with generating a PGP keypair. We will use the &lt;code&gt;--batch&lt;/code&gt; feature of &lt;code&gt;gpg&lt;/code&gt; rather than using the interactive prompt. This has the benefit of generating keys in a repeatible way. First create a batch template by copying and pasting the following into your terminal:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb33&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb33-1&quot;&gt;&lt;a href=&quot;#cb33-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;%echo Generating an example PGP key&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-2&quot;&gt;&lt;a href=&quot;#cb33-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Key-Type: RSA&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-3&quot;&gt;&lt;a href=&quot;#cb33-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Key-Length: 4096&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-4&quot;&gt;&lt;a href=&quot;#cb33-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Name-Real: example&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-5&quot;&gt;&lt;a href=&quot;#cb33-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Name-Email: example@example.com&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-6&quot;&gt;&lt;a href=&quot;#cb33-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;Expire-Date: 0&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-7&quot;&gt;&lt;a href=&quot;#cb33-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;%no-ask-passphrase&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-8&quot;&gt;&lt;a href=&quot;#cb33-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;%no-protection&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb33-9&quot;&gt;&lt;a href=&quot;#cb33-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;st&quot;&gt;%commit&amp;quot;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; /tmp/example-pgp-key.batch&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then we will generate it under a new temporary gpg keyring:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb34&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb34-1&quot;&gt;&lt;a href=&quot;#cb34-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;GNUPGHOME&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;mktemp&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-d&lt;/span&gt; ~/example/pgpkeys-XXXXXX&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb34-2&quot;&gt;&lt;a href=&quot;#cb34-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--no-tty&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--batch&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--gen-key&lt;/span&gt; /tmp/example-pgp-key.batch&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Since we overrode the GNUPGHOME to a temporary directory, we can keep this key seperate from our other keys. Let’s take a quick look at the contents of the directory:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb35&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb35-1&quot;&gt;&lt;a href=&quot;#cb35-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$GNUPGHOME&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;/private-keys-v1.d&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;will show something along the lines of&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;A3FB218BA1929542FF110C7D1B077B6469F769C9.key&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;which contains binary data. We can also view all of our loaded keys with:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb37&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb37-1&quot;&gt;&lt;a href=&quot;#cb37-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--list-keys&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which will show something similar to&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/home/alex/example/pgpkeys-pyml86/pubring.kbx
-------------------------------
pub   rsa4096 2021-05-18 [SCEA]
      B4D5C8B003C50A38A7E85B5989376CAC59892E72
uid           [ultimate] example &amp;lt;example@example.com&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This PGP key is comprised of both a public key, and a private key. Let’s start with exporting the public key:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb39&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb39-1&quot;&gt;&lt;a href=&quot;#cb39-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--armor&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--export&lt;/span&gt; example &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/pgp-key.public&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Alternatively, you can reference the key by the email address or even the associated hex code. This should result in a public key that looks like:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBGCkNmcBEADjEcDdne3ti5derY+hSPnhrBWeBba/1gb3S7lKwsysFlxeAApU
mROTk7gijH84GofOkZzQw9PJEA4u4kkF6EFfOr+VS3JDt5kYjpGorXMD8iRtJAIq
Y6hX7vqNDHpXFHSEEBIFCUF9E3yf8p7Wrohe0/6HVz1m/XAcU34zWY3a4zfgntsd
r4hj1h3E/GkZEI8UpB+/LshzbIoZMEDy+EB3EX/oCstZc9aKTUZLP9q5r3CvbrJU
s3354N+XFxCocVv4c/UFtcUI14EfQv7LVB2JRWYrit65DAHx87V4xcajqbkswvYn
4ela0DCW/Bw2jz1DaEHLGzn9me6z+YYH8VWbYqUJ/hrHHHSqjjSZ3S5E8gLVzTuf
IpoWUCSNeZlltBqoWf4ei7Q4nhzFi7AkvLABSkmx7R1+7fOH0ZIN+M2G6lOgcHEU
IiS7v6ygyj1U2h+38xn66dDH/gUhjp0zJfivMnC1c7pz7R4zNhFxyv1cyekP1nJA
wmpW+Y5ja3qSJYCHGmrtNaQIVMo2Ho1aXZiMysaTXKp4CYluoUsh97GjLtksq834
y3+FHdGMt8dGFBCRlZ9BFr1B++FZvuovbLoS+ZREmXTQPXYhN0TinpmnSFJsY6DK
5zFOU9j3Mtmf77MxUA+xsKBQrDgGM76uN7ADTc0jrUo4hECxnXQkOGyYrQARAQAB
tB1leGFtcGxlIDxleGFtcGxlQGV4YW1wbGUuY29tPokCTgQTAQoAOBYhBLTVyLAD
xQo4p+hbWYk3bKxZiS5yBQJgpDZnAhsvBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheA
AAoJEIk3bKxZiS5yTUMP/1nlYpQTf8tQgSwSVUM8jhBhdOEEzmsXy/90KgpjX9WF
ABSC61SnGRonO60dn5CHT4oi0yJRKtsjJ3ZXLyxJY4Myop4ZCoJCcJw6sBOc3rvl
GN4J4O3+DZn7KRGUKFmLgeuxie2tSHdWYkonlpGPQ34xLgKT6Uf1NQOcCLZpMBim
2kxNXnnQXLEKXlbm9xmi/koub1qpko01T9DT9g9mlkv56660+sOw0XNwGmPy6HJ2
2IND53LYDNQv4qbt00ws29AUmZ6WmlUB9oP/nMx56Urgvmn6p/CLB9vbwIAb6egq
ZouUKsFAFyO5oVH3JoNBYbT84QewQv9BnJVQjuh0wK3OdCBjzT3YcBuRVwVJubKv
nSjvkJtq20tgxDSPc5ostzMpT5ZnBV+VQa6fwqBgb7VIGEPQklo6IZRwDH0rX1IA
Xpe2dZOvUICqvg17ol29uQ81BRpB7UynPDbgPDhBbELELPQN/GfaL+op8AB+cbga
JgC1JcX08nOqnT9TMpfig4TEpL/BKO+3cFy0Sttm44zMrR1f1SiyXdjZTS715LM/
nmAQWCZFMqN+5nHfT6lwJlqmtRCvjvHPdZla8Ah6B9oB+vJs1cClYJLSZuun89P/
bmQ5z+qJwCUOEVhVcVPTHAkqCTX2apQBeAszcmk54bGc/Q6UKncOgvOkELS7VuPt
=DYDE
-----END PGP PUBLIC KEY BLOCK-----&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;If the exported key is much larger than this, you may have exported multiple keys which can cause issues with some repositories.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;You can verify only a single key was exported by running:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb41&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb41-1&quot;&gt;&lt;a href=&quot;#cb41-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; ~/example/pgp-key.public &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--list-packets&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and checking that only a single &lt;code&gt;:public key packet:&lt;/code&gt; entry exists. It should look something like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# off=0 ctb=99 tag=6 hlen=3 plen=525
:public key packet:
    version 4, algo 1, created 1621374567, expires 0
    pkey[0]: [4096 bits]
    pkey[1]: [17 bits]
    keyid: 89376CAC59892E72
# off=528 ctb=b4 tag=13 hlen=2 plen=29
:user ID packet: &amp;quot;example &amp;lt;example@example.com&amp;gt;&amp;quot;
# off=559 ctb=89 tag=2 hlen=3 plen=590
:signature packet: algo 1, keyid 89376CAC59892E72
    version 4, created 1621374567, md5len 0, sigclass 0x13
    digest algo 10, begin of digest 4d 43
    hashed subpkt 33 len 21 (issuer fpr v4 B4D5C8B003C50A38A7E85B5989376CAC59892E72)
    hashed subpkt 2 len 4 (sig created 2021-05-18)
    hashed subpkt 27 len 1 (key flags: 2F)
    hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)
    hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)
    hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)
    hashed subpkt 30 len 1 (features: 01)
    hashed subpkt 23 len 1 (keyserver preferences: 80)
    subpkt 16 len 8 (issuer key ID 89376CAC59892E72)
    data: [4095 bits]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next let’s export the private key so we can back it up somewhere safe.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb43&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb43-1&quot;&gt;&lt;a href=&quot;#cb43-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--armor&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--export-secret-keys&lt;/span&gt; example &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/pgp-key.private&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should never share this key with anyone. If you look at the output file, it should look similar to this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-----BEGIN PGP PRIVATE KEY BLOCK-----

lQcYBGCkPGEBEAC7P59Xp933LVYAKsDzDgMp/kc9SyLd8VxsqX4FEJ31/hMkl8Bh
RPg1l40IuVP9nVf0W9LrLoHVI13uoUdMYJ7+ZoOihd7Qi6ePqgmWahx+U4hyUMeQ
2MtBV23A2HLfUxP/vOs3BgQxf6efDdZpf6Jyq7hLagXbBoGE0X02igj4ModMD7fy
8HpKbiXhIIqTFQM1V8EQVdERzY0aEzFD/hlKKj2+NdhhYB3UwnyKoIYXrsfEnGMy
8Yje2sr2HKXrqVBIOfqZls8MJrkMZHrMzWF9ZdBC+CJfN2/DG5bl/kBkZfpHq6Mn
C3WPdRWOunJaDSahc7baghM4aSj5oEtaJ4e3CGi3vBajGDRXAbrDpuBPfuzyp6dI
cqbNLTkriYq5idXx9XxD6EaGrkZ12U4JCvfhex4qsczQMl/AUNZDmW+9MB7J0ZdS
tAUJCSbsM5B5663l9uVwI6is4PH18GX0b76EBjrYe8OcSljKLGXobtfZSIKd4zBf
K6Fxs7gAST8VewApWjsLDGuBdLJcOcdftUxo/5Vg+c/ThtlxduOdsoB6+z/pVufj
YAGMl388jeV34d+2FzH+VxedzdIO6tPN8G0WINLP7YyKmE89BccYKpIVd9fqYg/Y
KIqF1zRbu7MtAMfpUsHt90Wctn6mLe7KR5BSoBzf3cu2RxbOlhWohOD7aQARAQAB
AA/6ArEBa1MgX6MpL0tuBpBW/02GXJ0t3R7RA0bUZuI8QwLp54a+3ycMokiRYGS5
jlWqo/qF55d9ikC94uYyjih9YI68qaNe9oRrXidFiAHycuZkebArjitvkHrfOvxh
elBJY02l296cRNHe6Oxb/pw1C4zoUz0s5F8NkYkpUZVeV6LySueW70kBmPxIUxoS
o9aTezrNrZxuKuFXe952wNFwL5630HoZqBynkR1SiPORudlrSaotytep7fobHLqA
sAh4/PDIZ1jBlR0hX8o58aOqGRFTkwLaC6BSXO2Sl6+14TuOA2W2LKN/hxZZvvlz
F1RFD+EH6dAg0pjAXAYvzxXuX27V0aeKzxssbK0Xl/c6n3IMNHTdbAw17W4lg0fJ
Omd9csGh0+wEGxsM30gqTT46Z5ixtZ6Q6zbpUBN3k4Lr5iW0BEBYIj4J0YVD2c0Q
3jKQ/xnrE1GjrBuVT4WIvKGaHlcrP/v+tg4AZjhZzwcRi84AlEOTTNjNkmQqDc02
1ogx5zZ8/RoNitswPd1v4Cj7zQzhozinEcv/8PJoCm1thbIUE84i7/vTEsmFm/gq
Xh93/v8k8comM2EUVSrmJOuUWtTx9fCKLE34ZhyETVgl68thDp2oX6HQXPPkPOF5
Q3k4ujWd3tn1dTR9brPHtf0/9f/LQCLp5L+lNxOQzeHABgEIANYIwHxbIXEyojjS
R6FG8FjPWVD7D2vo5V176V3N+ERjSBGwyDZ3sjqSuj+TnBNwiPL7XKKxNslXvww0
I8hLmhw3bEN9ZzmdZ5IIzUmEjDhUTDMmTF6C7HpnLpuuqpKRcwCRtnHJM/3umQpY
l51MQNNbkKDYrU+1UVO6aTV3h56btPZSdKvyQ26zOf2UfDe2KdEaVruoCbnFnmBD
oDerCeRf3MGc7nw21kMrJ9FPYZpMzKBqu5BI9OsB5Ju9LgAhsNW6Ux2+X0HvQQB3
GMLU3v1KsRiwwVLvsnGpA3j28XEsq5L17sqR6knSE/0e/X0SNyJXMX9NMNf0Whlw
TZ1nF6EIAN/2Y5V7vOa6AHdOYSpmGNoeAWeOFLXDcDdL0U7tntWFnrnI4wGyziiz
pH2T/wfuHp6b7PcL5YzCtYGaP7/omje7WjIkFl6rJcpynu/X80ogE88c1U7u7KDb
dqjkWyonGnSmpTvLG3fF/MA1tJawUWDwFV65ahX3N0ZS7siZbGzaBFFfuw2uzdvY
zP04bvFeQSuTeH/XxJ5n0Ea68JRkoHwITTRX9/Gi3mNwe4YkaXu4SebCqKl1pl0v
NwTQBAWwYSKo0xibZF5WLcax3qvhGdyyunN/WaMO7oDwxiGKg7fFym2z9Fm6/XHv
pOJukl9ujJxp2C0Gfn5c9aIueTDgrskH/3CfvxmOyLIeDN2OOvLV//5/srYTqDGz
b7FW20r6IxbY4Jt9kFDcOWlzErsD2L3l0D1Xyv2rE7CaWErEfGbQaYqSJ8EBB6EI
N24Q90pzkfaL84zNGrLRpxlSd5YknDh344wID0KFHLcYy1MHynLErQPexAQDsxCY
sv+9BxjwK9pSLEvu6+hfKAmeRPCU8LPxjgnxLXhm92CklUGmZYVIMiFtwWKqwB3c
vmFTW/4cgfuxVxYiriAE1DQ6VOPjweKpyPli1AcMkgPXG1dVD8DkQ5WR99jFoAs4
f2F+xbYp5cK/xoK8imCdI7TUEWd9jOpD5fgW3cI3jHf4UHZvJfVrTDCNAbQdZXhh
bXBsZSA8ZXhhbXBsZUBleGFtcGxlLmNvbT6JAk4EEwEKADgWIQQjmwbKSoK7sgII
vKnhkzUydQ6e7wUCYKQ8YQIbLwULCQgHAgYVCgkICwIEFgIDAQIeAQIXgAAKCRDh
kzUydQ6e7wepD/981U87Qr9IBh1nMFyNuLpGpRwzNMiBP/KlOQ/7HTAVvOKAYYZT
tTG5teVcwQX9PLStjsrqJ5owpjeHkX8qydioLbK8XFFlhxi/5X6YxYKUuBfky32w
DN+B9gqbWc9xFcEyoSgM1aZBrvVB4GKC/vqlgNnU5TDaszMIeD40tNlXZa8fv7Ie
Hz4Sgw3MrOzLdMjW3ZpoFiYsUX0fh4CB397pOXJlOam9doznhv5vYF6scVS9GU8D
sF8fsa0fX9kciAEw863q21R/gvJF6SnjCGsDtlVVDXJZwex30JzYyeVHg6NWXpyp
cs9vS9gfpETmgdG9/Sx8qcV4UCsoeSodaJ4slfFkTMMFbupb5YrXkf7B6pm5esTy
eTsP08GiDS8LDe+BsvqYyi9GuLMknAyBPD8mTTB0/lU9eEt/lFAAGVcYsGuYdc9d
dHFEvWWflPNNx7vXS1zwdCYd4RcnIYfpLurHbb79Yv2YVr9rOS1ivWZcfi5T8bdI
WGPxI2rJ2gZYUB7w0t9s23qADaaf/MpgbekAyPGIxKEGGQGyv9kqzYmVZdfdRss3
MsMwELFwsvuUi1duyuXkbY+jJ+6qCfoWJF6zriJKNjIvjPFois9YAH3CGQP/5nsl
rRYC0Psjil8wZAHa/sJePBtn+9Ol0atZ6QDvyr2r3fMHQiEe+mB0cpKnBw==
=+Tgf
-----END PGP PRIVATE KEY BLOCK-----&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;The above is a burner-key I created for this article. It’s never been used for anything aside from this article. You should be generating your own key, don’t use this one.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Now that we’ve generated a PGP keypair, let’s move on to signing files with them.&lt;/p&gt;
&lt;h4 id=&quot;signing-the-release-file&quot;&gt;Signing the Release file&lt;/h4&gt;
&lt;p&gt;Before we start signing with out keys, let’s make sure that we can import the backup we made. To do that, we will create a new GPG keyring location:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb45&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb45-1&quot;&gt;&lt;a href=&quot;#cb45-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;GNUPGHOME&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;mktemp&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-d&lt;/span&gt; ~/example/pgpkeys-XXXXXX&lt;span class=&quot;va&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and then verify that it is empty:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb46&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb46-1&quot;&gt;&lt;a href=&quot;#cb46-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--list-keys&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which should show something similar to:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;gpg: keybox &amp;#39;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx&amp;#39; created
gpg: /home/alex/example/pgpkeys-e7u1Ad/trustdb.gpg: trustdb created&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next we will import our backed up private key:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb48&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb48-1&quot;&gt;&lt;a href=&quot;#cb48-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; ~/example/pgp-key.private &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--import&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;which should show a similar imported message:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;gpg: key 4E793BC948F34C6F: public key &amp;quot;example &amp;lt;example@example.com&amp;gt;&amp;quot; imported
gpg: key 4E793BC948F34C6F: secret key imported
gpg: Total number processed: 1
gpg:               imported: 1
gpg:       secret keys read: 1
gpg:   secret keys imported: 1&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and now if we run &lt;code&gt;gpg --list-keys&lt;/code&gt;, we should see it is now available:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx
---------------------------------------------
pub   rsa4096 2021-05-18 [SCEA]
      CFBFFC9CCD163CC7E1768BFF4E793BC948F34C6F
uid           [ unknown] example &amp;lt;example@example.com&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Ok, let’s get around to signing the &lt;code&gt;Release&lt;/code&gt; file now.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb51&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb51-1&quot;&gt;&lt;a href=&quot;#cb51-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; ~/example/apt-repo/dists/stable/Release &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--default-key&lt;/span&gt; example &lt;span class=&quot;at&quot;&gt;-abs&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/apt-repo/dists/stable/Release.gpg&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The contents of &lt;code&gt;Release.gpg&lt;/code&gt; should be similar to this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-----BEGIN PGP SIGNATURE-----

iQJIBAABCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkTYYUHGV4YW1wbGVA
ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG+f2g//QpVA4RP5qp2mAlolhqKCqLr6r7DX
mUC5ueSISXlRwVK7l0xFADqw4uHsl+T0DIeX7K/efHyyqIYq+t8fCA8HbB5CmWFk
2rOa9jFR4G+afJ1mdfQYUHshwEzY+NIScg3suO0ZeILFXcTW6a6AzlwqI3pVy/b8
o/FCjj4hBnaPysDS1BmPqxjWvt5ilQR3RTodsFahr2FncmgZI8zvrbCey630O/Cs
ELLp9fqBQj//FEje/JgHtG6E85qjsod0Nstu5h2yEs9iwMP1+peMB80NLpyeacpS
CWbZmFgxqKL7JNSx04T8epL23Zg6trrzhvOzOiVp2+Ilg438LBrErSVO+3puWT2e
bR3jpFSg9ej0+90QnG3IIkZW1RSkitlpNiFGFrUvlBRE9tSjZMK10EofPtzENEWN
uXYqjcWTJxp6R7d1IW/lTFzwdCPorgBPBbjmJ7Ux5YWZP7jjJmFpF9jSHVz6xDcp
oUBQcF4jHn5ewh0yKZQbqA3ZRXpPBDSNSraIDFToeFzhV94FQR2f5A5FgBR8n/Kr
Gfb76dsKabwVJlr7z8+W2C8gHmOe4dlVVUje3bxo05VNwZEBPbRldFox4GKIWT46
FbXyzB/EfRR7rzmaRfIpDfQa6hLOoivlat1no6akT7bK2mE7Y0L+Kae1dP+BpBUe
BqY84ZTkmQiOL0c=
=Dqab
-----END PGP SIGNATURE-----&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now when an apt client performs an update, it will fetch both &lt;code&gt;Release&lt;/code&gt; and &lt;code&gt;Release.gpg&lt;/code&gt; and will verify the signature is valid; However to increase the speed, we will create a third file &lt;code&gt;InRelease&lt;/code&gt; which will combine both the contents of &lt;code&gt;Release&lt;/code&gt; and the PGP signature:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb53&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb53-1&quot;&gt;&lt;a href=&quot;#cb53-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; ~/example/apt-repo/dists/stable/Release &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;ex&quot;&gt;gpg&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--default-key&lt;/span&gt; example &lt;span class=&quot;at&quot;&gt;-abs&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;--clearsign&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; ~/example/apt-repo/dists/stable/InRelease&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The contents of &lt;code&gt;InRelease&lt;/code&gt; should be similar to this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Origin: Example Repository
Label: Example
Suite: stable
Codename: stable
Version: 1.0
Architectures: amd64 arm64 arm7
Components: main
Description: An example software repository
Date: Tue, 18 May 2021 01:17:46 +0000
MD5Sum:
 d47739655e6312da85a96711f78c78db 405 main/binary-amd64/Packages
SHA1:
 d6aa46cf29cca1b01af6e9e256bf963ff5dfdaeb 405 main/binary-amd64/Packages
SHA256:
 3b888d4257fcf475fc06f74bd46045c3f1d667562fdb37e86f5bea642efa49f8 405 main/binary-amd64/Packages
-----BEGIN PGP SIGNATURE-----

iQJIBAEBCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkT1wUHGV4YW1wbGVA
ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG8w/RAAwB6HRyZWVOWT1A0OJAt+RlLREjev
gfRZVLZRDv18QRZKCcj71v0Ki1hX3xWE8WVjIR9eSXNf1wJvqza+/FBGN00NY1Bk
AFmypZP/04kjwGeUtULopLB1KrCaFdWuC9W49zUyeElIz1owX9tk+SsoLB7hGLQE
jtweFjxhaMeCHgSJIXDoR0RpmKBuydtB3UTHjCQJBvErkYfKrAJQCDYDz+XVPLh6
XPAohVb6SO4qBCxX30QcQpUVDRtMMRKbIOD5B+hjCP5cupvej1fBlzlFh4lBIywj
eUXrwBxmOiO/yrsYNoJJB+mV9u1mEpQDo7yRDCICsY2c/Io/Q0CxiEIIwoEfHCb/
WOFYYmUj1Sh9YARi74eTblMyr/Ay/9+opEr54uAixecJyC/kqsC3uptH4ZpOSwTw
hdj24Cl2veYmiCimPB4QCLOsCU5A1phwEkgADUOh4iRaszuzGkh/NZ0al0dCF0HY
/UsDuiMzEQGOP6ByILt1zoPrnwZKFDEbYjzSbjSXfkU9LKfrp5PWgeeq5iD58sQW
ZCE34ksK8W67GOtQuzy0Z8NlTJY1Mkzp7IsUt60owyv6dQVZFIPYwGEisGFSOCNk
3VZ66m1D6HtDZ60CZEJUhfu+WTC1K95cKYkhYArBR9pDecygYomLQVFO2T1ENxCA
BKaAtOSl2Jcb4eA=
=3Hft
-----END PGP SIGNATURE-----&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&quot;testing-it-out&quot;&gt;Testing it out&lt;/h4&gt;
&lt;p&gt;We need to tell apt which public pgp key to use when verifying the apt repository. We will add a new &lt;code&gt;signed-by&lt;/code&gt; attribute to our apt config:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb55&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb55-1&quot;&gt;&lt;a href=&quot;#cb55-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;deb [arch=amd64 signed-by=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$HOME&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;/example/pgp-key.public] http://127.0.0.1:8000/apt-repo stable main&amp;quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; tee /etc/apt/sources.list.d/example.list&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;note that &lt;code&gt;$HOME&lt;/code&gt; should be expanded to the absolute path of the pgp key.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Next start back up your webserver:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb56&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb56-1&quot;&gt;&lt;a href=&quot;#cb56-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;cd&lt;/span&gt; ~/example&lt;/span&gt;
&lt;span id=&quot;cb56-2&quot;&gt;&lt;a href=&quot;#cb56-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;python3&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-m&lt;/span&gt; http.server&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then finally try updating and re-installing our hello-world package:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb57&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb57-1&quot;&gt;&lt;a href=&quot;#cb57-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get clean&lt;/span&gt;
&lt;span id=&quot;cb57-2&quot;&gt;&lt;a href=&quot;#cb57-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get update&lt;/span&gt;
&lt;span id=&quot;cb57-3&quot;&gt;&lt;a href=&quot;#cb57-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;sudo&lt;/span&gt; apt-get install hello-world&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This time you shouldn’t see any security warnings.&lt;/p&gt;
&lt;h4 id=&quot;keeping-your-private-key-secure&quot;&gt;Keeping your private key secure&lt;/h4&gt;
&lt;p&gt;If you followed this tutorial to the tee, and your webserver is still running, what happens if we try running:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb58&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb58-1&quot;&gt;&lt;a href=&quot;#cb58-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;curl&lt;/span&gt; http://127.0.0.1:8000/pgp-key.private&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Oh no! we just leaked our private key. Now’s the time to regenerate it but using a real name and email address other than &lt;code&gt;example@example.com&lt;/code&gt;. Maybe you can store it in earthly’s &lt;a href=&quot;https://docs.earthly.dev/docs/guides/cloud-secrets&quot;&gt;secret store&lt;/a&gt; instead?&lt;/p&gt;
&lt;h2 id=&quot;appendix-a-a-complete-example-using-earthly&quot;&gt;Appendix A: A complete example using Earthly&lt;/h2&gt;
&lt;p&gt;A complete example has been created under &lt;a href=&quot;https://github.com/earthly/example-apt-repo/blob/main/Earthfile&quot;&gt;github.com/earthly/example-apt-repo/Earthfile&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This Earthfile contains all the above steps from this tutorial in a single location, which can be run directly in a single shot with:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb59&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb59-1&quot;&gt;&lt;a href=&quot;#cb59-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;earthly&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-P&lt;/span&gt; github.com/earthly/example-apt-repo+test&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Alternatively, you can clone the repo and run &lt;code&gt;+test&lt;/code&gt; directly.&lt;/p&gt;</content><author><name>Alex Couture-Beil</name></author><category term="Tutorials" /><summary type="html">As an Ubuntu user, I find myself typing apt install ... frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests.</summary></entry><entry><title type="html">Deployment Strategies</title><link href="https://earthly.dev/blog/deployment-strategies/" rel="alternate" type="text/html" title="Deployment Strategies" /><published>2021-05-31T00:00:00-04:00</published><updated>2021-05-31T00:00:00-04:00</updated><id>https://earthly.dev/blog/deployment-strategies</id><content type="html" xml:base="https://earthly.dev/blog/deployment-strategies/">&lt;p&gt;There are many ways to deploy applications to a production server environment, and the terminology around deploy strategies is often confusing. In this short guide, I’ll review software deployment options starting from the most basic and straightforward and moving towards the more complex.&lt;/p&gt;
&lt;h2 id=&quot;recreate-deployment-strategy&quot;&gt;Recreate Deployment Strategy&lt;/h2&gt;
&lt;p&gt;This is the most straightforward deployment strategy. It’s been the default strategy in enterprise IT for a long time and works well when updates are very infrequent and maintenance windows plentiful. You stop the old service and then start up the new service. During the teardown and spin-up process, the service is down.&lt;/p&gt;
&lt;p&gt;In a software-as-a-service world, with frequent updates, this strategy can really only work with the use of queues and async messaging architectures. For example, when upgrading a service that sends email, the mail will queue in an outbox waiting for the upgraded version to start up.&lt;/p&gt;
&lt;section id=&quot;pros&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Pros&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Easy&lt;/li&gt;
&lt;li&gt;Works excellent with queues and async message buffers&lt;/li&gt;
&lt;li&gt;Never need to run more than one version of the service in parallel&lt;/li&gt;
&lt;/ul&gt;
&lt;section id=&quot;cons&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Cons&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Downtime to upgrade&lt;/li&gt;
&lt;li&gt;Downtime to rollback&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;rolling-update-deployment-strategy&quot;&gt;Rolling Update Deployment Strategy&lt;/h2&gt;
&lt;p&gt;The recreate strategy above assumes you only have one instance of your service running at a time. But if you have several with a load balancer in front, you can improve the downtime story with a rolling update strategy. You start an instance of the new version, and once it’s up, gracefully terminate one instance of the old version. Then continue this pattern until only new versions of the service are running. This strategy is ubiquitous in Kubernetes and other containerized production environments.&lt;/p&gt;
&lt;section id=&quot;pros-1&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Pros&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Easy on Kubernetes&lt;/li&gt;
&lt;li&gt;No Downtime on upgrade&lt;/li&gt;
&lt;/ul&gt;
&lt;section id=&quot;cons-1&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Cons&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Multiple versions of same service active during the overlap&lt;/li&gt;
&lt;li&gt;No warm rollback services&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;blue-green-deployment&quot;&gt;Blue-Green Deployment&lt;/h2&gt;
&lt;p&gt;A blue-green deployment requires a bit more resources: you need two identical production environments and a load balancer. One of these environments always receives 100% of the traffic while the other version sits idle. Updates are deployed to inactive version, and once it is successfully upgraded, traffic is switched over to it. These two environments are named blue and green, respectively, and traffic alternates back and forth from green to blue and then blue to green and so on. This means that the previously deployed version is always running on the idle environment, which simplifies rollbacks.&lt;/p&gt;
&lt;section id=&quot;pros-2&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Pros&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Eliminates upgrade downtime&lt;/li&gt;
&lt;li&gt;Very quick rollbacks&lt;/li&gt;
&lt;/ul&gt;
&lt;section id=&quot;cons-2&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Cons:&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;More Resources&lt;/li&gt;
&lt;li&gt;More Deployment complexity&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;canary-deployment&quot;&gt;Canary Deployment&lt;/h2&gt;
&lt;p&gt;A canary deployment strategy looks a lot like a blue-green deployment – a new version of the service starts up parallel to the existing version – with a slight improvement made: instead of switching all traffic over to the new version, only a percentage of traffic is initially sent. This traffic is the canary in the coal mine. Canaries were used in mining to measure air quality. The miners would bring a canary with them as they traveled down into the mine. If there was an air quality problem, the canary would die before the miners and act as an early warning signal.&lt;/p&gt;
&lt;p&gt;In the same way, a canary deployment does not prevent downtime, but limits its impact by giving an early warning. It limits access to the new version to a subset of users. If metrics indicate that the new service is not responding well to this fraction of requests, then the roll-out can be aborted, lessening its impact. If everything looks OK, request volume is slowly ramped up until its being entirely served by the new version.&lt;/p&gt;
&lt;p&gt;Depending on how the canary traffic is chosen, a downside to this approach is that a specific subset of users may experience most of the production issues.&lt;/p&gt;
&lt;section id=&quot;pros-3&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Pros&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Catch Problems Early&lt;/li&gt;
&lt;/ul&gt;
&lt;section id=&quot;cons-3&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Cons&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Deployment complexity&lt;/li&gt;
&lt;li&gt;Canary users bear the brunt of production issues&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;shadow-deployment&quot;&gt;Shadow Deployment&lt;/h2&gt;
&lt;p&gt;If the problems a canary deployment finds can genuinely be found with metrics alone, and if the cost of incidents is very high, then a shadow or mirrored deployment is worth considering.&lt;/p&gt;
&lt;p&gt;In a shadow deployment, the new version of the service is started, and all traffic is mirrored by the load balancer. That is, requests are sent to the current version and the new version, but all responses come only from the existing stable version. In this way, you can monitor the latest version under load without any possibility of customer impact. This strategy is sometimes called a mirrored canary deployment.&lt;/p&gt;
&lt;p&gt;The cost of this approach is in the implementation. A service mesh like Istio is probably needed to perform the actual request mirroring, and it gets more complex from there. If a new version of a user service backed by a relational database was shadow deployed, all users might be created twice, leading to untold ramifications. To embrace a shadow or mirrored deployment strategy, you have to think about the implications of duplicated requests, and any non-idempotent actions on downstream services may need to be mocked.&lt;/p&gt;
&lt;section id=&quot;pros-4&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Pros&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Catch production problems without custom impact&lt;/li&gt;
&lt;/ul&gt;
&lt;section id=&quot;cons-4&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Cons&lt;/h3&gt;
&lt;/section&gt;
&lt;ul&gt;
&lt;li&gt;Deployment complexity&lt;/li&gt;
&lt;li&gt;Architectural complexity&lt;/li&gt;
&lt;/ul&gt;
&lt;section id=&quot;summary&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;/section&gt;
&lt;p&gt;There are many deployment methods, from the very simple to the very complex. The deployment strategy the works best for any given situation depends on many factors. When choosing a deployment strategy balancing the cost of downtime versus the cost of deployment complexity is essential.&lt;/p&gt;
&lt;p&gt;If there are other deployment strategies or other continuous deployment terms you would like to see covered, please reach out to us on &lt;a href=&quot;https://twitter.com/earthlytech&quot;&gt;Twitter&lt;/a&gt; or via &lt;a href=&quot;adam@earthly.dev&quot;&gt;email&lt;/a&gt;.&lt;/p&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Tutorial" /><summary type="html">There are many ways to deploy applications to a production server environment, and the terminology around deploy strategies is often confusing. In this short guide, I’ll review software deployment options starting from the most basic and straightforward and moving towards the more complex.</summary></entry><entry><title type="html">Why is JRuby Slow?</title><link href="https://earthly.dev/blog/jruby/" rel="alternate" type="text/html" title="Why is JRuby Slow?" /><published>2021-05-26T00:00:00-04:00</published><updated>2021-05-26T00:00:00-04:00</updated><id>https://earthly.dev/blog/jruby</id><content type="html" xml:base="https://earthly.dev/blog/jruby/">&lt;p&gt;Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses &lt;a href=&quot;http://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.&lt;/p&gt;
&lt;p&gt;The build times looked like this:&lt;/p&gt;
&lt;div class=&quot;center&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Ruby Version&lt;/th&gt;
&lt;th style=&quot;text-align: center;&quot;&gt;Jekyll CI Time&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;2.5&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;8m 31s&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;2.7&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;8m 33s&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;3.0&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;7m 47s&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;JRuby&lt;/td&gt;
&lt;td style=&quot;text-align: center;&quot;&gt;45m 16s&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figcaption&gt;
A Representative Jekyll CI &lt;a href=&quot;https://github.com/jekyll/jekyll/runs/2048545456?check_suite_focus=true&quot;&gt;Build&lt;/a&gt;
&lt;/figcaption&gt;
&lt;/div&gt;
&lt;p&gt;The Jekyll CI does lots of things in it that a simple Jekyll site build might not but clearly JRuby was slowing the whole process down by a significant amount, and this surprised me: Wasn’t the entire point of using JRuby, and its new brother TruffleRuby, speed? &lt;strong&gt;Why was JRuby so slow?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Even building this blog and using all the tricks I’ve found, the performance of Ruby on the JVM still looks like this:&lt;/p&gt;
&lt;div class=&quot;center&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Runtime&lt;/th&gt;
&lt;th&gt;Jekyll Build Time&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;MRI Ruby 2.7.0&lt;/td&gt;
&lt;td&gt;2.64 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;Fastest Ruby on JVM Build&lt;/td&gt;
&lt;td&gt;25.7 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figcaption&gt;
Building This blog is 10x slower
&lt;/figcaption&gt;
&lt;/div&gt;
&lt;p&gt;So why is Jruby slow in these examples? It turns out that the answer is complicated.&lt;/p&gt;
&lt;h2 id=&quot;what-is-jruby&quot;&gt;What is JRuby?&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;I was very happy to discover the JRuby project, my favorite programming language running on what’s probably the best virtual machine in the world. - Peter Lind&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;JRuby is an alternative Ruby interpreter that runs on the Java Virtual Machine (JVM). MRI Ruby, also known as CRuby, is written in C and is the standard interpreter and runtime for Ruby.&lt;/p&gt;
&lt;h3 id=&quot;install-jruby&quot;&gt;Install JRuby&lt;/h3&gt;
&lt;p&gt;On my mac book, I can switch from the MRI Ruby to JRuby like this.&lt;/p&gt;
&lt;p&gt;Install rbenv:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;brew install rbenv&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;List possible install options:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rbenv install -l     &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Install:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rbenv install jruby-9.2.16.0&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Set a specific project to use JRuby:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rbenv local jruby-9.2.16.0&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;why-do-people-use-jruby&quot;&gt;Why do people use JRuby?&lt;/h2&gt;
&lt;blockquote class=&quot;twitter-tweet&quot;&gt;
&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;
OMG &lt;a href=&quot;https://twitter.com/hashtag/JRuby?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#JRuby&lt;/a&gt; +Java.util.concurrent FTW! Doing a recursive backtrace through billion+, I've made it 30,000x faster than 1.9.3. 30 THOUSAND.
&lt;/p&gt;
— /dave/null (&lt;span class=&quot;citation&quot; data-cites=&quot;bokmann&quot;&gt;@bokmann&lt;/span&gt;) &lt;a href=&quot;https://twitter.com/bokmann/status/381422498170273792?ref_src=twsrc%5Etfw&quot;&gt;September 21, 2013&lt;/a&gt;
&lt;/blockquote&gt;
&lt;script async src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
&lt;p&gt;There are several reasons people might choose JRuby, several of which have to do with performance.&lt;/p&gt;
&lt;h3 id=&quot;getting-past-the-gil&quot;&gt;Getting past the GIL&lt;/h3&gt;
&lt;p&gt;MRI Ruby, much like Python, has a global interpreter lock. This means that although you can have many threads in a single Ruby process, only one will ever be running at a time. If you look at &lt;a href=&quot;https://benchmarksgame-team.pages.debian.net/benchmarksgame/performance/fannkuchredux.html&quot;&gt;many&lt;/a&gt; of the benchmark shoutout results, parallel multi-core solutions dominate. JRuby lets you sidestep the GIL as a bottleneck, at the cost of having to worry about writing thread-safe code.&lt;/p&gt;
&lt;h3 id=&quot;library-access-and-environment-access&quot;&gt;Library Access and Environment Access&lt;/h3&gt;
&lt;p&gt;A common driver for JRuby usage is the need for a Java-based library or the need to target the JVM. You could be trying to write an Android app or a Swing app using JRuby, or maybe you already have an existing Ruby codebase but need it to run on the JVM. My 2 cents is that if you start from scratch and need to target the JVM, JRuby should not be the first option you consider. If you do choose JRuby, be warned that you will need a good grasp of Java, the JVM, and Ruby: if you’re coming to the JVM for java libraries and functionality, then JRuby won’t save you from having to read Java.&lt;/p&gt;
&lt;h3 id=&quot;long-running-process-performance&quot;&gt;Long-Running Process Performance&lt;/h3&gt;
&lt;p&gt;MRI Ruby is known to be slow, as compared to the JVM or even Node.js. According to &lt;a href=&quot;https://benchmarksgame-team.pages.debian.net/benchmarksgame/performance/pidigits.html&quot;&gt;The Computer Language Benchmarks Game&lt;/a&gt;, it’s often 5-10x slower than a similar Java solution. Small performance benchmarks are often not the best way to assess practical performance, but one place the JVM is known to perform very well compared to interpreted languages is in long-running server applications, where &lt;a href=&quot;https://jakubstransky.com/2018/08/28/hotspot-jvm-jit-optimisation-techniques/&quot;&gt;adaptive optimzations&lt;/a&gt; can make a big difference.&lt;/p&gt;
&lt;h2 id=&quot;why-is-my-jruby-program-slow&quot;&gt;Why is my JRuby Program Slow?&lt;/h2&gt;
&lt;p&gt;The JVM might be fast at running Java in benchmark games, but that doesn’t necessarily carry over to JRuby. The JVM makes different performance trade-offs than MRI Ruby. Notably, an untuned JVM process has a slow start-up time, and with JRuby, this can get even worse as lots of standard library code is loaded on start-up. The JVM starts by working as a byte code interpreter and compiles “hot” code as it goes but in a large Ruby project, with lots of gems, the overhead of JITing all the Ruby code to bytecode can lead to a significantly slower start-up time.&lt;/p&gt;
&lt;p&gt;If you are using JRuby at the command line or starting lots of short-lived JRuby processes, then it is likely that JRuby will be slower than MRI Ruby. However, the JVM is extensively tunable, and it’s possible to tune things to behave more like standard Ruby. If you want your JRuby to behave more like MRI Ruby, you probably want to set the &lt;code&gt;--dev&lt;/code&gt; flag. Either like this:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt; ENV JRUBY_OPTS=&amp;quot;--dev&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;OR&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;jruby --dev file.rb&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In my Jekyll use case, this change and some other small JVM parameter tweaking made a big difference. I was able to get the build time down from 45m 16s to 24m 1s.&lt;/p&gt;
&lt;div class=&quot;center&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;JRuby Flags&lt;/th&gt;
&lt;th&gt;Jekyll CI Run Time&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;JRuby&lt;/td&gt;
&lt;td&gt;45m 16s&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;JRuby –dev&lt;/td&gt;
&lt;td&gt;24m 1s&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figcaption&gt;
&lt;code&gt;--dev&lt;/code&gt; gets us closer to MRI Ruby
&lt;/figcaption&gt;
&lt;/div&gt;
&lt;h3 id=&quot;inside---dev&quot;&gt;Inside &lt;code&gt;--dev&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;The &lt;code&gt;--dev&lt;/code&gt; flag indicates to JRuby that you are running it in as a developer and would prefer quick startup time over absolute performance. JRuby, in turn, tells the JVM only do a single level jit (&lt;code&gt;-J-XX:TieredStopAtLevel=1&lt;/code&gt;) and to not worry about verifying the bytecode (&lt;code&gt;-J-Xverify:none&lt;/code&gt;). More details on the flag can found &lt;a href=&quot;http://blog.headius.com/2019/09/jruby-startup-time-exploration.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;why-is-my-jruby-program-wrong&quot;&gt;Why is my JRuby Program Wrong?&lt;/h2&gt;
&lt;p&gt;Ruby’s built-in types were built with the GIL in mind and are not thread-safe on the JVM. If you move the JRuby to sidestep the GIL, keep in mind that you may be introducing threading bugs. If you get unexpected or non-deterministic results in your concurrent array usage, you should look at concurrent data structures for the JVM like ConcurrentHashMap or ConcurrentSkipListMap. You may find that they not only fix the threading issues but could be &lt;a href=&quot;https://gist.github.com/bokmann/6652776&quot;&gt;orders of magnitude faster&lt;/a&gt; than the idiomatic Ruby way. Jekyll is not multi-threaded, however, so this is not an issue I needed to worry about.&lt;/p&gt;
&lt;h2 id=&quot;what-is-truffleruby&quot;&gt;What is TruffleRuby?&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://www.graalvm.org/&quot;&gt;GraalVM&lt;/a&gt; is a JVM with different goals than the standard Java virtual machine.&lt;br /&gt;
According to Wikipedia, these goals are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;To improve the performance of Java virtual machine-based languages to match the performance of native languages.&lt;/li&gt;
&lt;li&gt;To reduce the start-up time of JVM-based applications by compiling them ahead-of-time with GraalVM Native Image technology.&lt;/li&gt;
&lt;li&gt;To allow freeform mixing of code from any programming language in a single program.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Increased performance and better start-up time sound precisely like what we need to improve on JRuby, and this fact did not go unnoticed: &lt;a href=&quot;https://github.com/oracle/truffleruby&quot;&gt;TruffleRuby&lt;/a&gt; is a fork of JRuby that runs on GraalVM. Because GraalVM supports both ahead of time compilation and JIT, it’s possible to optimize either for peak performance of a long-running service or for start-up time, which is helpful for shorter running command-line apps like Jekyll.&lt;/p&gt;
&lt;p&gt;TruffleRuby explains the trade-offs of AOT vs. JIT like this:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Configuration:&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;Native (&lt;code&gt;--native&lt;/code&gt;, default)&lt;/th&gt;
&lt;th style=&quot;text-align: right;&quot;&gt;JVM (&lt;code&gt;--jvm&lt;/code&gt;)&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;Time to start TruffleRuby&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;about as fast as MRI start-up&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;slower&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;Time to reach peak performance&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;faster&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;slower&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;Peak performance (also considering GC)&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;good&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;best&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;Java host interoperability&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;needs reflection configuration&lt;/td&gt;
&lt;td style=&quot;text-align: right;&quot;&gt;just works&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&quot;install-truffleruby&quot;&gt;Install TruffleRuby&lt;/h3&gt;
&lt;p&gt;Install rbenv:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;brew install rbenv&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;List possible install options:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rbenv install -l     &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Install:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rbenv install truffleruby+graalvm-21.0.0  
rbenv local truffleruby+graalvm-21.0.0  &lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;ruby --version
truffleruby 21.0.0, like ruby 2.7.2, GraalVM CE Native [x86_64-darwin]&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Set mode to &lt;code&gt;--native&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ENV TRUFFLERUBYOPT=&amp;#39;--native&amp;#39;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;performance-shoot-out&quot;&gt;Performance Shoot-out&lt;/h2&gt;
TruffleRuby is significantly better in CPU heavy performance tests than JRuby, whose performance is significantly better than MRI Ruby. &lt;a href=&quot;https://pragtob.wordpress.com/2020/08/24/the-great-rubykon-benchmark-2020-cruby-vs-jruby-vs-truffleruby/&quot;&gt;PragToby&lt;/a&gt; has a great breakdown:
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/jruby/2020_relative_speedup.png&quot; alt=&quot;Performance of JVM Ruby runtimes in small tests looks good but is it too good to be true?&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Performance of JVM Ruby runtimes in small tests looks good but is it too good to be true?&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;However, in my testing with Jekyll and the Jekyll CI pipeline, JRuby and TruffleRuby are significantly slower than using MRI Ruby. How can this be?&lt;/p&gt;
&lt;p&gt;I think there are two reasons for this:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Real-World projects like Jekyll involve a lot more code, and JITing that code has a high start-up cost.&lt;/li&gt;
&lt;li&gt;Real-world code like Jekyll or Rails is optimized for MRI Ruby, and many of those optimizations don’t help or actively hinder the JVM.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;failure-of-fork&quot;&gt;Failure Of Fork&lt;/h3&gt;
&lt;p&gt;The most obvious place where you see this difference is multi-process Ruby programs. The GIL is not an issue across processes and the comparatively fast start time of MRI Ruby is an advantage when forking a new process. On the other hand, JVM Programs are often written in a multi-threading style where code only has to be JIT’d once, and the start-up cost is shared across threads. And in fact, if you ignore language shoot-out games, where everything is a single process and instead compare an MRI multi-process approach to a TruffleRuby multi-threading approach, many advantages of the JVM seem to disappear.&lt;/p&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/jruby/mri_truffle.png&quot; alt=&quot;Multi-process MRI Ruby is close in performance to multi-threaded TruffleRuby&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Multi-process MRI Ruby is close in performance to multi-threaded TruffleRuby&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;This chart comes from &lt;a href=&quot;https://github.com/eregon&quot;&gt;Benoit Daloze&lt;/a&gt;&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;, the TruffleRuby lead. The benchmark in question is a long-running server-side application using a minimal web framework. It is in the sweet spot of the Graal and TruffleRuby, with little code to JIT and much time to make up for a slow start. But even so, MRIRuby does well.&lt;/p&gt;
&lt;p&gt;Which brings me back to my original question: Why is JRuby slow for Jekyll? I do not see similar times but significantly slower times. Jekyll is not forking processes, so that is not the issue. Hugo, the static site builder for Go, is &lt;a href=&quot;https://forestry.io/blog/hugo-and-jekyll-compared/#performance-1&quot;&gt;signifcantly&lt;/a&gt; faster than Jekyll. So we know that Jekyll is not at the limits of hardware where there is simply no more performance to squeeze out.&lt;/p&gt;
&lt;h3 id=&quot;test-with-rubyspy&quot;&gt;Test with RubySpy&lt;/h3&gt;
&lt;p&gt;To dig into this, let’s take a look at a flame-graph of the Jekyll build for this blog using RubySpy:&lt;/p&gt;
&lt;div class=&quot;center&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Runtime&lt;/th&gt;
&lt;th&gt;Jekyll Build Time for this site&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;MRI Ruby 2.7.0&lt;/td&gt;
&lt;td&gt;2.64 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;TruffleRuby-dev&lt;/td&gt;
&lt;td&gt;25.7 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figcaption&gt;
This blog is 10x slower to build on TruffleRuby
&lt;/figcaption&gt;
&lt;/div&gt;
&lt;h4 id=&quot;jekyll-test-1&quot;&gt;Jekyll Test 1&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;sudo RUBYOPT=&amp;#39;-W0&amp;#39; rbspy record -- bundle exec jekyll build --profile&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/jruby/flame-graph.png&quot; alt=&quot;A Flame Graph shows most time is File Access&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;A Flame Graph shows most time is File Access&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;What we see is that 50% of the wall time was spent in writing files:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode ruby&quot;&gt;&lt;code class=&quot;sourceCode ruby&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Write static files, pages, and posts.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Returns nothing.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-4&quot;&gt;&lt;a href=&quot;#cb13-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;def&lt;/span&gt; write&lt;/span&gt;
&lt;span id=&quot;cb13-5&quot;&gt;&lt;a href=&quot;#cb13-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      each_site_file &lt;span class=&quot;cf&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt;item&lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-6&quot;&gt;&lt;a href=&quot;#cb13-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        item&lt;span class=&quot;at&quot;&gt;.write&lt;/span&gt;(dest) &lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; regenerator&lt;span class=&quot;at&quot;&gt;.regenerate?&lt;/span&gt;(item)&lt;/span&gt;
&lt;span id=&quot;cb13-7&quot;&gt;&lt;a href=&quot;#cb13-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;cf&quot;&gt;end&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-8&quot;&gt;&lt;a href=&quot;#cb13-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      regenerator&lt;span class=&quot;at&quot;&gt;.write_metadata&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-9&quot;&gt;&lt;a href=&quot;#cb13-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;dt&quot;&gt;Jekyll&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Hooks&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;.trigger&lt;/span&gt; &lt;span class=&quot;wa&quot;&gt;:site&lt;/span&gt;, &lt;span class=&quot;wa&quot;&gt;:post_write&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;self&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-10&quot;&gt;&lt;a href=&quot;#cb13-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And 16% of time was spent reading files.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode ruby&quot;&gt;&lt;code class=&quot;sourceCode ruby&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Read Site data from disk and load it into internal data structures.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Returns nothing.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;def&lt;/span&gt; read&lt;/span&gt;
&lt;span id=&quot;cb14-5&quot;&gt;&lt;a href=&quot;#cb14-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      reader&lt;span class=&quot;at&quot;&gt;.read&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-6&quot;&gt;&lt;a href=&quot;#cb14-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      limit_posts!&lt;/span&gt;
&lt;span id=&quot;cb14-7&quot;&gt;&lt;a href=&quot;#cb14-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;dt&quot;&gt;Jekyll&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Hooks&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;.trigger&lt;/span&gt; &lt;span class=&quot;wa&quot;&gt;:site&lt;/span&gt;, &lt;span class=&quot;wa&quot;&gt;:post_read&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;self&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb14-8&quot;&gt;&lt;a href=&quot;#cb14-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Overall only 22% of the time was spent doing the actual work of generating HTML:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode ruby&quot;&gt;&lt;code class=&quot;sourceCode ruby&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Render the site to the destination.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;#&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-3&quot;&gt;&lt;a href=&quot;#cb15-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;co&quot;&gt;# Returns nothing.&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-4&quot;&gt;&lt;a href=&quot;#cb15-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;def&lt;/span&gt; render&lt;/span&gt;
&lt;span id=&quot;cb15-5&quot;&gt;&lt;a href=&quot;#cb15-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      relative_permalinks_are_deprecated&lt;/span&gt;
&lt;span id=&quot;cb15-6&quot;&gt;&lt;a href=&quot;#cb15-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-7&quot;&gt;&lt;a href=&quot;#cb15-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      payload &lt;span class=&quot;kw&quot;&gt;=&lt;/span&gt; site_payload&lt;/span&gt;
&lt;span id=&quot;cb15-8&quot;&gt;&lt;a href=&quot;#cb15-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-9&quot;&gt;&lt;a href=&quot;#cb15-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;dt&quot;&gt;Jekyll&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Hooks&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;.trigger&lt;/span&gt; &lt;span class=&quot;wa&quot;&gt;:site&lt;/span&gt;, &lt;span class=&quot;wa&quot;&gt;:pre_render&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;self&lt;/span&gt;, payload&lt;/span&gt;
&lt;span id=&quot;cb15-10&quot;&gt;&lt;a href=&quot;#cb15-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-11&quot;&gt;&lt;a href=&quot;#cb15-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      render_docs(payload)&lt;/span&gt;
&lt;span id=&quot;cb15-12&quot;&gt;&lt;a href=&quot;#cb15-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      render_pages(payload)&lt;/span&gt;
&lt;span id=&quot;cb15-13&quot;&gt;&lt;a href=&quot;#cb15-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb15-14&quot;&gt;&lt;a href=&quot;#cb15-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;dt&quot;&gt;Jekyll&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Hooks&lt;/span&gt;&lt;span class=&quot;at&quot;&gt;.trigger&lt;/span&gt; &lt;span class=&quot;wa&quot;&gt;:site&lt;/span&gt;, &lt;span class=&quot;wa&quot;&gt;:post_render&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;self&lt;/span&gt;, payload&lt;/span&gt;
&lt;span id=&quot;cb15-15&quot;&gt;&lt;a href=&quot;#cb15-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;cf&quot;&gt;end&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In other words, all the time is spent reading to and from the disk. Clearly, the hugo case shows us this could be faster: we aren’t hitting a hardware limit. Yet why does this run even slower in JRuby and TruffleRuby than it does in MRI Ruby? Let’s try another test.&lt;/p&gt;
&lt;h4 id=&quot;jekyll-test-2&quot;&gt;Jekyll Test 2&lt;/h4&gt;
&lt;p&gt;Testing on the build process for another Jekyll site gives similar results timings: TruffleRuby is significantly slower.&lt;/p&gt;
&lt;div class=&quot;center&quot;&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Runtime&lt;/th&gt;
&lt;th&gt;Jekyll CI Run Time&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;MRI Ruby 2.7.0&lt;/td&gt;
&lt;td&gt;20 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;TruffleRuby-dev&lt;/td&gt;
&lt;td&gt;116 seconds&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figcaption&gt;
A larger Jekyll Site
&lt;/figcaption&gt;
&lt;/div&gt;
&lt;div class=&quot;wide&quot;&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/jruby/flame-graph2.png&quot; alt=&quot;This time most of the time is Liquid Template Rendering&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;This time most of the time is Liquid Template Rendering&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;/div&gt;
&lt;p&gt;This time the flamegraph shows most time is spent with rendering liquid templates rather than IO. I wasn’t able to figure out a way to get a flamegraph out of TruffleRuby.&lt;/p&gt;
&lt;p&gt;So what does this mean? My guess is that the filesystem Ruby code or the liquid templates do not benefit from being on the JVM. On the contrary, they seem to run slower.&lt;/p&gt;
&lt;p&gt;It might be possible to reimplement &lt;code&gt;write&lt;/code&gt; and &lt;code&gt;read&lt;/code&gt; to follow JVM high-performance file access best practices, and it might be possible to reimplement liquid templates in a Java native way. That should bring a speed-up, but I’m not sure if that would make JRuby faster than MRI Ruby for Jekyll or only bring it up to a similar performance.&lt;/p&gt;
&lt;h2 id=&quot;performance-advice&quot;&gt;Performance Advice&lt;/h2&gt;
&lt;p&gt;All this leaves me with the most generic performance advice: You should test your Ruby codebase with different runtimes and see what works best for you.&lt;/p&gt;
&lt;p&gt;If your code is long-running, CPU bound, and thread-based, and if the GIL limits you, TruffleRuby will probably be a win. Also, if that is the case and you tweak your code to use Java concurrent data structures instead of Ruby defaults, you can probably achieve an order of magnitude speed-up. If the garbage collector is a bottleneck for your app, that could also be another reason for trying out a different runtime.&lt;/p&gt;
&lt;p&gt;However, if your existing ruby codebase is not CPU bound and not multi-threaded, it will probably run slower on JRuby and Truffle Ruby than with the MRIRuby runtime.&lt;/p&gt;
&lt;p&gt;Also, I could be wrong. If I missed something important, then I’d love to hear from you. Here at &lt;a href=&quot;http://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; we take build performance very seriously, so if you have additional suggestions for speeding up Ruby or Jekyll, I’d love to hear them.&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot; role=&quot;doc-noteref&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;updates&quot;&gt;Updates&lt;/h2&gt;
&lt;section id=&quot;update-1&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Update #1&lt;/h3&gt;
&lt;/section&gt;
&lt;p&gt;Both &lt;span class=&quot;citation&quot; data-cites=&quot;ChrisGSeaton&quot;&gt;@ChrisGSeaton&lt;/span&gt;, the creator of TruffleRuby and &lt;span class=&quot;citation&quot; data-cites=&quot;headius&quot;&gt;@headius&lt;/span&gt;, who works on JRuby have responded on &lt;a href=&quot;https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/&quot;&gt;reddit&lt;/a&gt; with suggestions and requests for reproduction steps. I’m going to put together an example repo to share.&lt;/p&gt;
&lt;section id=&quot;update-2&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Update #2&lt;/h3&gt;
&lt;/section&gt;
&lt;p&gt;The area where JRuby and TruffleRuby shine are long running processes that have had time to warm up. Based on suggestions I put together a repo of a simple small Jekyll build being built 20 times by the same process in a repo &lt;a href=&quot;https://github.com/agbell/jekyll-perf&quot;&gt;here&lt;/a&gt;. After 20 builds with the same running process the build times do start to converge, but even after that MRI Ruby is still fastest.&lt;/p&gt;
&lt;section id=&quot;update-3&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h3&gt;Update #3&lt;/h3&gt;
&lt;/section&gt;
&lt;p&gt;I have filed a bug with Truffle Ruby and received some performance advice that I think is worth sharing here:&lt;/p&gt;
&lt;section id=&quot;some-feedback-on-the-assumptions-of-the-article&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h4&gt;Some Feedback on The Assumptions of The Article&lt;/h4&gt;
&lt;/section&gt;
&lt;blockquote&gt;
&lt;p&gt;Hello there, here are some notes on the blog post.&lt;/p&gt;
&lt;p&gt;“TruffleRuby is a fork of JRuby”&lt;/p&gt;
&lt;p&gt;Technically true from a repository point of view, and that’s what the README says (I’ll update that), but in practice it’s like &amp;gt;90% of code is not from JRuby. It’s quite different technologies.&lt;/p&gt;
&lt;p&gt;“Hugo, the static site builder for Go, is significantly faster than Jekyll. So we know that Jekyll is not at the limits of hardware where there is simply no more performance to squeeze out.”&lt;/p&gt;
&lt;p&gt;I’d bet that’s in part due to a different design. Most likely Hugo is better optimized and might do much less work due to different constraints.&lt;/p&gt;
&lt;p&gt;“However, if your existing ruby codebase is not CPU bound and not multi-threaded, it will probably run slower on JRuby and TruffleRuby than with the MRI Ruby runtime.”&lt;/p&gt;
&lt;p&gt;I think there is no such simple rule and also there is the question of “not CPU bound” is how much time spent in the kernel. TruffleRuby can be faster on many Ruby workloads, as long as there is Ruby code to run, there is potential for optimization. Of course if 90% is spent in read/write system calls, only 10% of it can be optimized by a Ruby implementation, but I would expect that’s pretty rare.&lt;/p&gt;
&lt;p&gt;The main thing I think is if it’s not almost entirely IO-bound, then there is potential to speed up. And the only way to know for sure is to try it, as you say.&lt;/p&gt;
&lt;p&gt;“I’d especially love to hear how to get a flame graph out of TruffleRuby”&lt;/p&gt;
&lt;p&gt;Thank you for the issue at &lt;a href=&quot;https://github.com/oracle/truffleruby/issues/2363&quot;&gt;https://github.com/oracle/truffleruby/issues/2363&lt;/a&gt;. Currently TruffleRuby has multiple Ruby-level profilers (–cpusampler, VisualVM, Chrome Inspector). We’re working on having an easy way to get a flamegraph (right now we use this but one needs to clone the truffleruby repo which is less convenient). Java-level profiling is also possible via VisualVM. async-profiler needs something like JDK&amp;gt;=15 to work properly with Graal compilations IIRC.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/gzqxexa/?context=3&quot;&gt;eregontp on reddit&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;section id=&quot;some-advice-for-making-ruby-single-process&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h4&gt;Some Advice for Making Ruby Single Process&lt;/h4&gt;
&lt;/section&gt;
&lt;blockquote&gt;
&lt;p&gt;Your simplest answer for both JRuby and TruffleRuby would be to set it up to use a single process to do everything. In JRuby, it is trivial to start up a separate, isolated JRuby instance within the same process:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;my_jruby = org.jruby.Ruby.new_instance
my_jruby.eval_script(ruby_code)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The code given will run in the same process but a completely different JRuby environment. This can be adapted to run your “subprocesses” without starting a fresh JVM every time.&lt;/p&gt;
&lt;p&gt;TruffleRuby likely has something similar based on GraalVM polyglot APIs.&lt;/p&gt;
&lt;p&gt;If you managed to get your CI run to use a single process, I would be surprised if it was not as fast or faster than standard C-based Ruby.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/gzjh5kt/?utm_source=reddit&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;headius on reddit&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Note: The article does cover &lt;code&gt;--dev&lt;/code&gt; and I did put together a single process &lt;a href=&quot;https://github.com/agbell/jekyll-perf&quot;&gt;example&lt;/a&gt; in update 2. The results are way better, but still slower.&lt;/p&gt;
&lt;section id=&quot;using-application-class-data-sharing&quot; class=&quot;no_toc_section&quot;&gt;
&lt;h4&gt;Using Application Class Data Sharing&lt;/h4&gt;
&lt;/section&gt;
&lt;blockquote&gt;
&lt;p&gt;AppCDS is a way to significantly improve startup speed without impacting total runtime performance. It’d be interesting to see if employing that helps with performance. &lt;a href=&quot;https://medium.com/@toparvion/appcds-for-spring-boot-applications-first-contact-6216db6a4194&quot; class=&quot;uri&quot;&gt;https://medium.com/@toparvion/appcds-for-spring-boot-applications-first-contact-6216db6a4194&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Finally, if you can, I’d be interested to see what happens if you work from a ramdisk rather than the HD. I imagine the IO problems you were likely seeing is due to a lot of back and forth communication between the app and the disk, what happens if you kill that off?&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.reddit.com/r/programming/comments/nlhmcz/why_is_jruby_slow/gzj1d3j/?utm_source=reddit&amp;amp;utm_medium=web2x&amp;amp;context=3&quot;&gt;cogman on reddit&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The feedback from the JRuby and TruffleRuby people has been amazing. They have been offering suggestions and asking for tickets and reproduction steps. These are ambitious projects that keep improving and I’m excited to hear that making Jekyll run faster than it does on CRuby is very possible with some additional elbow grease.&lt;/p&gt;
&lt;h2 id=&quot;more-resources&quot;&gt;More Resources&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://pragtob.wordpress.com/2020/08/24/the-great-rubykon-benchmark-2020-cruby-vs-jruby-vs-truffleruby/&quot;&gt;CRUBY VS JRUBY VS TRUFFLERUBY&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/oracle/truffleruby/blob/master/README.md&quot;&gt;Truffle Ruby&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=281YdMYRAsk&quot;&gt;Running Rack and Rails Faster with TruffleRuby&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;section class=&quot;footnotes&quot; role=&quot;doc-endnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;The work behind JRuby, TruffleRuby, and especially GraalVM is terrific. The TruffleRuby benchmark numbers for CPU heavy work continue to improve year upon year. I’m not trying to dunk on the great work done, merely trying to investigate the numbers I am seeing.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot; role=&quot;doc-endnote&quot;&gt;&lt;p&gt;I’d especially love to hear how to get a flame graph out of TruffleRuby. I didn’t get anywhere getting &lt;a href=&quot;https://github.com/jvm-profiling-tools/async-profiler&quot;&gt;async-profiler&lt;/a&gt; to attach.&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot; role=&quot;doc-backlink&quot;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;</content><author><name>Adam Gordon Bell</name></author><category term="Tutorial" /><summary type="html">Recently, I made some contributions to the continuous integration process for Jekyll. Jekyll is a static site generator created by GitHub and written in Ruby, and it uses Earthly and GitHub Actions to test that it works with Ruby 2.5, 2.7, 3.0, and JRuby.</summary></entry><entry><title type="html">Protocol Buffers Best Practices for Backward and Forward Compatibility</title><link href="https://earthly.dev/blog/backward-and-forward-compatibility/" rel="alternate" type="text/html" title="Protocol Buffers Best Practices for Backward and Forward Compatibility" /><published>2021-05-21T00:00:00-04:00</published><updated>2021-05-21T00:00:00-04:00</updated><id>https://earthly.dev/blog/backward-and-forward-compatibility</id><content type="html" xml:base="https://earthly.dev/blog/backward-and-forward-compatibility/">&lt;p&gt;&lt;a href=&quot;https://developers.google.com/protocol-buffers&quot; title=&quot;Protocol Buffers Documentation&quot;&gt;Protocol Buffers&lt;/a&gt; serialize structured data so it can be efficiently stored or shared over a network. They were designed for internal use at Google in 2001 and released to the public under an open-source license in 2008.&lt;/p&gt;
&lt;p&gt;Protocol Buffers are compiled to a series of strictly arranged bytes, so they can be transmitted very efficiently. After reconstitution, they can also be understood by a wide range of languages. Let’s examine protobufs first at a high level, then do a deep dive into best practices for working with them to see if they’re a fit for your expanding data workflow.&lt;/p&gt;
&lt;h2 id=&quot;what-exactly-are-protocol-buffers&quot;&gt;What Exactly Are Protocol Buffers?&lt;/h2&gt;
&lt;p&gt;Protocol Buffers are designed with the concept of extensibility at their core. You can add fields without a care, though you do have to be attentive when modifying or removing fields. This article will go through how you can manage your messages to maintain forward and backward compatibility.&lt;/p&gt;
&lt;p&gt;Protocol Buffers are most useful when regularly sharing small pieces of data (generally under 1 MB) between two computers on a regular basis. It’s designed for extracting and sharing that data, but it’s also very effective at storing data that will have to be shared between systems using different languages or controlled by different organizations.&lt;/p&gt;
&lt;p&gt;Protocol Buffers are also great at persisting blobs of data, particularly in languages like C++ where you can use protobuf as a data struct. If you’re communicating with lots of computers a little at a time, Protocol Buffers will save you network bandwidth.&lt;/p&gt;
&lt;h3 id=&quot;understanding-backward-and-forward-compatibility&quot;&gt;Understanding Backward and Forward Compatibility&lt;/h3&gt;
&lt;p&gt;Both backward and forward compatibility is important for any project you expect will run for a long time. There are at least two parts to any protobuf system, the sender and the receiver. If either one can be upgraded to a new message format, and the system functionality continues uninterrupted then the message protocol is both forward and backward compatible.&lt;/p&gt;
&lt;section id=&quot;backward-compatibility&quot; class=&quot;notice notice--big&quot;&gt;
&lt;h4&gt;Backward Compatibility&lt;/h4&gt;
&lt;p&gt;If a client that was updated to a new message type but is still able to understand the previous message type then the message change is backward compatible. Backward compatibility is being able to understand messages from a previous version.&lt;/p&gt;
&lt;/section&gt;
&lt;section id=&quot;forward-compatibility&quot; class=&quot;notice notice--big&quot;&gt;
&lt;h4&gt;Forward Compatibility&lt;/h4&gt;
&lt;p&gt;If a message is changed and a non-updated client can still understand and process the message then the message change is forward compatible. Forward compatibility is being able to understand messages from a future version.&lt;/p&gt;
&lt;/section&gt;
&lt;p&gt;With Protocol buffers, if a sender is upgraded, the receiver can still understand messages if it is forward compatible. It can accept input crafted by later versions of protobuf. The sender is backward compatible because it’s creating output that can be consumed by earlier versions. So long as you’re careful about when and how you change and remove fields, your protobuf will be forward and backward compatible.&lt;/p&gt;
&lt;h3 id=&quot;getting-started-with-buffers&quot;&gt;Getting Started with Buffers&lt;/h3&gt;
&lt;p&gt;The first step to making a Protocol Buffer is to define data structures in a &lt;code&gt;.proto&lt;/code&gt; file. For each data structure you want to create, you’ll make a &lt;code&gt;message&lt;/code&gt; that contains a name and data type for each field it contains.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode protobuf&quot;&gt;&lt;code class=&quot;sourceCode protobuf&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;syntax = &lt;span class=&quot;st&quot;&gt;&amp;quot;proto3&amp;quot;&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;package&lt;/span&gt; tutorial;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;message&lt;/span&gt; Sample{&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;string&lt;/span&gt; content = &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;int32&lt;/span&gt; id = &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;string&lt;/span&gt; situation = &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These declarations in the &lt;code&gt;.proto&lt;/code&gt; file are shared with both the message sender and receiver to construct immutable getters and setters that allow data to be read into and accessed from binary using a &lt;a href=&quot;/blog/compiling-containers-dockerfiles-llvm-and-buildkit&quot;&gt;compiler&lt;/a&gt;, then accessed in a variety of programming languages.&lt;/p&gt;
&lt;h2 id=&quot;tips-for-maintaining-compatibility&quot;&gt;Tips for Maintaining Compatibility&lt;/h2&gt;
&lt;p&gt;Compatibility starts with defining the syntax and version of protobuf the sender and receiver are using. The &lt;code&gt;package&lt;/code&gt; makes sure your code is namespaced to avoid any collisions. It is possible to have a sender using &lt;code&gt;proto3&lt;/code&gt; while a receiver uses &lt;code&gt;proto2&lt;/code&gt; (or any other combination) as long as you’re careful about what fields you include. Both the sender and receiver have strict definitions of existing fields—you can make changes as long as you don’t disturb those definitions.&lt;/p&gt;
&lt;h3 id=&quot;create-numerical-order&quot;&gt;Create (Numerical) Order&lt;/h3&gt;
&lt;p&gt;From a compatibility perspective, unique field numbers are the most vital piece of the message declaration. These numbers (the &lt;code&gt;= 1&lt;/code&gt; after the name declaration) are used as identifiers for fields after they are converted to binary. When the message is decoded, a crucial step for compatibility is allowing the parser to skip fields it doesn’t recognize so it’s possible to add new fields without breaking programs that weren’t designed to look for them.&lt;/p&gt;
&lt;p&gt;The unique field number is combined with a wire type corresponding to the data type of the field. This identifier and type combination form the key of every field in a message. These fields combined give the receiver the ability to uniquely identify fields and determine the length of the field, so it knows when to start looking for the next field.&lt;/p&gt;
&lt;p&gt;This means once a unique field number or length is set, it cannot be changed. Any program consuming or serizalizing protobuf data needs the number to be fixed forever, or both the sender and all the receivers must be updated.&lt;/p&gt;
&lt;p&gt;Encoding the numbers 1 through 15 takes one byte to encode, 16 through 2047 take two bytes, and so on. In situations where the size of messages is important, the most frequently exchanged data should have the smallest field numbers. The language is designed to effectively handle new fields, but because you can’t change the identifier of fields, it may be wise to leave yourself a couple gaps in these high-efficiency identifier ranges in case a very common field pops up in the future.&lt;/p&gt;
&lt;p&gt;One of the best ways to prevent problems with overlapping or misunderstood field numbers is to use the &lt;code&gt;reserved&lt;/code&gt; keyword. If you wanted to remove the &lt;code&gt;type&lt;/code&gt; field in your &lt;code&gt;Sample&lt;/code&gt; message, any applications running the protobuf version that contained that field would break if the identifier was removed and then reused for some other field.&lt;/p&gt;
&lt;p&gt;To get around these compatibility issues, you can reserve identifiers. You can also reserve ranges of identifiers; here you’re reserving a range and the removed value of &lt;code&gt;1&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode protobuf&quot;&gt;&lt;code class=&quot;sourceCode protobuf&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;message&lt;/span&gt; Sample{&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  reserved &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;5&lt;/span&gt; to &lt;span class=&quot;dv&quot;&gt;8&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb2-3&quot;&gt;&lt;a href=&quot;#cb2-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;int32&lt;/span&gt; id = &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb2-4&quot;&gt;&lt;a href=&quot;#cb2-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;dt&quot;&gt;string&lt;/span&gt; text = &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb2-5&quot;&gt;&lt;a href=&quot;#cb2-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;beware-of-required-fields&quot;&gt;Beware of Required Fields&lt;/h3&gt;
&lt;p&gt;Another tricky part of compatibility is the required modifier preceding the data type. In the second version of protobuf, there were three modifiers to choose from: &lt;code&gt;optional&lt;/code&gt;, &lt;code&gt;repeated&lt;/code&gt;, and &lt;code&gt;required&lt;/code&gt;. The &lt;code&gt;required&lt;/code&gt; option was removed in &lt;code&gt;protobuf3&lt;/code&gt;, because it requires careful planning to ensure compatibility. If a required field is missing from a message, readers will consider the message incomplete and return an error.&lt;/p&gt;
&lt;p&gt;Instead, consider writing custom validation or use default values within your application to handle required fields. In &lt;code&gt;protobuf2&lt;/code&gt;, you were able to set &lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/proto#optional&quot; title=&quot;Default fields in protobuf2&quot;&gt;default values&lt;/a&gt;, in &lt;code&gt;protobuf3&lt;/code&gt;, every field type has a &lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/proto3#default&quot; title=&quot;Default fields in protobuf3&quot;&gt;fixed default value&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;avoid-groups&quot;&gt;Avoid Groups&lt;/h3&gt;
&lt;p&gt;Another feature of &lt;code&gt;protobuf2&lt;/code&gt; that should be avoided to ensure compatibility is Groups. These enable nesting information inside method definitions. A Group combines a nested message type and a field into a single declaration using the &lt;code&gt;group&lt;/code&gt; keyword.&lt;/p&gt;
&lt;p&gt;The recommended way to nest messages is to nest them, then call them:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode protobuf&quot;&gt;&lt;code class=&quot;sourceCode protobuf&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;message&lt;/span&gt; SampleContainer {&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;message&lt;/span&gt; Sample{&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;optional&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;int32&lt;/span&gt; id = &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;optional&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;string&lt;/span&gt; text = &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;   &lt;span class=&quot;kw&quot;&gt;repeated&lt;/span&gt; Sample samples = &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;;&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The difference between nested message types and Groups is the wire format they use.&lt;/p&gt;
&lt;h3 id=&quot;adding-new-fields&quot;&gt;Adding New Fields&lt;/h3&gt;
&lt;p&gt;New fields can be safely added in any version of protobuf, but there are still compatibility considerations to be aware of. Pay attention to the depreciation of the &lt;code&gt;required&lt;/code&gt; fields and transition from user-specified defaults to protobuf-specified defaults. The application receiving protobuf data has to be responsible for handling the &lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/proto3#default&quot;&gt;default values&lt;/a&gt; for any new fields.&lt;/p&gt;
&lt;p&gt;You generally can freely change the name and order of fields. However, when you’re producing JSON serialized data with protobuf, the field names are also reserved by the receiver. This requires users to reserve &lt;strong&gt;field identifiers and names&lt;/strong&gt; when removing or deprecating fields.&lt;/p&gt;
&lt;h3 id=&quot;keep-an-eye-on-compatibility-when-changing-field-types&quot;&gt;Keep an Eye on Compatibility When Changing Field Types&lt;/h3&gt;
&lt;p&gt;Because field types are also used to determine when the receiver ends a field, changing field types across versions without carefully checking for compatibility can also cause problems. There are many specific &lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/proto3#updating&quot; title=&quot;Rule for updating fields&quot;&gt;rules&lt;/a&gt; about how to change field types, but a good standard is to avoid ever changing the wire type of any field. If you’re in a situation where you need to change a field type, the best path forward is to deprecate the existing field and put the new information into a new field.&lt;/p&gt;
&lt;h3 id=&quot;dont-destroy-deprecate&quot;&gt;Don’t Destroy, Deprecate&lt;/h3&gt;
&lt;p&gt;Protocol Buffer compatibility problems generally start when you need to change the length of or remove existing fields. There are a whole host of rules about how fields can &lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/proto3#updating&quot; title=&quot;Protobuf3 update fields&quot;&gt;change&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Largely, maintaining backward and forward compatibility comes down to maintaining a consistent wire type. You can’t change the wire type or alter the length of fields and expect old code to properly send or receive messages—the sender’s and receiver’s understanding of the exact length of each element in the transmitted messages needs to be precise.&lt;/p&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col style=&quot;width: 33%&quot; /&gt;
&lt;col style=&quot;width: 33%&quot; /&gt;
&lt;col style=&quot;width: 33%&quot; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&quot;header&quot;&gt;
&lt;th&gt;Type&lt;/th&gt;
&lt;th&gt;Meaning&lt;/th&gt;
&lt;th&gt;Used For&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;Varint&lt;/td&gt;
&lt;td&gt;int32, int64, uint32, uint64, sint32, sint64, bool, enum&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;64-bit&lt;/td&gt;
&lt;td&gt;fixed64, sfixed64, double&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;Length-delimited&lt;/td&gt;
&lt;td&gt;string, bytes, embedded messages, packed repeated fields&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;td&gt;Start group&lt;/td&gt;
&lt;td&gt;groups (deprecated)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td&gt;4&lt;/td&gt;
&lt;td&gt;End group&lt;/td&gt;
&lt;td&gt;groups (deprecated)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;even&quot;&gt;
&lt;td&gt;5&lt;/td&gt;
&lt;td&gt;32-bit&lt;/td&gt;
&lt;td&gt;fixed32, sfixed32, float&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;figcaption&gt;
Protobuf Wire Types
&lt;/figcaption&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;The biggest problems when upgrading are mismatching required fields or a need to change field types. In the short term, adding other fields is a viable solution, but at a certain point, the marginal cost of that solution becomes more of a burden than auditing and upgrading your services.&lt;/p&gt;
&lt;p&gt;Protocol Buffers are a relatively young technology, so changes now will have long-lasting implications. Compatibility issues do exist between versions, but they’re possible to step around if you’re careful. As always, make life simpler by planning out your data structures in advance. Once things eventually do change, the safest method for modifying fields is to add a new one and deprecate the old field.&lt;/p&gt;
&lt;p&gt;To deprecate a field, you can change the name to something deprecated or remove it and reserve the identifier. If you really want to change a field type, and you’re able to follow the correct version of &lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/proto3#updating&quot; title=&quot;Updating messages&quot;&gt;the rules&lt;/a&gt;, remember to never change the numerical identifier for that field. Plan well, and it’ll be easy to maintain backward and forward compatibility for your Protocol Buffer deployment.&lt;/p&gt;</content><author><name>John Gramila</name></author><category term="Tutorials" /><summary type="html">Protocol Buffers serialize structured data so it can be efficiently stored or shared over a network. They were designed for internal use at Google in 2001 and released to the public under an open-source license in 2008.</summary></entry><entry><title type="html">Understanding Docker Multistage Builds</title><link href="https://earthly.dev/blog/docker-multistage/" rel="alternate" type="text/html" title="Understanding Docker Multistage Builds" /><published>2021-05-20T00:00:00-04:00</published><updated>2021-05-20T00:00:00-04:00</updated><id>https://earthly.dev/blog/docker-multistage</id><content type="html" xml:base="https://earthly.dev/blog/docker-multistage/">&lt;p&gt;At first glance, writing Dockerfiles appears to be a straightforward process. After all, most basic examples reflect the same set of steps. However, not all Dockerfiles are created equal. There is an optimal way of writing these files to produce the kind of Docker images you want for your final product. If you were to pop the hood, you’d see that Docker images actually consist of file system layers that correlate to the individual build steps involved in the creation of the image.&lt;/p&gt;
&lt;p&gt;To build an efficient Docker image, you want to eliminate some of these layers from the final output. Optimizing an image can take a lot of effort as you attempt to filter out what you don’t need. Building these kinds of images has a lot to do with keeping them as small as possible, because large images lead to a host of other issues.&lt;/p&gt;
&lt;p&gt;One approach to keeping Docker images small is using multistage builds. A multistage build allows you to use multiple images to build a final product. In a multistage build, you have a single Dockerfile, but can define multiple images inside it to help build the final image.&lt;/p&gt;
&lt;p&gt;In this post, you’ll learn about the core concepts of multistage builds in Docker and how they help to create production-grade images. In addition, I will detail how you can create these types of files, as well as highlight some challenges that they present.&lt;/p&gt;
&lt;h2 id=&quot;core-concepts-of-docker-multistage-builds&quot;&gt;Core Concepts of Docker Multistage Builds&lt;/h2&gt;
&lt;p&gt;Before getting to the details of multistage builds, it’s good to have an understanding of the main idea behind them. You’re already familiar with the starting point of container images, the Dockerfile. Dockerfiles are text files that make it easy to assemble all the relevant commands required to create your container image. These commands in the Dockerfile should be combined whenever possible for the sake of optimization.&lt;/p&gt;
&lt;p&gt;When I first came across this idea of building the right kind of Docker image, I asked myself a few questions that may be crossing your mind as you read this. What are the implications of &lt;em&gt;not&lt;/em&gt; optimizing an image? Can it really have that much of a negative impact on your application? The answer to the latter question is yes.&lt;/p&gt;
&lt;p&gt;As for the implications, you typically end up with bigger images. The reason big images should be avoided is because &lt;a href=&quot;https://developers.redhat.com/blog/2016/03/09/more-about-docker-images-size/&quot; title=&quot;Keep it small: a closer look at Docker image sizing&quot;&gt;they increase both potential security vulnerabilities and the surface area for attack&lt;/a&gt;. You definitely want to keep things lean by ensuring you only have what your application needs to run successfully in a production environment.&lt;/p&gt;
&lt;p&gt;One way of reducing the size of your Docker images is through the use of what is informally known as the &lt;a href=&quot;https://en.wikipedia.org/wiki/Builder_pattern&quot; title=&quot;builder design pattern entry at Wikipedia&quot;&gt;builder pattern&lt;/a&gt;. The builder pattern uses two Docker images to create a base image for building assets and the second to run it. This pattern was previously implemented through the use of multiple Dockerfiles. It has become an uncommon practice since the introduction and support of multistage builds in &lt;a href=&quot;https://www.docker.com/blog/multi-stage-builds/&quot; title=&quot;Multi-Stage Builds&quot;&gt;Docker 17.06 CE&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;For context, it’s good to understand how this was typically done before multistage builds. The following example makes use of a basic React application that is first built and then has its static content served by an &lt;a href=&quot;https://www.nginx.com/&quot; title=&quot;Nginx web servers&quot;&gt;Nginx virtual server&lt;/a&gt;. Following are the two Dockerfiles used to create the optimized image. In addition, you’ll see a &lt;a href=&quot;/blog/understanding-bash&quot;&gt;shell script&lt;/a&gt; that demonstrates the Docker CLI commands that have to be run in order to achieve this outcome. You can find the source code for this example in &lt;a href=&quot;https://github.com/LukeMwila/builder-pattern-example&quot; title=&quot;builder pattern example in Lukonde Mwila&amp;#39;s GitHub repository&quot;&gt;this repository&lt;/a&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Dockerfile.build
FROM node:12.13.0-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Dockerfile.main
FROM nginx
EXPOSE 3000
COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf
COPY /app/build /usr/share/nginx/html&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Build.sh
#!/bin/sh
echo Building lukondefmwila/react:build

docker build -t lukondefmwila:build . -f Dockerfile.build

docker create --name extract lukondefmwila:build

docker cp extract:/app/build ./app

docker rm -f extract

echo Building lukondefmwila/react:latest

docker build --no-cache -t lukondefmwila/react:latest . -f Dockerfile.main&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;While using the builder pattern does give you the desired outcome, it presents additional challenges. This process introduces the management overhead that comes with maintaining multiple Dockerfiles—not to mention the cumbersome procedure of running through several Docker CLI commands, even if this can be streamlined by a shell script.&lt;/p&gt;
&lt;h2 id=&quot;how-to-use-docker-multistage-builds&quot;&gt;How to Use Docker Multistage Builds&lt;/h2&gt;
&lt;p&gt;Now that you get the underlying concept, turn your attention to how this translates to the modern implementation of the builder pattern. What the former approach accomplishes with multiple Dockerfiles, the multistage feature does in one. You can get the same results with your builds without the added complexity.&lt;/p&gt;
&lt;p&gt;Multistage builds make use of one Dockerfile with multiple FROM instructions. Each of these FROM instructions is a new build stage that can COPY artifacts from the previous stages. By going and copying the build artifact from the build stage, you eliminate all the intermediate steps such as downloading of code, installing dependencies, and testing. All these steps create additional layers, and you want to eliminate them from the final image.&lt;/p&gt;
&lt;p&gt;The build stage is named by appending AS &lt;em&gt;name-of-build&lt;/em&gt; to the FROM instruction. The name of the build stage can be used in a subsequent FROM and COPY command by providing a convenient way to identify the source layer for files brought into the image build. The final image is produced from the last stage executed in the Dockerfile.&lt;/p&gt;
&lt;p&gt;Try taking the example from the previous section that used more than one Dockerfile for the React application and replacing the solution with one file that uses a multistage build.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Dockerfile
FROM node:12.13.0-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx
EXPOSE 3000
COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/build /usr/share/nginx/html&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This Dockerfile has two FROM commands, with each one constituting a distinct build stage. These distinct commands are numbered internally, stage 0 and stage 1 respectively. However, stage 0 is given a friendly alias of &lt;code&gt;build&lt;/code&gt;. This stage builds the application and stores it in the directory specified by the WORKDIR command. The resultant image is over 420 MB in size.&lt;/p&gt;
&lt;p&gt;The second stage starts by pulling the official Nginx image from Docker Hub. It then copies the updated virtual server configuration to replace the default Nginx configuration. Then the COPY –from command is used to copy only the production-related application code from the image built by the previous stage. The final image is approximately 127 MB.&lt;/p&gt;
&lt;h2 id=&quot;problems-that-docker-multistage-builds-might-encounter&quot;&gt;Problems That Docker Multistage Builds Might Encounter&lt;/h2&gt;
&lt;p&gt;Depending on how they are designed, multistage builds can introduce some serious issues around the speed of the build process. Since these Dockerfiles have multiple stages to produce the production-grade image, your cache will not consist of the images built in the previous steps leading to your final output. Simulating the build locally might give you the impression that it’s worth the wait. However, when you’re working with build services such as &lt;a href=&quot;https://aws.amazon.com/codebuild/&quot;&gt;AWS CodeBuild&lt;/a&gt;, &lt;a href=&quot;https://travis-ci.org/&quot;&gt;Travis CI&lt;/a&gt;, or &lt;a href=&quot;https://circleci.com/&quot;&gt;CircleCI&lt;/a&gt;, you want to keep your build time as short as possible for cost reasons, as well as streamlining application delivery.&lt;/p&gt;
&lt;p&gt;In order to make use of the cache, you will have to tag, push, and pull the images produced from the preliminary build stages. As an example, take the multistage Dockerfile from the previous section and split it into two files, Dockerfile.stage-one and Dockerfile.final. The first Dockerfile will create the image that will be pulled and used in stage 0 of the multistage Dockerfile.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Dockerfile.stage-one
FROM node:12.13.0-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;Dockerfile.final
FROM lukondefmwila/react:build-stage as build

FROM nginx
EXPOSE 3000
COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf
COPY --from=build /app/build /usr/share/nginx/html&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;That being said, following such an approach for every stage can create an increasingly verbose process every stage that you have. Another way of solving this issue is to make use of &lt;a href=&quot;https://earthly.dev/blog/what-is-buildkit-and-what-can-i-do-with-it/&quot;&gt;BuildKit&lt;/a&gt;. BuildKit came about to address issues and improve on the build features in the &lt;a href=&quot;https://mobyproject.org/&quot;&gt;Moby Engine&lt;/a&gt;. It allows for better cache efficiency and control when building. To enable BuildKit builds, follow the steps outlined in &lt;a href=&quot;https://docs.docker.com/develop/develop-images/build_enhancements/#to-enable-buildkit-builds&quot;&gt;Docker’s documentation&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;more-stages&quot;&gt;More Stages&lt;/h2&gt;
&lt;p&gt;As your multi-stage build grows in complexity, comprehending how each step follows from the next can become a challenge. If the number of stages extends beyond two or if caching is becoming a challenge, you may want to consider using &lt;a href=&quot;http://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; to produce your docker images. Earthly mirrors the dockerfile syntax but allows for naming the stages and for more fine-grained caching.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM node:12.13.0-alpine as build
WORKDIR /app

build:
  COPY package*.json ./
  RUN npm install
  COPY . .
  RUN npm run build

final:
  FROM nginx
  EXPOSE 3000
  COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf
  COPY  +build/app/build /usr/share/nginx/html&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;While creating Docker images the right way is not a small task, the final outcome does a great deal of good for the speed and security of your application delivery. Larger images have a high number of security vulnerabilities that shouldn’t be overlooked for the sake of speed. The reality is that quality images take time and care.&lt;/p&gt;
&lt;p&gt;The builder pattern has evolved over time in its implementation, with multistage builds coming to the rescue from the tedious steps that previously had to be followed. Tools like BuildKit and Earthly further improve on this process. Though not foolproof, multistage builds have made it much easier to create optimized images that you can be more pleased and confident to have running in your production environment.&lt;/p&gt;</content><author><name>Lukonde Mwila</name></author><category term="Tutorials" /><summary type="html">At first glance, writing Dockerfiles appears to be a straightforward process. After all, most basic examples reflect the same set of steps. However, not all Dockerfiles are created equal. There is an optimal way of writing these files to produce the kind of Docker images you want for your final product. If you were to pop the hood, you’d see that Docker images actually consist of file system layers that correlate to the individual build steps involved in the creation of the image.</summary></entry><entry><title type="html">Getting a Repeatable Build, Every Time</title><link href="https://earthly.dev/blog/repeatable-builds-every-time/" rel="alternate" type="text/html" title="Getting a Repeatable Build, Every Time" /><published>2021-05-19T00:00:00-04:00</published><updated>2021-05-19T00:00:00-04:00</updated><id>https://earthly.dev/blog/repeatable-builds-every-time</id><content type="html" xml:base="https://earthly.dev/blog/repeatable-builds-every-time/">&lt;p&gt;&lt;em&gt;EDIT This post used to be titled &lt;strong&gt;How to not use our build tool&lt;/strong&gt;. Thanks to Reddit user &lt;a href=&quot;https://www.reddit.com/user/musman&quot;&gt;musman&lt;/a&gt; for suggesting the current updated title&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;In our journey to becoming better software engineers we have learned of various ways in which the team’s productivity could be improved. We noticed that a focus on build repeatability and maintainability goes a long way towards keeping the team focused on what really matters: delivering great software. Many of these ideas helped shape what Earthly is today. In fact, the complexity of the matter is what got us to &lt;a href=&quot;https://earthly.dev/blog/the-world-deserves-better-builds/&quot;&gt;start Earthly in the first place&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I wanted to sit down and write about all the tricks we learned and that we used every day to help make builds more manageable in the absence of Earthly. It’s kinda like a “what would you do if you couldn’t use Earthly” article. This will hopefully give you some ideas on best practices around build script maintenance, or it might help you decide on whether Earthly is something for you (or if the alternative is preferrable).&lt;/p&gt;
&lt;p&gt;In this article, we will walk through the 10,000 feet view of your build strategy, then dive into some specific tricks, tools, and techniques you might use to keep your builds effective and reproducible, with other off-the-shelf tools.&lt;/p&gt;
&lt;h2 id=&quot;putting-together-complex-builds---assumptions&quot;&gt;Putting Together Complex Builds - Assumptions&lt;/h2&gt;
&lt;p&gt;Since this is a guide about how not to use Earthly, we’ll try to achieve the same benefits of Earthly, using other tools. Here are some assumptions:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;You are building cloud or web services, targeting Linux.&lt;/li&gt;
&lt;li&gt;You have a setup where multiple programming languages come together (e.g. multiple microservices).&lt;/li&gt;
&lt;li&gt;You would like to have fast local dev-test cycles for individual components.&lt;/li&gt;
&lt;li&gt;You would like to be able to iterate quickly when there is a CI failure.&lt;/li&gt;
&lt;li&gt;Developers on your team use varying platforms for day-to-day development: some Linux, some Mac, some Windows.&lt;/li&gt;
&lt;li&gt;You would like to optimize for cross-team collaboration.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;scope-the-glue-layer&quot;&gt;Scope: The Glue Layer&lt;/h2&gt;
&lt;p&gt;We will focus primarily on the glue layer of your builds. The stuff that brings everything together - maybe it packages things up for releases, or maybe it prepares packages for deployment, or perhaps it is simply a script that the CI definition calls into.&lt;/p&gt;
&lt;p&gt;This is a diagram we sometimes use to describe the glue layer. In this article, we’ll be focusing on the Dockerfile, Makefile, and Bash parts of that glue layer. Not having a glue layer can make CI failures difficult to reproduce, or for other teams unfamiliar with the language-specific build tooling to effectively create the right environment to run builds.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/assets/images/repeatable-builds-every-time/glue-layer.png&quot; alt=&quot;The glue layer&quot; /&gt;&lt;br /&gt;
&lt;/p&gt;
&lt;p&gt;The glue layer is the layer between the various projects that need to be built and will act as the common denominator - &lt;a href=&quot;https://earthly.dev/blog/migrating-from-travis/#neutral-build-specifications&quot;&gt;a vendor-neutral build specification&lt;/a&gt;. If we don’t choose such a glue layer, then the CI YAML (or Groovy?) becomes the glue layer and that would mean that it’s more difficult to run it locally for fast iteration.&lt;/p&gt;
&lt;p&gt;Because we want to encourage cross-team collaboration, we want to standardize the tooling across teams as much as possible. Different language ecosystems will have different tools and we want to keep using those. You can’t tell the frontend team not to use package.json / NPM / Yarn etc - that would be terribly cumbersome for them. So we’re not touching the language-specific build layer.&lt;/p&gt;
&lt;p&gt;In addition, because we want to be able to iterate quickly when there are CI failures, we will containerize the build as much as possible. If the failure is part of a containerized script, then it will be easier to reproduce it locally.&lt;/p&gt;
&lt;p&gt;A popular choice for the glue layer is to use Makefile + Dockerfile. Makefiles are great as a collection of everyday commands that we can use (&lt;code&gt;make build&lt;/code&gt;, &lt;code&gt;make start&lt;/code&gt;, &lt;code&gt;make package&lt;/code&gt;, &lt;code&gt;make test&lt;/code&gt;), while Dockerfiles help keep most of the build containerized.&lt;/p&gt;
&lt;p&gt;Another option might be to use bash + Dockerfile, where a collection scripts for everyday tasks exist under a &lt;code&gt;hack&lt;/code&gt; or &lt;code&gt;scripts&lt;/code&gt; directory (&lt;code&gt;./hack/build&lt;/code&gt;, &lt;code&gt;./hack/test&lt;/code&gt;, &lt;code&gt;./hack/release&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Yet another, more exotic, option is to use another scripting language, such as Python or JavaScript (see, for example, the &lt;a href=&quot;https://github.com/google/zx&quot;&gt;zx&lt;/a&gt; library). Keep in mind, however, that it’s best when most of the engineers can read and write the build scripts with ease. Sometimes too much flexibility of the programming language can make it harder for others to read and understand the scripts. This is an especially important point as the build scripts will likely be read much more often than they will be written.&lt;/p&gt;
&lt;p&gt;For this guide, we’ll use Makefile + Dockerfile, as an arbitrary choice. Note, however, that neither Bash nor Makefile is very intuitive at first glance and you will need to help out junior developers, or developers that simply haven’t had the opportunity to learn these yet. And also, these are purely arbitrary choices, based on what we see as popular technologies used in this area. Your own choice may vary for good reasons. This guide is not saying that Makefile / Bash / Dockerfile are the only right choices.&lt;/p&gt;
&lt;h2 id=&quot;tips-for-taming-makefiles-in-large-teams&quot;&gt;Tips for Taming Makefiles in Large Teams&lt;/h2&gt;
&lt;p&gt;While there is &lt;a href=&quot;https://www.shellcheck.net/&quot;&gt;shellcheck&lt;/a&gt; for linting shell scripts and avoiding the typical pitfalls, there is currently no linter for Makefiles. Part of the reason is that there are multiple styles or philosophies as to how to write Makefiles that it is hard to enforce specific rules that prevent human errors. For example, take a look at this &lt;a href=&quot;https://tech.davis-hansson.com/p/make/&quot;&gt;particularly opinionated approach&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Makefiles have the ability to manage the chain of dependencies and avoid duplicate work. However, this feature is heavily based on file creation time (if an input is newer than the output, then rebuild the target), and in most cases that is not enough. If you really want to, it is possible to force everything into that model. However, that tends to create very complicated Makefiles that often only one person on the team understands. This person becomes the “Build Guru” and all build maintenance works flow through them. This “Build Guru” dynamic is very common but best avoided. With Makefiles, using a limited subset of the Makefile language can help avoid this pattern and keep everything more maintainable for the entire team.&lt;/p&gt;
&lt;p&gt;If the Makefile wraps an existing build (for example, a Gradle-based or NPM-based build), it might make more sense to avoid Makefile’s more advanced features in those particular projects, to help the team be comfortable with making changes to the Makefile, with limited knowledge. In such cases, the caching would be handled by the wrapped build system and not by the Makefile itself.&lt;/p&gt;
&lt;p&gt;Here are some guidelines to help keep Makefiles simple and understandable, when the Makefile wraps another build system.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Only use &lt;a href=&quot;https://www.gnu.org/software/make/manual/html_node/Phony-Targets.html&quot;&gt;&lt;code&gt;.PHONY&lt;/code&gt; targets&lt;/a&gt;. Explanation: regular Makefile targets are names of files that need to be output. If the file does not exist or it is older than its inputs, &lt;code&gt;make&lt;/code&gt; decides to run the target. A &lt;code&gt;.PHONY&lt;/code&gt; target is a target that is not really a file - it’s just a name that the user can use as a short-hand to refer to a recipe to be run.&lt;code&gt;.PHONY&lt;/code&gt; targets don’t use the freshness algorithm.&lt;/li&gt;
&lt;li&gt;Avoid overusing the distinct features of the different variable flavors (&lt;code&gt;=&lt;/code&gt; vs &lt;code&gt;:=&lt;/code&gt; vs &lt;code&gt;?=&lt;/code&gt; vs &lt;code&gt;+=&lt;/code&gt; vs &lt;code&gt;!=&lt;/code&gt;). Someone not knowing the details of how Makefiles work will be confused if the logic relies heavily on the specific flavor.&lt;/li&gt;
&lt;li&gt;Avoid order-only prerequisite types (&lt;code&gt;targets : normal-prerequisites | order-only-prerequisites&lt;/code&gt;). The &lt;code&gt;order-only-prerequisite&lt;/code&gt; can be misleading to someone new to Makefiles.&lt;/li&gt;
&lt;li&gt;Avoid complex rules involving &lt;code&gt;patsubst&lt;/code&gt; or special variables like &lt;code&gt;$&amp;lt;&lt;/code&gt;, &lt;code&gt;$^&lt;/code&gt;, &lt;code&gt;$*&lt;/code&gt;, &lt;code&gt;$@&lt;/code&gt;. The way these work is a mystery to Makefile newcomers and it can be really hard to Google for the meaning.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In other words, try not to be too smart about Makefiles. Note, however, that if the Makefile does not wrap an existing build system, then it is likely that you’ll need the advanced features of Makefile to correctly make use of the caching system.&lt;/p&gt;
&lt;p&gt;Another thing to consider is that certain UNIX commands vary from platform to platform. For example, &lt;code&gt;sed&lt;/code&gt; and &lt;code&gt;find&lt;/code&gt; have important differences between GNU/Linux and macOS, and while Windows can behave very much like Linux through WSL 2, testing is needed to verify everything you are using will work the same. Ask a colleague to test out your scripts on their platform if in doubt.&lt;/p&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;&lt;strong&gt;Remember The Tab&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Use of the tab character is mandatory in Makefiles or you’ll get this error. This usually catches newbies off-guard.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;code&gt;Makefile:273: *** missing separator.  Stop.&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;h2 id=&quot;tips-for-dockerfiles&quot;&gt;Tips for Dockerfiles&lt;/h2&gt;
&lt;p&gt;To help keep builds reproducible, it’s useful to have a version of the build in containerized form. If performance allows, this might be the day-to-day form that everyone uses. If not, at the very least, it’s the form that is used to debug CI failures.&lt;/p&gt;
&lt;p&gt;Dockerfiles are the bread and butter of containerized builds. However, they have an important limitation: they can only output Docker images. They weren’t designed to run unit tests or to output regular artifacts (binaries, jars, packages, etc). However, with some wrapper code, it is possible to extract regular files from images or to execute unit tests too. The following will illustrate how.&lt;/p&gt;
&lt;h3 id=&quot;use-multi-stage-dockerfiles-or-multiple-dockerfiles&quot;&gt;Use Multi-stage Dockerfiles or Multiple Dockerfiles&lt;/h3&gt;
&lt;p&gt;To help split up Dockerfile recipes into logical groupings, you can make use of multiple Dockerfile targets (also called multi-stage builds) and/or of multiple Dockerfile files.&lt;/p&gt;
&lt;p&gt;To define targets use &lt;code&gt;FROM ... AS ...&lt;/code&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; alpine:latest AS my-target-name&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;...&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; ubuntu:latest AS another-target-name&lt;/span&gt;
&lt;span id=&quot;cb1-6&quot;&gt;&lt;a href=&quot;#cb1-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-7&quot;&gt;&lt;a href=&quot;#cb1-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;...&lt;/span&gt;
&lt;span id=&quot;cb1-8&quot;&gt;&lt;a href=&quot;#cb1-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-9&quot;&gt;&lt;a href=&quot;#cb1-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; my-target-name AS yet-another-target-name&lt;/span&gt;
&lt;span id=&quot;cb1-10&quot;&gt;&lt;a href=&quot;#cb1-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb1-11&quot;&gt;&lt;a href=&quot;#cb1-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A target can be used in another &lt;code&gt;FROM&lt;/code&gt; command or a &lt;code&gt;COPY&lt;/code&gt; command (&lt;code&gt;COPY --from=my-target-name &amp;lt;file-from&amp;gt; &amp;lt;file-to&amp;gt;&lt;/code&gt;) to copy resulting files from one target into another. This flexibility allows your definition to be more modular, and possibly also more efficient in cache, or more efficient in the size of the final image.&lt;/p&gt;
&lt;p&gt;To invoke a specific Dockerfile target, you can use the &lt;code&gt;--target&lt;/code&gt; flag of &lt;code&gt;docker build&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;--target&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;my-target-name &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; my-build-image .&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If a target is not specified, &lt;code&gt;docker build&lt;/code&gt; will simply build the last target in the file.&lt;/p&gt;
&lt;h3 id=&quot;running-containerized-unit-tests&quot;&gt;Running Containerized Unit Tests&lt;/h3&gt;
&lt;p&gt;In order to run unit tests in containers, you might take either of the following strategies:&lt;/p&gt;
&lt;ol type=&quot;a&quot;&gt;
&lt;li&gt;
Run the test as a Dockerfile target
&lt;/li&gt;
&lt;li&gt;
Build a container with all the necessary code and set the entrypoint to execute the unit tests, then run that container.
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;A third, less recommended, option is to execute tests as additional layers of the final image. This is not a great option because it unnecessarily bloats your image size and also, there’s no way to skip them. If you just want an image quickly this option will end up getting in your way.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option a.&lt;/strong&gt; has the advantage that if nothing changes, the Dockerfile caching will simply reuse previous work and return quickly. Since you don’t need the image being created, you can simply skip mentioning a tag via &lt;code&gt;-t&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build .&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Option b.&lt;/strong&gt; requires managing an extra image, but might make them look more like the integration tests. Plus, if you want to mount in the source code instead of &lt;code&gt;COPY&lt;/code&gt;ing it (faster on Linux), this option allows that.&lt;/p&gt;
&lt;h3 id=&quot;running-integration-tests&quot;&gt;Running Integration Tests&lt;/h3&gt;
&lt;p&gt;When running containerized integration tests that depend on additional services, only &lt;strong&gt;option b.&lt;/strong&gt; above is available. In such cases, you might want to make use of docker-compose to manage multiple containers running together. Even if your setup is small, it’s just easier to be able to kill everything at once if your tests hang.&lt;/p&gt;
&lt;p&gt;Another option is to use &lt;a href=&quot;https://github.com/testcontainers&quot;&gt;testcontainers&lt;/a&gt; - a language-specific library that allows you to bring up containerized helper services during integration testing. This can be a great abstraction, however, if you want to keep the integration tests containerized too, you’ll need to mount &lt;code&gt;/var/run/docker.sock&lt;/code&gt; (this is sometimes referred to as “docker-out-of-docker”). This will allow the integration test code to bring up the necessary helper services via testcontainers.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; run &lt;span class=&quot;at&quot;&gt;-v&lt;/span&gt; /var/run/docker.sock:/var/run/docker.sock ...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Either way, to keep your test suite as easy to use as possible, it’s great if you can map the series of commands needed to run the integration tests to a single make command (e.g. &lt;code&gt;make integration&lt;/code&gt;) and use this command without any additional settings or wrappers in your CI scripts too. That way, if your CI breaks, then you have a very easy one-liner that should (hopefully) reproduce the failure on your local machine.&lt;/p&gt;
&lt;h3 id=&quot;outputting-regular-files&quot;&gt;Outputting Regular Files&lt;/h3&gt;
&lt;p&gt;Even the most containerized builds benefit from being able to occasionally output regular files. Here are some possible situations:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Binaries / Packages / Library archives&lt;/li&gt;
&lt;li&gt;Releaseables (deb packages, source code tarballs)&lt;/li&gt;
&lt;li&gt;Screenshots from UI tests&lt;/li&gt;
&lt;li&gt;Test coverage reports&lt;/li&gt;
&lt;li&gt;Performance profile reports&lt;/li&gt;
&lt;li&gt;Database schema init scripts&lt;/li&gt;
&lt;li&gt;Generated source code files (to help IDEs with syntax highlighting)&lt;/li&gt;
&lt;li&gt;Generated configuration&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To output regular files as part of a containerized build, there are a few options.&lt;/p&gt;
&lt;ol type=&quot;a&quot;&gt;
&lt;li&gt;
Generate the file(s) into a host-mounted volume as part of &lt;code&gt;docker run&lt;/code&gt;.
&lt;/li&gt;
&lt;li&gt;
Generate the file(s) as part of &lt;code&gt;docker run&lt;/code&gt; and then extract them using &lt;code&gt;docker cp&lt;/code&gt;.
&lt;/li&gt;
&lt;li&gt;
Generate the file(s) as the contents of an image during &lt;code&gt;docker build&lt;/code&gt; then extract them using the &lt;code&gt;docker build -o&lt;/code&gt;option.
&lt;/li&gt;
&lt;li&gt;
Generate the file(s) as the contents of an image during &lt;code&gt;docker build&lt;/code&gt; then extract them using &lt;code&gt;docker cp&lt;/code&gt;.
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Let’s take these one at a time:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option a. Generate the file(s) into a host-mounted volume as part of &lt;code&gt;docker run&lt;/code&gt;&lt;/strong&gt;: This is by far the most used, but arguably the least useful. This technique involves setting the entrypoint as the command that generates the resulting artifact and mounting an output directory (or maybe even the entire source code directory) where the result can be stored and shared with the host system.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; run &lt;span class=&quot;at&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;$PWD&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;/output:/output&amp;quot;&lt;/span&gt; my-image:latest&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;ls&lt;/span&gt; /output&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The typical issue with this approach is that the resulting artifacts are owned by &lt;code&gt;root&lt;/code&gt;. Getting rid of them or moving them around then requires &lt;code&gt;sudo&lt;/code&gt;. There are, of course, ways to generate the files as a different user within the container, but this can be cumbersome.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option b. Generate the file(s) as part of &lt;code&gt;docker run&lt;/code&gt; and then extract them using &lt;code&gt;docker cp&lt;/code&gt;&lt;/strong&gt;: This option involves executing the &lt;code&gt;docker run&lt;/code&gt; and then afterward issuing &lt;code&gt;docker cp&lt;/code&gt; to extract the resulting artifact. Here’s an example:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; run &lt;span class=&quot;at&quot;&gt;--name&lt;/span&gt; build-artifact my-image:latest&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; cp build-artifact:/output/my-artifact ./output/my-artifact&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; rm build-artifact&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This option will produce results owned by the right user. The one possible downside of this approach is that if the &lt;code&gt;docker run&lt;/code&gt; fails, a hanging &lt;code&gt;build-artifact&lt;/code&gt; container remains, which will cause the next run to fail due to naming conflict. This can be easily fixed, however, by adding &lt;code&gt;docker rm -f build-artifact&lt;/code&gt; at the beginning of the script.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option c. Generate the file(s) as the contents of an image during &lt;code&gt;docker build&lt;/code&gt; then extract them using the &lt;code&gt;docker build -o&lt;/code&gt; option&lt;/strong&gt;: This is a lesser-known technique particularly suited for outputting entire directories. It essentially outputs the root directory of an entire image to the host. Here’s how this might be used.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; alpine AS base&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; mkdir -p /output&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; echo &lt;span class=&quot;st&quot;&gt;&amp;quot;contents&amp;quot;&lt;/span&gt; &amp;gt;/output/my-artifact&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; scratch&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; --from=base /output/* /&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb8&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb8-1&quot;&gt;&lt;a href=&quot;#cb8-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;-o&lt;/span&gt; ./output .&lt;/span&gt;
&lt;span id=&quot;cb8-2&quot;&gt;&lt;a href=&quot;#cb8-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;cat&lt;/span&gt; ./output/my-artifact &lt;span class=&quot;co&quot;&gt;# prints &amp;quot;contents&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The use of the scratch base image is such that the final image is minimal and only the required artifact is copied over to the host.&lt;/p&gt;
&lt;p&gt;This technique outputs files owned by the right user, however sometimes the fact that it outputs a whole directory can be limiting.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option d. Generate the file(s) as the contents of an image during &lt;code&gt;docker build&lt;/code&gt; then extract them using &lt;code&gt;docker cp&lt;/code&gt;&lt;/strong&gt;: This technique is somewhat similar to &lt;strong&gt;option b.&lt;/strong&gt; except that no &lt;code&gt;docker run&lt;/code&gt; is used.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb9&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb9-1&quot;&gt;&lt;a href=&quot;#cb9-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; my-image:latest .&lt;/span&gt;
&lt;span id=&quot;cb9-2&quot;&gt;&lt;a href=&quot;#cb9-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; create &lt;span class=&quot;at&quot;&gt;--name&lt;/span&gt; output-artifact my-image:latest&lt;/span&gt;
&lt;span id=&quot;cb9-3&quot;&gt;&lt;a href=&quot;#cb9-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; cp output-artifact:/output/my-artifact ./output/my-artifact&lt;/span&gt;
&lt;span id=&quot;cb9-4&quot;&gt;&lt;a href=&quot;#cb9-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; rm output-artifact&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This option too will produce artifacts owned by the right user.&lt;/p&gt;
&lt;h2 id=&quot;tips-for-taming-bash-scripts&quot;&gt;Tips for Taming Bash Scripts&lt;/h2&gt;
&lt;p&gt;Regardless of the build setup, bash scripts are sometimes inevitable, especially when extensive release logic is needed and the language-specific tooling doesn’t offer specific support.&lt;/p&gt;
&lt;p&gt;If you’re new to bash scripting, I’ll run through a few of the more useful beginner tricks from our &lt;a href=&quot;https://earthly.dev/blog/understanding-bash/&quot;&gt;understanding bash article&lt;/a&gt;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Spaces are surprisingly important. &lt;code&gt;A=B&lt;/code&gt; is different from &lt;code&gt;A = B&lt;/code&gt;. Also &lt;code&gt;if[$A=$B]&lt;/code&gt; does not work - it has to be &lt;code&gt;if [ $A = $B ]&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Variables can cause really weird things if they are not wrapped in double-quotes. The reason is that a variable that contains spaces can expand across multiple command parameters unless it’s within quotes. To prevent any surprises, a good rule is to never expand a variable outside of double-quotes. So use &lt;code&gt;&quot;$ABC&quot;&lt;/code&gt; always and not simply &lt;code&gt;$ABC&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;A really good tool to check for some common errors like the above is &lt;a href=&quot;https://www.shellcheck.net/&quot;&gt;&lt;code&gt;shellcheck&lt;/code&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;If there is an error in a bash script, by default, the script simply continues without a worry. This is very often not what you want - you want to terminate immediately so that the user is aware that something has failed. To enable this, put &lt;code&gt;set -e&lt;/code&gt; at the top of the file.&lt;/li&gt;
&lt;li&gt;A series of piped commands can also fail and bash doesn’t terminate by default. To terminate immediately in such cases, you can enable &lt;code&gt;set -o pipefail&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;An undefined variable is treated as the empty string in bash. However a lot of times an undefined variable can also be caused by a typo, or an incomplete rename during a refactor, or some other human error. To avoid surprises, you can do &lt;code&gt;set -u&lt;/code&gt;, which will cause the script to fail on undefined variables. To initialize a variable with a default value (and avoid this error, if you’d like to allow an optional external variable), you can use &lt;code&gt;: &quot;${&amp;lt;variable-name&amp;gt;:=&amp;lt;default-value&amp;gt;}&quot;&lt;/code&gt;. Just don’t forget the &lt;code&gt;:&lt;/code&gt; in front of it.&lt;/li&gt;
&lt;li&gt;If you have no idea what your bash script is doing, you can make it print every statement being evaluated using &lt;code&gt;set -x&lt;/code&gt;. It’s especially useful when debugging.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;importing-code-and-artifacts-from-another-repository&quot;&gt;Importing Code and Artifacts from Another Repository&lt;/h2&gt;
&lt;p&gt;Sometimes it’s useful to import the result of one build from repo A into the build of repo B. Here are some examples of situations where this is needed:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Building some binaries in a core repo and packaging the release in a “build-tooling” repo (example in &lt;a href=&quot;https://github.com/Kong/kong-build-tools&quot;&gt;kong&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;Generating protobuf files in one repo and reusing those files in multiple other repos (client(s) and server)&lt;/li&gt;
&lt;li&gt;Pre-computing some initialization data in one repo and using it in another repo&lt;/li&gt;
&lt;li&gt;Cases where the language-specific tooling offers little or no support for importing code from another repository&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There are multiple ways to achieve importing on your own. In general, if the language you use provides solid importing mechanisms, there is little to no reason to build any scripting that does the same thing. In other cases, you might go with one of the following makeshift options:&lt;/p&gt;
&lt;ol type=&quot;a&quot;&gt;
&lt;li&gt;
Git clone
&lt;/li&gt;
&lt;li&gt;
Submodule
&lt;/li&gt;
&lt;li&gt;
Pass files via a Docker image
&lt;/li&gt;
&lt;li&gt;
Pass files via S3
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Option a. Git clone&lt;/strong&gt;: This relies on git-cloning one repo from within the other. It’s especially useful when the code itself is needed and not necessarily an artifact resulting from building that code. Here how this might be achieved in a Makefile:&lt;/p&gt;
&lt;!-- markdownlint-disable no-hard-tabs --&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode makefile&quot;&gt;&lt;code class=&quot;sourceCode makefile&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;dv&quot;&gt;my-dep:&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt; ./deps/my-dep&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ot&quot;&gt;./deps/my-dep:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  mkdir -p deps&lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  rm -rf ./deps/my-dep&lt;/span&gt;
&lt;span id=&quot;cb10-6&quot;&gt;&lt;a href=&quot;#cb10-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  git clone --branch v1.2.3 &amp;lt;clone-url&amp;gt; ./deps/my-dep&lt;/span&gt;
&lt;span id=&quot;cb10-7&quot;&gt;&lt;a href=&quot;#cb10-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-8&quot;&gt;&lt;a href=&quot;#cb10-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;dv&quot;&gt;clean:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb10-9&quot;&gt;&lt;a href=&quot;#cb10-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  rm -rf ./deps&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- markdownlint-enable no-hard-tabs --&gt;
&lt;p&gt;Although it’s relatively crude in that it wipes the whole dir and re-clones it when necessary, it’s also pretty robust because there’s nothing assumed about the state of that directory. (Just make sure you’re not making important changes in that directory as those may be lost!)&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;--branch&lt;/code&gt; setting takes any git tag, sha, or branch, or, in general, a git ref. This helps pin the dependency to something specific if that is needed.&lt;/p&gt;
&lt;p&gt;You’ll need to be careful about how you use the &lt;code&gt;&amp;lt;clone-url&amp;gt;&lt;/code&gt; as some engineers will use HTTPS auth, while others will use &lt;code&gt;ssh&lt;/code&gt; auth. You might want to standardize on only one of the two options and use git’s &lt;code&gt;insteadof&lt;/code&gt; feature if an individual developer would like to switch to the other URL.&lt;/p&gt;
&lt;p&gt;For example, if a developer wants to dynamically switch from &lt;code&gt;https://&lt;/code&gt; to SSH GitHub URLs, they can do:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb11&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb11-1&quot;&gt;&lt;a href=&quot;#cb11-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;git&lt;/span&gt; config &lt;span class=&quot;at&quot;&gt;--global&lt;/span&gt; url.&lt;span class=&quot;st&quot;&gt;&amp;quot;git@github.com:&amp;quot;&lt;/span&gt;.insteadOf &lt;span class=&quot;st&quot;&gt;&amp;quot;https://github.com/&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Option b. Submodule&lt;/strong&gt;: This is another popular option especially when the source code itself is also needed. The technique involves relying on the &lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Tools-Submodules&quot;&gt;&lt;code&gt;git submodule&lt;/code&gt;&lt;/a&gt; capabilities built into git.&lt;/p&gt;
&lt;p&gt;The way it works is that git marks certain paths within the repository where submodules (other git repositories) can be cloned into. You can use the following command to add such submodules:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;git&lt;/span&gt; submodule add &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;clone-url&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;&amp;lt;&lt;/span&gt;path&lt;span class=&quot;op&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This command clones the referenced repository into that path and also adds a &lt;code&gt;.gitmodules&lt;/code&gt; file in the root of your repository, which might look like this.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb13&quot;&gt;&lt;pre class=&quot;sourceCode toml&quot;&gt;&lt;code class=&quot;sourceCode toml&quot;&gt;&lt;span id=&quot;cb13-1&quot;&gt;&lt;a href=&quot;#cb13-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;submodule&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;&amp;quot;&amp;lt;name&amp;gt;&amp;quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;]&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-2&quot;&gt;&lt;a href=&quot;#cb13-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;path&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;&amp;lt;path&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb13-3&quot;&gt;&lt;a href=&quot;#cb13-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;url&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;&amp;lt;clone-url&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Besides this entry, git internally also stores the git sha of the submoduled repository, so it is tied strongly to a specific version of it.&lt;/p&gt;
&lt;p&gt;Although there is significant tooling out there for working with submodules, some people don’t enjoy them because they require adjusting the typical git workflow to account for maintaining the submodules. In some cases, when submodules are overused, they can create more confusion than necessary. You can tell things can get complex when git comes with commands like &lt;code&gt;git submodule foreach 'git stash'&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There is much more to submodules than is in scope for this guide, but a good run-down can be found in the &lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Tools-Submodules&quot;&gt;git official documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option c. Pass files via a Docker image&lt;/strong&gt;: This option involves creating a Docker image that is not really actually run. It is merely used as a package repository.&lt;/p&gt;
&lt;p&gt;The advantage of this technique is that Docker images support tags, which allow for embedding into a release-process-based workflow. This technique is especially useful when artifacts beyond the source code itself are needed. Things like binaries, or generated files.&lt;/p&gt;
&lt;p&gt;However, this option does require repo A to execute a build that packages up the image before it can be used in repo B. If &lt;strong&gt;options a.&lt;/strong&gt; and &lt;strong&gt;b.&lt;/strong&gt; are simply &lt;strong&gt;commit to repo A&lt;/strong&gt; -&amp;gt; &lt;strong&gt;use in repo B&lt;/strong&gt;, for &lt;strong&gt;option c.&lt;/strong&gt; the sequence is &lt;strong&gt;commit to repo A&lt;/strong&gt; -&amp;gt; &lt;strong&gt;wait for CI build of repo A to complete&lt;/strong&gt; -&amp;gt; &lt;strong&gt;use in repo B&lt;/strong&gt;.&lt;/p&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;&lt;strong&gt;Side Note&lt;/strong&gt;. If the CI is slow, this can be a productivity hog. To counter this situation, make sure that the individual engineer on the team can build the image independently from the CI, in order to be able to iterate locally quickly.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Here’s how this option works in general.&lt;/p&gt;
&lt;p&gt;Repo A:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; scratch&lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; ./build/files ./&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb15&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb15-1&quot;&gt;&lt;a href=&quot;#cb15-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; my-registry/my-artifacts:my_tag .&lt;/span&gt;
&lt;span id=&quot;cb15-2&quot;&gt;&lt;a href=&quot;#cb15-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; push my-registry/my-artifacts:my_tag&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Repo B:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull my-registry/my-artifacts:my_tag
docker create --name output-artifacts my-registry/my-artifacts:my_tag
docker cp output-artifacts:files ./deps/files
docker rm output-artifacts&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The nice thing about this approach is that Docker will use its cache if an artifact has not changed.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Option d. Pass files via S3&lt;/strong&gt;: This option is very similar to &lt;strong&gt;option c.&lt;/strong&gt;, except that it uses an S3 bucket instead of a Docker registry for storing artifacts.&lt;/p&gt;
&lt;p&gt;Although I’ve heard this being used as a viable alternative, I’ve never seen this in action myself. With the wide range of Docker registries available out there, I don’t think this option is necessarily better. If, however, your company for whatever reason cannot provide you with a Docker registry repository, just know that using S3 (or any other cloud blob store) is also a possibility.&lt;/p&gt;
&lt;h2 id=&quot;parallelism-with-makefiles-and-dockerfiles&quot;&gt;Parallelism with Makefiles and Dockerfiles&lt;/h2&gt;
&lt;p&gt;The bread and butter of improving build speed are caching and parallelism. We will look at each of these topics in the context of Makefiles and Dockerfiles.&lt;/p&gt;
&lt;p&gt;Makefiles have parallelism support out of the box. Running any make target with the &lt;code&gt;-j&lt;/code&gt; option tells Make to execute dependencies in parallel (e.g. &lt;code&gt;make -j build&lt;/code&gt;). Although this is a seemingly easy win for performance, it comes with a number of strings attached, that you should be aware of.&lt;/p&gt;
&lt;p&gt;First of all, Make targets are not isolated - they all operate on the same directory. When you run multiple such targets in parallel, you may get very surprising results due to race conditions. Imagine if, for one of your targets, you really want to run a clean build, so you make it depend on the target &lt;code&gt;clean&lt;/code&gt;. And then you have another target, which ensures that your &lt;code&gt;build&lt;/code&gt; directory has been created. Well if these run in parallel, you can imagine how they could get in each other’s way.&lt;/p&gt;
&lt;p&gt;To really make use of this option, you’ll need to design target dependencies with parallelism mindfulness. You’ll need to really think about dependencies whether they need to be built in a certain order, or if they can be built in any order.&lt;/p&gt;
&lt;p&gt;If you need dependencies to be built in a specific order, a great way to achieve that is to use recursive Make calls:&lt;/p&gt;
&lt;!-- markdownlint-disable no-hard-tabs --&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb17&quot;&gt;&lt;pre class=&quot;sourceCode makefile&quot;&gt;&lt;code class=&quot;sourceCode makefile&quot;&gt;&lt;span id=&quot;cb17-1&quot;&gt;&lt;a href=&quot;#cb17-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;dv&quot;&gt;build:&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb17-2&quot;&gt;&lt;a href=&quot;#cb17-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;ch&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;MAKE&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;)&lt;/span&gt; dep1&lt;/span&gt;
&lt;span id=&quot;cb17-3&quot;&gt;&lt;a href=&quot;#cb17-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;ch&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;MAKE&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;)&lt;/span&gt; dep2&lt;/span&gt;
&lt;span id=&quot;cb17-4&quot;&gt;&lt;a href=&quot;#cb17-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;ch&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;MAKE&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;)&lt;/span&gt; dep3&lt;/span&gt;
&lt;span id=&quot;cb17-5&quot;&gt;&lt;a href=&quot;#cb17-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  actually build&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- markdownlint-enable no-hard-tabs --&gt;
&lt;p&gt;If dependencies can execute in any order, then declaring them as regular target dependencies will be fine:&lt;/p&gt;
&lt;!-- markdownlint-disable no-hard-tabs --&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb18&quot;&gt;&lt;pre class=&quot;sourceCode makefile&quot;&gt;&lt;code class=&quot;sourceCode makefile&quot;&gt;&lt;span id=&quot;cb18-1&quot;&gt;&lt;a href=&quot;#cb18-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;dv&quot;&gt;build:&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt; dep1 dep2 dep3&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb18-2&quot;&gt;&lt;a href=&quot;#cb18-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  actually build&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;!-- markdownlint-enable no-hard-tabs --&gt;
&lt;p&gt;Note that these principles may be difficult to uphold in a large team, as not all engineers will be running the build with the parallel option turned on. So a lot of times the parallelism capability is not tested, and as a result, it can break often. Keep these things in mind as you may need to reinforce the use of parallelism in project READMEs to hopefully be better supported by individual PRs.&lt;/p&gt;
&lt;p&gt;Another, either alternative or complementary option, is to make use of Dockerfile parallelism. With &lt;a href=&quot;https://github.com/moby/buildkit&quot;&gt;Buildkit&lt;/a&gt; turned on (&lt;code&gt;DOCKER_BUILDKIT=1 docker build ...&lt;/code&gt;), Dockerfiles are built with parallelism automatically, if they involve multiple targets. So for example, if you have targets &lt;code&gt;dep1&lt;/code&gt;, &lt;code&gt;dep2&lt;/code&gt; and &lt;code&gt;dep3&lt;/code&gt; and you &lt;code&gt;COPY&lt;/code&gt; files from them like so:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb19&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb19-1&quot;&gt;&lt;a href=&quot;#cb19-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; alpine AS build&lt;/span&gt;
&lt;span id=&quot;cb19-2&quot;&gt;&lt;a href=&quot;#cb19-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; --from=dep1 /output/artifact1 ./&lt;/span&gt;
&lt;span id=&quot;cb19-3&quot;&gt;&lt;a href=&quot;#cb19-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; --from=dep2 /output/artifact2 ./&lt;/span&gt;
&lt;span id=&quot;cb19-4&quot;&gt;&lt;a href=&quot;#cb19-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; --from=dep3 /output/artifact3 ./&lt;/span&gt;
&lt;span id=&quot;cb19-5&quot;&gt;&lt;a href=&quot;#cb19-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; actually build&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then &lt;code&gt;dep1&lt;/code&gt;, &lt;code&gt;dep2&lt;/code&gt;, and &lt;code&gt;dep3&lt;/code&gt; will be executed in parallel. The nice thing about this is that there is nothing shared between these three targets (unlike the Makefile case) and they will just work in parallel. No special considerations are necessary.&lt;/p&gt;
&lt;h2 id=&quot;shared-caching&quot;&gt;Shared Caching&lt;/h2&gt;
&lt;p&gt;Another way to speed up builds is to make use of shared caching. Shared caching is especially relevant in modern CI setups where the CI task is sandboxed. Because the CI is sandboxed, it cannot reuse the result of a previous build.&lt;/p&gt;
&lt;p&gt;There are, of course, CI-supported cache saving features. However, those features are not usable when testing locally. And in the end, all that CI caching does is just upload a file or directory to cloud storage, which can be downloaded later in another instance of the build.&lt;/p&gt;
&lt;p&gt;Dockerfile builds have pretty powerful cache saving and importing capabilities, thanks to the new &lt;a href=&quot;https://github.com/moby/buildkit&quot;&gt;Buildkit&lt;/a&gt; engine. To use these capabilities, you need to first enable Buildkit (&lt;code&gt;DOCKER_BUILDKIT=1 docker build ...&lt;/code&gt;) and then pass the right arguments to turn these features on.&lt;/p&gt;
&lt;p&gt;First, you need to push images together with the cache manifest:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb20&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb20-1&quot;&gt;&lt;a href=&quot;#cb20-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;va&quot;&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; my-registry/my-image &lt;span class=&quot;at&quot;&gt;--build-arg&lt;/span&gt; BUILDKIT_INLINE_CACHE=1 .&lt;/span&gt;
&lt;span id=&quot;cb20-2&quot;&gt;&lt;a href=&quot;#cb20-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; push my-registry/my-image&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And then you need to make use of the cache in subsequent builds using &lt;code&gt;--cache-from&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb21&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb21-1&quot;&gt;&lt;a href=&quot;#cb21-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;va&quot;&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;--cache-from&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;my-registry/my-image &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; my-registry/my-image .&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Doing both in the same command looks like this:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb22&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb22-1&quot;&gt;&lt;a href=&quot;#cb22-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;va&quot;&gt;DOCKER_BUILDKIT&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;1 &lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; build &lt;span class=&quot;at&quot;&gt;--cache-from&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;my-registry/my-image &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; my-registry/my-image &lt;span class=&quot;at&quot;&gt;--build-arg&lt;/span&gt; BUILDKIT_INLINE_CACHE=1 .&lt;/span&gt;
&lt;span id=&quot;cb22-2&quot;&gt;&lt;a href=&quot;#cb22-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;docker&lt;/span&gt; push my-registry/my-image&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the image does not already exist (or if it does not have a cache manifest embedded), there will be a warning, but the build will work fine otherwise.&lt;/p&gt;
&lt;h2 id=&quot;managing-secrets&quot;&gt;Managing Secrets&lt;/h2&gt;
&lt;p&gt;Mature CI/CD setups often hold more secrets than there are available in the production environment. That’s because they often need access to registries, artifactories, git repositories, as well as staging environments where additional testing can be performed, and also the production environment itself, where live releases are deployed to, together with schema write access to DBs for upgrades, and also possibly S3 access. Wow - that’s a mouthful.&lt;/p&gt;
&lt;p&gt;Oh, did I also mention that the CI runs a ton of code imported from the web? That &lt;code&gt;npm install&lt;/code&gt; one of your colleagues ran in CI will download half the internet. And not all of it is particularly &lt;a href=&quot;https://www.zdnet.com/article/codecov-breach-impacted-hundreds-of-customer-networks/&quot;&gt;trust-worthy&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This whole thing makes for an incredibly risky attack surface. Giving access to build secrets to every developer adds an unnecessary extra dimension to the whole risk.&lt;/p&gt;
&lt;p&gt;However, to be able to reproduce some of the builds, you really need to give at least &lt;em&gt;some&lt;/em&gt; access. At the very least, developers need read access to most Docker registries and package artifactories / package repositories. In fact, if you want to ensure that artifacts and images that make it to production are never created on a developer’s computer (because you don’t know if their specific environment will produce the releasable correctly consistently), you can simply not give out write access to any Docker repository and make it a rule that only the CI may have write access. (You might still need separate, non-production repos for local testing, though).&lt;/p&gt;
&lt;p&gt;For the read access, it’s best if each engineer gets their own account and credentials. In case someone is terminated, you can simply revoke access from that engineer’s account and know that all other credentials are not compromised.&lt;/p&gt;
&lt;p&gt;For reproducing CI/CD failures in pipelines with more sensitive access, you will need to maintain a small list of employees who will receive more privileged production access.&lt;/p&gt;
&lt;p&gt;To share the initial credentials with each engineer, if an email invite feature is not provided by the system, it’s best to use a password manager to send credentials one-to-one. Sometimes this process gets fairly manual in larger teams, but for the reasons mentioned above, it’s important to maintain segregated access.&lt;/p&gt;
&lt;p&gt;For a seamless setup, you can also store build credentials in HashiCorp Vault and use the Vault CLI in scripts to read secrets where they are needed.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb23&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb23-1&quot;&gt;&lt;a href=&quot;#cb23-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;vault&lt;/span&gt; read &lt;span class=&quot;at&quot;&gt;-field&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;foo secret/my-secret&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This may be helpful in setups where extensive use of build credentials is required. Managing a &lt;a href=&quot;https://www.vaultproject.io/docs/install&quot;&gt;Vault installation&lt;/a&gt;, however, is a whole project of its own, and going into those details is perhaps a story for another day.&lt;/p&gt;
&lt;h2 id=&quot;maintaining-consistency&quot;&gt;Maintaining Consistency&lt;/h2&gt;
&lt;p&gt;Now to turn to a more philosophical aspect of builds. A great build setup is one where every engineer can understand what it does fairly quickly and where every engineer can contribute with minimal to no help at all. Although these principles are obvious goals to have, the norm is quite the opposite.&lt;/p&gt;
&lt;p&gt;Engineers don’t have an innate need to mess things up. It’s not like we wake up in the morning trying to make builds cumbersome and complex for everyone else. The issue is usually that builds simply grow organically into an eventual big hairball of mess.&lt;/p&gt;
&lt;p&gt;The result of this is that new team members have difficulty making sense of the build scripts and colleagues from other teams have difficulty in contributing to your team’s project, thus creating integration gaps.&lt;/p&gt;
&lt;p&gt;Think about how this is in your organization. Is it difficult for you to contribute to another team’s codebase? Do you know how to run the project’s unit and integration test suites? Is there even an integration test between the two projects?&lt;/p&gt;
&lt;p&gt;To help teams meld with each other, it’s particularly important to have a standard way to build and test any project in the organization. If the build is containerized and everyone has read access to the right base images, then everyone can build and test each other’s codebases, thus eliminating at least one of the natural barriers that get formed between engineering teams.&lt;/p&gt;
&lt;p&gt;If you want to go a step further, you can even standardize a set of commands for the repositories across the organization. For example:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;make build&lt;/code&gt; - builds the project&lt;/li&gt;
&lt;li&gt;&lt;code&gt;make test&lt;/code&gt; - runs the unit tests&lt;/li&gt;
&lt;li&gt;&lt;code&gt;make integration&lt;/code&gt; - runs the integration tests&lt;/li&gt;
&lt;li&gt;&lt;code&gt;make ci&lt;/code&gt; - executes the same script that is run in CI&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Then your engineers will be able to build another team’s codebase in their sleep!&lt;/p&gt;
&lt;h2 id=&quot;other-options&quot;&gt;Other Options&lt;/h2&gt;
&lt;p&gt;This article wouldn’t be complete without mentioning that if you’re a large organization (thousands of engineers), you can also take a look at some large-scale build systems as popular alternatives to in-house scripts. The names that come to mind are &lt;a href=&quot;https://bazel.build/&quot;&gt;Bazel&lt;/a&gt;, &lt;a href=&quot;https://buck.build/&quot;&gt;Buck&lt;/a&gt; and &lt;a href=&quot;https://v1.pantsbuild.org/&quot;&gt;Pants&lt;/a&gt;. These systems imply heavy organization buy-in and well-staffed build engineering teams to manage them.&lt;/p&gt;
&lt;p&gt;Some of these can provide some of the most advanced capabilities available on planet Earth, however, they do come with the tradeoff that they don’t integrate well with most open-source tooling and so all projects need to be adapted to fit the paradigm.&lt;/p&gt;
&lt;p&gt;If you’d like to get started exploring these, we have previously written about &lt;a href=&quot;https://earthly.dev/blog/monorepo-with-bazel/&quot;&gt;Monorepos and Bazel&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;parting-words-and-mandatory-plug&quot;&gt;Parting Words and Mandatory Plug&lt;/h2&gt;
&lt;p&gt;Getting everyone to write containerized builds is difficult in a growing organization. As you can see from this article, certain operations within containerized builds are not trivial to achieve and the wheel may be reinvented many times across the different teams.&lt;/p&gt;
&lt;p&gt;For these reasons, we have built Earthly. Through Earthly, we wanted to give containerized builds to the world, for the sake of reproducibility. From our own experience, we saw that Dockerfiles alone are not meant as build scripts, but rather as container image definitions. In true Unix philosophy, they are a great tool for that specific job - they do one thing and they do it well. To go the extra step and have containerized builds scripts (not just image definitions), a number of tricks and wrappers are necessary. Earthly takes the best ideas from Dockerfiles and Makefiles and puts them into a unified syntax that anyone can understand at-a-glance.&lt;/p&gt;
&lt;p&gt;Give Earthly a try and tell us what you think via our &lt;a href=&quot;https://earthly.dev/slack&quot;&gt;Slack&lt;/a&gt; or our &lt;a href=&quot;https://github.com/earthly/earthly/issues&quot;&gt;GitHub issue tracker&lt;/a&gt;.&lt;/p&gt;</content><author><name>Vlad A. Ionescu</name></author><category term="Articles" /><category term="Makefile" /><category term="Dockerfile" /><category term="Bash" /><category term="Build scripts" /><category term="Build strategy" /><category term="Repeatable builds" /><category term="Glue layer" /><summary type="html">I wanted to sit down and write about all the tricks we learned and that we used every day to help make builds more manageable in the absence of Earthly. It's kinda like a &quot;what would you do if you couldn't use Earthly&quot; article. This will hopefully give you some ideas on best practices around build script maintenance, or it might help you decide on whether Earthly is something for you (or if the alternative is preferrable).</summary></entry><entry><title type="html">What Is Continuous Integration?</title><link href="https://earthly.dev/blog/continuous-integration/" rel="alternate" type="text/html" title="What Is Continuous Integration?" /><published>2021-05-17T00:00:00-04:00</published><updated>2021-05-17T00:00:00-04:00</updated><id>https://earthly.dev/blog/continuous-integration</id><content type="html" xml:base="https://earthly.dev/blog/continuous-integration/">&lt;p&gt;Continuous integration has become prevalent in software development, but it’s still a complex and wide-ranging topic. In this post, we’ll cover the basics of continuous integration, the differences between CI and CD, and common CI tools. You’ll also find some tips for the best way to set up CI in your environment.&lt;/p&gt;
&lt;h2 id=&quot;what-is-continuous-integration&quot;&gt;What Is Continuous Integration?&lt;/h2&gt;
&lt;p&gt;Continuous integration (CI) is a set of operating principles and practices in the DevOps process that helps software development teams release faster and more reliable application updates. With the advancement of modern tooling, most CI processes center around automated tests, static analysis, and building releasable software. This process is helpful for teams that want to ensure each update to their software is working, stable, and ready to deploy before they integrate it into their production environment.&lt;/p&gt;
&lt;p&gt;For example, if a team member makes a change to a project, they might make updates on a new branch (assuming they’re using &lt;a href=&quot;https://git-scm.com/&quot;&gt;git for version control&lt;/a&gt;). When complete, they &lt;em&gt;push&lt;/em&gt; these changes to a shared &lt;a href=&quot;/blog/monorepo-vs-polyrepo&quot;&gt;repository&lt;/a&gt; where a continuous integration workflow will automatically install dependencies, run tests, and check for linting errors before merging the changes into the main branch.&lt;/p&gt;
&lt;h2 id=&quot;the-relationship-between-continuous-integration-and-continuous-deliverydeployment&quot;&gt;The Relationship Between Continuous Integration and Continuous Delivery/Deployment&lt;/h2&gt;
&lt;p&gt;Continuous integration is the first part of the CI/CD process. The &lt;em&gt;CD&lt;/em&gt; stands for either &lt;em&gt;continuous delivery&lt;/em&gt; or &lt;em&gt;continuous deployment&lt;/em&gt;. Although these terms are sometimes used interchangeably, they are not quite the same.&lt;/p&gt;
&lt;p&gt;In both cases, code is released in short cycles. However, with continuous delivery, code changes are automatically deployed through the development and &lt;a href=&quot;/blog/unit-vs-integration&quot;&gt;testing stages&lt;/a&gt;, but must be manually reviewed and approved before being batched and released to production.&lt;/p&gt;
&lt;p&gt;With continuous deployment, code changes that successfully pass through all stages of the development process are automatically released to production without human intervention. A failed test along the pipeline is the only event that will prevent a change from reaching production.&lt;/p&gt;
&lt;h3 id=&quot;why-ci-is-important-to-software-development&quot;&gt;Why CI Is Important to Software Development&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;“Continuous integration doesn’t get rid of bugs, but it does make them dramatically easier to find and remove.” – &lt;a href=&quot;http://www.thoughtworks.com/continuous-integration?utm_source=Codeship&amp;amp;utm_medium=CI-Guide&quot; title=&quot;CI explainer at ThoughtWorks&quot;&gt;Martin Fowler&lt;/a&gt;, Chief Scientist, ThoughtWorks&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Before continuous integration became an industry standard, developers’ changes were tested less frequently, often only when it was time to release a new version of the software. This meant the team had to spend unnecessary hours fixing bugs that could have been caught earlier in the process with a robust continuous integration process.&lt;/p&gt;
&lt;p&gt;CI helps developers avoid such problems while increasing productivity. Because code changes are automatically and continuously tested, verified, and built, developers should not have to manually check for integration issues. Because testing in CI is frequent and automated, developers can find and address bugs faster and earlier in the software development life cycle. This promotes a culture that delivers faster, higher-quality releases into production.&lt;/p&gt;
&lt;h2 id=&quot;how-ci-works&quot;&gt;How CI Works&lt;/h2&gt;
&lt;p&gt;CI validates changes upon check-in using an automated build process that also runs validation and integration tests. The continuous integration process aims to detect bugs and errors faster and eliminate the integration issues that occur when developers work in isolation, resulting in higher quality software releases and faster delivery times.&lt;/p&gt;
&lt;h3 id=&quot;a-typical-ci-build-process&quot;&gt;A Typical CI Build Process&lt;/h3&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/continuous-integration/r80Ri4R.png&quot; alt=&quot;Earthly integration diagram&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Earthly integration diagram&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;In a typical CI build process, developers push code changes from a branch to a central repository such as GitHub. CI automation servers such as Jenkins and CircleCI continuously monitor the repository to check for code updates.&lt;/p&gt;
&lt;p&gt;Once it detects a change, the automation server triggers the build process to compile and build the code, then run validation and integration tests. CI automation servers interface with compilation tools such as Docker, Bash, and Makefile to create deployable artifacts such as binaries, packages, or Docker images. When continuous deployment is employed, the built application is then deployed and run on subsequent testing or production environments. Other developers can also pull down the resulting image and test locally.&lt;/p&gt;
&lt;p&gt;If the build fails, the development team will typically receive an alert, allowing them to fix any errors that occur.&lt;/p&gt;
&lt;h3 id=&quot;how-has-ci-changed-in-the-past-few-years&quot;&gt;How Has CI Changed in the Past Few Years?&lt;/h3&gt;
&lt;p&gt;CI became popular as an integral part of agile software development but has since developed into one of the pillars of the DevOps process. Guided by key principles such as revision control, software integration, and build automation, it is now an industry standard in software development.&lt;/p&gt;
&lt;p&gt;As DevOps practices &lt;a href=&quot;https://www.novelvista.com/blogs/project-management/3-devops-trends-in-2020&quot; title=&quot;NovelVista blog on DevOps changes in 2020&quot;&gt;continue to evolve&lt;/a&gt;, we see trends moving toward self-service and a more cloud-centric model to give developers more autonomy. Because of COVID-19, CIOs and other IT leaders have recognized the need to adjust and adapt to support more cloud-based workflows and applications. Moving forward, cloud-native approaches, including multi-cloud solutions, will become the standard for hosting, pipelines, storage, and load balancing.&lt;/p&gt;
&lt;p&gt;As part of the self-service trend, developers will no longer have to wait for a separate operations team to dispatch new applications or updates, but will instead be able to build DevOps infrastructure that allows them to deploy updates themselves. Self-service capabilities are already available today for several DevOps processes, including development environments, CI/CD workflows, and audit logging.&lt;/p&gt;
&lt;h2 id=&quot;common-tools-for-ci&quot;&gt;Common Tools for CI&lt;/h2&gt;
&lt;p&gt;Your choice of CI tools will largely depend on your business requirements, the tech stack you already have or plan to implement, and your daily workflow. There are many CI tools and solutions to choose from. Let’s look at four of them.&lt;/p&gt;
&lt;h3 id=&quot;jenkins&quot;&gt;Jenkins&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://www.jenkins.io/&quot;&gt;Jenkins&lt;/a&gt; is the most well-known continuous integration tool and has a reputation for reliability. Written in Java, it’s an open-source cross-platform tool with a large community following that contributes to its development.&lt;/p&gt;
&lt;p&gt;Jenkins works as a standalone CI server or a continuous delivery platform and offers several features to support the entire software development life cycle, including automated builds and testing, code debugging and analysis, and project deployment.&lt;/p&gt;
&lt;p&gt;It can run on any operating system including Windows, OS X, and Unix, and you can easily configure it via a web GUI interface or console commands. Jenkins is highly extensible; thanks to its robust ecosystem of almost 1400 plugins, you can add several features for user interface, platform integration, source code management and builds, and administrative tasks.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Where is it hosted?&lt;/strong&gt; Self-hosted; cloud&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What platform does it run?&lt;/strong&gt; Containers; virtual machines&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What is its pricing model?&lt;/strong&gt; Open source&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/continuous-integration/xoiqawt.png&quot; alt=&quot;Jenkins CI/CD Tool&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Jenkins CI/CD Tool&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;circleci&quot;&gt;CircleCI&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://circleci.com/&quot;&gt;CircleCI&lt;/a&gt; is an excellent platform for build automation and testing along with a branch-focused deployment process. It integrates seamlessly with several version control systems, container systems, and delivery mechanisms, including GitHub and Bitbucket as well as build tools such as Gradle and Apache Maven. You can host CircleCI on premise or integrate it with AWS, Google Cloud, and other cloud services. It’s highly customizable and performance-optimized for quick builds, and it also provides analytics to measure build performance.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Where is it hosted?&lt;/strong&gt; Self-hosted; cloud&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What platform does it run?&lt;/strong&gt; Containers; virtual machine&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What is its pricing model?&lt;/strong&gt; Free entry-level version; Premium starts at $30&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/continuous-integration/HmA7mZy.png&quot; title=&quot;Circle CI CI/CD tool&quot; alt=&quot;Circle CI CI/CD tool&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Circle CI CI/CD tool&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;github-actions&quot;&gt;GitHub Actions&lt;/h3&gt;
&lt;p&gt;Introduced in 2018, &lt;a href=&quot;https://github.com/features/actions&quot;&gt;GitHub Actions&lt;/a&gt; is one of the newer tools in the CI/CD tech stack. It is fully integrated within GitHub, making it manageable from a single place.&lt;/p&gt;
&lt;p&gt;Integration with GitHub means you can build, test, and deploy code directly from your GitHub repository. GitHub manages the execution and provides feedback and security for the entire CI process.&lt;/p&gt;
&lt;p&gt;GitHub Actions offers a wide range of automation tasks and actions that allow you to create, share, reuse, and branch software development workflows directly in your GitHub repository. It also supports Docker for multi-container testing and offers several CI templates.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Where is it hosted?&lt;/strong&gt; Self-hosted; cloud&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What platform does it run?&lt;/strong&gt; Container; virtual machine&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What is its pricing model?&lt;/strong&gt; Free for public repositories and self-hosted runners. For private repositories, build minutes/month depend on account type and spending limits&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/continuous-integration/Gu0ruur.png&quot; title=&quot;GitHub Actions CI/CD tool&quot; alt=&quot;GitHub Actions CI/CD tool&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;GitHub Actions CI/CD tool&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h3 id=&quot;azure-devops&quot;&gt;Azure DevOps&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://azure.microsoft.com/en-us/services/devops/&quot;&gt;Azure DevOps&lt;/a&gt; by Microsoft is a platform for creating a CI/CD pipeline to Azure. It provides several advanced features and services that support the software development cycle from planning to deployment. Azure DevOps integrates with both Team Foundation Version Control and Git for version control, code repository management, and build automation.&lt;/p&gt;
&lt;p&gt;Azure DevOps also integrates with major languages and platforms, allowing you to build, test and deploy in Java, .Net, Android, or iOS. It also runs parallel on Linux, macOS, and Windows and on both virtual machines and containers.&lt;/p&gt;
&lt;p&gt;One standout feature of Azure DevOps is that it supports automated load testing, which can simulate thousands of users using your app at the same time. This helps your developers uncover bottlenecks and improve throughput before an application is released.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Where is it hosted?&lt;/strong&gt; Self-hosted; cloud&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What platform does it run?&lt;/strong&gt; Container; virtual machine&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;What is its pricing model?&lt;/strong&gt; Free up to a specific number of builds, but build servers can be reserved at a cost for higher volumes&lt;/li&gt;
&lt;/ul&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/continuous-integration/iIfItCx.png&quot; title=&quot;Azure DevOps CI/CD Tool&quot; alt=&quot;Azure DevOps CI/CD Tool&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Azure DevOps CI/CD Tool&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;h2 id=&quot;continuous-integration-best-practices&quot;&gt;Continuous Integration Best Practices&lt;/h2&gt;
&lt;p&gt;To get the most out of your CI process, you’ll need to set it up with the following best practices: consistency between environments, disciplined use of the CI/CD pipeline (no sidestepping it for special cases), prioritizing tests by speed, and the “Build Once” practice.&lt;/p&gt;
&lt;h3 id=&quot;strive-for-consistency-between-environments&quot;&gt;Strive for Consistency Between Environments&lt;/h3&gt;
&lt;p&gt;We’ve all had it happen: code that works perfectly in your development environment throws a hissy fit in production.&lt;/p&gt;
&lt;p&gt;Your CI environment should either match production exactly or be customized in a way that mitigates any bugs that might happen due to the difference in the two environments. The wider the difference between your development or staging and production environments, the less accurate your tests will be in showing how the code will perform in the real world.&lt;/p&gt;
&lt;p&gt;A few ways to make sure that your environments are consistent are as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Using &lt;a href=&quot;https://www.redhat.com/en/topics/devops/what-is-blue-green-deployment&quot;&gt;blue-green deployments&lt;/a&gt;. This release strategy involves running two parallel versions of the production environment and involves using a load balancer to swap production traffic between two environments alternately designated as production (green) and staging (blue).&lt;/li&gt;
&lt;li&gt;Deploy a scaled-down version of your production environment to your development or staging environment. If you’re using this method, ensure that the code is consistent and that differences between the two environments are well-documented.&lt;/li&gt;
&lt;li&gt;Use a clone of the production environment to make sure that your CI environment is an exact match.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;all-deployments-must-go-through-ci&quot;&gt;All Deployments Must Go Through CI&lt;/h3&gt;
&lt;p&gt;CI acts as a watchman to enforce best practices in the development process and ensure that changes are in line with your company’s standards and procedures. A failure during integration is flagged immediately and prevents the affected code from moving forward into other parts of the development process. This protects subsequent environments like production from untrusted or error-prone code.&lt;/p&gt;
&lt;p&gt;For CI to be successful, you’ll need to make sure that the CI/CD pipeline is the only mechanism through which code enters your production environment. This could be via continuous delivery with manual approval processes and batched releases or through automated continuous deployment practices.&lt;/p&gt;
&lt;p&gt;Development teams may feel pressured to make exceptions and circumvent the CI process when problems arise. It’s tempting to bypass the system to mitigate excessive downtime and fix other issues as soon as possible, but adhering to the CI/CD pipeline helps ensure that the changes being made won’t worsen the current problem or introduce new ones.&lt;/p&gt;
&lt;p&gt;Sending all changes through the CI/CD pipeline helps to protect the integrity of your deployments and prevents ad hoc fixes from being erased by subsequent updates.&lt;/p&gt;
&lt;h3 id=&quot;run-your-fastest-testschecks-first&quot;&gt;Run Your Fastest Tests/Checks First&lt;/h3&gt;
&lt;p&gt;The general goal of the CI/CD process is to provide rapid feedback to developers and promote rapid software delivery to users. You want to keep the entire pipeline fast, but the reality is that some parts will be faster than others. If developers have to wait too long to get feedback from testing, they might look for ways around the process.&lt;/p&gt;
&lt;p&gt;Because you want to discover failures as early as possible, prioritize and run the tests that complete quickest first and leave longer running tests until later.&lt;/p&gt;
&lt;p&gt;This usually means running your unit tests first, as those are faster, make up most of your tests, and can give you immediate feedback on bugs and errors introduced by the latest update. After unit testing is complete, run integration tests next to see how different parts of your code interact. Then follow up with system-wide tests such as GUI, performance, load and security tests, and manual acceptance tests.&lt;/p&gt;
&lt;h3 id=&quot;build-only-once-and-promote-the-result-through-the-pipeline&quot;&gt;Build Only Once and Promote the Result Through the Pipeline&lt;/h3&gt;
&lt;p&gt;One aim of CI/CD is to ensure that your end product is robust and won’t produce unexpected results. This is why it’s important to perform your build step only once and then advance resulting binaries through the entire pipeline. Software builds that occur separately at each new stage of the pipeline can introduce inconsistencies, and tests completed in earlier environments become invalid because they may not be targeting the same software that is eventually deployed.&lt;/p&gt;
&lt;p&gt;In the “Build Once” best practice, the build process always occurs as the first step in the pipeline, and the resulting artifact is versioned and uploaded to the central repository where it can be pulled and used in the later stages. This ensures that the build does not change as it moves through the pipeline.&lt;/p&gt;
&lt;h2 id=&quot;whats-next&quot;&gt;What’s Next?&lt;/h2&gt;
&lt;p&gt;Continuous integration speeds up the software development process and helps development teams avoid common pitfalls such as broken application builds, and chaotic release cycles. Rather than catching issues just before (or even after) they’re released, continuous integration allows you to mitigate errors &lt;em&gt;while&lt;/em&gt; you’re working on a feature.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; is a free and open-source build automation tool that works with your existing build systems to create repeatable, containerized, language-agnostic builds. It acts as a layer between language-specific tools such as Gradle and Apache Maven and the CI buildspec and allows for faster iteration on build scripts and easier debugging. You can discuss automation and other topics in the &lt;a href=&quot;https://earthly.dev/slack&quot;&gt;Earthly Community on Slack&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To find out more about how Earthly can help you simplify your CI systems, check us out on &lt;a href=&quot;https://github.com/earthly/earthly&quot; title=&quot;Earthly build automation tool documentation and download&quot;&gt;GitHub&lt;/a&gt;. With CI automation in place, developers can push changes more frequently, get faster feedback, and ensure that every change is integrated, tested, and verified.&lt;/p&gt;</content><author><name>Deborah Ruck</name></author><category term="Articles" /><summary type="html">Continuous integration has become prevalent in software development, but it’s still a complex and wide-ranging topic. In this post, we’ll cover the basics of continuous integration, the differences between CI and CD, and common CI tools. You’ll also find some tips for the best way to set up CI in your environment.</summary></entry><entry><title type="html">DOS Gaming In Docker</title><link href="https://earthly.dev/blog/dos-gaming-in-docker/" rel="alternate" type="text/html" title="DOS Gaming In Docker" /><published>2021-05-12T00:00:00-04:00</published><updated>2021-05-12T00:00:00-04:00</updated><id>https://earthly.dev/blog/dos-gaming-in-docker</id><content type="html" xml:base="https://earthly.dev/blog/dos-gaming-in-docker/">&lt;p&gt;Its been three decades since the height of the DOS era, and look how far we’ve come! A machine that used to cost $2,000 can be emulated - &lt;em&gt;down to the processor!&lt;/em&gt; — in our &lt;a href=&quot;https://bellard.org/jslinux/&quot;&gt;&lt;em&gt;web browsers&lt;/em&gt;&lt;/a&gt; while also checking email or watching a YouTube video. However, amidst these advancements, our old software falls by the wayside and stops working. Games are especially prone to this, since they often relied on incompatible tricks to eke out every ounce of performance from these old machines.&lt;/p&gt;
&lt;p&gt;Many projects have sprung up to help preserve this heritage. &lt;a href=&quot;https://www.dosbox.com/&quot;&gt;DOSBox&lt;/a&gt; provides a modern, compatible environment for old games (and other software), while projects like the &lt;a href=&quot;https://archive.org/details/software&quot;&gt;Internet Archive&lt;/a&gt; provide a massive library of DOS games, freely available to play in your browser. In my experience, they play pretty well!&lt;/p&gt;
&lt;p&gt;However, I still miss those less-connected days of the early 90’s. I remember the thrill of riding my bike to the store to pick up a shareware copy of whatever game was available for $1. I then held a physical disk, with the game on it, ready to install on the nearest accessible computer. The self-contained nature of it all was magical. Nowadays, many &lt;em&gt;web pages&lt;/em&gt; &lt;a href=&quot;https://www.pingdom.com/blog/webpages-are-getting-larger-every-year-and-heres-why-it-matters/&quot;&gt;are bigger than the shareware games I used to buy&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This got me thinking: “Floppies can be &lt;a href=&quot;https://www.kryoflux.com/&quot;&gt;imaged&lt;/a&gt;. That sounds kind of like a Docker image. I wonder… could I make DOS shareware Docker images?”&lt;/p&gt;
&lt;p&gt;Turns out you can!&lt;/p&gt;
&lt;h2 id=&quot;what-you-will-need&quot;&gt;What You Will Need&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/caiiiycuk/js-dos&quot;&gt;JS-DOS 6.22&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;A copy of a Shareware game&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://hub.docker.com/_/node&quot;&gt;NodeJS&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.docker.com/get-started&quot;&gt;Docker&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; (Optional, but I think it’s neat!)&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;putting-it-together&quot;&gt;Putting It Together&lt;/h2&gt;
&lt;p&gt;First, we will need to acquire JS-DOS. JS-DOS is a wrapper around an Emscripten-compiled version of &lt;a href=&quot;https://www.dosbox.com&quot;&gt;DOSBox&lt;/a&gt;, so it can run in a browser. You can get the latest versions of the files &lt;a href=&quot;https://js-dos.com/#js-dos-622-archives&quot;&gt;here&lt;/a&gt;. Download and place these files into a project directory. Here’s how I’m doing it, using Docker:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb1&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb1-1&quot;&gt;&lt;a href=&quot;#cb1-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;WORKDIR&lt;/span&gt; site&lt;/span&gt;
&lt;span id=&quot;cb1-2&quot;&gt;&lt;a href=&quot;#cb1-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; wget https://js-dos.com/6.22/current/js-dos.js &amp;amp;&amp;amp; \&lt;/span&gt;
&lt;span id=&quot;cb1-3&quot;&gt;&lt;a href=&quot;#cb1-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    wget https://js-dos.com/6.22/current/wdosbox.js &amp;amp;&amp;amp; \&lt;/span&gt;
&lt;span id=&quot;cb1-4&quot;&gt;&lt;a href=&quot;#cb1-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    wget https://js-dos.com/6.22/current/wdosbox.wasm.js&lt;/span&gt;
&lt;span id=&quot;cb1-5&quot;&gt;&lt;a href=&quot;#cb1-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; npm install -g serve&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;JS-DOS is nice, but it’s nothing without a game to play in it. For our example purposes, we’ll use one of my childhood favorites: &lt;a href=&quot;https://3drealms.com/catalog/secret-agent_39/&quot;&gt;Secret Agent&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&quot;notice--warning&quot;&gt;
&lt;p&gt;&lt;strong&gt;❗ Warning&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;A couple things to note when you are looking for games:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Make sure that the game you choose is &lt;em&gt;actually&lt;/em&gt; shareware. &lt;a href=&quot;https://www.youtube.com/watch?v=up863eQKGUI&quot;&gt;Don’t copy that floppy!&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Make sure that it is the actual game files, not just the installer.
&lt;ul&gt;
&lt;li&gt;While you &lt;em&gt;can&lt;/em&gt; install and &lt;em&gt;then&lt;/em&gt; run the game via DOSBox, you’ll have to install it on every visit to the webpage. The installation is also fairly slow.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Make sure that it is a &lt;code&gt;zip&lt;/code&gt; file. This is what JS-DOS wants to load for us.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;Heres how I add the game to our image:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb2-1&quot;&gt;&lt;a href=&quot;#cb2-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;ARG&lt;/span&gt; GAME_URL&lt;/span&gt;
&lt;span id=&quot;cb2-2&quot;&gt;&lt;a href=&quot;#cb2-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; wget -O game.zip $GAME_URL&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ Note&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;You may note that we don’t preserve the name of the downloaded file here. This is to make our job easier, when we make the game accessible to play later.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;If you built and ran the Dockerfile at this point, you would have an image containing Node, JS-DOS, and a zip file of your beloved game; but no way to play it! To make it playable, we need to create a webpage which loads JS-DOS, loads our game, and provides a canvas for JS-DOS to render its output to. Here is my tiny webpage:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode html&quot;&gt;&lt;code class=&quot;sourceCode html&quot;&gt;&lt;span id=&quot;cb3-1&quot;&gt;&lt;a href=&quot;#cb3-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-2&quot;&gt;&lt;a href=&quot;#cb3-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;&amp;lt;style&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;text/css&amp;quot;&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;media&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;screen&amp;quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-3&quot;&gt;&lt;a href=&quot;#cb3-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      canvas {&lt;/span&gt;
&lt;span id=&quot;cb3-4&quot;&gt;&lt;a href=&quot;#cb3-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;          &lt;span class=&quot;kw&quot;&gt;width&lt;/span&gt;: &lt;span class=&quot;dv&quot;&gt;800&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;px&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb3-5&quot;&gt;&lt;a href=&quot;#cb3-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;          &lt;span class=&quot;kw&quot;&gt;height&lt;/span&gt;: &lt;span class=&quot;dv&quot;&gt;600&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;px&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-6&quot;&gt;&lt;a href=&quot;#cb3-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      }&lt;/span&gt;
&lt;span id=&quot;cb3-7&quot;&gt;&lt;a href=&quot;#cb3-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-8&quot;&gt;&lt;a href=&quot;#cb3-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-9&quot;&gt;&lt;a href=&quot;#cb3-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;&amp;lt;title&amp;gt;&lt;/span&gt;DOS Game!&lt;span class=&quot;kw&quot;&gt;&amp;lt;/title&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-10&quot;&gt;&lt;a href=&quot;#cb3-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;&amp;lt;script&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;src&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;js-dos.js&amp;quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-11&quot;&gt;&lt;a href=&quot;#cb3-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-12&quot;&gt;&lt;a href=&quot;#cb3-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-13&quot;&gt;&lt;a href=&quot;#cb3-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;&amp;lt;canvas&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;jsdos&amp;quot;&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;800&amp;quot;&lt;/span&gt; &lt;span class=&quot;er&quot;&gt;height&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&amp;quot;600&amp;quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;&amp;gt;&amp;lt;/canvas&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-14&quot;&gt;&lt;a href=&quot;#cb3-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;&amp;lt;script&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-15&quot;&gt;&lt;a href=&quot;#cb3-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;fu&quot;&gt;Dos&lt;/span&gt;(&lt;span class=&quot;bu&quot;&gt;document&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;getElementById&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;jsdos&amp;quot;&lt;/span&gt;)&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb3-16&quot;&gt;&lt;a href=&quot;#cb3-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      })&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;ready&lt;/span&gt;((fs&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt; main) &lt;span class=&quot;kw&quot;&gt;=&amp;gt;&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb3-17&quot;&gt;&lt;a href=&quot;#cb3-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        fs&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;extract&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;quot;game.zip&amp;quot;&lt;/span&gt;)&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;then&lt;/span&gt;(() &lt;span class=&quot;kw&quot;&gt;=&amp;gt;&lt;/span&gt; {&lt;/span&gt;
&lt;span id=&quot;cb3-18&quot;&gt;&lt;a href=&quot;#cb3-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;          &lt;span class=&quot;fu&quot;&gt;main&lt;/span&gt;([&lt;span class=&quot;st&quot;&gt;&amp;quot;-c&amp;quot;&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt; GAME_ARGS])&lt;/span&gt;
&lt;span id=&quot;cb3-19&quot;&gt;&lt;a href=&quot;#cb3-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        })&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-20&quot;&gt;&lt;a href=&quot;#cb3-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      })&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-21&quot;&gt;&lt;a href=&quot;#cb3-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-22&quot;&gt;&lt;a href=&quot;#cb3-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;kw&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb3-23&quot;&gt;&lt;a href=&quot;#cb3-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ Note&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;GAME_ARGS&lt;/code&gt; is the command for DOSBox (which is inside JS-DOS) to start once it is loaded. The CLI arguments should line up with what a regular installation of DOSBox would expect. If your game requires additional arguments, please provide them in a comma-separated list.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Copy this html file into the same directory as your JS-DOS files and your game. Now all you need to do is start a server within our Docker container to serve this webpage. For this, I used &lt;a href=&quot;https://www.npmjs.com/package/serve&quot;&gt;&lt;code&gt;serve&lt;/code&gt;&lt;/a&gt;, because it was quick and easy to script (you may have noticed installing this dependency alongside JS-DOS earlier). Heres how I add the server to the container:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb4&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb4-1&quot;&gt;&lt;a href=&quot;#cb4-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;ARG&lt;/span&gt; GAME_ARGS&lt;/span&gt;
&lt;span id=&quot;cb4-2&quot;&gt;&lt;a href=&quot;#cb4-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; index.html .&lt;/span&gt;
&lt;span id=&quot;cb4-3&quot;&gt;&lt;a href=&quot;#cb4-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; sed -i s/GAME_ARGS/$GAME_ARGS/ index.html&lt;/span&gt;
&lt;span id=&quot;cb4-4&quot;&gt;&lt;a href=&quot;#cb4-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb4-5&quot;&gt;&lt;a href=&quot;#cb4-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;kw&quot;&gt;ENTRYPOINT&lt;/span&gt; npx serve -l tcp://0.0.0.0:8000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now we have a shareable Docker container, with playable shareware inside! You can now play the game by:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb5&quot;&gt;&lt;pre class=&quot;sourceCode bash&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb5-1&quot;&gt;&lt;a href=&quot;#cb5-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker build &lt;span class=&quot;dt&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-2&quot;&gt;&lt;a href=&quot;#cb5-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;--build-arg&lt;/span&gt; GAME_URL=https://archive.org/download/msdos_festival_SCORCH15/SCORCH15.ZIP &lt;span class=&quot;dt&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-3&quot;&gt;&lt;a href=&quot;#cb5-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;--build-arg&lt;/span&gt; GAME_ARGS=&lt;span class=&quot;dt&quot;&gt;\&amp;quot;&lt;/span&gt;SCORCH.EXE&lt;span class=&quot;dt&quot;&gt;\&amp;quot;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-4&quot;&gt;&lt;a href=&quot;#cb5-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; 127.0.0.1:8000:8000 &lt;span class=&quot;dt&quot;&gt;\&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-5&quot;&gt;&lt;a href=&quot;#cb5-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;at&quot;&gt;-t&lt;/span&gt; mycool:dosgame .&lt;/span&gt;
&lt;span id=&quot;cb5-6&quot;&gt;&lt;a href=&quot;#cb5-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-7&quot;&gt;&lt;a href=&quot;#cb5-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;...&lt;/span&gt; &lt;/span&gt;
&lt;span id=&quot;cb5-8&quot;&gt;&lt;a href=&quot;#cb5-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb5-9&quot;&gt;&lt;a href=&quot;#cb5-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;$&lt;/span&gt; docker run &lt;span class=&quot;at&quot;&gt;--rm&lt;/span&gt; &lt;span class=&quot;at&quot;&gt;-p&lt;/span&gt; 127.0.0.1:8000:8000 mycool:dosgame&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;going-further&quot;&gt;Going Further&lt;/h2&gt;
&lt;p&gt;Using Earthly, we can even go a step further! Earhly lets us separate some of the concerns within the Dockerfile:&lt;/p&gt;
&lt;div class=&quot;notice--info&quot;&gt;
&lt;p&gt;&lt;strong&gt;ℹ️ About Earthly&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://earthly.dev/&quot;&gt;Earthly&lt;/a&gt; makes creating Docker images easier. &lt;a href=&quot;https://docs.earthly.dev/basics&quot;&gt;Take it for a spin!&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb6&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb6-1&quot;&gt;&lt;a href=&quot;#cb6-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;jsdos:&lt;/span&gt;
&lt;span id=&quot;cb6-2&quot;&gt;&lt;a href=&quot;#cb6-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; node:16-alpine&lt;/span&gt;
&lt;span id=&quot;cb6-3&quot;&gt;&lt;a href=&quot;#cb6-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-4&quot;&gt;&lt;a href=&quot;#cb6-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;WORKDIR&lt;/span&gt; site&lt;/span&gt;
&lt;span id=&quot;cb6-5&quot;&gt;&lt;a href=&quot;#cb6-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; wget https://js-dos.com/6.22/current/js-dos.js &amp;amp;&amp;amp; \&lt;/span&gt;
&lt;span id=&quot;cb6-6&quot;&gt;&lt;a href=&quot;#cb6-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        wget https://js-dos.com/6.22/current/wdosbox.js &amp;amp;&amp;amp; \&lt;/span&gt;
&lt;span id=&quot;cb6-7&quot;&gt;&lt;a href=&quot;#cb6-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        wget https://js-dos.com/6.22/current/wdosbox.wasm.js&lt;/span&gt;
&lt;span id=&quot;cb6-8&quot;&gt;&lt;a href=&quot;#cb6-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; npm install -g serve&lt;/span&gt;
&lt;span id=&quot;cb6-9&quot;&gt;&lt;a href=&quot;#cb6-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-10&quot;&gt;&lt;a href=&quot;#cb6-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;game:&lt;/span&gt;
&lt;span id=&quot;cb6-11&quot;&gt;&lt;a href=&quot;#cb6-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; +jsdos&lt;/span&gt;
&lt;span id=&quot;cb6-12&quot;&gt;&lt;a href=&quot;#cb6-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-13&quot;&gt;&lt;a href=&quot;#cb6-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;ARG&lt;/span&gt; GAME_URL&lt;/span&gt;
&lt;span id=&quot;cb6-14&quot;&gt;&lt;a href=&quot;#cb6-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; wget -O game.zip $GAME_URL&lt;/span&gt;
&lt;span id=&quot;cb6-15&quot;&gt;&lt;a href=&quot;#cb6-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-16&quot;&gt;&lt;a href=&quot;#cb6-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;web:&lt;/span&gt;
&lt;span id=&quot;cb6-17&quot;&gt;&lt;a href=&quot;#cb6-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;FROM&lt;/span&gt; +game&lt;/span&gt;
&lt;span id=&quot;cb6-18&quot;&gt;&lt;a href=&quot;#cb6-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-19&quot;&gt;&lt;a href=&quot;#cb6-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;ARG&lt;/span&gt; GAME_ARGS&lt;/span&gt;
&lt;span id=&quot;cb6-20&quot;&gt;&lt;a href=&quot;#cb6-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;COPY&lt;/span&gt; index.html .&lt;/span&gt;
&lt;span id=&quot;cb6-21&quot;&gt;&lt;a href=&quot;#cb6-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; sed -i s/GAME_ARGS/$GAME_ARGS/ index.html&lt;/span&gt;
&lt;span id=&quot;cb6-22&quot;&gt;&lt;a href=&quot;#cb6-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb6-23&quot;&gt;&lt;a href=&quot;#cb6-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;ENTRYPOINT&lt;/span&gt; npx serve -l tcp://0.0.0.0:8000&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But it also lets us build &lt;em&gt;and launch&lt;/em&gt; the game with a single command. It will also end up saving the game for you as an image on your local system! Here is the additional target that I added to accomplish this:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode dockerfile&quot;&gt;&lt;code class=&quot;sourceCode dockerfile&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;play:&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    LOCALLY&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;kw&quot;&gt;ARG&lt;/span&gt; GAME_TAG&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    WITH DOCKER --load jsdos:$GAME_TAG=+web&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;kw&quot;&gt;RUN&lt;/span&gt; docker inspect jsdos:$GAME_TAG &amp;gt; /dev/null &amp;amp;&amp;amp; \ &lt;span class=&quot;co&quot;&gt;#Using side-effect to save image locally too&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;            docker run --rm -p 127.0.0.1:8000:8000 jsdos:$GAME_TAG&lt;/span&gt;
&lt;span id=&quot;cb7-9&quot;&gt;&lt;a href=&quot;#cb7-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    END&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We also have a couple pre-made targets that wrap this all up for you, and all you need to do is have &lt;a href=&quot;https://earthly.dev/get-earthly&quot;&gt;Earthly installed&lt;/a&gt;! Running any of these commands will start the game. Just navigate on over to &lt;a href=&quot;http://localhost:8000&quot;&gt;localhost:8000&lt;/a&gt; and start playing! Additionally, you will find a Docker image on your system named &lt;code&gt;jsdos:$GAME_TAG&lt;/code&gt; for when you want to play later.&lt;/p&gt;
&lt;img src=&quot;/blog/assets/images/dos-gaming-in-docker/doom.png&quot; title=&quot;fig:&quot; alt=&quot;Screenshot of id’s Doom running in a web browser.&quot; /&gt;
&lt;figcaption&gt;
&lt;code&gt;earthly github.com/dchw/earthly-dos-gaming:main+doom&lt;/code&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;/blog/assets/images/dos-gaming-in-docker/agent.png&quot; title=&quot;fig:&quot; alt=&quot;Screenshot of Apogee’s Secret Agent running in a web browser.&quot; /&gt;
&lt;figcaption&gt;
&lt;code&gt;earthly github.com/dchw/earthly-dos-gaming:main+cosmo&lt;/code&gt;
&lt;/figcaption&gt;
&lt;img src=&quot;/blog/assets/images/dos-gaming-in-docker/cosmo.png&quot; title=&quot;fig:&quot; alt=&quot;Screenshot of Apogee’s Cosmos Cosmic Adventure running in a web browser.&quot; /&gt;
&lt;figcaption&gt;
&lt;code&gt;earthly github.com/dchw/earthly-dos-gaming:main+secretagent&lt;/code&gt;
&lt;/figcaption&gt;
&lt;p&gt;You can run your own dos games by running:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;earthly \
    --build-arg GAME_TAG=doom \
    --build-arg GAME_URL=https://archive.org/download/DoomsharewareEpisode/doom.ZIP \
    --build-arg GAME_ARGS=\&amp;quot;DOOM.EXE\&amp;quot; \
    github.com/dchw/earthly-dos-gaming:main+play&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Make sure you replace the tag, URL, and args as appropriate.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;It’s neat that we can make independent, offline bundles, similar to those shareware floppy disks from back in the day. To see the project as a whole, check out the &lt;a href=&quot;https://github.com/earthly/example-dos-gaming&quot;&gt;repository&lt;/a&gt;. Thanks for reading!&lt;/p&gt;</content><author><name>Corey Larson</name></author><category term="Tutorials" /><summary type="html">Distributing shareware from the 90's in modern Docker images.</summary></entry><entry><title type="html">Building a Monorepo with Bazel</title><link href="https://earthly.dev/blog/monorepo-with-bazel/" rel="alternate" type="text/html" title="Building a Monorepo with Bazel" /><published>2021-05-11T00:00:00-04:00</published><updated>2021-05-11T00:00:00-04:00</updated><id>https://earthly.dev/blog/monorepo-with-bazel</id><content type="html" xml:base="https://earthly.dev/blog/monorepo-with-bazel/">&lt;p&gt;A &lt;em&gt;&lt;a href=&quot;/blog/monorepo-vs-polyrepo&quot;&gt;monorepo&lt;/a&gt;&lt;/em&gt; is perhaps what you would expect from the name: a single code repository for your entire codebase.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Monorepo&quot;&gt;Wikipedia&lt;/a&gt; describes it as a decade-old software development strategy for storing all your code in a single repository, but you can also think of it as a higher-level architecture pattern for governing loosely tied applications. For instance, if you have a full-stack web application stored in one repository and an Android client in another, a monorepo would essentially wrap them in the same repository codebase.&lt;/p&gt;
&lt;h2 id=&quot;who-uses-monorepos-and-why&quot;&gt;Who Uses Monorepos and Why?&lt;/h2&gt;
&lt;p&gt;Google is one of the most notable adopters of the monorepo pattern, and &lt;a href=&quot;https://bazel.build/users.html#whos-using-bazel&quot;&gt;companies&lt;/a&gt; like Dropbox, LinkedIn, and Uber use monorepos to manage their large codebases. This is because large-scale projects having little or no dependency on each other can be developed, tested, and built without bisecting them into smaller projects.&lt;/p&gt;
&lt;p&gt;If you’re from a JavaScript or &lt;a href=&quot;https://www.npmjs.com/&quot;&gt;npm&lt;/a&gt; background, you can think of a monorepo as a project having a single &lt;code&gt;package.json&lt;/code&gt; file for managing all your project dependencies. It also allows you to easily share code between multiple environments using isolated modules as published packages. You can configure a single bundler for performing unit tests, integration tests, and other configurations without worrying about language and ecosystem-specific configurations.&lt;/p&gt;
&lt;h2 id=&quot;the-efficiency-of-building-a-monorepo-with-bazel&quot;&gt;The Efficiency of Building a Monorepo with Bazel&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/bazel-overview.html&quot;&gt;Bazel&lt;/a&gt; is an open-source build tool developed by Google to give power and life to your monorepo. It’s similar to other build tools like &lt;a href=&quot;https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html&quot;&gt;Maven&lt;/a&gt;, &lt;a href=&quot;https://gradle.org/&quot;&gt;Gradle&lt;/a&gt;, and &lt;a href=&quot;https://buck.build/&quot;&gt;Buck&lt;/a&gt;, but it has a number of advantages:&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;Bazel supports multiple languages (Java, JavaScript, Go, C++, to name a few) and platforms (Linux, macOS, and Windows).&lt;/li&gt;
&lt;li&gt;It’s built with &lt;a href=&quot;https://docs.rs/starlark/0.3.1/starlark/&quot;&gt;Starlark&lt;/a&gt;, a high-level language similar to Python that allows it to perform complex operations on binaries, scripts, and data sets.&lt;/li&gt;
&lt;li&gt;Even for large source files, Bazel is blazingly fast at building, as it caches previous work and rebuilds only the code that needs to be.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This article will walk you through the core concepts of Bazel and set you up for building and compiling your own monorepo in JavaScript.&lt;/p&gt;
&lt;h2 id=&quot;bazel-basics&quot;&gt;Bazel Basics&lt;/h2&gt;
&lt;p&gt;First, some vocabulary.&lt;/p&gt;
&lt;h3 id=&quot;workspace&quot;&gt;Workspace&lt;/h3&gt;
&lt;p&gt;Bazel calls your top-level source file a &lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/build-ref.html#workspace&quot;&gt;workspace&lt;/a&gt;, which contains other source files in a nested fashion. Your workspace is what builds your entire software by taking a set of inputs and generating the desired output.&lt;/p&gt;
&lt;h3 id=&quot;packages&quot;&gt;Packages&lt;/h3&gt;
&lt;p&gt;A &lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/build-ref.html#packages&quot;&gt;package&lt;/a&gt; contains all your related files and dependencies and a file named &lt;code&gt;BUILD&lt;/code&gt;. Subdirectories falling under a package are called subpackages.&lt;/p&gt;
&lt;p&gt;Consider the following directory tree:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;src/app/BUILD
src/app/core/input.txt
src/app/tests/BUILD&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It has two packages: &lt;code&gt;app&lt;/code&gt;, and a subpackage, &lt;code&gt;app/tests&lt;/code&gt;, since both contain their own BUILD files. Note that &lt;code&gt;app/core&lt;/code&gt; is not a package but a regular directory inside &lt;code&gt;app&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;targets&quot;&gt;Targets&lt;/h3&gt;
&lt;p&gt;Elements of a package are called &lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/build-ref.html#targets&quot;&gt;targets&lt;/a&gt;, which can be categorized as &lt;em&gt;files&lt;/em&gt; and &lt;em&gt;rules&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Files can either be source files containing the code of a developer or &lt;em&gt;generated files&lt;/em&gt; generated by Bazel according to a specific set of rules. A rule specifies the relationship between a set of inputs and outputs along with the necessary steps to derive the latter from the former.&lt;/p&gt;
&lt;h3 id=&quot;labels&quot;&gt;Labels&lt;/h3&gt;
&lt;p&gt;The name of a target is its &lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/build-ref.html#labels&quot;&gt;label&lt;/a&gt;, which uniquely identifies it and always starts with &lt;code&gt;//&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;@repo//app/main:app_binary&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Each label has two parts: a package name (&lt;code&gt;app/main&lt;/code&gt;) and a target name (&lt;code&gt;app_binary&lt;/code&gt;).&lt;/p&gt;
&lt;h3 id=&quot;dependencies&quot;&gt;Dependencies&lt;/h3&gt;
&lt;p&gt;Target X is considered a dependency for target Y, if Y needs X at build or execution time. The dependency relation produces a &lt;a href=&quot;https://en.wikipedia.org/wiki/Directed_acyclic_graph&quot;&gt;Directed Acyclic Graph&lt;/a&gt; (DAG) called a &lt;em&gt;dependency graph&lt;/em&gt;, which is used to classify these dependencies further. You can read more about &lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/build-ref.html#dependencies&quot;&gt;these types and their definitions here&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;build-files&quot;&gt;Build Files&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.bazel.build/versions/4.0.0/build-ref.html#BUILD_files&quot;&gt;Build files&lt;/a&gt; contain the top-level program that describes the set of declared rules. These files are periodically updated with respect to changes in the dependencies being used.&lt;/p&gt;
&lt;h3 id=&quot;bazel-basic-commands&quot;&gt;Bazel Basic Commands&lt;/h3&gt;
&lt;p&gt;You can check if you have Bazel installed on your system by running the &lt;code&gt;version&lt;/code&gt; command.&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;$ bazel --version
bazel 4.0.0&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The primary &lt;code&gt;build&lt;/code&gt; command builds your project’s targets, and &lt;code&gt;analyze-profile&lt;/code&gt; can analyze your builds. You can also remove output files and close the server using the &lt;code&gt;clean&lt;/code&gt; command. You can get a list of all these basic commands along with their use cases by running:&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;$ bazel help 
Usage: bazel &amp;lt;command&amp;gt; &amp;lt;options&amp;gt; ...

Available commands:
  analyze-profile     Analyzes build profile data.
...&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;how-to-build-a-monorepo-with-bazel&quot;&gt;How to Build a Monorepo with Bazel&lt;/h2&gt;
&lt;p&gt;Once you have the &lt;a href=&quot;https://nodejs.org/en/&quot;&gt;Node.js&lt;/a&gt; installed on your system, you can run the following command to install Bazel globally:&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;npm install -g @bazel/bazelisk &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can also install &lt;a href=&quot;https://docs.bazel.build/versions/master/build-javascript.html#installing-ibazel&quot;&gt;iBazel&lt;/a&gt; to enable hot reloading. This lets you see your changes live in real time.&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;npm install --save-dev @bazel/ibazel
npm install --global @bazel/ibazel&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;configuring-the-bazel.rc-file&quot;&gt;Configuring the &lt;code&gt;bazel.rc&lt;/code&gt; File&lt;/h3&gt;
&lt;p&gt;You can write build options in a &lt;a href=&quot;https://docs.bazel.build/versions/master/guide.html#bazelrc&quot;&gt;&lt;code&gt;bazel.rc&lt;/code&gt; file&lt;/a&gt; to apply them on every build. You can use the same settings for your project by creating a &lt;code&gt;tools/bazel.rc&lt;/code&gt; file at the root of your Bazel workspace.&lt;/p&gt;
&lt;p&gt;If you don’t want to share these settings, you can move out the &lt;code&gt;.bazel.rc&lt;/code&gt; file to the root directory and add it to your &lt;code&gt;.gitignore&lt;/code&gt; list instead. You can also personalize these settings locally by moving it in your home directory.&lt;/p&gt;
&lt;p&gt;The following is a generic &lt;code&gt;bazel.rc&lt;/code&gt; file that you can modify according to your needs:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb7&quot;&gt;&lt;pre class=&quot;sourceCode .rc&quot;&gt;&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span id=&quot;cb7-1&quot;&gt;&lt;a href=&quot;#cb7-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;###############################&lt;/span&gt;
&lt;span id=&quot;cb7-2&quot;&gt;&lt;a href=&quot;#cb7-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Directory structure         #&lt;/span&gt;
&lt;span id=&quot;cb7-3&quot;&gt;&lt;a href=&quot;#cb7-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;###############################&lt;/span&gt;
&lt;span id=&quot;cb7-4&quot;&gt;&lt;a href=&quot;#cb7-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-5&quot;&gt;&lt;a href=&quot;#cb7-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Artifacts are typically placed in a directory called &amp;quot;dist&amp;quot;&lt;/span&gt;
&lt;span id=&quot;cb7-6&quot;&gt;&lt;a href=&quot;#cb7-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Be aware that this setup will still create a bazel-out symlink in&lt;/span&gt;
&lt;span id=&quot;cb7-7&quot;&gt;&lt;a href=&quot;#cb7-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# your project directory, which you must exclude from version control and your&lt;/span&gt;
&lt;span id=&quot;cb7-8&quot;&gt;&lt;a href=&quot;#cb7-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# editor&amp;#39;s search path.&lt;/span&gt;
&lt;span id=&quot;cb7-9&quot;&gt;&lt;a href=&quot;#cb7-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;build --symlink_prefix=dist/&lt;/span&gt;
&lt;span id=&quot;cb7-10&quot;&gt;&lt;a href=&quot;#cb7-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-11&quot;&gt;&lt;a href=&quot;#cb7-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;###############################&lt;/span&gt;
&lt;span id=&quot;cb7-12&quot;&gt;&lt;a href=&quot;#cb7-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Output                      #&lt;/span&gt;
&lt;span id=&quot;cb7-13&quot;&gt;&lt;a href=&quot;#cb7-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;###############################&lt;/span&gt;
&lt;span id=&quot;cb7-14&quot;&gt;&lt;a href=&quot;#cb7-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-15&quot;&gt;&lt;a href=&quot;#cb7-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# A more useful default output mode for bazel query, which&lt;/span&gt;
&lt;span id=&quot;cb7-16&quot;&gt;&lt;a href=&quot;#cb7-16&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# prints &amp;quot;ng_module rule //foo:bar&amp;quot; instead of just &amp;quot;//foo:bar&amp;quot;.&lt;/span&gt;
&lt;span id=&quot;cb7-17&quot;&gt;&lt;a href=&quot;#cb7-17&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;query --output=label_kind&lt;/span&gt;
&lt;span id=&quot;cb7-18&quot;&gt;&lt;a href=&quot;#cb7-18&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-19&quot;&gt;&lt;a href=&quot;#cb7-19&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# By default, failing tests don&amp;#39;t print any output, it&amp;#39;s logged to a&lt;/span&gt;
&lt;span id=&quot;cb7-20&quot;&gt;&lt;a href=&quot;#cb7-20&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# file instead.&lt;/span&gt;
&lt;span id=&quot;cb7-21&quot;&gt;&lt;a href=&quot;#cb7-21&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;test --test_output=errors&lt;/span&gt;
&lt;span id=&quot;cb7-22&quot;&gt;&lt;a href=&quot;#cb7-22&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-23&quot;&gt;&lt;a href=&quot;#cb7-23&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;###############################&lt;/span&gt;
&lt;span id=&quot;cb7-24&quot;&gt;&lt;a href=&quot;#cb7-24&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Typescript / Angular / Sass #&lt;/span&gt;
&lt;span id=&quot;cb7-25&quot;&gt;&lt;a href=&quot;#cb7-25&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;###############################&lt;/span&gt;
&lt;span id=&quot;cb7-26&quot;&gt;&lt;a href=&quot;#cb7-26&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Make TypeScript and Angular compilation fast by keeping a few&lt;/span&gt;
&lt;span id=&quot;cb7-27&quot;&gt;&lt;a href=&quot;#cb7-27&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# copies of the compiler running as daemons, and cache SourceFile&lt;/span&gt;
&lt;span id=&quot;cb7-28&quot;&gt;&lt;a href=&quot;#cb7-28&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# ASTs to reduce parse time.&lt;/span&gt;
&lt;span id=&quot;cb7-29&quot;&gt;&lt;a href=&quot;#cb7-29&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;build --strategy=TypeScriptCompile=worker --strategy=AngularTemplateCompile=worker&lt;/span&gt;
&lt;span id=&quot;cb7-30&quot;&gt;&lt;a href=&quot;#cb7-30&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;/span&gt;
&lt;span id=&quot;cb7-31&quot;&gt;&lt;a href=&quot;#cb7-31&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;# Enable debugging tests with --config=debug&lt;/span&gt;
&lt;span id=&quot;cb7-32&quot;&gt;&lt;a href=&quot;#cb7-32&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;test:debug --test_arg=--node_options=--inspect-brk --test_output=streamed --test_strategy=exclusive --test_timeout=9999 --nocache_test_results&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;adding-the-buildifier-dependency-to-your-project&quot;&gt;Adding the &lt;code&gt;buildifier&lt;/code&gt; Dependency to Your Project&lt;/h3&gt;
&lt;p&gt;Buildifier is a formatting tool that ensures all &lt;code&gt;BUILD&lt;/code&gt; files are formatted in a similar fashion. It creates a standardized formatting for all your &lt;code&gt;BUILD&lt;/code&gt; and &lt;code&gt;.bzl&lt;/code&gt; files. It also has a linter out of the box to help you detect issues in your code and automatically fix them. You can add the &lt;code&gt;buildifier&lt;/code&gt; dependency to your project either using npm:&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;npm install --save-dev @bazel/buildifier&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;or Yarn:&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;yarn add -D @bazel/buildifier&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You will need the following scripts inside your &lt;code&gt;package.json&lt;/code&gt; file to run the &lt;code&gt;buildifier&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb10&quot;&gt;&lt;pre class=&quot;sourceCode json&quot;&gt;&lt;code class=&quot;sourceCode json&quot;&gt;&lt;span id=&quot;cb10-1&quot;&gt;&lt;a href=&quot;#cb10-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;er&quot;&gt;&amp;quot;scripts&amp;quot;:&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb10-2&quot;&gt;&lt;a href=&quot;#cb10-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;bazel:format&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;find . -type f &lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;( -name &lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\&amp;quot;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;*.bzl&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\&amp;quot;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; -or -name WORKSPACE -or -name BUILD -or -name BUILD.bazel &lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\\&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;) ! -path &lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\&amp;quot;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;*/node_modules/*&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;\&amp;quot;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; | xargs buildifier -v --warnings=attr-cfg,attr-license,attr-non-empty,attr-output-default,attr-single-file,constant-glob,ctx-actions,ctx-args,depset-iteration,depset-union,dict-concatenation,duplicated-name,filetype,git-repository,http-archive,integer-division,load,load-on-top,native-build,native-package,out-of-order-load,output-group,package-name,package-on-top,positional-args,redefined-variable,repository-name,same-origin-load,string-iteration,unsorted-dict-items,unused-variable&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb10-3&quot;&gt;&lt;a href=&quot;#cb10-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;bazel:lint&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;yarn bazel:format --lint=warn&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb10-4&quot;&gt;&lt;a href=&quot;#cb10-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;bazel:lint-fix&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;yarn bazel:format --lint=fix&amp;quot;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb10-5&quot;&gt;&lt;a href=&quot;#cb10-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;buildingcompiling-code&quot;&gt;Building/Compiling Code&lt;/h3&gt;
&lt;p&gt;In this example, you’ll start from a new empty directory and build and compile a simple Node.js application using Bazel. You’ll end up with the following structure:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;  WORKSPACE     
  BUILD.bazel    
  es5.babelrc  
  app.js    
  package-lock.json  
  package.json    
  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Instead of manually configuring everything, you can use the following commands to get started:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb12&quot;&gt;&lt;pre class=&quot;sourceCode sh&quot;&gt;&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span id=&quot;cb12-1&quot;&gt;&lt;a href=&quot;#cb12-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;ex&quot;&gt;npm&lt;/span&gt; init @bazel bazel_build_nodejs  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or if you’re using Yarn:&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;yarn create @bazel bazel_build_nodejs  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The previous commands use &lt;a href=&quot;https://www.npmjs.com/package/@bazel/create&quot;&gt;&lt;code&gt;@bazel/create&lt;/code&gt;&lt;/a&gt; under the hood to set up your monorepo with some minimal configurations. This means that it automatically creates &lt;code&gt;package.json&lt;/code&gt;, &lt;code&gt;WORKSPACE&lt;/code&gt;, and &lt;code&gt;BUILD.bazel&lt;/code&gt; files for you.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;package.json&lt;/code&gt; is exactly how it’s created when you’re initializing any Node.js project using the &lt;code&gt;npm init&lt;/code&gt; command. It contains some development time dependencies and some scripts through which you can run your build.&lt;/p&gt;
&lt;p&gt;Also notice how it automatically adds &lt;code&gt;buildifier&lt;/code&gt; to your project so you can avoid manually setting it up. This is only a starting point though, and you would need to manually set up a &lt;code&gt;buildifier&lt;/code&gt; depending on the requirements of your project.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb14&quot;&gt;&lt;pre class=&quot;sourceCode json&quot;&gt;&lt;code class=&quot;sourceCode json&quot;&gt;&lt;span id=&quot;cb14-1&quot;&gt;&lt;a href=&quot;#cb14-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-2&quot;&gt;&lt;a href=&quot;#cb14-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;bazel_build_nodejs&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-3&quot;&gt;&lt;a href=&quot;#cb14-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;version&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;0.1.0&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-4&quot;&gt;&lt;a href=&quot;#cb14-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;private&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-5&quot;&gt;&lt;a href=&quot;#cb14-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;devDependencies&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-6&quot;&gt;&lt;a href=&quot;#cb14-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;@bazel/bazelisk&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-7&quot;&gt;&lt;a href=&quot;#cb14-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;@bazel/ibazel&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-8&quot;&gt;&lt;a href=&quot;#cb14-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;@bazel/buildifier&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;latest&amp;quot;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-9&quot;&gt;&lt;a href=&quot;#cb14-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;},&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-10&quot;&gt;&lt;a href=&quot;#cb14-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;&amp;quot;scripts&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;{&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-11&quot;&gt;&lt;a href=&quot;#cb14-11&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;build&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;bazel build //...&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-12&quot;&gt;&lt;a href=&quot;#cb14-12&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;        &lt;span class=&quot;dt&quot;&gt;&amp;quot;test&amp;quot;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&amp;quot;bazel test //...&amp;quot;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-13&quot;&gt;&lt;a href=&quot;#cb14-13&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-14&quot;&gt;&lt;a href=&quot;#cb14-14&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;fu&quot;&gt;}&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb14-15&quot;&gt;&lt;a href=&quot;#cb14-15&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Let’s install these packages and a few more like &lt;a href=&quot;https://babeljs.io/&quot;&gt;Babel&lt;/a&gt; to &lt;a href=&quot;https://scotch.io/tutorials/javascript-transpilers-what-they-are-why-we-need-them&quot;&gt;transpile&lt;/a&gt; your JavaScript code.&lt;/p&gt;
&lt;pre class=&quot;shell&quot;&gt;&lt;code&gt;npm install @babel/core @babel/cli @babel/preset-env  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A &lt;code&gt;package-lock.json&lt;/code&gt; file will also be automatically created for you. Your &lt;code&gt;WORKSPACE.bazel&lt;/code&gt; file should look like this:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;&lt;code&gt;# Bazel workspace created by @bazel/create 3.4.1  
  
# Declares that this directory is the root of a Bazel workspace.  
# See https://docs.bazel.build/versions/master/build-ref.html#workspace  
workspace(  
    # How this workspace would be referenced with absolute labels from another workspace  
    name = &amp;quot;bazel_build_nodejs&amp;quot;,  
    # Map the @npm bazel workspace to the node_modules directory.  
    # This lets Bazel use the same node_modules as other local tooling.  
    managed_directories = {&amp;quot;@npm&amp;quot;: [&amp;quot;node_modules&amp;quot;]},  
)  
  
# Install the nodejs &amp;quot;bootstrap&amp;quot; package  
# This provides the basic tools for running and packaging Node.js programs in Bazel  
load(&amp;quot;@bazel_tools//tools/build_defs/repo:http.bzl&amp;quot;, &amp;quot;http_archive&amp;quot;)  
http_archive(  
    name = &amp;quot;build_bazel_rules_nodejs&amp;quot;,  
    sha256 = &amp;quot;a160d9ac88f2aebda2aa995de3fa3171300c076f06ad1d7c2e1385728b8442fa&amp;quot;,  
    urls = [&amp;quot;https://github.com/bazelbuild/rules_nodejs/releases/download/3.4.1/rules_nodejs-3.4.1.tar.gz&amp;quot;],  
)  
  
# The npm_install rule runs Yarn anytime the package.json or package-lock.json file changes.  
# It also extracts any Bazel rules distributed in an npm package.  
load(&amp;quot;@build_bazel_rules_nodejs//:index.bzl&amp;quot;, &amp;quot;npm_install&amp;quot;)  
npm_install(  
    # Name this npm so that Bazel Label references look like @npm//package  
    name = &amp;quot;npm&amp;quot;,  
    package_json = &amp;quot;//:package.json&amp;quot;,  
    package_lock_json = &amp;quot;//:package-lock.json&amp;quot;,  
)  
  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It basically tells Bazel where to pull the tools for running your project and fetches all the required rules to create a build. You also need to tell Bazel to use auto-generated rules. Add the following line to the top of your &lt;code&gt;BUILD.bazel&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;load(&amp;quot;@npm//@babel/cli:index.bzl&amp;quot;, &amp;quot;babel&amp;quot;)  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let’s add a simple console statement inside &lt;code&gt;app.js&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb18&quot;&gt;&lt;pre class=&quot;sourceCode javascript&quot;&gt;&lt;code class=&quot;sourceCode javascript&quot;&gt;&lt;span id=&quot;cb18-1&quot;&gt;&lt;a href=&quot;#cb18-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;&lt;span class=&quot;bu&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;NodeJS Built using Bazel!&amp;#39;&lt;/span&gt;)&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next add the following code inside &lt;code&gt;es5.babelrc&lt;/code&gt; to configure Babel for transpiling JavaScript code:&lt;/p&gt;
&lt;pre class=&quot;babelrc&quot;&gt;&lt;code&gt;{  
    &amp;quot;sourceMaps&amp;quot;: &amp;quot;inline&amp;quot;,  
    &amp;quot;presets&amp;quot;: [  
      [  
        &amp;quot;@babel/preset-env&amp;quot;,  
        {  
          &amp;quot;modules&amp;quot;: &amp;quot;systemjs&amp;quot;  
        }  
      ]  
    ]  
  }  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally, you need to tell Bazel how to take JavaScript inputs and convert them to transpiled or &lt;a href=&quot;https://johnpapa.net/es5-es2015-typescript/&quot;&gt;ES5&lt;/a&gt; output. Add the following code inside &lt;code&gt;BUILD.bazel&lt;/code&gt; file after the previous load statement:&lt;/p&gt;
&lt;pre class=&quot;bazel&quot;&gt;&lt;code&gt;babel(  
    name = &amp;quot;compile&amp;quot;,  
    data = [  
        &amp;quot;app.js&amp;quot;,  
        &amp;quot;es5.babelrc&amp;quot;,  
        &amp;quot;@npm//@babel/preset-env&amp;quot;,  
    ],  
    outs = [&amp;quot;app.es5.js&amp;quot;],  
    args = [  
        &amp;quot;app.js&amp;quot;,  
        &amp;quot;--config-file&amp;quot;,  
        &amp;quot;./$(execpath es5.babelrc)&amp;quot;,  
        &amp;quot;--out-file&amp;quot;,  
        &amp;quot;$(execpath app.es5.js)&amp;quot;,  
    ],  
)  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Run the following command to build and compile your JavaScript code:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;npm run build  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In case you run into an error, try renaming your &lt;code&gt;WORKSPACE.bazel&lt;/code&gt; file to simply &lt;code&gt;WORKSPACE&lt;/code&gt;. If all goes well, you should see something similar to the following screenshot on your terminal:&lt;/p&gt;
&lt;figure&gt;
&lt;img src=&quot;/blog/assets/images/monorepo-with-bazel/RhmR1Xx.png&quot; alt=&quot;Terminal log of the build command&quot; /&gt;&lt;figcaption aria-hidden=&quot;true&quot;&gt;Terminal log of the build command&lt;/figcaption&gt;
&lt;/figure&gt;
&lt;p&gt;You will see &lt;code&gt;bazel-out&lt;/code&gt; and a &lt;code&gt;dist&lt;/code&gt; directory where your output files will be present.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/blog/assets/images/monorepo-with-bazel/Ffu5zoQ.png&quot; height=&quot;400&quot; alt=&quot;Output directories&quot; /&gt;&lt;br /&gt;
&lt;/p&gt;
&lt;p&gt;If you check inside &lt;code&gt;dist/bin/app.es5.js&lt;/code&gt;, you should see your transpiled ES5 JavaScript code as shown:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb22&quot;&gt;&lt;pre class=&quot;sourceCode javascript&quot;&gt;&lt;code class=&quot;sourceCode javascript&quot;&gt;&lt;span id=&quot;cb22-1&quot;&gt;&lt;a href=&quot;#cb22-1&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;System&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;register&lt;/span&gt;([]&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;function&lt;/span&gt; (_export&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt; _context) {  &lt;/span&gt;
&lt;span id=&quot;cb22-2&quot;&gt;&lt;a href=&quot;#cb22-2&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;st&quot;&gt;&amp;quot;use strict&amp;quot;&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb22-3&quot;&gt;&lt;a href=&quot;#cb22-3&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;/span&gt;
&lt;span id=&quot;cb22-4&quot;&gt;&lt;a href=&quot;#cb22-4&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; {  &lt;/span&gt;
&lt;span id=&quot;cb22-5&quot;&gt;&lt;a href=&quot;#cb22-5&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;setters&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;:&lt;/span&gt; []&lt;span class=&quot;op&quot;&gt;,&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb22-6&quot;&gt;&lt;a href=&quot;#cb22-6&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    &lt;span class=&quot;dt&quot;&gt;execute&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;function&lt;/span&gt; () {  &lt;/span&gt;
&lt;span id=&quot;cb22-7&quot;&gt;&lt;a href=&quot;#cb22-7&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;      &lt;span class=&quot;bu&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;op&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;log&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&amp;#39;NodeJS Built using Bazel!&amp;#39;&lt;/span&gt;)&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb22-8&quot;&gt;&lt;a href=&quot;#cb22-8&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;    }  &lt;/span&gt;
&lt;span id=&quot;cb22-9&quot;&gt;&lt;a href=&quot;#cb22-9&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;  }&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;  &lt;/span&gt;
&lt;span id=&quot;cb22-10&quot;&gt;&lt;a href=&quot;#cb22-10&quot; aria-hidden=&quot;true&quot; tabindex=&quot;-1&quot;&gt;&lt;/a&gt;})&lt;span class=&quot;op&quot;&gt;;&lt;/span&gt;  &lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;setting-up-continuous-integration&quot;&gt;Setting Up Continuous Integration&lt;/h3&gt;
&lt;p&gt;Bazel recommends using container environments like the &lt;a href=&quot;https://hub.docker.com/r/angular/ngcontainer/&quot;&gt;ngcontainer Docker image&lt;/a&gt; for continuous integration (CI). You can easily add specific CI settings using the &lt;code&gt;build:ci&lt;/code&gt; or &lt;code&gt;test:ci&lt;/code&gt; prefixes to your &lt;code&gt;bazel.rc&lt;/code&gt; file.&lt;/p&gt;
&lt;p&gt;If you’re using &lt;a href=&quot;/blog/continuous-integration#circleci&quot;&gt;CircleCI&lt;/a&gt;, you can use &lt;a href=&quot;https://github.com/angular/angular-bazel-example/blob/master/.circleci/config.yml&quot;&gt;this example&lt;/a&gt; as a reference. If you’re using GitLab, you can set up CI in minutes using the following scripts:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;variables:  
  BAZEL_DIGEST_VERSION: &amp;quot;f670e9aec235aa23a5f068566352c5850a67eb93de8d7a2350240c68fcec3b25&amp;quot; # Bazel 3.4.1  
  
build:  
  image:  
    name: gcr.io/cloud-marketplace-containers/google/bazel@sha256:$BAZEL_DIGEST_VERSION  
    entrypoint: [&amp;quot;&amp;quot;]  
  stage: build  
  script:  
    - bazel --output_base output build //main/...  
  artifacts:  
    paths:  
      - bazel-bin/main/hello-world  
  cache:  
    key: $BAZEL_DIGEST_VERSION  
    paths:  
      - output  &lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The above scripts define the build outputs and cache directory and also ensures immutability. Luckily the GitLab team has a &lt;a href=&quot;https://about.gitlab.com/blog/2020/09/01/using-bazel-to-speed-up-gitlab-ci-builds/&quot;&gt;dedicated article&lt;/a&gt; on this for the best reference.&lt;/p&gt;
&lt;h2 id=&quot;downsides-of-bazel-and-the-monorepo-pattern&quot;&gt;Downsides of Bazel and the Monorepo Pattern&lt;/h2&gt;
&lt;p&gt;The monorepo pattern is trendy these days, but there are some trade-offs you should be aware of. For a large and diverse team working on a monorepo, it might not be a great idea to expose every ounce of that codebase to novice developers.&lt;/p&gt;
&lt;p&gt;Besides someone messing things up accidentally, keeping open access to all your config files, API keys, and so on might pose an issue from a security standpoint. On similar lines, you can understand why open-source projects aren’t living inside monorepos yet.&lt;/p&gt;
&lt;p&gt;While Bazel definitely does some magic to ease out this pain for developers, it doesn’t have a large open-source community backing it yet. Having all your source code in one place could slow down the general process of approving pull requests and running the build scripts every now and then.&lt;/p&gt;
&lt;p&gt;Bazel also promotes a strict demarcation between your dependencies and source code, while modern languages and frameworks have dedicated directories for bookkeeping dependencies. For instance, an npm project will always have its dependencies in a &lt;code&gt;node_modules&lt;/code&gt; directory inside the root directory. Diverging away from that pattern can present a steep learning curve, or at minimum an uncomfortable change.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Due to better structured configurational files and multiple language support, Bazel is a viable option for your large multi-language project deployed on multiple platforms. It’s fast, and you can even optimize your slow builds &lt;a href=&quot;https://docs.bazel.build/versions/master/remote-caching.html&quot;&gt;using your own build cache&lt;/a&gt;. Google has tried and tested Bazel’s core features to validate its stability, and their extensive documentation is some compensation for the small community.&lt;/p&gt;
&lt;p&gt;If you’d like to explore further, you can build your own React or Angular app using Bazel to see how it treats different environments of the same language. You can also try out their &lt;a href=&quot;https://docs.bazel.build/versions/0.17.2/build-javascript.html#tutorials&quot;&gt;tutorials for different languages&lt;/a&gt; to get a bigger picture of how Bazel works. And if today’s the day you’re welcoming Bazel into your project, definitely take a moment to familiarize yourself with its documented &lt;a href=&quot;https://docs.bazel.build/versions/master/best-practices.html&quot;&gt;best practices&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If the benefits of Bazel look promising but the downsides prevent you from adopting it, then take a look at &lt;a href=&quot;https://earthly.dev/&quot;&gt;Earthly&lt;/a&gt;. It supports monorepo and poly repos and has a gentler learning curve.&lt;/p&gt;</content><author><name>Siddhant Varma</name></author><category term="Tutorials" /><summary type="html">A monorepo is perhaps what you would expect from the name: a single code repository for your entire codebase.</summary></entry></feed>
<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<link rel="icon" type="image/png" href="/blog/assets/images/favicon.png">
<!-- begin _includes/seo.html -->





<title>Creating and hosting your own deb packages and apt repo - Earthly Blog</title>
<meta name="description" content="As an Ubuntu user, I find myself typing apt install … frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests.    Prerequisites   This tutorial assumes you are using Ubuntu, and that the following packages are installed:   sudo apt-get install -y gcc dpkg-dev gpg   Step 0: Creating a Simple Hello World Program   Before getting started with packaging, let’s create a basic hello world program under ~/example/hello-world-program. To do this, you can copy and paste the following commands into your terminal:   mkdir -p ~/example/hello-world-program  echo &#39;#include &lt;stdio.h&gt; int main() {     printf(&quot;hello packaged world\n&quot;);     return 0; }&#39; &gt; ~/example/hello-world-program/hello.c   Then, you can compile it with:   cd ~/example/hello-world-program gcc -o hello-world hello.c   There’s no technical reason for picking C for this example – the language doesn’t matter. It’s the binary we will be distributing in our deb package.   Step 1: Creating a deb Package   Debian, and Debian-based Linux distributions use .deb packages to package and distribute programs. To start we will create a directory in the form:  &lt;package-name&gt;_&lt;version&gt;-&lt;release-number&gt;_&lt;architecture&gt;  where the    package-name is the name of our package, hello-world in our case,   version is the version of the software, 0.0.1 in our case,   release-number is used to track different releases of the same software version; it’s usually set to 1, but hypothetically if there was an error in the packaging (e.g. a file was missed, or the description had an error in it, or a post-install script was wrong), this number would be increased to track the change, and   architecture is the target architecture of the platform, amd64 in this example; however if your package is architecture-independent (e.g. a python script), then you can set this to all.     Theoretically, the directory doesn’t have to follow this naming convention; however some of the tools we will use later in the tutorial require this directory naming convention.    So for this example, we’ll create the directory with:   mkdir -p ~/example/hello-world_0.0.1-1_amd64   This directory will be the root of the package. Since we want our hello-world binary to be installed system wide, we’ll have to store it under usr/bin/hello-world with the following commands:   cd ~/example/hello-world_0.0.1-1_amd64 mkdir -p usr/bin cp ~/example/hello-world-program/hello-world usr/bin/.   Each package requires a control file which needs to be located under the DEBIAN directory. You can copy and paste the following to create one:   mkdir -p ~/example/hello-world_0.0.1-1_amd64/DEBIAN  echo &quot;Package: hello-world Version: 0.0.1 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Architecture: amd64 Homepage: http://example.com Description: A program that prints hello&quot; \ &gt; ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control   Note that we’re assuming an amd64 Architecture for this tutorial, if your binary is for a different architecture, adjust accordingly. If you’re distributing a platform-independent package, you can set the architecture to all.   By this point you should have created two files:  ~/example/hello-world_0.0.1-1_amd64/usr/bin/hello-world ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control  To build the .deb package, run:   dpkg --build ~/example/hello-world_0.0.1-1_amd64   This will output a deb package under ~/example/hello-world_0.0.1.deb.   You can inspect the info of the deb by running:   dpkg-deb --info ~/example/hello-world_0.0.1.deb   which will show:   new Debian package, version 2.0. size 2832 bytes: control archive=336 bytes.     182 bytes,     7 lines      control Package: hello-world Version: 0.0.1 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Architecture: amd64 Homepage: http://example.com Description: A program that prints hello   You can also view the contents by running:   dpkg-deb --contents ~/example/hello-world_0.0.1.deb   which will show:  drwxrwxr-x alex/alex         0 2021-05-17 16:21 ./ drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/ drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/bin/ -rwxrwxr-x alex/alex     16696 2021-05-17 16:18 ./usr/bin/hello-world   It’s also possible to run less ~/example/hello-world_0.0.1.deb which will output the above information, thanks to /bin/lesspipe.    This package can then be installed using the -f option under apt-get install:   sudo apt-get install -f ~/example/hello-world_0.0.1-1_amd64.deb   Then once installed, you can verify it works with commands like:   which hello-world   and  hello-world  which should output /usr/bin/hello-world and hello packaged world respectively.   Finally, if you want to remove it, you can run:   sudo apt-get remove hello-world   This concludes the first step of building a .deb package. If you have access to an existing apt repository, you could submit the deb to the repository maintainer, and call it a day.   Step 2: Creating an apt Repository   In this step, we will show how to create your own apt repository which can be used to host one or more deb packages.   Let’s start with creating a directory to hold our debs:   mkdir -p ~/example/apt-repo/pool/main/   Then copy our deb(s) into this directory:   cp ~/example/hello-world_0.0.1-1_amd64.deb ~/example/apt-repo/pool/main/.    Larger apt repositories create sub-directories for each program or project. For example, the official Ubuntu apt repository stores all vim related packages under /ubuntu/pool/main/v/vim/.    Once you’ve copied in all of your debs, we will create a different directory to contain a list of all available packages and corresponding metadata:   mkdir -p ~/example/apt-repo/dists/stable/main/binary-amd64    If you want to support multiple architectures, make a directory above for each type (e.g. i386, amd64, etc).    Next, we will generate a Packages file, which will contain a list of all available packages in this repository. We will use the dpkg-scanpackages program to generate it, by running:   cd ~/example/apt-repo dpkg-scanpackages --arch amd64 pool/ &gt; dists/stable/main/binary-amd64/Packages   It’s also good practice to compress the packages file, as apt will favour downloading compressed data whenever available. Let’s do this by running:   cat dists/stable/main/binary-amd64/Packages | gzip -9 &gt; dists/stable/main/binary-amd64/Packages.gz   Let’s take a quick look at the contents of the Packages file:  Package: hello-world Version: 0.0.1 Architecture: amd64 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Filename: pool/main/hello-world_0.0.1-1_amd64.deb Size: 2832 MD5sum: 3eba602abba5d6ea2a924854d014f4a7 SHA1: e300cabc138ac16b64884c9c832da4f811ea40fb SHA256: 6e314acd7e1e97e11865c11593362c65db9616345e1e34e309314528c5ef19a6 Homepage: http://example.com Description: A program that prints hello   if you had multiple deb files, you would have an entry for each package    The contents of the Packages file is a list of all available packages along with metadata from the DEBIAN/control file, and some hashes which can be used to validate the integrity of the package.   Next we will create a Release file. Unfortunately dpkg-scanpackages does not create Release files. Some people use programs like apt-ftparchive; however in this example I’ll cover an alternative to apt-ftparchive by using a small bash script.   First let’s look at an example of a Release file, which can be broken up into two parts:     Metadata about the repository, for example:  Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository    A list of all Packages files and their corresponding hashes and file size, for example:  MD5Sum:  9eb0c0528a0647daf18c7e225ac68f45 667 main/binary-amd64/Packages.gz  628682afa8a0208e08b5a208a4c4c85b 1685 main/binary-amd64/Packages  b5bef2199e86a43ae02adc0b7b38bc8a 556 main/binary-arm7/Packages.gz  81c53db3b9c5e9de44d3ca9fc4487995 1289 main/binary-arm7/Packages  15258b054124639f0641c399f291af17 557 main/binary-arm64/Packages.gz  dc597a0815aebb56b25a4ad979682f49 1292 main/binary-arm64/Packages SHA1:  a4074284eb528e5d16c2c94e203d61dd825fa774 667 main/binary-amd64/Packages.gz  ee86dd9061967232e6e68104a695f7d45d191b41 1685 main/binary-amd64/Packages  a6f4897bcf6a4b068c5b8fafca01fc89761106dc 556 main/binary-arm7/Packages.gz  43171192ce84dcb43bba99828fe7493ff23e0b0e 1289 main/binary-arm7/Packages  9f353a909a9a3dab0a9cae1a3c7ccb879ff18d32 557 main/binary-arm64/Packages.gz  da15c24e51a028ff591656eef0d1da0dbb85ba97 1292 main/binary-arm64/Packages SHA256:  dee57f6f4a2209b63301984acb4b279f694648915fd559287a414365884c1842 667 main/binary-amd64/Packages.gz  7d82e5929d909d10d9f2d7129df3f6754946397caf1c08e9e4a65713f4ac39ff 1685 main/binary-amd64/Packages  2b3c611305e096ef246d77d2bc5fcfa807034dd200f8f99005ab640cf2c014a4 556 main/binary-arm7/Packages.gz  d03d5192e24e098a91465ab37d34e0a2c539f50a430eb3262a543e7bd11212a1 1289 main/binary-arm7/Packages  f96316ff77e96d246447f0ca8383472acefc0744d9b49d2be1d214d174bba38a 557 main/binary-arm64/Packages.gz  58120a7b5ceb57ab4faca01adac3d62009a52962e0d0a6f4b7ceb1b8faedf280 1292 main/binary-arm64/Packages    And that’s it for what a Release file looks like. How hard could it be? let’s write some bash. Just copy and paste the following in your terminal to get a copy of the script:   echo &#39;#!/bin/sh set -e  do_hash() {     HASH_NAME=$1     HASH_CMD=$2     echo &quot;${HASH_NAME}:&quot;     for f in $(find -type f); do         f=$(echo $f | cut -c3-) # remove ./ prefix         if [ &quot;$f&quot; = &quot;Release&quot; ]; then             continue         fi         echo &quot; $(${HASH_CMD} ${f}  | cut -d&quot; &quot; -f1) $(wc -c $f)&quot;     done }  cat &lt;&lt; EOF Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository Date: $(date -Ru) EOF do_hash &quot;MD5Sum&quot; &quot;md5sum&quot; do_hash &quot;SHA1&quot; &quot;sha1sum&quot; do_hash &quot;SHA256&quot; &quot;sha256sum&quot; &#39; &gt; ~/example/generate-release.sh &amp;&amp; chmod +x ~/example/generate-release.sh   Next let’s run the generate-release.sh script with:   cd ~/example/apt-repo/dists/stable ~/example/generate-release.sh &gt; Release   At this point, you can try hosting this repo for yourself. In this example we’ll use python’s simple HTTP server; however in practice you’ll want to use a production-ready server. Here’s how you can start it up for testing:   cd ~/example python3 -m http.server   Then configure this apt repository:   echo &quot;deb [arch=amd64] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.list   Then finally update apt and install our new hello-world package:   sudo apt-get update --allow-insecure-repositories sudo apt-get install hello-world   Note that the –allow-insecure-repositories will print the following warning message:  W: The repository &#39;http://127.0.0.1:8000/apt-repo stable Release&#39; is not signed. N: Data from such a repository can&#39;t be authenticated and is therefore potentially dangerous to use. N: See apt-secure(8) manpage for repository creation and user configuration details.  That flag should never be used in a production environment. In the next section we’ll cover how to sign the repository, so it can be used in a trusted manor. Similarly when we install hello-world, we are asked if we want to proceed with an un-authenticated package:  WARNING: The following packages cannot be authenticated!   hello-world Install these packages without verification? [y/N]  Fortunately in the next section we’ll cover generating a PGP key, and signing our repository with it, which will allow users to verify the repository contents have not been tampered with.   Step 3: Signing your apt Repository With GPG   In the previous step, we generated a Release file, which referenced one or more Packages files along with it’s corresponding md5, sha1, and sha256 hashes. The Packages file in turns references a deb package along with it’s md5, sha1, and sha256 hashes.   As of 2021, md5 and sha1 hashes are no longer considered secure; however sha256 is still considered to be secure. Therefore if a user can verify that the initial Release file has not been tampered with, then they could make use of the sha256 to verify the Packages file, then use the sha256 contained in the Packages file to verify the deb file.   In order to sign the apt repo, all we must do is sign the Release file.   PGP, GPG, and GnuPGP   PGP, OpenPGP, GnuPG, GPG, (and careful not to typo PHP).   Software has a lot of acronyms, and this extends into digital signatures. “Pretty Good Privacy” (PGP), was created in 1991 by Phil Zimmermann and eventually became the main product of non other than PGP Inc. To encourage adoption of PGP, the company created an open standard unsurprisingly called OpenPGP.   OpenPGP is only a specification, that’s where GNU Privacy Guard (GPG) fits in: GPG is an implementation of (Open)PGP. So is it a PGP key, or a GPG key? I don’t know, I’ve seen it called both, I’m going to call it a PGP because that’s what is contained in the first line of the armoured text: —–BEGIN PGP PUBLIC KEY BLOCK—–.   Creating a New Public/Private PGP Key Pair   Let’s start with generating a PGP key pair. We will use the –batch feature of gpg rather than using the interactive prompt. This has the benefit of generating keys in a repeatable way. First create a batch template by copying and pasting the following into your terminal:   echo &quot;%echo Generating an example PGP key Key-Type: RSA Key-Length: 4096 Name-Real: example Name-Email: example@example.com Expire-Date: 0 %no-ask-passphrase %no-protection %commit&quot; &gt; /tmp/example-pgp-key.batch   then we will generate it under a new temporary gpg keyring:   export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot; gpg --no-tty --batch --gen-key /tmp/example-pgp-key.batch   Since we overrode the GNUPGHOME to a temporary directory, we can keep this key separate from our other keys. Let’s take a quick look at the contents of the directory:   ls &quot;$GNUPGHOME/private-keys-v1.d&quot;   will show something along the lines of  A3FB218BA1929542FF110C7D1B077B6469F769C9.key  which contains binary data. We can also view all of our loaded keys with:   gpg --list-keys   which will show something similar to  /home/alex/example/pgpkeys-pyml86/pubring.kbx ------------------------------- pub   rsa4096 2021-05-18 [SCEA]       B4D5C8B003C50A38A7E85B5989376CAC59892E72 uid           [ultimate] example &lt;example@example.com&gt;  This PGP key is comprised of both a public key, and a private key. Let’s start with exporting the public key:   gpg --armor --export example &gt; ~/example/pgp-key.public   Alternatively, you can reference the key by the email address or even the associated hex code. This should result in a public key that looks like:  -----BEGIN PGP PUBLIC KEY BLOCK-----  mQINBGCkNmcBEADjEcDdne3ti5derY+hSPnhrBWeBba/1gb3S7lKwsysFlxeAApU mROTk7gijH84GofOkZzQw9PJEA4u4kkF6EFfOr+VS3JDt5kYjpGorXMD8iRtJAIq Y6hX7vqNDHpXFHSEEBIFCUF9E3yf8p7Wrohe0/6HVz1m/XAcU34zWY3a4zfgntsd r4hj1h3E/GkZEI8UpB+/LshzbIoZMEDy+EB3EX/oCstZc9aKTUZLP9q5r3CvbrJU s3354N+XFxCocVv4c/UFtcUI14EfQv7LVB2JRWYrit65DAHx87V4xcajqbkswvYn 4ela0DCW/Bw2jz1DaEHLGzn9me6z+YYH8VWbYqUJ/hrHHHSqjjSZ3S5E8gLVzTuf IpoWUCSNeZlltBqoWf4ei7Q4nhzFi7AkvLABSkmx7R1+7fOH0ZIN+M2G6lOgcHEU IiS7v6ygyj1U2h+38xn66dDH/gUhjp0zJfivMnC1c7pz7R4zNhFxyv1cyekP1nJA wmpW+Y5ja3qSJYCHGmrtNaQIVMo2Ho1aXZiMysaTXKp4CYluoUsh97GjLtksq834 y3+FHdGMt8dGFBCRlZ9BFr1B++FZvuovbLoS+ZREmXTQPXYhN0TinpmnSFJsY6DK 5zFOU9j3Mtmf77MxUA+xsKBQrDgGM76uN7ADTc0jrUo4hECxnXQkOGyYrQARAQAB tB1leGFtcGxlIDxleGFtcGxlQGV4YW1wbGUuY29tPokCTgQTAQoAOBYhBLTVyLAD xQo4p+hbWYk3bKxZiS5yBQJgpDZnAhsvBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheA AAoJEIk3bKxZiS5yTUMP/1nlYpQTf8tQgSwSVUM8jhBhdOEEzmsXy/90KgpjX9WF ABSC61SnGRonO60dn5CHT4oi0yJRKtsjJ3ZXLyxJY4Myop4ZCoJCcJw6sBOc3rvl GN4J4O3+DZn7KRGUKFmLgeuxie2tSHdWYkonlpGPQ34xLgKT6Uf1NQOcCLZpMBim 2kxNXnnQXLEKXlbm9xmi/koub1qpko01T9DT9g9mlkv56660+sOw0XNwGmPy6HJ2 2IND53LYDNQv4qbt00ws29AUmZ6WmlUB9oP/nMx56Urgvmn6p/CLB9vbwIAb6egq ZouUKsFAFyO5oVH3JoNBYbT84QewQv9BnJVQjuh0wK3OdCBjzT3YcBuRVwVJubKv nSjvkJtq20tgxDSPc5ostzMpT5ZnBV+VQa6fwqBgb7VIGEPQklo6IZRwDH0rX1IA Xpe2dZOvUICqvg17ol29uQ81BRpB7UynPDbgPDhBbELELPQN/GfaL+op8AB+cbga JgC1JcX08nOqnT9TMpfig4TEpL/BKO+3cFy0Sttm44zMrR1f1SiyXdjZTS715LM/ nmAQWCZFMqN+5nHfT6lwJlqmtRCvjvHPdZla8Ah6B9oB+vJs1cClYJLSZuun89P/ bmQ5z+qJwCUOEVhVcVPTHAkqCTX2apQBeAszcmk54bGc/Q6UKncOgvOkELS7VuPt =DYDE -----END PGP PUBLIC KEY BLOCK-----   If the exported key is much larger than this, you may have exported multiple keys which can cause issues with some repositories.    You can verify only a single key was exported by running:   cat ~/example/pgp-key.public | gpg --list-packets   and checking that only a single :public key packet: entry exists. It should look something like this:  # off=0 ctb=99 tag=6 hlen=3 plen=525 :public key packet:     version 4, algo 1, created 1621374567, expires 0     pkey[0]: [4096 bits]     pkey[1]: [17 bits]     keyid: 89376CAC59892E72 # off=528 ctb=b4 tag=13 hlen=2 plen=29 :user ID packet: &quot;example &lt;example@example.com&gt;&quot; # off=559 ctb=89 tag=2 hlen=3 plen=590 :signature packet: algo 1, keyid 89376CAC59892E72     version 4, created 1621374567, md5len 0, sigclass 0x13     digest algo 10, begin of digest 4d 43     hashed subpkt 33 len 21 (issuer fpr v4 B4D5C8B003C50A38A7E85B5989376CAC59892E72)     hashed subpkt 2 len 4 (sig created 2021-05-18)     hashed subpkt 27 len 1 (key flags: 2F)     hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)     hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)     hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)     hashed subpkt 30 len 1 (features: 01)     hashed subpkt 23 len 1 (keyserver preferences: 80)     subpkt 16 len 8 (issuer key ID 89376CAC59892E72)     data: [4095 bits]  Next let’s export the private key so we can back it up somewhere safe.   gpg --armor --export-secret-keys example &gt; ~/example/pgp-key.private   You should never share this key with anyone. If you look at the output file, it should look similar to this:  -----BEGIN PGP PRIVATE KEY BLOCK-----  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 =+Tgf -----END PGP PRIVATE KEY BLOCK-----   The above is a burner-key I created for this article. It’s never been used for anything aside from this article. You should be generating your own key, don’t use this one.    Now that we’ve generated a PGP key pair, let’s move on to signing files with them.   Signing the Release File   Before we start signing with out keys, let’s make sure that we can import the backup we made. To do that, we will create a new GPG keyring location:   export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot;   and then verify that it is empty:   gpg --list-keys   which should show something similar to:  gpg: keybox &#39;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx&#39; created gpg: /home/alex/example/pgpkeys-e7u1Ad/trustdb.gpg: trustdb created  Next we will import our backed up private key:   cat ~/example/pgp-key.private | gpg --import   which should show a similar imported message:  gpg: key 4E793BC948F34C6F: public key &quot;example &lt;example@example.com&gt;&quot; imported gpg: key 4E793BC948F34C6F: secret key imported gpg: Total number processed: 1 gpg:               imported: 1 gpg:       secret keys read: 1 gpg:   secret keys imported: 1  and now if we run gpg –list-keys, we should see it is now available:  /home/alex/example/pgpkeys-e7u1Ad/pubring.kbx --------------------------------------------- pub   rsa4096 2021-05-18 [SCEA]       CFBFFC9CCD163CC7E1768BFF4E793BC948F34C6F uid           [ unknown] example &lt;example@example.com&gt;  Ok, let’s get around to signing the Release file now.   cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs &gt; ~/example/apt-repo/dists/stable/Release.gpg   The contents of Release.gpg should be similar to this:  -----BEGIN PGP SIGNATURE-----  iQJIBAABCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkTYYUHGV4YW1wbGVA ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG+f2g//QpVA4RP5qp2mAlolhqKCqLr6r7DX mUC5ueSISXlRwVK7l0xFADqw4uHsl+T0DIeX7K/efHyyqIYq+t8fCA8HbB5CmWFk 2rOa9jFR4G+afJ1mdfQYUHshwEzY+NIScg3suO0ZeILFXcTW6a6AzlwqI3pVy/b8 o/FCjj4hBnaPysDS1BmPqxjWvt5ilQR3RTodsFahr2FncmgZI8zvrbCey630O/Cs ELLp9fqBQj//FEje/JgHtG6E85qjsod0Nstu5h2yEs9iwMP1+peMB80NLpyeacpS CWbZmFgxqKL7JNSx04T8epL23Zg6trrzhvOzOiVp2+Ilg438LBrErSVO+3puWT2e bR3jpFSg9ej0+90QnG3IIkZW1RSkitlpNiFGFrUvlBRE9tSjZMK10EofPtzENEWN uXYqjcWTJxp6R7d1IW/lTFzwdCPorgBPBbjmJ7Ux5YWZP7jjJmFpF9jSHVz6xDcp oUBQcF4jHn5ewh0yKZQbqA3ZRXpPBDSNSraIDFToeFzhV94FQR2f5A5FgBR8n/Kr Gfb76dsKabwVJlr7z8+W2C8gHmOe4dlVVUje3bxo05VNwZEBPbRldFox4GKIWT46 FbXyzB/EfRR7rzmaRfIpDfQa6hLOoivlat1no6akT7bK2mE7Y0L+Kae1dP+BpBUe BqY84ZTkmQiOL0c= =Dqab -----END PGP SIGNATURE-----  Now when an apt client performs an update, it will fetch both Release and Release.gpg and will verify the signature is valid; However to increase the speed, we will create a third file InRelease which will combine both the contents of Release and the PGP signature:   cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs --clearsign &gt; ~/example/apt-repo/dists/stable/InRelease   The contents of InRelease should be similar to this:  -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512  Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository Date: Tue, 18 May 2021 01:17:46 +0000 MD5Sum:  d47739655e6312da85a96711f78c78db 405 main/binary-amd64/Packages SHA1:  d6aa46cf29cca1b01af6e9e256bf963ff5dfdaeb 405 main/binary-amd64/Packages SHA256:  3b888d4257fcf475fc06f74bd46045c3f1d667562fdb37e86f5bea642efa49f8 405 main/binary-amd64/Packages -----BEGIN PGP SIGNATURE-----  iQJIBAEBCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkT1wUHGV4YW1wbGVA ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG8w/RAAwB6HRyZWVOWT1A0OJAt+RlLREjev gfRZVLZRDv18QRZKCcj71v0Ki1hX3xWE8WVjIR9eSXNf1wJvqza+/FBGN00NY1Bk AFmypZP/04kjwGeUtULopLB1KrCaFdWuC9W49zUyeElIz1owX9tk+SsoLB7hGLQE jtweFjxhaMeCHgSJIXDoR0RpmKBuydtB3UTHjCQJBvErkYfKrAJQCDYDz+XVPLh6 XPAohVb6SO4qBCxX30QcQpUVDRtMMRKbIOD5B+hjCP5cupvej1fBlzlFh4lBIywj eUXrwBxmOiO/yrsYNoJJB+mV9u1mEpQDo7yRDCICsY2c/Io/Q0CxiEIIwoEfHCb/ WOFYYmUj1Sh9YARi74eTblMyr/Ay/9+opEr54uAixecJyC/kqsC3uptH4ZpOSwTw hdj24Cl2veYmiCimPB4QCLOsCU5A1phwEkgADUOh4iRaszuzGkh/NZ0al0dCF0HY /UsDuiMzEQGOP6ByILt1zoPrnwZKFDEbYjzSbjSXfkU9LKfrp5PWgeeq5iD58sQW ZCE34ksK8W67GOtQuzy0Z8NlTJY1Mkzp7IsUt60owyv6dQVZFIPYwGEisGFSOCNk 3VZ66m1D6HtDZ60CZEJUhfu+WTC1K95cKYkhYArBR9pDecygYomLQVFO2T1ENxCA BKaAtOSl2Jcb4eA= =3Hft -----END PGP SIGNATURE-----  Testing It Out   We need to tell apt which public pgp key to use when verifying the apt repository. We will add a new signed-by attribute to our apt config:   echo &quot;deb [arch=amd64 signed-by=$HOME/example/pgp-key.public] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.list    note that $HOME should be expanded to the absolute path of the pgp key.    Next start back up your web server:   cd ~/example python3 -m http.server   Then finally try updating and re-installing our hello-world package:   sudo apt-get clean sudo apt-get update sudo apt-get install hello-world   This time you shouldn’t see any security warnings.   Keeping Your Private Key Secure   If you followed this tutorial to the tee, and your web server is still running, what happens if we try running:   curl http://127.0.0.1:8000/pgp-key.private   Oh no! we just leaked our private key. Now’s the time to regenerate it but using a real name and email address other than example@example.com. Maybe you can store it in earthly’s secret store instead?   Appendix A: A Complete Example using Earthly   A complete example has been created under github.com/earthly/example-apt-repo/Earthfile.   This Earthfile contains all the above steps from this tutorial in a single location, which can be run directly in a single shot with:   earthly -P github.com/earthly/example-apt-repo:main+test   Alternatively, you can clone the repo and run +test directly.">


  <meta name="author" content="Alex Couture-Beil">
  
  <meta property="article:author" content="Alex Couture-Beil">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Earthly Blog">
<meta property="og:title" content="Creating and hosting your own deb packages and apt repo">
<meta property="og:url" content="https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo/">


  <meta property="og:description" content="As an Ubuntu user, I find myself typing apt install … frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests.    Prerequisites   This tutorial assumes you are using Ubuntu, and that the following packages are installed:   sudo apt-get install -y gcc dpkg-dev gpg   Step 0: Creating a Simple Hello World Program   Before getting started with packaging, let’s create a basic hello world program under ~/example/hello-world-program. To do this, you can copy and paste the following commands into your terminal:   mkdir -p ~/example/hello-world-program  echo &#39;#include &lt;stdio.h&gt; int main() {     printf(&quot;hello packaged world\n&quot;);     return 0; }&#39; &gt; ~/example/hello-world-program/hello.c   Then, you can compile it with:   cd ~/example/hello-world-program gcc -o hello-world hello.c   There’s no technical reason for picking C for this example – the language doesn’t matter. It’s the binary we will be distributing in our deb package.   Step 1: Creating a deb Package   Debian, and Debian-based Linux distributions use .deb packages to package and distribute programs. To start we will create a directory in the form:  &lt;package-name&gt;_&lt;version&gt;-&lt;release-number&gt;_&lt;architecture&gt;  where the    package-name is the name of our package, hello-world in our case,   version is the version of the software, 0.0.1 in our case,   release-number is used to track different releases of the same software version; it’s usually set to 1, but hypothetically if there was an error in the packaging (e.g. a file was missed, or the description had an error in it, or a post-install script was wrong), this number would be increased to track the change, and   architecture is the target architecture of the platform, amd64 in this example; however if your package is architecture-independent (e.g. a python script), then you can set this to all.     Theoretically, the directory doesn’t have to follow this naming convention; however some of the tools we will use later in the tutorial require this directory naming convention.    So for this example, we’ll create the directory with:   mkdir -p ~/example/hello-world_0.0.1-1_amd64   This directory will be the root of the package. Since we want our hello-world binary to be installed system wide, we’ll have to store it under usr/bin/hello-world with the following commands:   cd ~/example/hello-world_0.0.1-1_amd64 mkdir -p usr/bin cp ~/example/hello-world-program/hello-world usr/bin/.   Each package requires a control file which needs to be located under the DEBIAN directory. You can copy and paste the following to create one:   mkdir -p ~/example/hello-world_0.0.1-1_amd64/DEBIAN  echo &quot;Package: hello-world Version: 0.0.1 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Architecture: amd64 Homepage: http://example.com Description: A program that prints hello&quot; \ &gt; ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control   Note that we’re assuming an amd64 Architecture for this tutorial, if your binary is for a different architecture, adjust accordingly. If you’re distributing a platform-independent package, you can set the architecture to all.   By this point you should have created two files:  ~/example/hello-world_0.0.1-1_amd64/usr/bin/hello-world ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control  To build the .deb package, run:   dpkg --build ~/example/hello-world_0.0.1-1_amd64   This will output a deb package under ~/example/hello-world_0.0.1.deb.   You can inspect the info of the deb by running:   dpkg-deb --info ~/example/hello-world_0.0.1.deb   which will show:   new Debian package, version 2.0. size 2832 bytes: control archive=336 bytes.     182 bytes,     7 lines      control Package: hello-world Version: 0.0.1 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Architecture: amd64 Homepage: http://example.com Description: A program that prints hello   You can also view the contents by running:   dpkg-deb --contents ~/example/hello-world_0.0.1.deb   which will show:  drwxrwxr-x alex/alex         0 2021-05-17 16:21 ./ drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/ drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/bin/ -rwxrwxr-x alex/alex     16696 2021-05-17 16:18 ./usr/bin/hello-world   It’s also possible to run less ~/example/hello-world_0.0.1.deb which will output the above information, thanks to /bin/lesspipe.    This package can then be installed using the -f option under apt-get install:   sudo apt-get install -f ~/example/hello-world_0.0.1-1_amd64.deb   Then once installed, you can verify it works with commands like:   which hello-world   and  hello-world  which should output /usr/bin/hello-world and hello packaged world respectively.   Finally, if you want to remove it, you can run:   sudo apt-get remove hello-world   This concludes the first step of building a .deb package. If you have access to an existing apt repository, you could submit the deb to the repository maintainer, and call it a day.   Step 2: Creating an apt Repository   In this step, we will show how to create your own apt repository which can be used to host one or more deb packages.   Let’s start with creating a directory to hold our debs:   mkdir -p ~/example/apt-repo/pool/main/   Then copy our deb(s) into this directory:   cp ~/example/hello-world_0.0.1-1_amd64.deb ~/example/apt-repo/pool/main/.    Larger apt repositories create sub-directories for each program or project. For example, the official Ubuntu apt repository stores all vim related packages under /ubuntu/pool/main/v/vim/.    Once you’ve copied in all of your debs, we will create a different directory to contain a list of all available packages and corresponding metadata:   mkdir -p ~/example/apt-repo/dists/stable/main/binary-amd64    If you want to support multiple architectures, make a directory above for each type (e.g. i386, amd64, etc).    Next, we will generate a Packages file, which will contain a list of all available packages in this repository. We will use the dpkg-scanpackages program to generate it, by running:   cd ~/example/apt-repo dpkg-scanpackages --arch amd64 pool/ &gt; dists/stable/main/binary-amd64/Packages   It’s also good practice to compress the packages file, as apt will favour downloading compressed data whenever available. Let’s do this by running:   cat dists/stable/main/binary-amd64/Packages | gzip -9 &gt; dists/stable/main/binary-amd64/Packages.gz   Let’s take a quick look at the contents of the Packages file:  Package: hello-world Version: 0.0.1 Architecture: amd64 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Filename: pool/main/hello-world_0.0.1-1_amd64.deb Size: 2832 MD5sum: 3eba602abba5d6ea2a924854d014f4a7 SHA1: e300cabc138ac16b64884c9c832da4f811ea40fb SHA256: 6e314acd7e1e97e11865c11593362c65db9616345e1e34e309314528c5ef19a6 Homepage: http://example.com Description: A program that prints hello   if you had multiple deb files, you would have an entry for each package    The contents of the Packages file is a list of all available packages along with metadata from the DEBIAN/control file, and some hashes which can be used to validate the integrity of the package.   Next we will create a Release file. Unfortunately dpkg-scanpackages does not create Release files. Some people use programs like apt-ftparchive; however in this example I’ll cover an alternative to apt-ftparchive by using a small bash script.   First let’s look at an example of a Release file, which can be broken up into two parts:     Metadata about the repository, for example:  Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository    A list of all Packages files and their corresponding hashes and file size, for example:  MD5Sum:  9eb0c0528a0647daf18c7e225ac68f45 667 main/binary-amd64/Packages.gz  628682afa8a0208e08b5a208a4c4c85b 1685 main/binary-amd64/Packages  b5bef2199e86a43ae02adc0b7b38bc8a 556 main/binary-arm7/Packages.gz  81c53db3b9c5e9de44d3ca9fc4487995 1289 main/binary-arm7/Packages  15258b054124639f0641c399f291af17 557 main/binary-arm64/Packages.gz  dc597a0815aebb56b25a4ad979682f49 1292 main/binary-arm64/Packages SHA1:  a4074284eb528e5d16c2c94e203d61dd825fa774 667 main/binary-amd64/Packages.gz  ee86dd9061967232e6e68104a695f7d45d191b41 1685 main/binary-amd64/Packages  a6f4897bcf6a4b068c5b8fafca01fc89761106dc 556 main/binary-arm7/Packages.gz  43171192ce84dcb43bba99828fe7493ff23e0b0e 1289 main/binary-arm7/Packages  9f353a909a9a3dab0a9cae1a3c7ccb879ff18d32 557 main/binary-arm64/Packages.gz  da15c24e51a028ff591656eef0d1da0dbb85ba97 1292 main/binary-arm64/Packages SHA256:  dee57f6f4a2209b63301984acb4b279f694648915fd559287a414365884c1842 667 main/binary-amd64/Packages.gz  7d82e5929d909d10d9f2d7129df3f6754946397caf1c08e9e4a65713f4ac39ff 1685 main/binary-amd64/Packages  2b3c611305e096ef246d77d2bc5fcfa807034dd200f8f99005ab640cf2c014a4 556 main/binary-arm7/Packages.gz  d03d5192e24e098a91465ab37d34e0a2c539f50a430eb3262a543e7bd11212a1 1289 main/binary-arm7/Packages  f96316ff77e96d246447f0ca8383472acefc0744d9b49d2be1d214d174bba38a 557 main/binary-arm64/Packages.gz  58120a7b5ceb57ab4faca01adac3d62009a52962e0d0a6f4b7ceb1b8faedf280 1292 main/binary-arm64/Packages    And that’s it for what a Release file looks like. How hard could it be? let’s write some bash. Just copy and paste the following in your terminal to get a copy of the script:   echo &#39;#!/bin/sh set -e  do_hash() {     HASH_NAME=$1     HASH_CMD=$2     echo &quot;${HASH_NAME}:&quot;     for f in $(find -type f); do         f=$(echo $f | cut -c3-) # remove ./ prefix         if [ &quot;$f&quot; = &quot;Release&quot; ]; then             continue         fi         echo &quot; $(${HASH_CMD} ${f}  | cut -d&quot; &quot; -f1) $(wc -c $f)&quot;     done }  cat &lt;&lt; EOF Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository Date: $(date -Ru) EOF do_hash &quot;MD5Sum&quot; &quot;md5sum&quot; do_hash &quot;SHA1&quot; &quot;sha1sum&quot; do_hash &quot;SHA256&quot; &quot;sha256sum&quot; &#39; &gt; ~/example/generate-release.sh &amp;&amp; chmod +x ~/example/generate-release.sh   Next let’s run the generate-release.sh script with:   cd ~/example/apt-repo/dists/stable ~/example/generate-release.sh &gt; Release   At this point, you can try hosting this repo for yourself. In this example we’ll use python’s simple HTTP server; however in practice you’ll want to use a production-ready server. Here’s how you can start it up for testing:   cd ~/example python3 -m http.server   Then configure this apt repository:   echo &quot;deb [arch=amd64] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.list   Then finally update apt and install our new hello-world package:   sudo apt-get update --allow-insecure-repositories sudo apt-get install hello-world   Note that the –allow-insecure-repositories will print the following warning message:  W: The repository &#39;http://127.0.0.1:8000/apt-repo stable Release&#39; is not signed. N: Data from such a repository can&#39;t be authenticated and is therefore potentially dangerous to use. N: See apt-secure(8) manpage for repository creation and user configuration details.  That flag should never be used in a production environment. In the next section we’ll cover how to sign the repository, so it can be used in a trusted manor. Similarly when we install hello-world, we are asked if we want to proceed with an un-authenticated package:  WARNING: The following packages cannot be authenticated!   hello-world Install these packages without verification? [y/N]  Fortunately in the next section we’ll cover generating a PGP key, and signing our repository with it, which will allow users to verify the repository contents have not been tampered with.   Step 3: Signing your apt Repository With GPG   In the previous step, we generated a Release file, which referenced one or more Packages files along with it’s corresponding md5, sha1, and sha256 hashes. The Packages file in turns references a deb package along with it’s md5, sha1, and sha256 hashes.   As of 2021, md5 and sha1 hashes are no longer considered secure; however sha256 is still considered to be secure. Therefore if a user can verify that the initial Release file has not been tampered with, then they could make use of the sha256 to verify the Packages file, then use the sha256 contained in the Packages file to verify the deb file.   In order to sign the apt repo, all we must do is sign the Release file.   PGP, GPG, and GnuPGP   PGP, OpenPGP, GnuPG, GPG, (and careful not to typo PHP).   Software has a lot of acronyms, and this extends into digital signatures. “Pretty Good Privacy” (PGP), was created in 1991 by Phil Zimmermann and eventually became the main product of non other than PGP Inc. To encourage adoption of PGP, the company created an open standard unsurprisingly called OpenPGP.   OpenPGP is only a specification, that’s where GNU Privacy Guard (GPG) fits in: GPG is an implementation of (Open)PGP. So is it a PGP key, or a GPG key? I don’t know, I’ve seen it called both, I’m going to call it a PGP because that’s what is contained in the first line of the armoured text: —–BEGIN PGP PUBLIC KEY BLOCK—–.   Creating a New Public/Private PGP Key Pair   Let’s start with generating a PGP key pair. We will use the –batch feature of gpg rather than using the interactive prompt. This has the benefit of generating keys in a repeatable way. First create a batch template by copying and pasting the following into your terminal:   echo &quot;%echo Generating an example PGP key Key-Type: RSA Key-Length: 4096 Name-Real: example Name-Email: example@example.com Expire-Date: 0 %no-ask-passphrase %no-protection %commit&quot; &gt; /tmp/example-pgp-key.batch   then we will generate it under a new temporary gpg keyring:   export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot; gpg --no-tty --batch --gen-key /tmp/example-pgp-key.batch   Since we overrode the GNUPGHOME to a temporary directory, we can keep this key separate from our other keys. Let’s take a quick look at the contents of the directory:   ls &quot;$GNUPGHOME/private-keys-v1.d&quot;   will show something along the lines of  A3FB218BA1929542FF110C7D1B077B6469F769C9.key  which contains binary data. We can also view all of our loaded keys with:   gpg --list-keys   which will show something similar to  /home/alex/example/pgpkeys-pyml86/pubring.kbx ------------------------------- pub   rsa4096 2021-05-18 [SCEA]       B4D5C8B003C50A38A7E85B5989376CAC59892E72 uid           [ultimate] example &lt;example@example.com&gt;  This PGP key is comprised of both a public key, and a private key. Let’s start with exporting the public key:   gpg --armor --export example &gt; ~/example/pgp-key.public   Alternatively, you can reference the key by the email address or even the associated hex code. This should result in a public key that looks like:  -----BEGIN PGP PUBLIC KEY BLOCK-----  mQINBGCkNmcBEADjEcDdne3ti5derY+hSPnhrBWeBba/1gb3S7lKwsysFlxeAApU mROTk7gijH84GofOkZzQw9PJEA4u4kkF6EFfOr+VS3JDt5kYjpGorXMD8iRtJAIq Y6hX7vqNDHpXFHSEEBIFCUF9E3yf8p7Wrohe0/6HVz1m/XAcU34zWY3a4zfgntsd r4hj1h3E/GkZEI8UpB+/LshzbIoZMEDy+EB3EX/oCstZc9aKTUZLP9q5r3CvbrJU s3354N+XFxCocVv4c/UFtcUI14EfQv7LVB2JRWYrit65DAHx87V4xcajqbkswvYn 4ela0DCW/Bw2jz1DaEHLGzn9me6z+YYH8VWbYqUJ/hrHHHSqjjSZ3S5E8gLVzTuf IpoWUCSNeZlltBqoWf4ei7Q4nhzFi7AkvLABSkmx7R1+7fOH0ZIN+M2G6lOgcHEU IiS7v6ygyj1U2h+38xn66dDH/gUhjp0zJfivMnC1c7pz7R4zNhFxyv1cyekP1nJA wmpW+Y5ja3qSJYCHGmrtNaQIVMo2Ho1aXZiMysaTXKp4CYluoUsh97GjLtksq834 y3+FHdGMt8dGFBCRlZ9BFr1B++FZvuovbLoS+ZREmXTQPXYhN0TinpmnSFJsY6DK 5zFOU9j3Mtmf77MxUA+xsKBQrDgGM76uN7ADTc0jrUo4hECxnXQkOGyYrQARAQAB tB1leGFtcGxlIDxleGFtcGxlQGV4YW1wbGUuY29tPokCTgQTAQoAOBYhBLTVyLAD xQo4p+hbWYk3bKxZiS5yBQJgpDZnAhsvBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheA AAoJEIk3bKxZiS5yTUMP/1nlYpQTf8tQgSwSVUM8jhBhdOEEzmsXy/90KgpjX9WF ABSC61SnGRonO60dn5CHT4oi0yJRKtsjJ3ZXLyxJY4Myop4ZCoJCcJw6sBOc3rvl GN4J4O3+DZn7KRGUKFmLgeuxie2tSHdWYkonlpGPQ34xLgKT6Uf1NQOcCLZpMBim 2kxNXnnQXLEKXlbm9xmi/koub1qpko01T9DT9g9mlkv56660+sOw0XNwGmPy6HJ2 2IND53LYDNQv4qbt00ws29AUmZ6WmlUB9oP/nMx56Urgvmn6p/CLB9vbwIAb6egq ZouUKsFAFyO5oVH3JoNBYbT84QewQv9BnJVQjuh0wK3OdCBjzT3YcBuRVwVJubKv nSjvkJtq20tgxDSPc5ostzMpT5ZnBV+VQa6fwqBgb7VIGEPQklo6IZRwDH0rX1IA Xpe2dZOvUICqvg17ol29uQ81BRpB7UynPDbgPDhBbELELPQN/GfaL+op8AB+cbga JgC1JcX08nOqnT9TMpfig4TEpL/BKO+3cFy0Sttm44zMrR1f1SiyXdjZTS715LM/ nmAQWCZFMqN+5nHfT6lwJlqmtRCvjvHPdZla8Ah6B9oB+vJs1cClYJLSZuun89P/ bmQ5z+qJwCUOEVhVcVPTHAkqCTX2apQBeAszcmk54bGc/Q6UKncOgvOkELS7VuPt =DYDE -----END PGP PUBLIC KEY BLOCK-----   If the exported key is much larger than this, you may have exported multiple keys which can cause issues with some repositories.    You can verify only a single key was exported by running:   cat ~/example/pgp-key.public | gpg --list-packets   and checking that only a single :public key packet: entry exists. It should look something like this:  # off=0 ctb=99 tag=6 hlen=3 plen=525 :public key packet:     version 4, algo 1, created 1621374567, expires 0     pkey[0]: [4096 bits]     pkey[1]: [17 bits]     keyid: 89376CAC59892E72 # off=528 ctb=b4 tag=13 hlen=2 plen=29 :user ID packet: &quot;example &lt;example@example.com&gt;&quot; # off=559 ctb=89 tag=2 hlen=3 plen=590 :signature packet: algo 1, keyid 89376CAC59892E72     version 4, created 1621374567, md5len 0, sigclass 0x13     digest algo 10, begin of digest 4d 43     hashed subpkt 33 len 21 (issuer fpr v4 B4D5C8B003C50A38A7E85B5989376CAC59892E72)     hashed subpkt 2 len 4 (sig created 2021-05-18)     hashed subpkt 27 len 1 (key flags: 2F)     hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)     hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)     hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)     hashed subpkt 30 len 1 (features: 01)     hashed subpkt 23 len 1 (keyserver preferences: 80)     subpkt 16 len 8 (issuer key ID 89376CAC59892E72)     data: [4095 bits]  Next let’s export the private key so we can back it up somewhere safe.   gpg --armor --export-secret-keys example &gt; ~/example/pgp-key.private   You should never share this key with anyone. If you look at the output file, it should look similar to this:  -----BEGIN PGP PRIVATE KEY BLOCK-----  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 =+Tgf -----END PGP PRIVATE KEY BLOCK-----   The above is a burner-key I created for this article. It’s never been used for anything aside from this article. You should be generating your own key, don’t use this one.    Now that we’ve generated a PGP key pair, let’s move on to signing files with them.   Signing the Release File   Before we start signing with out keys, let’s make sure that we can import the backup we made. To do that, we will create a new GPG keyring location:   export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot;   and then verify that it is empty:   gpg --list-keys   which should show something similar to:  gpg: keybox &#39;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx&#39; created gpg: /home/alex/example/pgpkeys-e7u1Ad/trustdb.gpg: trustdb created  Next we will import our backed up private key:   cat ~/example/pgp-key.private | gpg --import   which should show a similar imported message:  gpg: key 4E793BC948F34C6F: public key &quot;example &lt;example@example.com&gt;&quot; imported gpg: key 4E793BC948F34C6F: secret key imported gpg: Total number processed: 1 gpg:               imported: 1 gpg:       secret keys read: 1 gpg:   secret keys imported: 1  and now if we run gpg –list-keys, we should see it is now available:  /home/alex/example/pgpkeys-e7u1Ad/pubring.kbx --------------------------------------------- pub   rsa4096 2021-05-18 [SCEA]       CFBFFC9CCD163CC7E1768BFF4E793BC948F34C6F uid           [ unknown] example &lt;example@example.com&gt;  Ok, let’s get around to signing the Release file now.   cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs &gt; ~/example/apt-repo/dists/stable/Release.gpg   The contents of Release.gpg should be similar to this:  -----BEGIN PGP SIGNATURE-----  iQJIBAABCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkTYYUHGV4YW1wbGVA ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG+f2g//QpVA4RP5qp2mAlolhqKCqLr6r7DX mUC5ueSISXlRwVK7l0xFADqw4uHsl+T0DIeX7K/efHyyqIYq+t8fCA8HbB5CmWFk 2rOa9jFR4G+afJ1mdfQYUHshwEzY+NIScg3suO0ZeILFXcTW6a6AzlwqI3pVy/b8 o/FCjj4hBnaPysDS1BmPqxjWvt5ilQR3RTodsFahr2FncmgZI8zvrbCey630O/Cs ELLp9fqBQj//FEje/JgHtG6E85qjsod0Nstu5h2yEs9iwMP1+peMB80NLpyeacpS CWbZmFgxqKL7JNSx04T8epL23Zg6trrzhvOzOiVp2+Ilg438LBrErSVO+3puWT2e bR3jpFSg9ej0+90QnG3IIkZW1RSkitlpNiFGFrUvlBRE9tSjZMK10EofPtzENEWN uXYqjcWTJxp6R7d1IW/lTFzwdCPorgBPBbjmJ7Ux5YWZP7jjJmFpF9jSHVz6xDcp oUBQcF4jHn5ewh0yKZQbqA3ZRXpPBDSNSraIDFToeFzhV94FQR2f5A5FgBR8n/Kr Gfb76dsKabwVJlr7z8+W2C8gHmOe4dlVVUje3bxo05VNwZEBPbRldFox4GKIWT46 FbXyzB/EfRR7rzmaRfIpDfQa6hLOoivlat1no6akT7bK2mE7Y0L+Kae1dP+BpBUe BqY84ZTkmQiOL0c= =Dqab -----END PGP SIGNATURE-----  Now when an apt client performs an update, it will fetch both Release and Release.gpg and will verify the signature is valid; However to increase the speed, we will create a third file InRelease which will combine both the contents of Release and the PGP signature:   cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs --clearsign &gt; ~/example/apt-repo/dists/stable/InRelease   The contents of InRelease should be similar to this:  -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512  Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository Date: Tue, 18 May 2021 01:17:46 +0000 MD5Sum:  d47739655e6312da85a96711f78c78db 405 main/binary-amd64/Packages SHA1:  d6aa46cf29cca1b01af6e9e256bf963ff5dfdaeb 405 main/binary-amd64/Packages SHA256:  3b888d4257fcf475fc06f74bd46045c3f1d667562fdb37e86f5bea642efa49f8 405 main/binary-amd64/Packages -----BEGIN PGP SIGNATURE-----  iQJIBAEBCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkT1wUHGV4YW1wbGVA ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG8w/RAAwB6HRyZWVOWT1A0OJAt+RlLREjev gfRZVLZRDv18QRZKCcj71v0Ki1hX3xWE8WVjIR9eSXNf1wJvqza+/FBGN00NY1Bk AFmypZP/04kjwGeUtULopLB1KrCaFdWuC9W49zUyeElIz1owX9tk+SsoLB7hGLQE jtweFjxhaMeCHgSJIXDoR0RpmKBuydtB3UTHjCQJBvErkYfKrAJQCDYDz+XVPLh6 XPAohVb6SO4qBCxX30QcQpUVDRtMMRKbIOD5B+hjCP5cupvej1fBlzlFh4lBIywj eUXrwBxmOiO/yrsYNoJJB+mV9u1mEpQDo7yRDCICsY2c/Io/Q0CxiEIIwoEfHCb/ WOFYYmUj1Sh9YARi74eTblMyr/Ay/9+opEr54uAixecJyC/kqsC3uptH4ZpOSwTw hdj24Cl2veYmiCimPB4QCLOsCU5A1phwEkgADUOh4iRaszuzGkh/NZ0al0dCF0HY /UsDuiMzEQGOP6ByILt1zoPrnwZKFDEbYjzSbjSXfkU9LKfrp5PWgeeq5iD58sQW ZCE34ksK8W67GOtQuzy0Z8NlTJY1Mkzp7IsUt60owyv6dQVZFIPYwGEisGFSOCNk 3VZ66m1D6HtDZ60CZEJUhfu+WTC1K95cKYkhYArBR9pDecygYomLQVFO2T1ENxCA BKaAtOSl2Jcb4eA= =3Hft -----END PGP SIGNATURE-----  Testing It Out   We need to tell apt which public pgp key to use when verifying the apt repository. We will add a new signed-by attribute to our apt config:   echo &quot;deb [arch=amd64 signed-by=$HOME/example/pgp-key.public] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.list    note that $HOME should be expanded to the absolute path of the pgp key.    Next start back up your web server:   cd ~/example python3 -m http.server   Then finally try updating and re-installing our hello-world package:   sudo apt-get clean sudo apt-get update sudo apt-get install hello-world   This time you shouldn’t see any security warnings.   Keeping Your Private Key Secure   If you followed this tutorial to the tee, and your web server is still running, what happens if we try running:   curl http://127.0.0.1:8000/pgp-key.private   Oh no! we just leaked our private key. Now’s the time to regenerate it but using a real name and email address other than example@example.com. Maybe you can store it in earthly’s secret store instead?   Appendix A: A Complete Example using Earthly   A complete example has been created under github.com/earthly/example-apt-repo/Earthfile.   This Earthfile contains all the above steps from this tutorial in a single location, which can be run directly in a single shot with:   earthly -P github.com/earthly/example-apt-repo:main+test   Alternatively, you can clone the repo and run +test directly.">



  <meta property="og:image" content="/blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-762-c7694d9ec.jpg">



  <meta name="twitter:site" content="@EarthlyTech">
  <meta name="twitter:title" content="Creating and hosting your own deb packages and apt repo">
  <meta name="twitter:description" content="As an Ubuntu user, I find myself typing apt install … frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests.    Prerequisites   This tutorial assumes you are using Ubuntu, and that the following packages are installed:   sudo apt-get install -y gcc dpkg-dev gpg   Step 0: Creating a Simple Hello World Program   Before getting started with packaging, let’s create a basic hello world program under ~/example/hello-world-program. To do this, you can copy and paste the following commands into your terminal:   mkdir -p ~/example/hello-world-program  echo &#39;#include &lt;stdio.h&gt; int main() {     printf(&quot;hello packaged world\n&quot;);     return 0; }&#39; &gt; ~/example/hello-world-program/hello.c   Then, you can compile it with:   cd ~/example/hello-world-program gcc -o hello-world hello.c   There’s no technical reason for picking C for this example – the language doesn’t matter. It’s the binary we will be distributing in our deb package.   Step 1: Creating a deb Package   Debian, and Debian-based Linux distributions use .deb packages to package and distribute programs. To start we will create a directory in the form:  &lt;package-name&gt;_&lt;version&gt;-&lt;release-number&gt;_&lt;architecture&gt;  where the    package-name is the name of our package, hello-world in our case,   version is the version of the software, 0.0.1 in our case,   release-number is used to track different releases of the same software version; it’s usually set to 1, but hypothetically if there was an error in the packaging (e.g. a file was missed, or the description had an error in it, or a post-install script was wrong), this number would be increased to track the change, and   architecture is the target architecture of the platform, amd64 in this example; however if your package is architecture-independent (e.g. a python script), then you can set this to all.     Theoretically, the directory doesn’t have to follow this naming convention; however some of the tools we will use later in the tutorial require this directory naming convention.    So for this example, we’ll create the directory with:   mkdir -p ~/example/hello-world_0.0.1-1_amd64   This directory will be the root of the package. Since we want our hello-world binary to be installed system wide, we’ll have to store it under usr/bin/hello-world with the following commands:   cd ~/example/hello-world_0.0.1-1_amd64 mkdir -p usr/bin cp ~/example/hello-world-program/hello-world usr/bin/.   Each package requires a control file which needs to be located under the DEBIAN directory. You can copy and paste the following to create one:   mkdir -p ~/example/hello-world_0.0.1-1_amd64/DEBIAN  echo &quot;Package: hello-world Version: 0.0.1 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Architecture: amd64 Homepage: http://example.com Description: A program that prints hello&quot; \ &gt; ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control   Note that we’re assuming an amd64 Architecture for this tutorial, if your binary is for a different architecture, adjust accordingly. If you’re distributing a platform-independent package, you can set the architecture to all.   By this point you should have created two files:  ~/example/hello-world_0.0.1-1_amd64/usr/bin/hello-world ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control  To build the .deb package, run:   dpkg --build ~/example/hello-world_0.0.1-1_amd64   This will output a deb package under ~/example/hello-world_0.0.1.deb.   You can inspect the info of the deb by running:   dpkg-deb --info ~/example/hello-world_0.0.1.deb   which will show:   new Debian package, version 2.0. size 2832 bytes: control archive=336 bytes.     182 bytes,     7 lines      control Package: hello-world Version: 0.0.1 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Architecture: amd64 Homepage: http://example.com Description: A program that prints hello   You can also view the contents by running:   dpkg-deb --contents ~/example/hello-world_0.0.1.deb   which will show:  drwxrwxr-x alex/alex         0 2021-05-17 16:21 ./ drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/ drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/bin/ -rwxrwxr-x alex/alex     16696 2021-05-17 16:18 ./usr/bin/hello-world   It’s also possible to run less ~/example/hello-world_0.0.1.deb which will output the above information, thanks to /bin/lesspipe.    This package can then be installed using the -f option under apt-get install:   sudo apt-get install -f ~/example/hello-world_0.0.1-1_amd64.deb   Then once installed, you can verify it works with commands like:   which hello-world   and  hello-world  which should output /usr/bin/hello-world and hello packaged world respectively.   Finally, if you want to remove it, you can run:   sudo apt-get remove hello-world   This concludes the first step of building a .deb package. If you have access to an existing apt repository, you could submit the deb to the repository maintainer, and call it a day.   Step 2: Creating an apt Repository   In this step, we will show how to create your own apt repository which can be used to host one or more deb packages.   Let’s start with creating a directory to hold our debs:   mkdir -p ~/example/apt-repo/pool/main/   Then copy our deb(s) into this directory:   cp ~/example/hello-world_0.0.1-1_amd64.deb ~/example/apt-repo/pool/main/.    Larger apt repositories create sub-directories for each program or project. For example, the official Ubuntu apt repository stores all vim related packages under /ubuntu/pool/main/v/vim/.    Once you’ve copied in all of your debs, we will create a different directory to contain a list of all available packages and corresponding metadata:   mkdir -p ~/example/apt-repo/dists/stable/main/binary-amd64    If you want to support multiple architectures, make a directory above for each type (e.g. i386, amd64, etc).    Next, we will generate a Packages file, which will contain a list of all available packages in this repository. We will use the dpkg-scanpackages program to generate it, by running:   cd ~/example/apt-repo dpkg-scanpackages --arch amd64 pool/ &gt; dists/stable/main/binary-amd64/Packages   It’s also good practice to compress the packages file, as apt will favour downloading compressed data whenever available. Let’s do this by running:   cat dists/stable/main/binary-amd64/Packages | gzip -9 &gt; dists/stable/main/binary-amd64/Packages.gz   Let’s take a quick look at the contents of the Packages file:  Package: hello-world Version: 0.0.1 Architecture: amd64 Maintainer: example &lt;example@example.com&gt; Depends: libc6 Filename: pool/main/hello-world_0.0.1-1_amd64.deb Size: 2832 MD5sum: 3eba602abba5d6ea2a924854d014f4a7 SHA1: e300cabc138ac16b64884c9c832da4f811ea40fb SHA256: 6e314acd7e1e97e11865c11593362c65db9616345e1e34e309314528c5ef19a6 Homepage: http://example.com Description: A program that prints hello   if you had multiple deb files, you would have an entry for each package    The contents of the Packages file is a list of all available packages along with metadata from the DEBIAN/control file, and some hashes which can be used to validate the integrity of the package.   Next we will create a Release file. Unfortunately dpkg-scanpackages does not create Release files. Some people use programs like apt-ftparchive; however in this example I’ll cover an alternative to apt-ftparchive by using a small bash script.   First let’s look at an example of a Release file, which can be broken up into two parts:     Metadata about the repository, for example:  Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository    A list of all Packages files and their corresponding hashes and file size, for example:  MD5Sum:  9eb0c0528a0647daf18c7e225ac68f45 667 main/binary-amd64/Packages.gz  628682afa8a0208e08b5a208a4c4c85b 1685 main/binary-amd64/Packages  b5bef2199e86a43ae02adc0b7b38bc8a 556 main/binary-arm7/Packages.gz  81c53db3b9c5e9de44d3ca9fc4487995 1289 main/binary-arm7/Packages  15258b054124639f0641c399f291af17 557 main/binary-arm64/Packages.gz  dc597a0815aebb56b25a4ad979682f49 1292 main/binary-arm64/Packages SHA1:  a4074284eb528e5d16c2c94e203d61dd825fa774 667 main/binary-amd64/Packages.gz  ee86dd9061967232e6e68104a695f7d45d191b41 1685 main/binary-amd64/Packages  a6f4897bcf6a4b068c5b8fafca01fc89761106dc 556 main/binary-arm7/Packages.gz  43171192ce84dcb43bba99828fe7493ff23e0b0e 1289 main/binary-arm7/Packages  9f353a909a9a3dab0a9cae1a3c7ccb879ff18d32 557 main/binary-arm64/Packages.gz  da15c24e51a028ff591656eef0d1da0dbb85ba97 1292 main/binary-arm64/Packages SHA256:  dee57f6f4a2209b63301984acb4b279f694648915fd559287a414365884c1842 667 main/binary-amd64/Packages.gz  7d82e5929d909d10d9f2d7129df3f6754946397caf1c08e9e4a65713f4ac39ff 1685 main/binary-amd64/Packages  2b3c611305e096ef246d77d2bc5fcfa807034dd200f8f99005ab640cf2c014a4 556 main/binary-arm7/Packages.gz  d03d5192e24e098a91465ab37d34e0a2c539f50a430eb3262a543e7bd11212a1 1289 main/binary-arm7/Packages  f96316ff77e96d246447f0ca8383472acefc0744d9b49d2be1d214d174bba38a 557 main/binary-arm64/Packages.gz  58120a7b5ceb57ab4faca01adac3d62009a52962e0d0a6f4b7ceb1b8faedf280 1292 main/binary-arm64/Packages    And that’s it for what a Release file looks like. How hard could it be? let’s write some bash. Just copy and paste the following in your terminal to get a copy of the script:   echo &#39;#!/bin/sh set -e  do_hash() {     HASH_NAME=$1     HASH_CMD=$2     echo &quot;${HASH_NAME}:&quot;     for f in $(find -type f); do         f=$(echo $f | cut -c3-) # remove ./ prefix         if [ &quot;$f&quot; = &quot;Release&quot; ]; then             continue         fi         echo &quot; $(${HASH_CMD} ${f}  | cut -d&quot; &quot; -f1) $(wc -c $f)&quot;     done }  cat &lt;&lt; EOF Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository Date: $(date -Ru) EOF do_hash &quot;MD5Sum&quot; &quot;md5sum&quot; do_hash &quot;SHA1&quot; &quot;sha1sum&quot; do_hash &quot;SHA256&quot; &quot;sha256sum&quot; &#39; &gt; ~/example/generate-release.sh &amp;&amp; chmod +x ~/example/generate-release.sh   Next let’s run the generate-release.sh script with:   cd ~/example/apt-repo/dists/stable ~/example/generate-release.sh &gt; Release   At this point, you can try hosting this repo for yourself. In this example we’ll use python’s simple HTTP server; however in practice you’ll want to use a production-ready server. Here’s how you can start it up for testing:   cd ~/example python3 -m http.server   Then configure this apt repository:   echo &quot;deb [arch=amd64] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.list   Then finally update apt and install our new hello-world package:   sudo apt-get update --allow-insecure-repositories sudo apt-get install hello-world   Note that the –allow-insecure-repositories will print the following warning message:  W: The repository &#39;http://127.0.0.1:8000/apt-repo stable Release&#39; is not signed. N: Data from such a repository can&#39;t be authenticated and is therefore potentially dangerous to use. N: See apt-secure(8) manpage for repository creation and user configuration details.  That flag should never be used in a production environment. In the next section we’ll cover how to sign the repository, so it can be used in a trusted manor. Similarly when we install hello-world, we are asked if we want to proceed with an un-authenticated package:  WARNING: The following packages cannot be authenticated!   hello-world Install these packages without verification? [y/N]  Fortunately in the next section we’ll cover generating a PGP key, and signing our repository with it, which will allow users to verify the repository contents have not been tampered with.   Step 3: Signing your apt Repository With GPG   In the previous step, we generated a Release file, which referenced one or more Packages files along with it’s corresponding md5, sha1, and sha256 hashes. The Packages file in turns references a deb package along with it’s md5, sha1, and sha256 hashes.   As of 2021, md5 and sha1 hashes are no longer considered secure; however sha256 is still considered to be secure. Therefore if a user can verify that the initial Release file has not been tampered with, then they could make use of the sha256 to verify the Packages file, then use the sha256 contained in the Packages file to verify the deb file.   In order to sign the apt repo, all we must do is sign the Release file.   PGP, GPG, and GnuPGP   PGP, OpenPGP, GnuPG, GPG, (and careful not to typo PHP).   Software has a lot of acronyms, and this extends into digital signatures. “Pretty Good Privacy” (PGP), was created in 1991 by Phil Zimmermann and eventually became the main product of non other than PGP Inc. To encourage adoption of PGP, the company created an open standard unsurprisingly called OpenPGP.   OpenPGP is only a specification, that’s where GNU Privacy Guard (GPG) fits in: GPG is an implementation of (Open)PGP. So is it a PGP key, or a GPG key? I don’t know, I’ve seen it called both, I’m going to call it a PGP because that’s what is contained in the first line of the armoured text: —–BEGIN PGP PUBLIC KEY BLOCK—–.   Creating a New Public/Private PGP Key Pair   Let’s start with generating a PGP key pair. We will use the –batch feature of gpg rather than using the interactive prompt. This has the benefit of generating keys in a repeatable way. First create a batch template by copying and pasting the following into your terminal:   echo &quot;%echo Generating an example PGP key Key-Type: RSA Key-Length: 4096 Name-Real: example Name-Email: example@example.com Expire-Date: 0 %no-ask-passphrase %no-protection %commit&quot; &gt; /tmp/example-pgp-key.batch   then we will generate it under a new temporary gpg keyring:   export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot; gpg --no-tty --batch --gen-key /tmp/example-pgp-key.batch   Since we overrode the GNUPGHOME to a temporary directory, we can keep this key separate from our other keys. Let’s take a quick look at the contents of the directory:   ls &quot;$GNUPGHOME/private-keys-v1.d&quot;   will show something along the lines of  A3FB218BA1929542FF110C7D1B077B6469F769C9.key  which contains binary data. We can also view all of our loaded keys with:   gpg --list-keys   which will show something similar to  /home/alex/example/pgpkeys-pyml86/pubring.kbx ------------------------------- pub   rsa4096 2021-05-18 [SCEA]       B4D5C8B003C50A38A7E85B5989376CAC59892E72 uid           [ultimate] example &lt;example@example.com&gt;  This PGP key is comprised of both a public key, and a private key. Let’s start with exporting the public key:   gpg --armor --export example &gt; ~/example/pgp-key.public   Alternatively, you can reference the key by the email address or even the associated hex code. This should result in a public key that looks like:  -----BEGIN PGP PUBLIC KEY BLOCK-----  mQINBGCkNmcBEADjEcDdne3ti5derY+hSPnhrBWeBba/1gb3S7lKwsysFlxeAApU mROTk7gijH84GofOkZzQw9PJEA4u4kkF6EFfOr+VS3JDt5kYjpGorXMD8iRtJAIq Y6hX7vqNDHpXFHSEEBIFCUF9E3yf8p7Wrohe0/6HVz1m/XAcU34zWY3a4zfgntsd r4hj1h3E/GkZEI8UpB+/LshzbIoZMEDy+EB3EX/oCstZc9aKTUZLP9q5r3CvbrJU s3354N+XFxCocVv4c/UFtcUI14EfQv7LVB2JRWYrit65DAHx87V4xcajqbkswvYn 4ela0DCW/Bw2jz1DaEHLGzn9me6z+YYH8VWbYqUJ/hrHHHSqjjSZ3S5E8gLVzTuf IpoWUCSNeZlltBqoWf4ei7Q4nhzFi7AkvLABSkmx7R1+7fOH0ZIN+M2G6lOgcHEU IiS7v6ygyj1U2h+38xn66dDH/gUhjp0zJfivMnC1c7pz7R4zNhFxyv1cyekP1nJA wmpW+Y5ja3qSJYCHGmrtNaQIVMo2Ho1aXZiMysaTXKp4CYluoUsh97GjLtksq834 y3+FHdGMt8dGFBCRlZ9BFr1B++FZvuovbLoS+ZREmXTQPXYhN0TinpmnSFJsY6DK 5zFOU9j3Mtmf77MxUA+xsKBQrDgGM76uN7ADTc0jrUo4hECxnXQkOGyYrQARAQAB tB1leGFtcGxlIDxleGFtcGxlQGV4YW1wbGUuY29tPokCTgQTAQoAOBYhBLTVyLAD xQo4p+hbWYk3bKxZiS5yBQJgpDZnAhsvBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheA AAoJEIk3bKxZiS5yTUMP/1nlYpQTf8tQgSwSVUM8jhBhdOEEzmsXy/90KgpjX9WF ABSC61SnGRonO60dn5CHT4oi0yJRKtsjJ3ZXLyxJY4Myop4ZCoJCcJw6sBOc3rvl GN4J4O3+DZn7KRGUKFmLgeuxie2tSHdWYkonlpGPQ34xLgKT6Uf1NQOcCLZpMBim 2kxNXnnQXLEKXlbm9xmi/koub1qpko01T9DT9g9mlkv56660+sOw0XNwGmPy6HJ2 2IND53LYDNQv4qbt00ws29AUmZ6WmlUB9oP/nMx56Urgvmn6p/CLB9vbwIAb6egq ZouUKsFAFyO5oVH3JoNBYbT84QewQv9BnJVQjuh0wK3OdCBjzT3YcBuRVwVJubKv nSjvkJtq20tgxDSPc5ostzMpT5ZnBV+VQa6fwqBgb7VIGEPQklo6IZRwDH0rX1IA Xpe2dZOvUICqvg17ol29uQ81BRpB7UynPDbgPDhBbELELPQN/GfaL+op8AB+cbga JgC1JcX08nOqnT9TMpfig4TEpL/BKO+3cFy0Sttm44zMrR1f1SiyXdjZTS715LM/ nmAQWCZFMqN+5nHfT6lwJlqmtRCvjvHPdZla8Ah6B9oB+vJs1cClYJLSZuun89P/ bmQ5z+qJwCUOEVhVcVPTHAkqCTX2apQBeAszcmk54bGc/Q6UKncOgvOkELS7VuPt =DYDE -----END PGP PUBLIC KEY BLOCK-----   If the exported key is much larger than this, you may have exported multiple keys which can cause issues with some repositories.    You can verify only a single key was exported by running:   cat ~/example/pgp-key.public | gpg --list-packets   and checking that only a single :public key packet: entry exists. It should look something like this:  # off=0 ctb=99 tag=6 hlen=3 plen=525 :public key packet:     version 4, algo 1, created 1621374567, expires 0     pkey[0]: [4096 bits]     pkey[1]: [17 bits]     keyid: 89376CAC59892E72 # off=528 ctb=b4 tag=13 hlen=2 plen=29 :user ID packet: &quot;example &lt;example@example.com&gt;&quot; # off=559 ctb=89 tag=2 hlen=3 plen=590 :signature packet: algo 1, keyid 89376CAC59892E72     version 4, created 1621374567, md5len 0, sigclass 0x13     digest algo 10, begin of digest 4d 43     hashed subpkt 33 len 21 (issuer fpr v4 B4D5C8B003C50A38A7E85B5989376CAC59892E72)     hashed subpkt 2 len 4 (sig created 2021-05-18)     hashed subpkt 27 len 1 (key flags: 2F)     hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)     hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)     hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)     hashed subpkt 30 len 1 (features: 01)     hashed subpkt 23 len 1 (keyserver preferences: 80)     subpkt 16 len 8 (issuer key ID 89376CAC59892E72)     data: [4095 bits]  Next let’s export the private key so we can back it up somewhere safe.   gpg --armor --export-secret-keys example &gt; ~/example/pgp-key.private   You should never share this key with anyone. If you look at the output file, it should look similar to this:  -----BEGIN PGP PRIVATE KEY BLOCK-----  lQcYBGCkPGEBEAC7P59Xp933LVYAKsDzDgMp/kc9SyLd8VxsqX4FEJ31/hMkl8Bh RPg1l40IuVP9nVf0W9LrLoHVI13uoUdMYJ7+ZoOihd7Qi6ePqgmWahx+U4hyUMeQ 2MtBV23A2HLfUxP/vOs3BgQxf6efDdZpf6Jyq7hLagXbBoGE0X02igj4ModMD7fy 8HpKbiXhIIqTFQM1V8EQVdERzY0aEzFD/hlKKj2+NdhhYB3UwnyKoIYXrsfEnGMy 8Yje2sr2HKXrqVBIOfqZls8MJrkMZHrMzWF9ZdBC+CJfN2/DG5bl/kBkZfpHq6Mn C3WPdRWOunJaDSahc7baghM4aSj5oEtaJ4e3CGi3vBajGDRXAbrDpuBPfuzyp6dI cqbNLTkriYq5idXx9XxD6EaGrkZ12U4JCvfhex4qsczQMl/AUNZDmW+9MB7J0ZdS tAUJCSbsM5B5663l9uVwI6is4PH18GX0b76EBjrYe8OcSljKLGXobtfZSIKd4zBf K6Fxs7gAST8VewApWjsLDGuBdLJcOcdftUxo/5Vg+c/ThtlxduOdsoB6+z/pVufj YAGMl388jeV34d+2FzH+VxedzdIO6tPN8G0WINLP7YyKmE89BccYKpIVd9fqYg/Y KIqF1zRbu7MtAMfpUsHt90Wctn6mLe7KR5BSoBzf3cu2RxbOlhWohOD7aQARAQAB AA/6ArEBa1MgX6MpL0tuBpBW/02GXJ0t3R7RA0bUZuI8QwLp54a+3ycMokiRYGS5 jlWqo/qF55d9ikC94uYyjih9YI68qaNe9oRrXidFiAHycuZkebArjitvkHrfOvxh elBJY02l296cRNHe6Oxb/pw1C4zoUz0s5F8NkYkpUZVeV6LySueW70kBmPxIUxoS o9aTezrNrZxuKuFXe952wNFwL5630HoZqBynkR1SiPORudlrSaotytep7fobHLqA sAh4/PDIZ1jBlR0hX8o58aOqGRFTkwLaC6BSXO2Sl6+14TuOA2W2LKN/hxZZvvlz F1RFD+EH6dAg0pjAXAYvzxXuX27V0aeKzxssbK0Xl/c6n3IMNHTdbAw17W4lg0fJ Omd9csGh0+wEGxsM30gqTT46Z5ixtZ6Q6zbpUBN3k4Lr5iW0BEBYIj4J0YVD2c0Q 3jKQ/xnrE1GjrBuVT4WIvKGaHlcrP/v+tg4AZjhZzwcRi84AlEOTTNjNkmQqDc02 1ogx5zZ8/RoNitswPd1v4Cj7zQzhozinEcv/8PJoCm1thbIUE84i7/vTEsmFm/gq Xh93/v8k8comM2EUVSrmJOuUWtTx9fCKLE34ZhyETVgl68thDp2oX6HQXPPkPOF5 Q3k4ujWd3tn1dTR9brPHtf0/9f/LQCLp5L+lNxOQzeHABgEIANYIwHxbIXEyojjS R6FG8FjPWVD7D2vo5V176V3N+ERjSBGwyDZ3sjqSuj+TnBNwiPL7XKKxNslXvww0 I8hLmhw3bEN9ZzmdZ5IIzUmEjDhUTDMmTF6C7HpnLpuuqpKRcwCRtnHJM/3umQpY l51MQNNbkKDYrU+1UVO6aTV3h56btPZSdKvyQ26zOf2UfDe2KdEaVruoCbnFnmBD oDerCeRf3MGc7nw21kMrJ9FPYZpMzKBqu5BI9OsB5Ju9LgAhsNW6Ux2+X0HvQQB3 GMLU3v1KsRiwwVLvsnGpA3j28XEsq5L17sqR6knSE/0e/X0SNyJXMX9NMNf0Whlw TZ1nF6EIAN/2Y5V7vOa6AHdOYSpmGNoeAWeOFLXDcDdL0U7tntWFnrnI4wGyziiz pH2T/wfuHp6b7PcL5YzCtYGaP7/omje7WjIkFl6rJcpynu/X80ogE88c1U7u7KDb dqjkWyonGnSmpTvLG3fF/MA1tJawUWDwFV65ahX3N0ZS7siZbGzaBFFfuw2uzdvY zP04bvFeQSuTeH/XxJ5n0Ea68JRkoHwITTRX9/Gi3mNwe4YkaXu4SebCqKl1pl0v NwTQBAWwYSKo0xibZF5WLcax3qvhGdyyunN/WaMO7oDwxiGKg7fFym2z9Fm6/XHv pOJukl9ujJxp2C0Gfn5c9aIueTDgrskH/3CfvxmOyLIeDN2OOvLV//5/srYTqDGz b7FW20r6IxbY4Jt9kFDcOWlzErsD2L3l0D1Xyv2rE7CaWErEfGbQaYqSJ8EBB6EI N24Q90pzkfaL84zNGrLRpxlSd5YknDh344wID0KFHLcYy1MHynLErQPexAQDsxCY sv+9BxjwK9pSLEvu6+hfKAmeRPCU8LPxjgnxLXhm92CklUGmZYVIMiFtwWKqwB3c vmFTW/4cgfuxVxYiriAE1DQ6VOPjweKpyPli1AcMkgPXG1dVD8DkQ5WR99jFoAs4 f2F+xbYp5cK/xoK8imCdI7TUEWd9jOpD5fgW3cI3jHf4UHZvJfVrTDCNAbQdZXhh bXBsZSA8ZXhhbXBsZUBleGFtcGxlLmNvbT6JAk4EEwEKADgWIQQjmwbKSoK7sgII vKnhkzUydQ6e7wUCYKQ8YQIbLwULCQgHAgYVCgkICwIEFgIDAQIeAQIXgAAKCRDh kzUydQ6e7wepD/981U87Qr9IBh1nMFyNuLpGpRwzNMiBP/KlOQ/7HTAVvOKAYYZT tTG5teVcwQX9PLStjsrqJ5owpjeHkX8qydioLbK8XFFlhxi/5X6YxYKUuBfky32w DN+B9gqbWc9xFcEyoSgM1aZBrvVB4GKC/vqlgNnU5TDaszMIeD40tNlXZa8fv7Ie Hz4Sgw3MrOzLdMjW3ZpoFiYsUX0fh4CB397pOXJlOam9doznhv5vYF6scVS9GU8D sF8fsa0fX9kciAEw863q21R/gvJF6SnjCGsDtlVVDXJZwex30JzYyeVHg6NWXpyp cs9vS9gfpETmgdG9/Sx8qcV4UCsoeSodaJ4slfFkTMMFbupb5YrXkf7B6pm5esTy eTsP08GiDS8LDe+BsvqYyi9GuLMknAyBPD8mTTB0/lU9eEt/lFAAGVcYsGuYdc9d dHFEvWWflPNNx7vXS1zwdCYd4RcnIYfpLurHbb79Yv2YVr9rOS1ivWZcfi5T8bdI WGPxI2rJ2gZYUB7w0t9s23qADaaf/MpgbekAyPGIxKEGGQGyv9kqzYmVZdfdRss3 MsMwELFwsvuUi1duyuXkbY+jJ+6qCfoWJF6zriJKNjIvjPFois9YAH3CGQP/5nsl rRYC0Psjil8wZAHa/sJePBtn+9Ol0atZ6QDvyr2r3fMHQiEe+mB0cpKnBw== =+Tgf -----END PGP PRIVATE KEY BLOCK-----   The above is a burner-key I created for this article. It’s never been used for anything aside from this article. You should be generating your own key, don’t use this one.    Now that we’ve generated a PGP key pair, let’s move on to signing files with them.   Signing the Release File   Before we start signing with out keys, let’s make sure that we can import the backup we made. To do that, we will create a new GPG keyring location:   export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot;   and then verify that it is empty:   gpg --list-keys   which should show something similar to:  gpg: keybox &#39;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx&#39; created gpg: /home/alex/example/pgpkeys-e7u1Ad/trustdb.gpg: trustdb created  Next we will import our backed up private key:   cat ~/example/pgp-key.private | gpg --import   which should show a similar imported message:  gpg: key 4E793BC948F34C6F: public key &quot;example &lt;example@example.com&gt;&quot; imported gpg: key 4E793BC948F34C6F: secret key imported gpg: Total number processed: 1 gpg:               imported: 1 gpg:       secret keys read: 1 gpg:   secret keys imported: 1  and now if we run gpg –list-keys, we should see it is now available:  /home/alex/example/pgpkeys-e7u1Ad/pubring.kbx --------------------------------------------- pub   rsa4096 2021-05-18 [SCEA]       CFBFFC9CCD163CC7E1768BFF4E793BC948F34C6F uid           [ unknown] example &lt;example@example.com&gt;  Ok, let’s get around to signing the Release file now.   cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs &gt; ~/example/apt-repo/dists/stable/Release.gpg   The contents of Release.gpg should be similar to this:  -----BEGIN PGP SIGNATURE-----  iQJIBAABCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkTYYUHGV4YW1wbGVA ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG+f2g//QpVA4RP5qp2mAlolhqKCqLr6r7DX mUC5ueSISXlRwVK7l0xFADqw4uHsl+T0DIeX7K/efHyyqIYq+t8fCA8HbB5CmWFk 2rOa9jFR4G+afJ1mdfQYUHshwEzY+NIScg3suO0ZeILFXcTW6a6AzlwqI3pVy/b8 o/FCjj4hBnaPysDS1BmPqxjWvt5ilQR3RTodsFahr2FncmgZI8zvrbCey630O/Cs ELLp9fqBQj//FEje/JgHtG6E85qjsod0Nstu5h2yEs9iwMP1+peMB80NLpyeacpS CWbZmFgxqKL7JNSx04T8epL23Zg6trrzhvOzOiVp2+Ilg438LBrErSVO+3puWT2e bR3jpFSg9ej0+90QnG3IIkZW1RSkitlpNiFGFrUvlBRE9tSjZMK10EofPtzENEWN uXYqjcWTJxp6R7d1IW/lTFzwdCPorgBPBbjmJ7Ux5YWZP7jjJmFpF9jSHVz6xDcp oUBQcF4jHn5ewh0yKZQbqA3ZRXpPBDSNSraIDFToeFzhV94FQR2f5A5FgBR8n/Kr Gfb76dsKabwVJlr7z8+W2C8gHmOe4dlVVUje3bxo05VNwZEBPbRldFox4GKIWT46 FbXyzB/EfRR7rzmaRfIpDfQa6hLOoivlat1no6akT7bK2mE7Y0L+Kae1dP+BpBUe BqY84ZTkmQiOL0c= =Dqab -----END PGP SIGNATURE-----  Now when an apt client performs an update, it will fetch both Release and Release.gpg and will verify the signature is valid; However to increase the speed, we will create a third file InRelease which will combine both the contents of Release and the PGP signature:   cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs --clearsign &gt; ~/example/apt-repo/dists/stable/InRelease   The contents of InRelease should be similar to this:  -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512  Origin: Example Repository Label: Example Suite: stable Codename: stable Version: 1.0 Architectures: amd64 arm64 arm7 Components: main Description: An example software repository Date: Tue, 18 May 2021 01:17:46 +0000 MD5Sum:  d47739655e6312da85a96711f78c78db 405 main/binary-amd64/Packages SHA1:  d6aa46cf29cca1b01af6e9e256bf963ff5dfdaeb 405 main/binary-amd64/Packages SHA256:  3b888d4257fcf475fc06f74bd46045c3f1d667562fdb37e86f5bea642efa49f8 405 main/binary-amd64/Packages -----BEGIN PGP SIGNATURE-----  iQJIBAEBCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkT1wUHGV4YW1wbGVA ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG8w/RAAwB6HRyZWVOWT1A0OJAt+RlLREjev gfRZVLZRDv18QRZKCcj71v0Ki1hX3xWE8WVjIR9eSXNf1wJvqza+/FBGN00NY1Bk AFmypZP/04kjwGeUtULopLB1KrCaFdWuC9W49zUyeElIz1owX9tk+SsoLB7hGLQE jtweFjxhaMeCHgSJIXDoR0RpmKBuydtB3UTHjCQJBvErkYfKrAJQCDYDz+XVPLh6 XPAohVb6SO4qBCxX30QcQpUVDRtMMRKbIOD5B+hjCP5cupvej1fBlzlFh4lBIywj eUXrwBxmOiO/yrsYNoJJB+mV9u1mEpQDo7yRDCICsY2c/Io/Q0CxiEIIwoEfHCb/ WOFYYmUj1Sh9YARi74eTblMyr/Ay/9+opEr54uAixecJyC/kqsC3uptH4ZpOSwTw hdj24Cl2veYmiCimPB4QCLOsCU5A1phwEkgADUOh4iRaszuzGkh/NZ0al0dCF0HY /UsDuiMzEQGOP6ByILt1zoPrnwZKFDEbYjzSbjSXfkU9LKfrp5PWgeeq5iD58sQW ZCE34ksK8W67GOtQuzy0Z8NlTJY1Mkzp7IsUt60owyv6dQVZFIPYwGEisGFSOCNk 3VZ66m1D6HtDZ60CZEJUhfu+WTC1K95cKYkhYArBR9pDecygYomLQVFO2T1ENxCA BKaAtOSl2Jcb4eA= =3Hft -----END PGP SIGNATURE-----  Testing It Out   We need to tell apt which public pgp key to use when verifying the apt repository. We will add a new signed-by attribute to our apt config:   echo &quot;deb [arch=amd64 signed-by=$HOME/example/pgp-key.public] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.list    note that $HOME should be expanded to the absolute path of the pgp key.    Next start back up your web server:   cd ~/example python3 -m http.server   Then finally try updating and re-installing our hello-world package:   sudo apt-get clean sudo apt-get update sudo apt-get install hello-world   This time you shouldn’t see any security warnings.   Keeping Your Private Key Secure   If you followed this tutorial to the tee, and your web server is still running, what happens if we try running:   curl http://127.0.0.1:8000/pgp-key.private   Oh no! we just leaked our private key. Now’s the time to regenerate it but using a real name and email address other than example@example.com. Maybe you can store it in earthly’s secret store instead?   Appendix A: A Complete Example using Earthly   A complete example has been created under github.com/earthly/example-apt-repo/Earthfile.   This Earthfile contains all the above steps from this tutorial in a single location, which can be run directly in a single shot with:   earthly -P github.com/earthly/example-apt-repo:main+test   Alternatively, you can clone the repo and run +test directly.">
  <meta name="twitter:url" content="https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://earthly.dev/blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-762-c7694d9ec.jpg">
  

  



  <meta property="article:published_time" content="2021-06-01T00:00:00-04:00">





  

  


<link rel="canonical" href="https://earthly.dev/blog/creating-and-hosting-your-own-deb-packages-and-apt-repo/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Organization",
      "url": "https://earthly.dev/blog/",
      "logo": "/assets/images/logo-header.png"
    
  }
</script>






<!-- end _includes/seo.html -->



  <link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="Earthly Blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/blog/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


  
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-161831101-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-161831101-5');
</script>
  <!-- Facebook Pixel Code -->
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '259843109045285');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=259843109045285&ev=PageView&noscript=1"
    />
</noscript>
 <!-- End Facebook Pixel Code -->
  <!-- Twitter universal website tag code -->
<script>
  !function(e,t,n,s,u,a){e.twq||(s=e.twq=function(){s.exe?s.exe.apply(s,arguments):s.queue.push(arguments);
  },s.version='1.1',s.queue=[],u=t.createElement(n),u.async=!0,u.src='//static.ads-twitter.com/uwt.js',
  a=t.getElementsByTagName(n)[0],a.parentNode.insertBefore(u,a))}(window,document,'script');
  // Insert Twitter Pixel ID and Standard Event data below
  twq('init','o5s6p');
  twq('track','PageView');
  </script>
  <!-- End Twitter universal website tag code -->


  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/blog/assets/images/white-logo.png" alt="Earthly"></a>
        
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/blog/">Blog home</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/articles/">Articles</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/news/">News</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/categories/tutorials/">Tutorials</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/earthly/earthly">GitHub</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  







<div class="page__hero"
  style=" background-image: url('');"
>
  
      <picture class="page__hero-image"><source srcset="/blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-400-f99309feb.webp 400w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-600-f99309feb.webp 600w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-800-f99309feb.webp 800w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-1000-f99309feb.webp 1000w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-1200-f99309feb.webp 1200w" type="image/webp"><source srcset="/blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-400-f99309feb.png 400w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-600-f99309feb.png 600w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-800-f99309feb.png 800w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-1000-f99309feb.png 1000w, /blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-1200-f99309feb.png 1200w" type="image/png"><img src="/blog/generated/assets/images/creating-and-hosting-your-own-deb-packages-and-apt-repo/header-800-f99309feb.jpg" alt="Creating and hosting your own deb packages and apt repo"></picture>

  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar">
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Creating and hosting your own deb packages and apt repo">
    <meta itemprop="description" content="As an Ubuntu user, I find myself typing apt install … frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests. PrerequisitesThis tutorial assumes you are using Ubuntu, and that the following packages are installed:sudo apt-get install -y gcc dpkg-dev gpgStep 0: Creating a Simple Hello World ProgramBefore getting started with packaging, let’s create a basic hello world program under ~/example/hello-world-program. To do this, you can copy and paste the following commands into your terminal:mkdir -p ~/example/hello-world-programecho &#39;#include &lt;stdio.h&gt;int main() {    printf(&quot;hello packaged world\n&quot;);    return 0;}&#39; &gt; ~/example/hello-world-program/hello.cThen, you can compile it with:cd ~/example/hello-world-programgcc -o hello-world hello.cThere’s no technical reason for picking C for this example – the language doesn’t matter. It’s the binary we will be distributing in our deb package.Step 1: Creating a deb PackageDebian, and Debian-based Linux distributions use .deb packages to package and distribute programs. To start we will create a directory in the form:&lt;package-name&gt;_&lt;version&gt;-&lt;release-number&gt;_&lt;architecture&gt;where thepackage-name is the name of our package, hello-world in our case,version is the version of the software, 0.0.1 in our case,release-number is used to track different releases of the same software version; it’s usually set to 1, but hypothetically if there was an error in the packaging (e.g. a file was missed, or the description had an error in it, or a post-install script was wrong), this number would be increased to track the change, andarchitecture is the target architecture of the platform, amd64 in this example; however if your package is architecture-independent (e.g. a python script), then you can set this to all.Theoretically, the directory doesn’t have to follow this naming convention; however some of the tools we will use later in the tutorial require this directory naming convention.So for this example, we’ll create the directory with:mkdir -p ~/example/hello-world_0.0.1-1_amd64This directory will be the root of the package. Since we want our hello-world binary to be installed system wide, we’ll have to store it under usr/bin/hello-world with the following commands:cd ~/example/hello-world_0.0.1-1_amd64mkdir -p usr/bincp ~/example/hello-world-program/hello-world usr/bin/.Each package requires a control file which needs to be located under the DEBIAN directory. You can copy and paste the following to create one:mkdir -p ~/example/hello-world_0.0.1-1_amd64/DEBIANecho &quot;Package: hello-worldVersion: 0.0.1Maintainer: example &lt;example@example.com&gt;Depends: libc6Architecture: amd64Homepage: http://example.comDescription: A program that prints hello&quot; \&gt; ~/example/hello-world_0.0.1-1_amd64/DEBIAN/controlNote that we’re assuming an amd64 Architecture for this tutorial, if your binary is for a different architecture, adjust accordingly. If you’re distributing a platform-independent package, you can set the architecture to all.By this point you should have created two files:~/example/hello-world_0.0.1-1_amd64/usr/bin/hello-world~/example/hello-world_0.0.1-1_amd64/DEBIAN/controlTo build the .deb package, run:dpkg --build ~/example/hello-world_0.0.1-1_amd64This will output a deb package under ~/example/hello-world_0.0.1.deb.You can inspect the info of the deb by running:dpkg-deb --info ~/example/hello-world_0.0.1.debwhich will show:new Debian package, version 2.0.size 2832 bytes: control archive=336 bytes.    182 bytes,     7 lines      controlPackage: hello-worldVersion: 0.0.1Maintainer: example &lt;example@example.com&gt;Depends: libc6Architecture: amd64Homepage: http://example.comDescription: A program that prints helloYou can also view the contents by running:dpkg-deb --contents ~/example/hello-world_0.0.1.debwhich will show:drwxrwxr-x alex/alex         0 2021-05-17 16:21 ./drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/bin/-rwxrwxr-x alex/alex     16696 2021-05-17 16:18 ./usr/bin/hello-worldIt’s also possible to run less ~/example/hello-world_0.0.1.deb which will output the above information, thanks to /bin/lesspipe.This package can then be installed using the -f option under apt-get install:sudo apt-get install -f ~/example/hello-world_0.0.1-1_amd64.debThen once installed, you can verify it works with commands like:which hello-worldandhello-worldwhich should output /usr/bin/hello-world and hello packaged world respectively.Finally, if you want to remove it, you can run:sudo apt-get remove hello-worldThis concludes the first step of building a .deb package. If you have access to an existing apt repository, you could submit the deb to the repository maintainer, and call it a day.Step 2: Creating an apt RepositoryIn this step, we will show how to create your own apt repository which can be used to host one or more deb packages.Let’s start with creating a directory to hold our debs:mkdir -p ~/example/apt-repo/pool/main/Then copy our deb(s) into this directory:cp ~/example/hello-world_0.0.1-1_amd64.deb ~/example/apt-repo/pool/main/.Larger apt repositories create sub-directories for each program or project. For example, the official Ubuntu apt repository stores all vim related packages under /ubuntu/pool/main/v/vim/.Once you’ve copied in all of your debs, we will create a different directory to contain a list of all available packages and corresponding metadata:mkdir -p ~/example/apt-repo/dists/stable/main/binary-amd64If you want to support multiple architectures, make a directory above for each type (e.g. i386, amd64, etc).Next, we will generate a Packages file, which will contain a list of all available packages in this repository. We will use the dpkg-scanpackages program to generate it, by running:cd ~/example/apt-repodpkg-scanpackages --arch amd64 pool/ &gt; dists/stable/main/binary-amd64/PackagesIt’s also good practice to compress the packages file, as apt will favour downloading compressed data whenever available. Let’s do this by running:cat dists/stable/main/binary-amd64/Packages | gzip -9 &gt; dists/stable/main/binary-amd64/Packages.gzLet’s take a quick look at the contents of the Packages file:Package: hello-worldVersion: 0.0.1Architecture: amd64Maintainer: example &lt;example@example.com&gt;Depends: libc6Filename: pool/main/hello-world_0.0.1-1_amd64.debSize: 2832MD5sum: 3eba602abba5d6ea2a924854d014f4a7SHA1: e300cabc138ac16b64884c9c832da4f811ea40fbSHA256: 6e314acd7e1e97e11865c11593362c65db9616345e1e34e309314528c5ef19a6Homepage: http://example.comDescription: A program that prints helloif you had multiple deb files, you would have an entry for each packageThe contents of the Packages file is a list of all available packages along with metadata from the DEBIAN/control file, and some hashes which can be used to validate the integrity of the package.Next we will create a Release file. Unfortunately dpkg-scanpackages does not create Release files. Some people use programs like apt-ftparchive; however in this example I’ll cover an alternative to apt-ftparchive by using a small bash script.First let’s look at an example of a Release file, which can be broken up into two parts:Metadata about the repository, for example:Origin: Example RepositoryLabel: ExampleSuite: stableCodename: stableVersion: 1.0Architectures: amd64 arm64 arm7Components: mainDescription: An example software repositoryA list of all Packages files and their corresponding hashes and file size, for example:MD5Sum: 9eb0c0528a0647daf18c7e225ac68f45 667 main/binary-amd64/Packages.gz 628682afa8a0208e08b5a208a4c4c85b 1685 main/binary-amd64/Packages b5bef2199e86a43ae02adc0b7b38bc8a 556 main/binary-arm7/Packages.gz 81c53db3b9c5e9de44d3ca9fc4487995 1289 main/binary-arm7/Packages 15258b054124639f0641c399f291af17 557 main/binary-arm64/Packages.gz dc597a0815aebb56b25a4ad979682f49 1292 main/binary-arm64/PackagesSHA1: a4074284eb528e5d16c2c94e203d61dd825fa774 667 main/binary-amd64/Packages.gz ee86dd9061967232e6e68104a695f7d45d191b41 1685 main/binary-amd64/Packages a6f4897bcf6a4b068c5b8fafca01fc89761106dc 556 main/binary-arm7/Packages.gz 43171192ce84dcb43bba99828fe7493ff23e0b0e 1289 main/binary-arm7/Packages 9f353a909a9a3dab0a9cae1a3c7ccb879ff18d32 557 main/binary-arm64/Packages.gz da15c24e51a028ff591656eef0d1da0dbb85ba97 1292 main/binary-arm64/PackagesSHA256: dee57f6f4a2209b63301984acb4b279f694648915fd559287a414365884c1842 667 main/binary-amd64/Packages.gz 7d82e5929d909d10d9f2d7129df3f6754946397caf1c08e9e4a65713f4ac39ff 1685 main/binary-amd64/Packages 2b3c611305e096ef246d77d2bc5fcfa807034dd200f8f99005ab640cf2c014a4 556 main/binary-arm7/Packages.gz d03d5192e24e098a91465ab37d34e0a2c539f50a430eb3262a543e7bd11212a1 1289 main/binary-arm7/Packages f96316ff77e96d246447f0ca8383472acefc0744d9b49d2be1d214d174bba38a 557 main/binary-arm64/Packages.gz 58120a7b5ceb57ab4faca01adac3d62009a52962e0d0a6f4b7ceb1b8faedf280 1292 main/binary-arm64/PackagesAnd that’s it for what a Release file looks like. How hard could it be? let’s write some bash. Just copy and paste the following in your terminal to get a copy of the script:echo &#39;#!/bin/shset -edo_hash() {    HASH_NAME=$1    HASH_CMD=$2    echo &quot;${HASH_NAME}:&quot;    for f in $(find -type f); do        f=$(echo $f | cut -c3-) # remove ./ prefix        if [ &quot;$f&quot; = &quot;Release&quot; ]; then            continue        fi        echo &quot; $(${HASH_CMD} ${f}  | cut -d&quot; &quot; -f1) $(wc -c $f)&quot;    done}cat &lt;&lt; EOFOrigin: Example RepositoryLabel: ExampleSuite: stableCodename: stableVersion: 1.0Architectures: amd64 arm64 arm7Components: mainDescription: An example software repositoryDate: $(date -Ru)EOFdo_hash &quot;MD5Sum&quot; &quot;md5sum&quot;do_hash &quot;SHA1&quot; &quot;sha1sum&quot;do_hash &quot;SHA256&quot; &quot;sha256sum&quot;&#39; &gt; ~/example/generate-release.sh &amp;&amp; chmod +x ~/example/generate-release.shNext let’s run the generate-release.sh script with:cd ~/example/apt-repo/dists/stable~/example/generate-release.sh &gt; ReleaseAt this point, you can try hosting this repo for yourself. In this example we’ll use python’s simple HTTP server; however in practice you’ll want to use a production-ready server. Here’s how you can start it up for testing:cd ~/examplepython3 -m http.serverThen configure this apt repository:echo &quot;deb [arch=amd64] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.listThen finally update apt and install our new hello-world package:sudo apt-get update --allow-insecure-repositoriessudo apt-get install hello-worldNote that the –allow-insecure-repositories will print the following warning message:W: The repository &#39;http://127.0.0.1:8000/apt-repo stable Release&#39; is not signed.N: Data from such a repository can&#39;t be authenticated and is therefore potentially dangerous to use.N: See apt-secure(8) manpage for repository creation and user configuration details.That flag should never be used in a production environment. In the next section we’ll cover how to sign the repository, so it can be used in a trusted manor. Similarly when we install hello-world, we are asked if we want to proceed with an un-authenticated package:WARNING: The following packages cannot be authenticated!  hello-worldInstall these packages without verification? [y/N]Fortunately in the next section we’ll cover generating a PGP key, and signing our repository with it, which will allow users to verify the repository contents have not been tampered with.Step 3: Signing your apt Repository With GPGIn the previous step, we generated a Release file, which referenced one or more Packages files along with it’s corresponding md5, sha1, and sha256 hashes. The Packages file in turns references a deb package along with it’s md5, sha1, and sha256 hashes.As of 2021, md5 and sha1 hashes are no longer considered secure; however sha256 is still considered to be secure. Therefore if a user can verify that the initial Release file has not been tampered with, then they could make use of the sha256 to verify the Packages file, then use the sha256 contained in the Packages file to verify the deb file.In order to sign the apt repo, all we must do is sign the Release file.PGP, GPG, and GnuPGPPGP, OpenPGP, GnuPG, GPG, (and careful not to typo PHP).Software has a lot of acronyms, and this extends into digital signatures. “Pretty Good Privacy” (PGP), was created in 1991 by Phil Zimmermann and eventually became the main product of non other than PGP Inc. To encourage adoption of PGP, the company created an open standard unsurprisingly called OpenPGP.OpenPGP is only a specification, that’s where GNU Privacy Guard (GPG) fits in: GPG is an implementation of (Open)PGP. So is it a PGP key, or a GPG key? I don’t know, I’ve seen it called both, I’m going to call it a PGP because that’s what is contained in the first line of the armoured text: —–BEGIN PGP PUBLIC KEY BLOCK—–.Creating a New Public/Private PGP Key PairLet’s start with generating a PGP key pair. We will use the –batch feature of gpg rather than using the interactive prompt. This has the benefit of generating keys in a repeatable way. First create a batch template by copying and pasting the following into your terminal:echo &quot;%echo Generating an example PGP keyKey-Type: RSAKey-Length: 4096Name-Real: exampleName-Email: example@example.comExpire-Date: 0%no-ask-passphrase%no-protection%commit&quot; &gt; /tmp/example-pgp-key.batchthen we will generate it under a new temporary gpg keyring:export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot;gpg --no-tty --batch --gen-key /tmp/example-pgp-key.batchSince we overrode the GNUPGHOME to a temporary directory, we can keep this key separate from our other keys. Let’s take a quick look at the contents of the directory:ls &quot;$GNUPGHOME/private-keys-v1.d&quot;will show something along the lines ofA3FB218BA1929542FF110C7D1B077B6469F769C9.keywhich contains binary data. We can also view all of our loaded keys with:gpg --list-keyswhich will show something similar to/home/alex/example/pgpkeys-pyml86/pubring.kbx-------------------------------pub   rsa4096 2021-05-18 [SCEA]      B4D5C8B003C50A38A7E85B5989376CAC59892E72uid           [ultimate] example &lt;example@example.com&gt;This PGP key is comprised of both a public key, and a private key. Let’s start with exporting the public key:gpg --armor --export example &gt; ~/example/pgp-key.publicAlternatively, you can reference the key by the email address or even the associated hex code. This should result in a public key that looks like:-----BEGIN PGP PUBLIC KEY BLOCK-----mQINBGCkNmcBEADjEcDdne3ti5derY+hSPnhrBWeBba/1gb3S7lKwsysFlxeAApUmROTk7gijH84GofOkZzQw9PJEA4u4kkF6EFfOr+VS3JDt5kYjpGorXMD8iRtJAIqY6hX7vqNDHpXFHSEEBIFCUF9E3yf8p7Wrohe0/6HVz1m/XAcU34zWY3a4zfgntsdr4hj1h3E/GkZEI8UpB+/LshzbIoZMEDy+EB3EX/oCstZc9aKTUZLP9q5r3CvbrJUs3354N+XFxCocVv4c/UFtcUI14EfQv7LVB2JRWYrit65DAHx87V4xcajqbkswvYn4ela0DCW/Bw2jz1DaEHLGzn9me6z+YYH8VWbYqUJ/hrHHHSqjjSZ3S5E8gLVzTufIpoWUCSNeZlltBqoWf4ei7Q4nhzFi7AkvLABSkmx7R1+7fOH0ZIN+M2G6lOgcHEUIiS7v6ygyj1U2h+38xn66dDH/gUhjp0zJfivMnC1c7pz7R4zNhFxyv1cyekP1nJAwmpW+Y5ja3qSJYCHGmrtNaQIVMo2Ho1aXZiMysaTXKp4CYluoUsh97GjLtksq834y3+FHdGMt8dGFBCRlZ9BFr1B++FZvuovbLoS+ZREmXTQPXYhN0TinpmnSFJsY6DK5zFOU9j3Mtmf77MxUA+xsKBQrDgGM76uN7ADTc0jrUo4hECxnXQkOGyYrQARAQABtB1leGFtcGxlIDxleGFtcGxlQGV4YW1wbGUuY29tPokCTgQTAQoAOBYhBLTVyLADxQo4p+hbWYk3bKxZiS5yBQJgpDZnAhsvBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheAAAoJEIk3bKxZiS5yTUMP/1nlYpQTf8tQgSwSVUM8jhBhdOEEzmsXy/90KgpjX9WFABSC61SnGRonO60dn5CHT4oi0yJRKtsjJ3ZXLyxJY4Myop4ZCoJCcJw6sBOc3rvlGN4J4O3+DZn7KRGUKFmLgeuxie2tSHdWYkonlpGPQ34xLgKT6Uf1NQOcCLZpMBim2kxNXnnQXLEKXlbm9xmi/koub1qpko01T9DT9g9mlkv56660+sOw0XNwGmPy6HJ22IND53LYDNQv4qbt00ws29AUmZ6WmlUB9oP/nMx56Urgvmn6p/CLB9vbwIAb6egqZouUKsFAFyO5oVH3JoNBYbT84QewQv9BnJVQjuh0wK3OdCBjzT3YcBuRVwVJubKvnSjvkJtq20tgxDSPc5ostzMpT5ZnBV+VQa6fwqBgb7VIGEPQklo6IZRwDH0rX1IAXpe2dZOvUICqvg17ol29uQ81BRpB7UynPDbgPDhBbELELPQN/GfaL+op8AB+cbgaJgC1JcX08nOqnT9TMpfig4TEpL/BKO+3cFy0Sttm44zMrR1f1SiyXdjZTS715LM/nmAQWCZFMqN+5nHfT6lwJlqmtRCvjvHPdZla8Ah6B9oB+vJs1cClYJLSZuun89P/bmQ5z+qJwCUOEVhVcVPTHAkqCTX2apQBeAszcmk54bGc/Q6UKncOgvOkELS7VuPt=DYDE-----END PGP PUBLIC KEY BLOCK-----If the exported key is much larger than this, you may have exported multiple keys which can cause issues with some repositories.You can verify only a single key was exported by running:cat ~/example/pgp-key.public | gpg --list-packetsand checking that only a single :public key packet: entry exists. It should look something like this:# off=0 ctb=99 tag=6 hlen=3 plen=525:public key packet:    version 4, algo 1, created 1621374567, expires 0    pkey[0]: [4096 bits]    pkey[1]: [17 bits]    keyid: 89376CAC59892E72# off=528 ctb=b4 tag=13 hlen=2 plen=29:user ID packet: &quot;example &lt;example@example.com&gt;&quot;# off=559 ctb=89 tag=2 hlen=3 plen=590:signature packet: algo 1, keyid 89376CAC59892E72    version 4, created 1621374567, md5len 0, sigclass 0x13    digest algo 10, begin of digest 4d 43    hashed subpkt 33 len 21 (issuer fpr v4 B4D5C8B003C50A38A7E85B5989376CAC59892E72)    hashed subpkt 2 len 4 (sig created 2021-05-18)    hashed subpkt 27 len 1 (key flags: 2F)    hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)    hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)    hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)    hashed subpkt 30 len 1 (features: 01)    hashed subpkt 23 len 1 (keyserver preferences: 80)    subpkt 16 len 8 (issuer key ID 89376CAC59892E72)    data: [4095 bits]Next let’s export the private key so we can back it up somewhere safe.gpg --armor --export-secret-keys example &gt; ~/example/pgp-key.privateYou should never share this key with anyone. If you look at the output file, it should look similar to this:-----BEGIN PGP PRIVATE KEY BLOCK-----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=+Tgf-----END PGP PRIVATE KEY BLOCK-----The above is a burner-key I created for this article. It’s never been used for anything aside from this article. You should be generating your own key, don’t use this one.Now that we’ve generated a PGP key pair, let’s move on to signing files with them.Signing the Release FileBefore we start signing with out keys, let’s make sure that we can import the backup we made. To do that, we will create a new GPG keyring location:export GNUPGHOME=&quot;$(mktemp -d ~/example/pgpkeys-XXXXXX)&quot;and then verify that it is empty:gpg --list-keyswhich should show something similar to:gpg: keybox &#39;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx&#39; createdgpg: /home/alex/example/pgpkeys-e7u1Ad/trustdb.gpg: trustdb createdNext we will import our backed up private key:cat ~/example/pgp-key.private | gpg --importwhich should show a similar imported message:gpg: key 4E793BC948F34C6F: public key &quot;example &lt;example@example.com&gt;&quot; importedgpg: key 4E793BC948F34C6F: secret key importedgpg: Total number processed: 1gpg:               imported: 1gpg:       secret keys read: 1gpg:   secret keys imported: 1and now if we run gpg –list-keys, we should see it is now available:/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx---------------------------------------------pub   rsa4096 2021-05-18 [SCEA]      CFBFFC9CCD163CC7E1768BFF4E793BC948F34C6Fuid           [ unknown] example &lt;example@example.com&gt;Ok, let’s get around to signing the Release file now.cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs &gt; ~/example/apt-repo/dists/stable/Release.gpgThe contents of Release.gpg should be similar to this:-----BEGIN PGP SIGNATURE-----iQJIBAABCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkTYYUHGV4YW1wbGVAZXhhbXBsZS5jb20ACgkQTnk7yUjzTG+f2g//QpVA4RP5qp2mAlolhqKCqLr6r7DXmUC5ueSISXlRwVK7l0xFADqw4uHsl+T0DIeX7K/efHyyqIYq+t8fCA8HbB5CmWFk2rOa9jFR4G+afJ1mdfQYUHshwEzY+NIScg3suO0ZeILFXcTW6a6AzlwqI3pVy/b8o/FCjj4hBnaPysDS1BmPqxjWvt5ilQR3RTodsFahr2FncmgZI8zvrbCey630O/CsELLp9fqBQj//FEje/JgHtG6E85qjsod0Nstu5h2yEs9iwMP1+peMB80NLpyeacpSCWbZmFgxqKL7JNSx04T8epL23Zg6trrzhvOzOiVp2+Ilg438LBrErSVO+3puWT2ebR3jpFSg9ej0+90QnG3IIkZW1RSkitlpNiFGFrUvlBRE9tSjZMK10EofPtzENEWNuXYqjcWTJxp6R7d1IW/lTFzwdCPorgBPBbjmJ7Ux5YWZP7jjJmFpF9jSHVz6xDcpoUBQcF4jHn5ewh0yKZQbqA3ZRXpPBDSNSraIDFToeFzhV94FQR2f5A5FgBR8n/KrGfb76dsKabwVJlr7z8+W2C8gHmOe4dlVVUje3bxo05VNwZEBPbRldFox4GKIWT46FbXyzB/EfRR7rzmaRfIpDfQa6hLOoivlat1no6akT7bK2mE7Y0L+Kae1dP+BpBUeBqY84ZTkmQiOL0c==Dqab-----END PGP SIGNATURE-----Now when an apt client performs an update, it will fetch both Release and Release.gpg and will verify the signature is valid; However to increase the speed, we will create a third file InRelease which will combine both the contents of Release and the PGP signature:cat ~/example/apt-repo/dists/stable/Release | gpg --default-key example -abs --clearsign &gt; ~/example/apt-repo/dists/stable/InReleaseThe contents of InRelease should be similar to this:-----BEGIN PGP SIGNED MESSAGE-----Hash: SHA512Origin: Example RepositoryLabel: ExampleSuite: stableCodename: stableVersion: 1.0Architectures: amd64 arm64 arm7Components: mainDescription: An example software repositoryDate: Tue, 18 May 2021 01:17:46 +0000MD5Sum: d47739655e6312da85a96711f78c78db 405 main/binary-amd64/PackagesSHA1: d6aa46cf29cca1b01af6e9e256bf963ff5dfdaeb 405 main/binary-amd64/PackagesSHA256: 3b888d4257fcf475fc06f74bd46045c3f1d667562fdb37e86f5bea642efa49f8 405 main/binary-amd64/Packages-----BEGIN PGP SIGNATURE-----iQJIBAEBCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkT1wUHGV4YW1wbGVAZXhhbXBsZS5jb20ACgkQTnk7yUjzTG8w/RAAwB6HRyZWVOWT1A0OJAt+RlLREjevgfRZVLZRDv18QRZKCcj71v0Ki1hX3xWE8WVjIR9eSXNf1wJvqza+/FBGN00NY1BkAFmypZP/04kjwGeUtULopLB1KrCaFdWuC9W49zUyeElIz1owX9tk+SsoLB7hGLQEjtweFjxhaMeCHgSJIXDoR0RpmKBuydtB3UTHjCQJBvErkYfKrAJQCDYDz+XVPLh6XPAohVb6SO4qBCxX30QcQpUVDRtMMRKbIOD5B+hjCP5cupvej1fBlzlFh4lBIywjeUXrwBxmOiO/yrsYNoJJB+mV9u1mEpQDo7yRDCICsY2c/Io/Q0CxiEIIwoEfHCb/WOFYYmUj1Sh9YARi74eTblMyr/Ay/9+opEr54uAixecJyC/kqsC3uptH4ZpOSwTwhdj24Cl2veYmiCimPB4QCLOsCU5A1phwEkgADUOh4iRaszuzGkh/NZ0al0dCF0HY/UsDuiMzEQGOP6ByILt1zoPrnwZKFDEbYjzSbjSXfkU9LKfrp5PWgeeq5iD58sQWZCE34ksK8W67GOtQuzy0Z8NlTJY1Mkzp7IsUt60owyv6dQVZFIPYwGEisGFSOCNk3VZ66m1D6HtDZ60CZEJUhfu+WTC1K95cKYkhYArBR9pDecygYomLQVFO2T1ENxCABKaAtOSl2Jcb4eA==3Hft-----END PGP SIGNATURE-----Testing It OutWe need to tell apt which public pgp key to use when verifying the apt repository. We will add a new signed-by attribute to our apt config:echo &quot;deb [arch=amd64 signed-by=$HOME/example/pgp-key.public] http://127.0.0.1:8000/apt-repo stable main&quot; | sudo tee /etc/apt/sources.list.d/example.listnote that $HOME should be expanded to the absolute path of the pgp key.Next start back up your web server:cd ~/examplepython3 -m http.serverThen finally try updating and re-installing our hello-world package:sudo apt-get cleansudo apt-get updatesudo apt-get install hello-worldThis time you shouldn’t see any security warnings.Keeping Your Private Key SecureIf you followed this tutorial to the tee, and your web server is still running, what happens if we try running:curl http://127.0.0.1:8000/pgp-key.privateOh no! we just leaked our private key. Now’s the time to regenerate it but using a real name and email address other than example@example.com. Maybe you can store it in earthly’s secret store instead?Appendix A: A Complete Example using EarthlyA complete example has been created under github.com/earthly/example-apt-repo/Earthfile.This Earthfile contains all the above steps from this tutorial in a single location, which can be run directly in a single shot with:earthly -P github.com/earthly/example-apt-repo:main+testAlternatively, you can clone the repo and run +test directly.  ">
    <meta itemprop="datePublished" content="2021-06-01T00:00:00-04:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Creating and hosting your own deb packages and apt repo
</h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          14 minute read
        
        
        &nbsp;	&nbsp;<i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-06-01T00:00:00-04:00">June 1, 2021</time>
        

      </span>
    
    <span>
      
      
      
      <div class="author__avatar_top">
          <picture class="image-author"><source srcset="/blog/generated/assets/images/authors/alexcouturebeil-240-5d6b0185c.webp 240w" type="image/webp"><source srcset="/blog/generated/assets/images/authors/alexcouturebeil-240-8935b6224.jpg 240w" type="image/jpeg"><img src="/blog/generated/assets/images/authors/alexcouturebeil-240-8935b6224.jpg" alt="Alex Couture-Beil %"></picture>

          &nbsp;	&nbsp;
          Alex Couture-Beil
      </div>
      
    </span>
  </p>


        </header>
      
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On this page</h4></header>
              <ul class="toc__menu"><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#step-0-creating-a-simple-hello-world-program">Step 0: Creating a Simple Hello World Program</a></li><li><a href="#step-1-creating-a-deb-package">Step 1: Creating a deb Package</a></li><li><a href="#step-2-creating-an-apt-repository">Step 2: Creating an apt Repository</a></li><li><a href="#step-3-signing-your-apt-repository-with-gpg">Step 3: Signing your apt Repository With GPG</a><ul><li><a href="#pgp-gpg-and-gnupgp">PGP, GPG, and GnuPGP</a><ul><li><a href="#creating-a-new-publicprivate-pgp-key-pair">Creating a New Public/Private PGP Key Pair</a></li><li><a href="#signing-the-release-file">Signing the Release File</a></li><li><a href="#testing-it-out">Testing It Out</a></li><li><a href="#keeping-your-private-key-secure">Keeping Your Private Key Secure</a></li></ul></li></ul></li><li><a href="#appendix-a-a-complete-example-using-earthly">Appendix A: A Complete Example using Earthly</a></li></ul>

            </nav>
          </aside>
        
        <!-- vale HouseStyle.TLA = NO -->
<!-- vale HouseStyle.ListStart = NO -->
<!-- markdownlint-disable MD032 -->
<p>As an Ubuntu user, I find myself typing <code>apt install ...</code> frequently as a way to install software on my system. But what if I wanted to distribute my code to others via an apt repository? In this post I’ll cover how to 1) create a deb package, 2) create an apt repo, 3) signing that apt repo with a PGP key, and 4) putting it all together with some tests. <!-- markdownlint-enable MD032 --></p>
<h2 id="prerequisites">Prerequisites</h2>
<p>This tutorial assumes you are using Ubuntu, and that the following packages are installed:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install <span class="at">-y</span> gcc dpkg-dev gpg</span></code></pre></div>
<h2 id="step-0-creating-a-simple-hello-world-program">Step 0: Creating a Simple Hello World Program</h2>
<p>Before getting started with packaging, let’s create a basic hello world program under <code>~/example/hello-world-program</code>. To do this, you can copy and paste the following commands into your terminal:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/example/hello-world-program</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;#include &lt;stdio.h&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="st">int main() {</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="st">    printf(&quot;hello packaged world\n&quot;);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="st">    return 0;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="st">}&#39;</span> <span class="op">&gt;</span> ~/example/hello-world-program/hello.c</span></code></pre></div>
<p>Then, you can compile it with:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/example/hello-world-program</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-o</span> hello-world hello.c</span></code></pre></div>
<p>There’s no technical reason for picking C for this example – the language doesn’t matter. It’s the binary we will be distributing in our deb package.</p>
<h2 id="step-1-creating-a-deb-package">Step 1: Creating a <code>deb</code> Package</h2>
<p>Debian, and Debian-based Linux distributions use <code>.deb</code> packages to package and distribute programs. To start we will create a directory in the form:</p>
<pre><code>&lt;package-name&gt;_&lt;version&gt;-&lt;release-number&gt;_&lt;architecture&gt;</code></pre>
<p>where the</p>
<ul>
<li><code>package-name</code> is the name of our package, <code>hello-world</code> in our case,</li>
<li><code>version</code> is the version of the software, <code>0.0.1</code> in our case,</li>
<li><code>release-number</code> is used to track different releases of the same software version; it’s usually set to <code>1</code>, but hypothetically if there was an error in the packaging (e.g. a file was missed, or the description had an error in it, or a post-install script was wrong), this number would be increased to track the change, and</li>
<li><code>architecture</code> is the target architecture of the platform, <code>amd64</code> in this example; however if your package is architecture-independent (e.g. a python script), then you can set this to <code>all</code>.</li>
</ul>
<div class="notice--info">
<p>Theoretically, the directory doesn’t have to follow this naming convention; however some of the tools we will use later in the tutorial require this directory naming convention.</p>
</div>
<p>So for this example, we’ll create the directory with:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/example/hello-world_0.0.1-1_amd64</span></code></pre></div>
<p>This directory will be the root of the package. Since we want our <code>hello-world</code> binary to be installed system wide, we’ll have to store it under <code>usr/bin/hello-world</code> with the following commands:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/example/hello-world_0.0.1-1_amd64</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> usr/bin</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> ~/example/hello-world-program/hello-world usr/bin/.</span></code></pre></div>
<p>Each package requires a <code>control</code> file which needs to be located under the <code>DEBIAN</code> directory. You can copy and paste the following to create one:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/example/hello-world_0.0.1-1_amd64/DEBIAN</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Package: hello-world</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="st">Version: 0.0.1</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="st">Maintainer: example &lt;example@example.com&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="st">Depends: libc6</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="st">Architecture: amd64</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="st">Homepage: http://example.com</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="st">Description: A program that prints hello&quot;</span> <span class="dt">\</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> ~/example/hello-world_0.0.1-1_amd64/DEBIAN/control</span></code></pre></div>
<p>Note that we’re assuming an amd64 Architecture for this tutorial, if your binary is for a different architecture, adjust accordingly. If you’re distributing a platform-independent package, you can set the architecture to <code>all</code>.</p>
<p>By this point you should have created two files:</p>
<pre><code>~/example/hello-world_0.0.1-1_amd64/usr/bin/hello-world
~/example/hello-world_0.0.1-1_amd64/DEBIAN/control</code></pre>
<p>To build the .deb package, run:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dpkg</span> <span class="at">--build</span> ~/example/hello-world_0.0.1-1_amd64</span></code></pre></div>
<p>This will output a deb package under <code>~/example/hello-world_0.0.1.deb</code>.</p>
<p>You can inspect the info of the deb by running:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dpkg-deb</span> <span class="at">--info</span> ~/example/hello-world_0.0.1.deb</span></code></pre></div>
<p>which will show:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">new</span> Debian package, version 2.0.</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">size</span> 2832 bytes: control archive=336 bytes.</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">182</span> bytes,     7 lines      control</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Package:</span> hello-world</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Version:</span> 0.0.1</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Maintainer:</span> example <span class="op">&lt;</span>example@example.com<span class="op">&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Depends:</span> libc6</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Architecture:</span> amd64</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Homepage:</span> http://example.com</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Description:</span> A program that prints hello</span></code></pre></div>
<p>You can also view the contents by running:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dpkg-deb</span> <span class="at">--contents</span> ~/example/hello-world_0.0.1.deb</span></code></pre></div>
<p>which will show:</p>
<pre><code>drwxrwxr-x alex/alex         0 2021-05-17 16:21 ./
drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/
drwxrwxr-x alex/alex         0 2021-05-17 16:18 ./usr/bin/
-rwxrwxr-x alex/alex     16696 2021-05-17 16:18 ./usr/bin/hello-world</code></pre>
<div class="notice--info">
<p>It’s also possible to run <code>less ~/example/hello-world_0.0.1.deb</code> which will output the above information, thanks to <code>/bin/lesspipe</code>.</p>
</div>
<p>This package can then be installed using the <code>-f</code> option under <code>apt-get install</code>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install <span class="at">-f</span> ~/example/hello-world_0.0.1-1_amd64.deb</span></code></pre></div>
<p>Then once installed, you can verify it works with commands like:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span> hello-world</span></code></pre></div>
<p>and</p>
<pre><code>hello-world</code></pre>
<p>which should output <code>/usr/bin/hello-world</code> and <code>hello packaged world</code> respectively.</p>
<p>Finally, if you want to remove it, you can run:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get remove hello-world</span></code></pre></div>
<p>This concludes the first step of building a <code>.deb</code> package. If you have access to an existing apt repository, you could submit the deb to the repository maintainer, and call it a day.</p>
<h2 id="step-2-creating-an-apt-repository">Step 2: Creating an <code>apt</code> Repository</h2>
<p>In this step, we will show how to create your own apt repository which can be used to host one or more deb packages.</p>
<p>Let’s start with creating a directory to hold our debs:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/example/apt-repo/pool/main/</span></code></pre></div>
<p>Then copy our deb(s) into this directory:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> ~/example/hello-world_0.0.1-1_amd64.deb ~/example/apt-repo/pool/main/.</span></code></pre></div>
<div class="notice--info">
<p>Larger apt repositories create sub-directories for each program or project. For example, the official Ubuntu apt repository stores all vim related packages under <code>/ubuntu/pool/main/v/vim/</code>.</p>
</div>
<p>Once you’ve copied in all of your debs, we will create a different directory to contain a list of all available packages and corresponding metadata:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/example/apt-repo/dists/stable/main/binary-amd64</span></code></pre></div>
<div class="notice--info">
<p>If you want to support multiple architectures, make a directory above for each type (e.g. <code>i386</code>, <code>amd64</code>, etc).</p>
</div>
<p>Next, we will generate a <code>Packages</code> file, which will contain a list of all available packages in this repository. We will use the <code>dpkg-scanpackages</code> program to generate it, by running:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/example/apt-repo</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dpkg-scanpackages</span> <span class="at">--arch</span> amd64 pool/ <span class="op">&gt;</span> dists/stable/main/binary-amd64/Packages</span></code></pre></div>
<p>It’s also good practice to compress the packages file, as apt will favour downloading compressed data whenever available. Let’s do this by running:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> dists/stable/main/binary-amd64/Packages <span class="kw">|</span> <span class="fu">gzip</span> <span class="at">-9</span> <span class="op">&gt;</span> dists/stable/main/binary-amd64/Packages.gz</span></code></pre></div>
<p>Let’s take a quick look at the contents of the Packages file:</p>
<pre><code>Package: hello-world
Version: 0.0.1
Architecture: amd64
Maintainer: example &lt;example@example.com&gt;
Depends: libc6
Filename: pool/main/hello-world_0.0.1-1_amd64.deb
Size: 2832
MD5sum: 3eba602abba5d6ea2a924854d014f4a7
SHA1: e300cabc138ac16b64884c9c832da4f811ea40fb
SHA256: 6e314acd7e1e97e11865c11593362c65db9616345e1e34e309314528c5ef19a6
Homepage: http://example.com
Description: A program that prints hello</code></pre>
<div class="notice--info">
<p>if you had multiple deb files, you would have an entry for each package</p>
</div>
<p>The contents of the Packages file is a list of all available packages along with metadata from the <code>DEBIAN/control</code> file, and some hashes which can be used to validate the integrity of the package.</p>
<p>Next we will create a Release file. Unfortunately <code>dpkg-scanpackages</code> does not create Release files. Some people use programs like <code>apt-ftparchive</code>; however in this example I’ll cover an alternative to <code>apt-ftparchive</code> by using a small bash script.</p>
<p>First let’s look at an example of a Release file, which can be broken up into two parts:</p>
<ol type="1">
<li><p>Metadata about the repository, for example:</p>
<pre><code>Origin: Example Repository
Label: Example
Suite: stable
Codename: stable
Version: 1.0
Architectures: amd64 arm64 arm7
Components: main
Description: An example software repository</code></pre></li>
<li><p>A list of all <code>Packages</code> files and their corresponding hashes and file size, for example:</p>
<pre><code>MD5Sum:
 9eb0c0528a0647daf18c7e225ac68f45 667 main/binary-amd64/Packages.gz
 628682afa8a0208e08b5a208a4c4c85b 1685 main/binary-amd64/Packages
 b5bef2199e86a43ae02adc0b7b38bc8a 556 main/binary-arm7/Packages.gz
 81c53db3b9c5e9de44d3ca9fc4487995 1289 main/binary-arm7/Packages
 15258b054124639f0641c399f291af17 557 main/binary-arm64/Packages.gz
 dc597a0815aebb56b25a4ad979682f49 1292 main/binary-arm64/Packages
SHA1:
 a4074284eb528e5d16c2c94e203d61dd825fa774 667 main/binary-amd64/Packages.gz
 ee86dd9061967232e6e68104a695f7d45d191b41 1685 main/binary-amd64/Packages
 a6f4897bcf6a4b068c5b8fafca01fc89761106dc 556 main/binary-arm7/Packages.gz
 43171192ce84dcb43bba99828fe7493ff23e0b0e 1289 main/binary-arm7/Packages
 9f353a909a9a3dab0a9cae1a3c7ccb879ff18d32 557 main/binary-arm64/Packages.gz
 da15c24e51a028ff591656eef0d1da0dbb85ba97 1292 main/binary-arm64/Packages
SHA256:
 dee57f6f4a2209b63301984acb4b279f694648915fd559287a414365884c1842 667 main/binary-amd64/Packages.gz
 7d82e5929d909d10d9f2d7129df3f6754946397caf1c08e9e4a65713f4ac39ff 1685 main/binary-amd64/Packages
 2b3c611305e096ef246d77d2bc5fcfa807034dd200f8f99005ab640cf2c014a4 556 main/binary-arm7/Packages.gz
 d03d5192e24e098a91465ab37d34e0a2c539f50a430eb3262a543e7bd11212a1 1289 main/binary-arm7/Packages
 f96316ff77e96d246447f0ca8383472acefc0744d9b49d2be1d214d174bba38a 557 main/binary-arm64/Packages.gz
 58120a7b5ceb57ab4faca01adac3d62009a52962e0d0a6f4b7ceb1b8faedf280 1292 main/binary-arm64/Packages</code></pre></li>
</ol>
<p>And that’s it for what a <code>Release</code> file looks like. How hard could it be? let’s <a href="/blog/understanding-bash">write some bash</a>. Just copy and paste the following in your terminal to get a copy of the script:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;#!/bin/sh</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="st">set -e</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="st">do_hash() {</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="st">    HASH_NAME=$1</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="st">    HASH_CMD=$2</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="st">    echo &quot;${HASH_NAME}:&quot;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="st">    for f in $(find -type f); do</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="st">        f=$(echo $f | cut -c3-) # remove ./ prefix</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ &quot;$f&quot; = &quot;Release&quot; ]; then</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="st">            continue</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="st">        fi</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot; $(${HASH_CMD} ${f}  | cut -d&quot; &quot; -f1) $(wc -c $f)&quot;</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="st">    done</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="st">cat &lt;&lt; EOF</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="st">Origin: Example Repository</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="st">Label: Example</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="st">Suite: stable</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="st">Codename: stable</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="st">Version: 1.0</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="st">Architectures: amd64 arm64 arm7</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="st">Components: main</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="st">Description: An example software repository</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="st">Date: $(date -Ru)</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="st">EOF</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="st">do_hash &quot;MD5Sum&quot; &quot;md5sum&quot;</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="st">do_hash &quot;SHA1&quot; &quot;sha1sum&quot;</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="st">do_hash &quot;SHA256&quot; &quot;sha256sum&quot;</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;</span> <span class="op">&gt;</span> ~/example/generate-release.sh <span class="kw">&amp;&amp;</span> <span class="fu">chmod</span> +x ~/example/generate-release.sh</span></code></pre></div>
<p>Next let’s run the <code>generate-release.sh</code> script with:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/example/apt-repo/dists/stable</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">~/example/generate-release.sh</span> <span class="op">&gt;</span> Release</span></code></pre></div>
<p>At this point, you can try hosting this repo for yourself. In this example we’ll use python’s simple HTTP server; however in practice you’ll want to use a production-ready server. Here’s how you can start it up for testing:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/example</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> http.server</span></code></pre></div>
<p>Then configure this apt repository:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;deb [arch=amd64] http://127.0.0.1:8000/apt-repo stable main&quot;</span> <span class="kw">|</span> <span class="fu">sudo</span> tee /etc/apt/sources.list.d/example.list</span></code></pre></div>
<p>Then finally update apt and install our new hello-world package:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update <span class="at">--allow-insecure-repositories</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install hello-world</span></code></pre></div>
<p>Note that the <code>--allow-insecure-repositories</code> will print the following warning message:</p>
<pre><code>W: The repository &#39;http://127.0.0.1:8000/apt-repo stable Release&#39; is not signed.
N: Data from such a repository can&#39;t be authenticated and is therefore potentially dangerous to use.
N: See apt-secure(8) manpage for repository creation and user configuration details.</code></pre>
<p>That flag should never be used in a production environment. In the next section we’ll cover how to sign the repository, so it can be used in a trusted manor. Similarly when we install <code>hello-world</code>, we are asked if we want to proceed with an un-authenticated package:</p>
<pre><code>WARNING: The following packages cannot be authenticated!
  hello-world
Install these packages without verification? [y/N]</code></pre>
<p>Fortunately in the next section we’ll cover generating a PGP key, and signing our repository with it, which will allow users to verify the repository contents have not been tampered with.</p>
<h2 id="step-3-signing-your-apt-repository-with-gpg">Step 3: Signing your <code>apt</code> Repository With GPG</h2>
<p>In the previous step, we generated a <code>Release</code> file, which referenced one or more <code>Packages</code> files along with it’s corresponding md5, sha1, and sha256 hashes. The <code>Packages</code> file in turns references a deb package along with it’s md5, sha1, and sha256 hashes.</p>
<p>As of 2021, md5 and sha1 hashes are no longer considered secure; however sha256 is still considered to be secure. Therefore if a user can verify that the initial Release file has not been tampered with, then they could make use of the sha256 to verify the Packages file, then use the sha256 contained in the Packages file to verify the deb file.</p>
<p>In order to sign the apt repo, all we must do is sign the Release file.</p>
<h3 id="pgp-gpg-and-gnupgp">PGP, GPG, and GnuPGP</h3>
<p><em>PGP, OpenPGP, GnuPG, GPG, (and careful not to typo PHP).</em></p>
<p>Software has a lot of acronyms, and this extends into digital signatures. “Pretty Good Privacy” (PGP), was created in 1991 by Phil Zimmermann and eventually became the main product of non other than PGP Inc. To encourage adoption of PGP, the company created an open standard unsurprisingly called OpenPGP.</p>
<p>OpenPGP is only a specification, that’s where GNU Privacy Guard (GPG) fits in: GPG is an implementation of (Open)PGP. So is it a PGP key, or a GPG key? I don’t know, I’ve seen it called both, I’m going to call it a PGP because that’s what is contained in the first line of the armoured text: <code>-----BEGIN PGP PUBLIC KEY BLOCK-----</code>.</p>
<h4 id="creating-a-new-publicprivate-pgp-key-pair">Creating a New Public/Private PGP Key Pair</h4>
<p>Let’s start with generating a PGP key pair. We will use the <code>--batch</code> feature of <code>gpg</code> rather than using the interactive prompt. This has the benefit of generating keys in a repeatable way. First create a batch template by copying and pasting the following into your terminal:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;%echo Generating an example PGP key</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="st">Key-Type: RSA</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="st">Key-Length: 4096</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="st">Name-Real: example</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="st">Name-Email: example@example.com</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="st">Expire-Date: 0</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="st">%no-ask-passphrase</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="st">%no-protection</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="st">%commit&quot;</span> <span class="op">&gt;</span> /tmp/example-pgp-key.batch</span></code></pre></div>
<p>then we will generate it under a new temporary gpg keyring:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">GNUPGHOME</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$(</span><span class="fu">mktemp</span> <span class="at">-d</span> ~/example/pgpkeys-XXXXXX<span class="va">)</span><span class="st">&quot;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">gpg</span> <span class="at">--no-tty</span> <span class="at">--batch</span> <span class="at">--gen-key</span> /tmp/example-pgp-key.batch</span></code></pre></div>
<p>Since we overrode the GNUPGHOME to a temporary directory, we can keep this key separate from our other keys. Let’s take a quick look at the contents of the directory:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="st">&quot;</span><span class="va">$GNUPGHOME</span><span class="st">/private-keys-v1.d&quot;</span></span></code></pre></div>
<p>will show something along the lines of</p>
<pre><code>A3FB218BA1929542FF110C7D1B077B6469F769C9.key</code></pre>
<p>which contains binary data. We can also view all of our loaded keys with:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gpg</span> <span class="at">--list-keys</span></span></code></pre></div>
<p>which will show something similar to</p>
<pre><code>/home/alex/example/pgpkeys-pyml86/pubring.kbx
-------------------------------
pub   rsa4096 2021-05-18 [SCEA]
      B4D5C8B003C50A38A7E85B5989376CAC59892E72
uid           [ultimate] example &lt;example@example.com&gt;</code></pre>
<p>This PGP key is comprised of both a public key, and a private key. Let’s start with exporting the public key:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gpg</span> <span class="at">--armor</span> <span class="at">--export</span> example <span class="op">&gt;</span> ~/example/pgp-key.public</span></code></pre></div>
<p>Alternatively, you can reference the key by the email address or even the associated hex code. This should result in a public key that looks like:</p>
<pre><code>-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBGCkNmcBEADjEcDdne3ti5derY+hSPnhrBWeBba/1gb3S7lKwsysFlxeAApU
mROTk7gijH84GofOkZzQw9PJEA4u4kkF6EFfOr+VS3JDt5kYjpGorXMD8iRtJAIq
Y6hX7vqNDHpXFHSEEBIFCUF9E3yf8p7Wrohe0/6HVz1m/XAcU34zWY3a4zfgntsd
r4hj1h3E/GkZEI8UpB+/LshzbIoZMEDy+EB3EX/oCstZc9aKTUZLP9q5r3CvbrJU
s3354N+XFxCocVv4c/UFtcUI14EfQv7LVB2JRWYrit65DAHx87V4xcajqbkswvYn
4ela0DCW/Bw2jz1DaEHLGzn9me6z+YYH8VWbYqUJ/hrHHHSqjjSZ3S5E8gLVzTuf
IpoWUCSNeZlltBqoWf4ei7Q4nhzFi7AkvLABSkmx7R1+7fOH0ZIN+M2G6lOgcHEU
IiS7v6ygyj1U2h+38xn66dDH/gUhjp0zJfivMnC1c7pz7R4zNhFxyv1cyekP1nJA
wmpW+Y5ja3qSJYCHGmrtNaQIVMo2Ho1aXZiMysaTXKp4CYluoUsh97GjLtksq834
y3+FHdGMt8dGFBCRlZ9BFr1B++FZvuovbLoS+ZREmXTQPXYhN0TinpmnSFJsY6DK
5zFOU9j3Mtmf77MxUA+xsKBQrDgGM76uN7ADTc0jrUo4hECxnXQkOGyYrQARAQAB
tB1leGFtcGxlIDxleGFtcGxlQGV4YW1wbGUuY29tPokCTgQTAQoAOBYhBLTVyLAD
xQo4p+hbWYk3bKxZiS5yBQJgpDZnAhsvBQsJCAcCBhUKCQgLAgQWAgMBAh4BAheA
AAoJEIk3bKxZiS5yTUMP/1nlYpQTf8tQgSwSVUM8jhBhdOEEzmsXy/90KgpjX9WF
ABSC61SnGRonO60dn5CHT4oi0yJRKtsjJ3ZXLyxJY4Myop4ZCoJCcJw6sBOc3rvl
GN4J4O3+DZn7KRGUKFmLgeuxie2tSHdWYkonlpGPQ34xLgKT6Uf1NQOcCLZpMBim
2kxNXnnQXLEKXlbm9xmi/koub1qpko01T9DT9g9mlkv56660+sOw0XNwGmPy6HJ2
2IND53LYDNQv4qbt00ws29AUmZ6WmlUB9oP/nMx56Urgvmn6p/CLB9vbwIAb6egq
ZouUKsFAFyO5oVH3JoNBYbT84QewQv9BnJVQjuh0wK3OdCBjzT3YcBuRVwVJubKv
nSjvkJtq20tgxDSPc5ostzMpT5ZnBV+VQa6fwqBgb7VIGEPQklo6IZRwDH0rX1IA
Xpe2dZOvUICqvg17ol29uQ81BRpB7UynPDbgPDhBbELELPQN/GfaL+op8AB+cbga
JgC1JcX08nOqnT9TMpfig4TEpL/BKO+3cFy0Sttm44zMrR1f1SiyXdjZTS715LM/
nmAQWCZFMqN+5nHfT6lwJlqmtRCvjvHPdZla8Ah6B9oB+vJs1cClYJLSZuun89P/
bmQ5z+qJwCUOEVhVcVPTHAkqCTX2apQBeAszcmk54bGc/Q6UKncOgvOkELS7VuPt
=DYDE
-----END PGP PUBLIC KEY BLOCK-----</code></pre>
<div class="notice--info">
<p>If the exported key is much larger than this, you may have exported multiple keys which can cause issues with some repositories.</p>
</div>
<p>You can verify only a single key was exported by running:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/example/pgp-key.public <span class="kw">|</span> <span class="ex">gpg</span> <span class="at">--list-packets</span></span></code></pre></div>
<p>and checking that only a single <code>:public key packet:</code> entry exists. It should look something like this:</p>
<pre><code># off=0 ctb=99 tag=6 hlen=3 plen=525
:public key packet:
    version 4, algo 1, created 1621374567, expires 0
    pkey[0]: [4096 bits]
    pkey[1]: [17 bits]
    keyid: 89376CAC59892E72
# off=528 ctb=b4 tag=13 hlen=2 plen=29
:user ID packet: &quot;example &lt;example@example.com&gt;&quot;
# off=559 ctb=89 tag=2 hlen=3 plen=590
:signature packet: algo 1, keyid 89376CAC59892E72
    version 4, created 1621374567, md5len 0, sigclass 0x13
    digest algo 10, begin of digest 4d 43
    hashed subpkt 33 len 21 (issuer fpr v4 B4D5C8B003C50A38A7E85B5989376CAC59892E72)
    hashed subpkt 2 len 4 (sig created 2021-05-18)
    hashed subpkt 27 len 1 (key flags: 2F)
    hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)
    hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)
    hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)
    hashed subpkt 30 len 1 (features: 01)
    hashed subpkt 23 len 1 (keyserver preferences: 80)
    subpkt 16 len 8 (issuer key ID 89376CAC59892E72)
    data: [4095 bits]</code></pre>
<p>Next let’s export the private key so we can back it up somewhere safe.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gpg</span> <span class="at">--armor</span> <span class="at">--export-secret-keys</span> example <span class="op">&gt;</span> ~/example/pgp-key.private</span></code></pre></div>
<p>You should never share this key with anyone. If you look at the output file, it should look similar to this:</p>
<pre><code>-----BEGIN PGP PRIVATE KEY BLOCK-----

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
=+Tgf
-----END PGP PRIVATE KEY BLOCK-----</code></pre>
<div class="notice--info">
<p>The above is a burner-key I created for this article. It’s never been used for anything aside from this article. You should be generating your own key, don’t use this one.</p>
</div>
<p>Now that we’ve generated a PGP key pair, let’s move on to signing files with them.</p>
<h4 id="signing-the-release-file">Signing the Release File</h4>
<p>Before we start signing with out keys, let’s make sure that we can import the backup we made. To do that, we will create a new GPG keyring location:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">GNUPGHOME</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$(</span><span class="fu">mktemp</span> <span class="at">-d</span> ~/example/pgpkeys-XXXXXX<span class="va">)</span><span class="st">&quot;</span></span></code></pre></div>
<p>and then verify that it is empty:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="ex">gpg</span> <span class="at">--list-keys</span></span></code></pre></div>
<p>which should show something similar to:</p>
<pre><code>gpg: keybox &#39;/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx&#39; created
gpg: /home/alex/example/pgpkeys-e7u1Ad/trustdb.gpg: trustdb created</code></pre>
<p>Next we will import our backed up private key:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/example/pgp-key.private <span class="kw">|</span> <span class="ex">gpg</span> <span class="at">--import</span></span></code></pre></div>
<p>which should show a similar imported message:</p>
<pre><code>gpg: key 4E793BC948F34C6F: public key &quot;example &lt;example@example.com&gt;&quot; imported
gpg: key 4E793BC948F34C6F: secret key imported
gpg: Total number processed: 1
gpg:               imported: 1
gpg:       secret keys read: 1
gpg:   secret keys imported: 1</code></pre>
<p>and now if we run <code>gpg --list-keys</code>, we should see it is now available:</p>
<pre><code>/home/alex/example/pgpkeys-e7u1Ad/pubring.kbx
---------------------------------------------
pub   rsa4096 2021-05-18 [SCEA]
      CFBFFC9CCD163CC7E1768BFF4E793BC948F34C6F
uid           [ unknown] example &lt;example@example.com&gt;</code></pre>
<p>Ok, let’s get around to signing the <code>Release</code> file now.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/example/apt-repo/dists/stable/Release <span class="kw">|</span> <span class="ex">gpg</span> <span class="at">--default-key</span> example <span class="at">-abs</span> <span class="op">&gt;</span> ~/example/apt-repo/dists/stable/Release.gpg</span></code></pre></div>
<p>The contents of <code>Release.gpg</code> should be similar to this:</p>
<pre><code>-----BEGIN PGP SIGNATURE-----

iQJIBAABCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkTYYUHGV4YW1wbGVA
ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG+f2g//QpVA4RP5qp2mAlolhqKCqLr6r7DX
mUC5ueSISXlRwVK7l0xFADqw4uHsl+T0DIeX7K/efHyyqIYq+t8fCA8HbB5CmWFk
2rOa9jFR4G+afJ1mdfQYUHshwEzY+NIScg3suO0ZeILFXcTW6a6AzlwqI3pVy/b8
o/FCjj4hBnaPysDS1BmPqxjWvt5ilQR3RTodsFahr2FncmgZI8zvrbCey630O/Cs
ELLp9fqBQj//FEje/JgHtG6E85qjsod0Nstu5h2yEs9iwMP1+peMB80NLpyeacpS
CWbZmFgxqKL7JNSx04T8epL23Zg6trrzhvOzOiVp2+Ilg438LBrErSVO+3puWT2e
bR3jpFSg9ej0+90QnG3IIkZW1RSkitlpNiFGFrUvlBRE9tSjZMK10EofPtzENEWN
uXYqjcWTJxp6R7d1IW/lTFzwdCPorgBPBbjmJ7Ux5YWZP7jjJmFpF9jSHVz6xDcp
oUBQcF4jHn5ewh0yKZQbqA3ZRXpPBDSNSraIDFToeFzhV94FQR2f5A5FgBR8n/Kr
Gfb76dsKabwVJlr7z8+W2C8gHmOe4dlVVUje3bxo05VNwZEBPbRldFox4GKIWT46
FbXyzB/EfRR7rzmaRfIpDfQa6hLOoivlat1no6akT7bK2mE7Y0L+Kae1dP+BpBUe
BqY84ZTkmQiOL0c=
=Dqab
-----END PGP SIGNATURE-----</code></pre>
<p>Now when an apt client performs an update, it will fetch both <code>Release</code> and <code>Release.gpg</code> and will verify the signature is valid; However to increase the speed, we will create a third file <code>InRelease</code> which will combine both the contents of <code>Release</code> and the PGP signature:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> ~/example/apt-repo/dists/stable/Release <span class="kw">|</span> <span class="ex">gpg</span> <span class="at">--default-key</span> example <span class="at">-abs</span> <span class="at">--clearsign</span> <span class="op">&gt;</span> ~/example/apt-repo/dists/stable/InRelease</span></code></pre></div>
<p>The contents of <code>InRelease</code> should be similar to this:</p>
<pre><code>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Origin: Example Repository
Label: Example
Suite: stable
Codename: stable
Version: 1.0
Architectures: amd64 arm64 arm7
Components: main
Description: An example software repository
Date: Tue, 18 May 2021 01:17:46 +0000
MD5Sum:
 d47739655e6312da85a96711f78c78db 405 main/binary-amd64/Packages
SHA1:
 d6aa46cf29cca1b01af6e9e256bf963ff5dfdaeb 405 main/binary-amd64/Packages
SHA256:
 3b888d4257fcf475fc06f74bd46045c3f1d667562fdb37e86f5bea642efa49f8 405 main/binary-amd64/Packages
-----BEGIN PGP SIGNATURE-----

iQJIBAEBCgAyFiEEz7/8nM0WPMfhdov/Tnk7yUjzTG8FAmCkT1wUHGV4YW1wbGVA
ZXhhbXBsZS5jb20ACgkQTnk7yUjzTG8w/RAAwB6HRyZWVOWT1A0OJAt+RlLREjev
gfRZVLZRDv18QRZKCcj71v0Ki1hX3xWE8WVjIR9eSXNf1wJvqza+/FBGN00NY1Bk
AFmypZP/04kjwGeUtULopLB1KrCaFdWuC9W49zUyeElIz1owX9tk+SsoLB7hGLQE
jtweFjxhaMeCHgSJIXDoR0RpmKBuydtB3UTHjCQJBvErkYfKrAJQCDYDz+XVPLh6
XPAohVb6SO4qBCxX30QcQpUVDRtMMRKbIOD5B+hjCP5cupvej1fBlzlFh4lBIywj
eUXrwBxmOiO/yrsYNoJJB+mV9u1mEpQDo7yRDCICsY2c/Io/Q0CxiEIIwoEfHCb/
WOFYYmUj1Sh9YARi74eTblMyr/Ay/9+opEr54uAixecJyC/kqsC3uptH4ZpOSwTw
hdj24Cl2veYmiCimPB4QCLOsCU5A1phwEkgADUOh4iRaszuzGkh/NZ0al0dCF0HY
/UsDuiMzEQGOP6ByILt1zoPrnwZKFDEbYjzSbjSXfkU9LKfrp5PWgeeq5iD58sQW
ZCE34ksK8W67GOtQuzy0Z8NlTJY1Mkzp7IsUt60owyv6dQVZFIPYwGEisGFSOCNk
3VZ66m1D6HtDZ60CZEJUhfu+WTC1K95cKYkhYArBR9pDecygYomLQVFO2T1ENxCA
BKaAtOSl2Jcb4eA=
=3Hft
-----END PGP SIGNATURE-----</code></pre>
<h4 id="testing-it-out">Testing It Out</h4>
<p>We need to tell apt which public pgp key to use when verifying the apt repository. We will add a new <code>signed-by</code> attribute to our apt config:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;deb [arch=amd64 signed-by=</span><span class="va">$HOME</span><span class="st">/example/pgp-key.public] http://127.0.0.1:8000/apt-repo stable main&quot;</span> <span class="kw">|</span> <span class="fu">sudo</span> tee /etc/apt/sources.list.d/example.list</span></code></pre></div>
<div class="notice--info">
<p>note that <code>$HOME</code> should be expanded to the absolute path of the pgp key.</p>
</div>
<p>Next start back up your web server:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~/example</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> http.server</span></code></pre></div>
<p>Then finally try updating and re-installing our hello-world package:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get clean</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get update</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install hello-world</span></code></pre></div>
<p>This time you shouldn’t see any security warnings.</p>
<h4 id="keeping-your-private-key-secure">Keeping Your Private Key Secure</h4>
<p>If you followed this tutorial to the tee, and your web server is still running, what happens if we try running:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://127.0.0.1:8000/pgp-key.private</span></code></pre></div>
<p>Oh no! we just leaked our private key. Now’s the time to regenerate it but using a real name and email address other than <code>example@example.com</code>. Maybe you can store it in earthly’s <a href="https://docs.earthly.dev/docs/guides/cloud-secrets">secret store</a> instead?</p>
<h2 id="appendix-a-a-complete-example-using-earthly">Appendix A: A Complete Example using Earthly</h2>
<p>A complete example has been created under <a href="https://github.com/earthly/example-apt-repo/blob/main/Earthfile">github.com/earthly/example-apt-repo/Earthfile</a>.</p>
<p>This Earthfile contains all the above steps from this tutorial in a single location, which can be run directly in a single shot with:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ex">earthly</span> <span class="at">-P</span> github.com/earthly/example-apt-repo:main+test</span></code></pre></div>
<p>Alternatively, you can clone the repo and run <code>+test</code> directly. <!-- vale HouseStyle.TLA = YES --> <!-- vale HouseStyle.ListStart = YES --></p>

        
      </section>

      


<div itemscope itemtype="https://schema.org/Person">
  <!-- <h5>About The Author</h5> -->

  
    <div class="author__avatar">
      
        <picture class="image-author"><source srcset="/blog/generated/assets/images/authors/alexcouturebeil-240-5d6b0185c.webp 240w" type="image/webp"><source srcset="/blog/generated/assets/images/authors/alexcouturebeil-240-8935b6224.jpg 240w" type="image/jpeg"><img src="/blog/generated/assets/images/authors/alexcouturebeil-240-8935b6224.jpg" alt="Alex Couture-Beil %"></picture>

      
    </div>
  

  <div class="author__content">
    
      <h4 class="author__name" itemprop="name">
        Alex Couture-Beil
    
    
    </h4>
    
      <div class="author__bio" itemprop="description">
        <p>Alex enjoys writing code, growing vegetables, and the great outdoors.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <!-- <button class="btn btn--inverse">Follow</button> -->
    <ul class="author__urls social-icons">
      

     

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

      <footer class="page__meta">
        
        



  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/blog/categories/tutorials" class="page__taxonomy-item" rel="tag">Tutorials</a>
    
    </span>
  </p>



        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2021-06-01T00:00:00-04:00">June 1, 2021</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/blog/achieving-repeatability/" class="pagination--pager" title="Achieving Repeatability in Continuous Integration
">Previous</a>
    
    
      <a href="/blog/autoconf/" class="pagination--pager" title="Using Autotools to Configure, Make, and Install a Program
">Next</a>
    
  </nav>

    </div>
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          










<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <picture><source srcset="/blog/generated/assets/images/example/teaser-600-fc9eab451.webp 600w, /blog/generated/assets/images/example/teaser-800-fc9eab451.webp 800w" type="image/webp"><source srcset="/blog/generated/assets/images/example/teaser-600-b449882ef.jpg 600w, /blog/generated/assets/images/example/teaser-800-b449882ef.jpg 800w" type="image/jpeg"><img src="/blog/generated/assets/images/example/teaser-800-b449882ef.jpg"></picture>

      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/example/" rel="permalink">Example Post
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

This post is in the future, and won’t show up in the published site


Image without figure


An image with the alt text hidden.





An image with alt text...</p>
  </article>
</div>

        
          










<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <picture><source srcset="/blog/generated/assets/images/python-timsort-merge/header-600-a71a6b2cc.webp 600w, /blog/generated/assets/images/python-timsort-merge/header-800-a71a6b2cc.webp 800w" type="image/webp"><source srcset="/blog/generated/assets/images/python-timsort-merge/header-600-2f03a0cf7.jpg 600w, /blog/generated/assets/images/python-timsort-merge/header-800-2f03a0cf7.jpg 800w" type="image/jpeg"><img src="/blog/generated/assets/images/python-timsort-merge/header-800-2f03a0cf7.jpg"></picture>

      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/blog/python-timsort-merge/" rel="permalink">Beating TimSort at Merging
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">

Here is a problem. You are tasked with improving the hot loop of a Python program: maybe it is an in-memory sequential index of some sort. The slow part is...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/earthlytech" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/earthly/earthly" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
    

    
      <li><a href="/blog/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 <a href="https://earthly.dev/">Earthly</a>. </div>

      </footer>
    </div>

    <script src="/blog/assets/js/vendor/jquery/jquery-3.5.1.js"></script>
<script src="/blog/assets/js/plugins/jquery.fitvids.js"></script>
<script src="/blog/assets/js/plugins/smooth-scroll.js"></script>
<script src="/blog/assets/js/plugins/gumshoe.js"></script>
<script src="/blog/assets/js/plugins/jquery.magnific-popup.js"></script>
<script src="/blog/assets/js/main.min.js"></script>

  <script> // minified version of https://earthly.dev/assets/js/analytics.js
    function setCookie(e,t,r){var i="";if(r){var o=new Date;o.setTime(o.getTime()+24*r*60*60*1e3),i="; expires="+o.toUTCString()}document.cookie=e+"="+(t||"")+i+"; path=/"}function getCookie(e){for(var t=e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var o=r[i];" "==o.charAt(0);)o=o.substring(1,o.length);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return null}function uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function getAnalyticCookie(){cookieName="earthlyID";var e=getCookie(cookieName);return null==e&&(e=uuidv4()),setCookie(cookieName,e,36500),e}jQuery.ajax({type:"POST",url:"https://api.earthly.dev/analytics",data:JSON.stringify({key:"website",url:window.location.href,referrer:document.referrer,earthlyID:getAnalyticCookie()})});
</script>




  </body>
</html>
